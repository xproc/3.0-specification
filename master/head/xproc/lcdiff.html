<?xml version="1.0" encoding="UTF-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><!--Generated by the DeltaXML.com xhtml-outfilter.xsl--><!--Using XSL Processor: Saxonica--><title>XProc -[[3.0]]- +[[3.1]]+: An XML Pipeline Language</title><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" /><link class="removeOnSave" crossorigin="anonymous" href="https://www.w3.org" rel="preconnect" /><link as="script" class="removeOnSave" href="js/fixup.js" rel="preload" /><link as="style" class="removeOnSave" href="css/base.css" rel="preload" /><link as="image" class="removeOnSave" href="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" rel="preload" /><link rel="stylesheet" href="css/cg-draft.css" /><link rel="stylesheet" href="css/respec.css" /><link rel="alternate" title="XML" href="specification.xml" /><meta name="generator" content="DocBook XSL 2.0 Stylesheets V2.5.0" /><meta name="description" content="Abstract This specification describes the syntax and semantics of&#xA;XProc 3.1: An XML Pipeline Language, a language for&#xA;describing operations to be performed on documents. An XML Pipeline specifies a sequence of operations to be&#xA;performed on documents. Pipelines generally accept&#xA;documents as input and produce documents as output.&#xA;Pipelines are made up of simple steps which&#xA;perform atomic operations on documents and constructs such as&#xA;conditionals, iterations, and exception handlers which control which&#xA;steps are executed." /><link href="css/default.css" rel="stylesheet" type="text/css" /><link href="css/db-prism.css" rel="stylesheet" type="text/css" /><link rel="stylesheet" type="text/css" href="css/base.css" /><link rel="stylesheet" type="text/css" href="css/xproc.css" /><link rel="stylesheet" type="text/css" href="css/print.css" media="print" /><script type="text/javascript" src="js/dbmodnizr.js"></script><style type="text/css">
          body { margin-top: 50px }
          a.button { background: #DDD; border: 2px outset black; padding: 2px; margin: 2px; font-family: sans-serif; font-size: small;}
          a.button:hover { cursor:pointer; }
          a.button:active { border-style: inset; }
        </style><link rel="stylesheet" href="/css/autodiff.css" /></head><body class="h-entry informative toc-sidebar"><div style="position:fixed; clear:both; top:0px" id="_autodiff_buttons"><p><a class="button" onclick="view('old')">
              View Old
            </a><a class="button" onclick="view('new')">
              View New
            </a><a class="button" onclick="view('both')">
              View Both
            </a><a class="button" onclick="view('only')">
              View Only
            </a><a class="button" onclick="scroll_to('prev')">
              Previous
            </a><a class="button" onclick="scroll_to('next')">
              Next
            </a><span id="__autodiff__"></span></p></div><div id="spec.head" class="head"><a class="logo" href="https://www.w3.org/"><img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" width="72" /></a><h1 id="title" class="title p-name">XProc <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span>: An XML Pipeline Language</h1><h2><span class="deltaxml-new" style="background:#90EE90">Draft </span>Community Group Report <time class="dt-published" datetime="2022-09-12"><span class="deltaxml-old" style="background:#FF5555">12 September 2022</span></time><time class="dt-published" datetime="2025-05-22"><span class="deltaxml-new" style="background:#90EE90">22 May 2025</span></time></h2><div class="editors-draft"><span class="deltaxml-new" style="background:#90EE90">Editor's Draft at </span><time class="dt-timestamp" datetime="20250522T14:37:41Z"><span class="deltaxml-new" style="background:#90EE90">14:37 UTC</span></time><span class="deltaxml-new" style="background:#90EE90"> (</span><a href="https://github.com/xproc//commit/ec7122ccb16ebcdc9827c0dab5f17a28be2ce934"><span class="deltaxml-new" style="background:#90EE90">build 44</span></a><span class="deltaxml-new" style="background:#90EE90">)</span></div><dl><dt><span class="deltaxml-old" style="background:#FF5555">Specification:</span></dt><dt><span class="deltaxml-new" style="background:#90EE90">Latest editor’s draft:</span></dt><dd><a href="https://spec.xproc.org/master/head/xproc/">https://spec.xproc.org/<span class="deltaxml-old" style="background:#FF5555">3.0/</span><span class="deltaxml-new" style="background:#90EE90">master/head/</span>xproc/</a></dd><dt>Editors:</dt><dd><span class="personname">Norman Walsh</span></dd><dd><span class="personname">Achim Berndzen</span></dd><dd><span class="personname">Gerrit Imsieke</span></dd><dd><span class="personname">Erik Siegel</span></dd><dt>Participate:</dt><dd><a href="http://github.com/xproc/3.0-specification">GitHub xproc/3.0-specification</a></dd><dd><a href="http://github.com/xproc/3.0-specification/issues">Report an issue</a></dd><dt><span class="deltaxml-old" style="background:#FF5555">Errata:</span></dt><dt><span class="deltaxml-new" style="background:#90EE90">Changes:</span></dt><dd><a href="https://spec.xproc.org/3.0/xproc/errata.html"><span class="deltaxml-old" style="background:#FF5555">https://spec.xproc.org/3.0/xproc/errata.html</span></a><a href="lcdiff.html"><span class="deltaxml-new" style="background:#90EE90">Diff against the 3.0 specification</span></a></dd><dd><a href="diff.html"><span class="deltaxml-new" style="background:#90EE90">Diff against current “status quo” draft</span></a></dd><dd><a href="http://github.com/xproc//commits/"><span class="deltaxml-new" style="background:#90EE90">Commits for this specification</span></a></dd></dl><p>This document is also available in these non-normative formats: <a href="specification.xml">XML</a><span class="deltaxml-old" style="background:#FF5555">,</span> <a href="xproc_a4.pdf"><span class="deltaxml-old" style="background:#FF5555">PDF (A4)</span></a><span class="deltaxml-old" style="background:#FF5555">,</span><span class="deltaxml-new" style="background:#90EE90">and HTML with automatic change markup courtesy of</span> <a href="xproc_letter.pdf"><span class="deltaxml-old" style="background:#FF5555">PDF (US Letter)</span></a><a href="http://www.deltaxml.com/"><span class="deltaxml-new" style="background:#90EE90">DeltaXML</span></a>.</p><p class="copyright"><span style="display: none;" class="delete_version"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © <span class="years">2018, 2019, 2020, 2021, 2022</span> the Contributors to the <cite>XProc 3.0: An XML Pipeline Language</cite> specification, published by the <a href="https://www.w3.org/community/xproc-next/">XProc Next Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. A human-readable <a href="https://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.</span><span style="display: none;" class="add_version"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © <span class="years">2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025</span> the Contributors to the <cite>XProc 3.1: An XML Pipeline Language</cite> specification, published by the <a href="https://www.w3.org/community/xproc-next/">XProc Next Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. A human-readable <a href="https://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.</span><span class="modify_version"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © <span class="years">2018, 2019, 2020, 2021, 2022<span class="deltaxml-old" style="background:#FF5555"> </span><span class="deltaxml-new" style="background:#90EE90">, 2023, 2024, 2025</span></span><span class="deltaxml-new" style="background:#90EE90"> </span>the Contributors to the <cite>XProc <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span>: An XML Pipeline Language</cite> specification, published by the <a href="https://www.w3.org/community/xproc-next/">XProc Next Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. A human-readable <a href="https://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.</span></p><hr title="Separator for header" /><section id="abstract" class="introductory"><h2>Abstract</h2><p><span style="display: none;" class="delete_version">This specification describes the syntax and semantics of <em class="citetitle">XProc 3.0: An XML Pipeline Language</em>, a language for describing operations to be performed on documents.</span><span style="display: none;" class="add_version">This specification describes the syntax and semantics of <em class="citetitle">XProc 3.1: An XML Pipeline Language</em>, a language for describing operations to be performed on documents.</span><span class="modify_version">This specification describes the syntax and semantics of <em class="citetitle">XProc <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span>: An XML Pipeline Language</em>, a language for describing operations to be performed on documents.</span></p><p>An XML Pipeline specifies a sequence of operations to be performed on documents. Pipelines generally accept documents as input and produce documents as output. Pipelines are made up of simple steps which perform atomic operations on documents and constructs such as conditionals, iterations, and exception handlers which control which steps are executed.</p></section><section id="sotd" class="introductory"><h2>Status of this Document</h2><p><strong><span class="deltaxml-new" style="background:#90EE90">This document is an editor's draft that has no official standing.</span></strong></p><p>This specification was published by the <a href="https://www.w3.org/community/xproc-next/">XProc Next Community Group</a>. It is not a W3C Standard nor is it on the W3C Standards Track. Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply. Learn more about <a href="https://www.w3.org/community/">W3C Community and Business Groups</a>. </p><p>If you wish to make comments regarding this document, please send them to <a href="mailto:xproc-dev@w3.org">xproc-dev@w3.org</a>. (<a href="mailto:xproc-dev-request@w3.org?subject=subscribe">subscribe</a>, <a href="https://lists.w3.org/Archives/Public/xproc-dev/">archives</a>). </p><div class="note editorial admonition"><h3><span class="deltaxml-new" style="background:#90EE90">Note</span></h3><div class="admonition-body"><p><span class="deltaxml-new" style="background:#90EE90">This draft is the “editor’s working draft” and may continue to evolve. </span></p></div></div><p>This document is derived from <a href="https://www.w3.org/TR/2010/REC-xproc-20100511/">XProc: An XML Pipeline Language</a> published by the W3C.</p><p><span class="deltaxml-new" style="background:#90EE90">Changes made since the 3.0 specification was published are listed in </span><a href="#changelog" title="Change Log"><span class="deltaxml-new" style="background:#90EE90">Appendix M, </span><i><span class="deltaxml-new" style="background:#90EE90">Change Log</span></i></a><span class="deltaxml-new" style="background:#90EE90">.</span></p></section></div><div class="lists-of-titles"><nav id="toc"><h2 id="TableOfContents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#intro-examples"><bdi class="secno">1.1. </bdi>Pipeline examples</a></li></ul></li><li class="tocline"><a class="tocxref" href="#pipeline-concepts"><bdi class="secno">2. </bdi>Pipeline Concepts</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#step-concept"><bdi class="secno">2.1. </bdi>Steps</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#step-names"><bdi class="secno">2.1.1. </bdi>Step names</a></li><li class="tocline"><a class="tocxref" href="#step-types"><bdi class="secno">2.1.2. </bdi>Step types</a></li></ul></li></ul></li><li class="tocline"><a class="tocxref" href="#documents"><bdi class="secno">3. </bdi>Documents</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#document-properties"><bdi class="secno">3.1. </bdi>Document Properties</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#managing-properties"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">3.1.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Managing properties</span></a></li></ul></li><li class="tocline"><a class="tocxref" href="#document-types"><bdi class="secno">3.2. </bdi>Document Types</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#xml-documents"><bdi class="secno">3.2.1. </bdi>XML Documents</a></li><li class="tocline"><a class="tocxref" href="#html-documents"><bdi class="secno">3.2.2. </bdi>HTML Documents</a></li><li class="tocline"><a class="tocxref" href="#text-documents"><bdi class="secno">3.2.3. </bdi>Text Documents</a></li><li class="tocline"><a class="tocxref" href="#json-documents"><bdi class="secno">3.2.4. </bdi>JSON Documents</a></li><li class="tocline"><a class="tocxref" href="#other-documents"><bdi class="secno">3.2.5. </bdi>Other documents</a></li></ul></li><li class="tocline"><a class="tocxref" href="#creating-documents-from-xdm-step-results"><bdi class="secno">3.3. </bdi>Creating documents from XDM step results</a></li><li class="tocline"><a class="tocxref" href="#specified-content-types"><bdi class="secno">3.4. </bdi>Specifying content types</a></li></ul></li><li class="tocline"><a class="tocxref" href="#input-output"><bdi class="secno">4. </bdi>Inputs and Outputs</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#external-docs"><bdi class="secno">4.1. </bdi>External Documents</a></li></ul></li><li class="tocline"><a class="tocxref" href="#primary-input-output"><bdi class="secno">5. </bdi>Primary Inputs and Outputs</a></li><li class="tocline"><a class="tocxref" href="#connections"><bdi class="secno">6. </bdi>Connections</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#connecting-the-drp"><bdi class="secno">6.1. </bdi>Connections and the Default Readable Port</a></li><li class="tocline"><a class="tocxref" href="#namespace-fixup"><bdi class="secno">6.2. </bdi>Namespace Fixup on XML Outputs</a></li></ul></li><li class="tocline"><a class="tocxref" href="#initiating"><bdi class="secno">7. </bdi>Initiating a pipeline</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#static-expressions"><bdi class="secno">7.1. </bdi>Evaluating expressions during static analysis</a></li><li class="tocline"><a class="tocxref" href="#dynamic-evaluation"><bdi class="secno">7.2. </bdi>Dynamic evaluation of the pipeline</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#environment"><bdi class="secno">7.2.1. </bdi>Environment</a></li><li class="tocline"><a class="tocxref" href="#xpath-context"><bdi class="secno">7.2.2. </bdi>XPath in XProc</a></li></ul></li></ul></li><li class="tocline"><a class="tocxref" href="#xpath-extension-functions"><bdi class="secno">8. </bdi>XPath Extension Functions</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#f.system-property"><bdi class="secno">8.1. </bdi>System Properties</a></li><li class="tocline"><a class="tocxref" href="#f.step-available"><bdi class="secno">8.2. </bdi>Step Available</a></li><li class="tocline"><a class="tocxref" href="#f.iteration-position"><bdi class="secno">8.3. </bdi>Iteration Position</a></li><li class="tocline"><a class="tocxref" href="#f.iteration-size"><bdi class="secno">8.4. </bdi>Iteration Size</a></li><li class="tocline"><a class="tocxref" href="#f.version-available"><bdi class="secno">8.5. </bdi>Version Available</a></li><li class="tocline"><a class="tocxref" href="#f.xpath-version-available"><bdi class="secno">8.6. </bdi>XPath Version Available</a></li><li class="tocline"><a class="tocxref" href="#f.document-properties"><bdi class="secno">8.7. </bdi>Document properties</a></li><li class="tocline"><a class="tocxref" href="#f.document-property"><bdi class="secno">8.8. </bdi>Document property</a></li><li class="tocline"><a class="tocxref" href="#f.urify"><bdi class="secno">8.9. </bdi>Transform file system paths into URIs and normalize URIs</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#urify-normalize"><bdi class="secno">8.9.1. </bdi>Normalize file separators</a></li><li class="tocline"><a class="tocxref" href="#urify-analysis"><bdi class="secno">8.9.2. </bdi>Analysis</a></li><li class="tocline"><a class="tocxref" href="#urify-fixup"><bdi class="secno">8.9.3. </bdi>Path fixup</a></li><li class="tocline"><a class="tocxref" href="#urify-uri-construction"><bdi class="secno">8.9.4. </bdi>URI construction</a></li></ul></li><li class="tocline"><a class="tocxref" href="#f.function-library-importable"><bdi class="secno">8.10. </bdi>Function library importable</a></li><li class="add_version" style="display: none;"><a class="tocxref" href="#f.lookup-uri"><bdi class="secno">8.11. </bdi>Lookup URI</a></li><li class="tocline"><a class="tocxref" href="#f.lookup-uri"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">8.11. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Lookup URI</span></a></li><li class="tocline"><a class="tocxref" href="#other-xpath-extension-functions"><bdi class="secno"><span class="deltaxml-old" style="background:#FF5555">8.11. </span></bdi><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">8.12. </span></bdi>Other XPath Extension Functions</a></li></ul></li><li class="tocline"><a class="tocxref" href="#psvi-support"><bdi class="secno">9. </bdi>PSVIs in XProc</a></li><li class="tocline"><a class="tocxref" href="#value-templates"><bdi class="secno">10. </bdi>Value Templates</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attribute-value-templates"><bdi class="secno">10.1. </bdi>Attribute Value Templates</a></li><li class="tocline"><a class="tocxref" href="#text-value-templates"><bdi class="secno">10.2. </bdi>Text Value Templates</a></li></ul></li><li class="tocline"><a class="tocxref" href="#variables-options-background"><bdi class="secno">11. </bdi>Variables and Options</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#variables"><bdi class="secno">11.1. </bdi>Variables</a></li><li class="tocline"><a class="tocxref" href="#options"><bdi class="secno">11.2. </bdi>Options</a></li><li class="tocline"><a class="tocxref" href="#statics"><bdi class="secno">11.3. </bdi>Static Options</a></li><li class="tocline"><a class="tocxref" href="#varopt-types"><bdi class="secno">11.4. </bdi>Variable and option types</a></li><li class="tocline"><a class="tocxref" href="#implicit-casting"><bdi class="secno">11.5. </bdi>Implicit casting</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#qname-handling"><bdi class="secno">11.5.1. </bdi>Special rules for casting QNames</a></li><li class="tocline"><a class="tocxref" href="#handling-uris"><bdi class="secno">11.5.2. </bdi>Special rules for casting URIs</a></li></ul></li><li class="tocline"><a class="tocxref" href="#opt-bindings"><bdi class="secno">11.6. </bdi>Namespaces on variables and options</a></li></ul></li><li class="tocline"><a class="tocxref" href="#security-considerations"><bdi class="secno">12. </bdi>Security Considerations</a></li><li class="tocline"><a class="tocxref" href="#versioning-considerations"><bdi class="secno">13. </bdi>Versioning Considerations</a></li><li class="tocline"><a class="tocxref" href="#syntax"><bdi class="secno">14. </bdi>Syntax Overview</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#namespaces"><bdi class="secno">14.1. </bdi>XProc Namespaces</a></li><li class="tocline"><a class="tocxref" href="#scoping"><bdi class="secno">14.2. </bdi>Scoping of Names</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#scoping.4"><bdi class="secno">14.2.1. </bdi>Scoping of step type names</a></li><li class="tocline"><a class="tocxref" href="#scoping.5"><bdi class="secno">14.2.2. </bdi>Scoping of step names</a></li><li class="tocline"><a class="tocxref" href="#scoping.6"><bdi class="secno">14.2.3. </bdi>Scoping of port names</a></li><li class="tocline"><a class="tocxref" href="#scoping.7"><bdi class="secno">14.2.4. </bdi>Scoping of non-static options and variables</a></li><li class="tocline"><a class="tocxref" href="#scoping.8"><bdi class="secno">14.2.5. </bdi>Scoping of static option names</a></li><li class="add_version" style="display: none;"><a class="tocxref" href="#scoping.9"><bdi class="secno">14.2.6. </bdi>Scoping of imported function names</a></li><li class="tocline"><a class="tocxref" href="#scoping.9"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">14.2.6. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Scoping of imported function names</span></a></li></ul></li><li class="tocline"><a class="tocxref" href="#xml-base-attribute"><bdi class="secno">14.3. </bdi>Base URIs and xml:base</a></li><li class="tocline"><a class="tocxref" href="#xml-id-attribute"><bdi class="secno">14.4. </bdi>Unique identifiers</a></li><li class="tocline"><a class="tocxref" href="#syntax-docs-ports"><bdi class="secno">14.5. </bdi>Associating Documents with Ports</a></li><li class="tocline"><a class="tocxref" href="#documentation"><bdi class="secno">14.6. </bdi>Documentation</a></li><li class="tocline"><a class="tocxref" href="#annotations"><bdi class="secno">14.7. </bdi>Processor annotations</a></li><li class="tocline"><a class="tocxref" href="#extension-attributes"><bdi class="secno">14.8. </bdi>Extension attributes</a></li><li class="tocline"><a class="tocxref" href="#common-attr"><bdi class="secno">14.9. </bdi>Common Attributes</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#expand-text-attribute"><bdi class="secno">14.9.1. </bdi>Expand text attributes</a></li><li class="tocline"><a class="tocxref" href="#use-when"><bdi class="secno">14.9.2. </bdi>Conditional Element Exclusion</a></li><li class="tocline"><a class="tocxref" href="#depends"><bdi class="secno">14.9.3. </bdi>Additional dependent connections</a></li><li class="tocline"><a class="tocxref" href="#timeout"><bdi class="secno">14.9.4. </bdi>Controlling long running steps</a></li><li class="tocline"><a class="tocxref" href="#messages"><bdi class="secno">14.9.5. </bdi>Status and debugging output</a></li></ul></li><li class="tocline"><a class="tocxref" href="#syntax-summaries"><bdi class="secno">14.10. </bdi>Syntax Summaries</a></li><li class="tocline"><a class="tocxref" href="#common-errors"><bdi class="secno">14.11. </bdi>Common errors</a></li></ul></li><li class="tocline"><a class="tocxref" href="#steps"><bdi class="secno">15. </bdi>Steps</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#pipelines"><bdi class="secno">15.1. </bdi>Pipelines</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#example-pipeline"><bdi class="secno">15.1.1. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.for-each"><bdi class="secno">15.2. </bdi>p:for-each</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#for-each-xpath-context"><bdi class="secno">15.2.1. </bdi>XPath Context</a></li><li class="tocline"><a class="tocxref" href="#example-for-each"><bdi class="secno">15.2.2. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.viewport"><bdi class="secno">15.3. </bdi>p:viewport</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#viewport-xpath-context"><bdi class="secno">15.3.1. </bdi>XPath Context</a></li><li class="tocline"><a class="tocxref" href="#example-viewport"><bdi class="secno">15.3.2. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.choose"><bdi class="secno">15.4. </bdi>p:choose</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#p.when"><bdi class="secno">15.4.1. </bdi>p:when</a></li><li class="tocline"><a class="tocxref" href="#p.otherwise"><bdi class="secno">15.4.2. </bdi>p:otherwise</a></li><li class="tocline"><a class="tocxref" href="#example-choose"><bdi class="secno">15.4.3. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.if"><bdi class="secno">15.5. </bdi>p:if</a></li><li class="tocline"><a class="tocxref" href="#p.group"><bdi class="secno">15.6. </bdi>p:group</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#example-group"><bdi class="secno">15.6.1. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.try"><bdi class="secno">15.7. </bdi>p:try</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#p.catch"><bdi class="secno">15.7.1. </bdi>p:catch</a></li><li class="tocline"><a class="tocxref" href="#p.finally"><bdi class="secno">15.7.2. </bdi>p:finally</a></li><li class="tocline"><a class="tocxref" href="#err-vocab"><bdi class="secno">15.7.3. </bdi>The Error Vocabulary</a></li><li class="tocline"><a class="tocxref" href="#example-try"><bdi class="secno">15.7.4. </bdi>Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.atomic"><bdi class="secno">15.8. </bdi>Atomic Steps</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#p.standard"><bdi class="secno">15.8.1. </bdi>Processor-provided standard atomic steps</a></li><li class="tocline"><a class="tocxref" href="#p.extension"><bdi class="secno">15.8.2. </bdi>Extension Steps</a></li></ul></li></ul></li><li class="tocline"><a class="tocxref" href="#other-elements"><bdi class="secno">16. </bdi>Other pipeline elements</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#p.input"><bdi class="secno">16.1. </bdi>p:input</a></li><li class="tocline"><a class="tocxref" href="#p.with-input"><bdi class="secno">16.2. </bdi>p:with-input</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#conn-prec"><bdi class="secno">16.2.1. </bdi>Connection precedence</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.output"><bdi class="secno">16.3. </bdi>p:output</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#serialization"><bdi class="secno">16.3.1. </bdi>Serialization parameters</a></li></ul></li><li class="tocline"><a class="tocxref" href="#variables-options"><bdi class="secno">16.4. </bdi>Variables and Options</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#p.variable"><bdi class="secno">16.4.1. </bdi>p:variable</a></li><li class="tocline"><a class="tocxref" href="#p.option"><bdi class="secno">16.4.2. </bdi>p:option</a></li><li class="tocline"><a class="tocxref" href="#p.with-option"><bdi class="secno">16.4.3. </bdi>p:with-option</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.declare-step"><bdi class="secno">16.5. </bdi>p:declare-step</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#declare-pipelines"><bdi class="secno">16.5.1. </bdi>Declaring pipelines</a></li><li class="tocline"><a class="tocxref" href="#declare-atomic-steps"><bdi class="secno">16.5.2. </bdi>Declaring external steps</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.library"><bdi class="secno">16.6. </bdi>p:library</a></li><li class="tocline"><a class="tocxref" href="#p.import"><bdi class="secno">16.7. </bdi>p:import</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#import-visibility"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">16.7.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Import visibility</span></a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.import-functions"><bdi class="secno">16.8. </bdi>p:import-functions</a></li><li class="tocline"><a class="tocxref" href="#p.pipe"><bdi class="secno">16.9. </bdi>p:pipe</a></li><li class="tocline"><a class="tocxref" href="#p.inline"><bdi class="secno">16.10. </bdi>p:inline</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#inline-xml-content"><bdi class="secno">16.10.1. </bdi>Inline XML and HTML content</a></li><li class="tocline"><a class="tocxref" href="#inline-text"><bdi class="secno">16.10.2. </bdi>Inline text content</a></li><li class="tocline"><a class="tocxref" href="#inline-json"><bdi class="secno">16.10.3. </bdi>Inline JSON content</a></li><li class="tocline"><a class="tocxref" href="#inline-others"><bdi class="secno">16.10.4. </bdi>Other inline content</a></li><li class="tocline"><a class="tocxref" href="#implicit-inlines"><bdi class="secno">16.10.5. </bdi>Implicit inlines</a></li></ul></li><li class="tocline"><a class="tocxref" href="#p.document"><bdi class="secno">16.11. </bdi>p:document</a></li><li class="tocline"><a class="tocxref" href="#p.empty"><bdi class="secno">16.12. </bdi>p:empty</a></li><li class="tocline"><a class="tocxref" href="#p.documentation"><bdi class="secno">16.13. </bdi>p:documentation</a></li><li class="tocline"><a class="tocxref" href="#p.pipeinfo"><bdi class="secno">16.14. </bdi>p:pipeinfo</a></li></ul></li><li class="tocline"><a class="tocxref" href="#errors"><bdi class="secno">17. </bdi>Errors</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#static-errors"><bdi class="secno">17.1. </bdi>Static Errors</a></li><li class="tocline"><a class="tocxref" href="#dynamic-errors"><bdi class="secno">17.2. </bdi>Dynamic Errors</a></li><li class="tocline"><a class="tocxref" href="#step-errors"><bdi class="secno">17.3. </bdi>Step Errors</a></li></ul></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">A. </bdi>Conformance</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#implementation-defined"><bdi class="secno">A.1. </bdi>Implementation-defined features</a></li><li class="tocline"><a class="tocxref" href="#implementation-dependent"><bdi class="secno">A.2. </bdi>Implementation-dependent features</a></li><li class="tocline"><a class="tocxref" href="#infoset-conformance"><bdi class="secno">A.3. </bdi>Infoset Conformance</a></li></ul></li><li class="tocline"><a class="tocxref" href="#xproc-and-step-xpath-context"><bdi class="secno">B. </bdi>XPath contexts in XProc</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#xproc-xpath-context-31"><bdi class="secno">B.1. </bdi>Processor XPath Context</a></li><li class="tocline"><a class="tocxref" href="#step-xpath-context-31"><bdi class="secno">B.2. </bdi>Step XPath Context</a></li></ul></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">C. </bdi>References</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">C.1. </bdi>Normative References</a></li></ul></li><li class="tocline"><a class="tocxref" href="#glossary"><bdi class="secno">D. </bdi>Glossary</a></li><li class="tocline"><a class="tocxref" href="#language-summary"><bdi class="secno">E. </bdi>Pipeline Language Summary</a></li><li class="tocline"><a class="tocxref" href="#errors-list"><bdi class="secno">F. </bdi>List of Error Codes</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#app.static-errors"><bdi class="secno">F.1. </bdi>Static Errors</a></li><li class="tocline"><a class="tocxref" href="#app.dynamic-errors"><bdi class="secno">F.2. </bdi>Dynamic Errors</a></li><li class="tocline"><a class="tocxref" href="#app.step-errors"><bdi class="secno">F.3. </bdi>Step Errors</a></li></ul></li><li class="tocline"><a class="tocxref" href="#namespace-fixup-guidance"><bdi class="secno">G. </bdi>Guidance on Namespace Fixup (Non-Normative)</a></li><li class="tocline"><a class="tocxref" href="#handling-imports"><bdi class="secno">H. </bdi>Handling Circular and Re-entrant Library Imports (Non-Normative)</a></li><li class="tocline"><a class="tocxref" href="#parallelism"><bdi class="secno">I. </bdi>Sequential steps, parallelism, and side-effects</a></li><li class="tocline"><a class="tocxref" href="#xproc-media-type"><bdi class="secno">J. </bdi>The <code class="code">application/xproc+xml</code> media type</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#media-type-registration"><bdi class="secno">J.1. </bdi>Registration of MIME media type application/xproc+xml</a></li><li class="tocline"><a class="tocxref" href="#fragid"><bdi class="secno">J.2. </bdi>Fragment Identifiers</a></li></ul></li><li class="tocline"><a class="tocxref" href="#ancillary-files"><bdi class="secno">K. </bdi>Ancillary files</a></li><li class="tocline"><a class="tocxref" href="#credits"><bdi class="secno">L. </bdi>Credits</a></li><li class="tocline"><a class="tocxref" href="#changelog"><bdi class="secno">M. </bdi>Change Log</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#changelog.3"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Backwards incompatible changes</span></a><ul class="toc"><li class="tocline"><a class="tocxref" href="#changelog.3.3"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Substantive changes</span></a></li><li class="tocline"><a class="tocxref" href="#changelog.3.4"><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1.2. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Editorial changes</span></a></li></ul></li></ul></li></ol></nav></div><article class="specification"><section id="introduction" class="section"><div class="section-titlepage"><h2><bdi class="secno">1. </bdi>Introduction<a aria-label="§" class="self-link" href="#introduction"></a></h2></div><div class="content"><p>An XML Pipeline specifies a sequence of operations to be performed on a collection of input documents. Pipelines take documents (XML, JSON, text, images, etc.) as their input and produce documents as their output.</p><p>A <em class="glossterm"><a href="#dt-pipeline">pipeline</a></em> consists of steps. Like pipelines, steps take documents as their inputs and produce documents as their outputs. The inputs of a step come from the web, from the pipeline document, from the inputs to the pipeline itself, or from the outputs of other steps in the pipeline. The outputs from a step are consumed by other steps, are outputs of the pipeline as a whole, or are discarded.</p><p>There are two kinds of steps: <em class="glossterm"><a href="#dt-atomic-step">atomic steps</a></em> and <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em>. Atomic steps carry out a single operation and have no substructure as far as the pipeline is concerned. Compound steps control the execution of other steps, which they include in the form of one or more subpipelines.</p><p><span style="display: none;" class="delete_version">[<a><span class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span class="modify_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span></a>] defines a standard library of steps. Pipeline implementations <span class="rfc2119" id="introduction.5.2">may</span> support additional types of steps as well. </span><span style="display: none;" class="add_version">[<a><span class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span></a>] defines a standard library of steps. Pipeline implementations <span class="rfc2119" id="introduction.5.2">may</span> support additional types of steps as well. </span><span class="modify_version">[<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>] defines a standard library of steps. Pipeline implementations <span class="rfc2119" id="introduction.5.2">may</span> support additional types of steps as well. </span></p><p>The media type for pipeline documents is <code class="literal">application/xml</code>. Often, pipeline documents are identified by the extension <code class="filename">.xpl</code>.</p><p>In this specification the words <span class="rfc2119" id="introduction.7.1">must</span>, <span class="rfc2119" id="introduction.7.2">must not</span>, <span class="rfc2119" id="introduction.7.3">should</span>, <span class="rfc2119" id="introduction.7.4">should not</span>, <span class="rfc2119" id="introduction.7.5">may</span> and <span class="rfc2119" id="introduction.7.6">recommended</span> are to be interpreted as described in [<a href="#rfc2119"><span class="abbrev">RFC 2119</span></a>].</p><section id="intro-examples" class="section"><div class="section-titlepage"><h3><bdi class="secno">1.1. </bdi>Pipeline examples<a aria-label="§" class="self-link" href="#intro-examples"></a></h3></div><div class="content"><p><a href="#fig-xival" title="A simple, linear XInclude/Validate pipeline">Figure 1, “A simple, linear XInclude/Validate pipeline”</a> is a graphical representation of a simple pipeline that performs XInclude processing and validation on a document.</p><figure id="fig-xival" class="figure-wrapper"><div class="figure"><div id="fig-xival.2" title="A simple, linear XInclude/Validate pipeline" class="mediaobject"><img src="graphics/sch-xinclude-validate-pipeline.png" alt="A simple, linear XInclude/Validate pipeline" /></div></div><div class="title">Figure 1. A simple, linear XInclude/Validate pipeline</div></figure><p>This is a pipeline that consists of two atomic steps, XInclude and Validate with XML Schema. The pipeline itself has two inputs, “source” (a source document) and “schemas” (a sequence of W3C XML Schemas). The XInclude step reads the pipeline input “source” and produces a result document. The Validate with XML Schema step reads the pipeline input “schemas” and the result of the XInclude step and produces its own result document. The result of the validation, “result”, is the result of the pipeline. (For consistency across the step vocabulary, the standard input is usually named “source” and the standard output is usually named “result”.) </p><p>The pipeline document determines how the steps are connected together inside the pipeline, that is, how the output of one step becomes the input of another.</p><p>The pipeline document for this pipeline is shown in <a href="#ex1" title="A simple, linear XInclude/Validate pipeline">Example 1, “A simple, linear XInclude/Validate pipeline”</a>.</p><figure id="ex1" class="example-wrapper"><div class="title">Example 1. A simple, linear XInclude/Validate pipeline</div><div class="example"><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.0"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"&gt; &lt;p:pipe step="validated" port="result"/&gt; &lt;/p:output&gt; &lt;p:xinclude name="included"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="xinclude-and-validate" port="source"/&gt; &lt;/p:with-input&gt; &lt;/p:xinclude&gt; &lt;p:validate-with-xml-schema name="validated"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="included" port="result"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="schema"&gt; &lt;p:pipe step="xinclude-and-validate" port="schemas"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.1"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"&gt; &lt;p:pipe step="validated" port="result"/&gt; &lt;/p:output&gt; &lt;p:xinclude name="included"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="xinclude-and-validate" port="source"/&gt; &lt;/p:with-input&gt; &lt;/p:xinclude&gt; &lt;p:validate-with-xml-schema name="validated"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="included" port="result"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="schema"&gt; &lt;p:pipe step="xinclude-and-validate" port="schemas"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:declare-step&gt;</span></code></pre></div></figure><p><a href="#ex1" title="A simple, linear XInclude/Validate pipeline">Example 1, “A simple, linear XInclude/Validate pipeline”</a> is very verbose. It makes all of the connections seen in the figure explicit. In practice, pipelines do not have to be this verbose. By default, where inputs and outputs are connected between sequential sibling steps, they do not have to be made explicit.</p><p>The same pipeline, using XProc defaults, is shown in <a href="#ex1-abbr" title="A simple, linear XInclude/Validate pipeline (simplified)">Example 2, “A simple, linear XInclude/Validate pipeline (simplified)”</a>.</p><figure id="ex1-abbr" class="example-wrapper"><div class="title">Example 2. A simple, linear XInclude/Validate pipeline (simplified)</div><div class="example"><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.0"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"/&gt; &lt;p:xinclude/&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema"&gt; &lt;p:pipe step="xinclude-and-validate" port="schemas"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.1"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"/&gt; &lt;p:xinclude/&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema"&gt; &lt;p:pipe step="xinclude-and-validate" port="schemas"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:declare-step&gt;</span></code></pre></div></figure><p><a href="#fig-style-proc" title="A validate and transform pipeline">Figure 2, “A validate and transform pipeline”</a> is a more complex example: it performs schema validation with an appropriate schema and then styles the validated document.</p><figure id="fig-style-proc" class="figure-wrapper"><div class="figure"><div id="fig-style-proc.2" title="A validate and transform pipeline" class="mediaobject"><img src="graphics/sch-transform.png" alt="A validate and transform pipeline" /></div></div><div class="title">Figure 2. A validate and transform pipeline</div></figure><p>The heart of this example is the conditional. The “choose” step evaluates an XPath expression over a test document. Based on the result of that expression, one or another branch is run. In this example, each branch consists of a single validate step.</p><figure id="ex2" class="example-wrapper"><div class="title">Example 3. A validate and transform pipeline</div><div class="example"><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.0"&gt; &lt;p:input port="source"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"/&gt; &lt;p:choose&gt; &lt;p:when test="/*[@version &amp;lt; 2.0]"&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v1schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:when&gt; &lt;p:otherwise&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v2schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:otherwise&gt; &lt;/p:choose&gt; &lt;p:xslt&gt; &lt;p:with-input port="stylesheet" href="stylesheet.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="xinclude-and-validate" version="3.1"&gt; &lt;p:input port="source"/&gt; &lt;p:input port="schemas" sequence="true"/&gt; &lt;p:output port="result"/&gt; &lt;p:choose&gt; &lt;p:when test="/*[@version &amp;lt; 2.0]"&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v1schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:when&gt; &lt;p:otherwise&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v2schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:otherwise&gt; &lt;/p:choose&gt; &lt;p:xslt&gt; &lt;p:with-input port="stylesheet" href="stylesheet.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre></div></figure><p>This example, like the preceding, relies on XProc defaults for simplicity. It is always valid to write the fully explicit form if you prefer. This example also takes advantage of using the <code class="tag-attribute">href</code> attribute directly on <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> as a shortcut for the <a href="#p.document"><code class="tag-element">p:document</code></a> connection.</p></div></section></div></section><section id="pipeline-concepts" class="section"><div class="section-titlepage"><h2><bdi class="secno">2. </bdi>Pipeline Concepts<a aria-label="§" class="self-link" href="#pipeline-concepts"></a></h2></div><div class="content"><p><span id="dt-pipeline" class="termdef">[Definition: A <em class="glossterm">pipeline</em> is a set of connected steps, with outputs of one step flowing into inputs of another.]</span> A pipeline is itself a <em class="glossterm"><a href="#dt-step">step</a></em> and must satisfy the constraints on steps. Connections between steps occur where the input of one step is connected to the output of another. </p><p>The result of evaluating a pipeline (or <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>) is the result of evaluating the steps that it contains, in an order consistent with the connections between them. A pipeline must behave as if it evaluated each step each time it is encountered. Unless otherwise indicated, implementations <span class="rfc2119" id="pipeline-concepts.3.2">must not</span> assume that steps are functional (that is, that their outputs depend only on their <a href="#input-output">inputs</a> and <em class="glossterm"><a href="#dt-option">options</a></em>) or side-effect free.</p><p>The pattern of connections between steps will not always completely determine their order of evaluation. <span id="impl-1">The evaluation order of steps not connected to one another is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></p><section id="step-concept" class="section"><div class="section-titlepage"><h3><bdi class="secno">2.1. </bdi>Steps<a aria-label="§" class="self-link" href="#step-concept"></a></h3></div><div class="content"><p><span id="dt-step" class="termdef">[Definition: A <em class="glossterm">step</em> is the basic computational unit of a pipeline.]</span> A typical step has inputs, from which it receives documents to process, outputs, to which it sends result documents, and options which influence its behavior.</p><p>There are two kinds of steps: atomic and compound:</p><div class="itemizedlist"><ul><li><p>An atomic step is a step that performs a unit of processing on its input, such as validation or transformation, and has no internal subpipeline. Atomic steps carry out fundamental operations and can perform arbitrary amounts of computation, but they are indivisible.</p><p><span style="display: none;" class="delete_version">There are many <em>types</em> of atomic steps. The standard library of atomic steps is described in [<a><span class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span class="modify_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span></a>], but implementations <span class="rfc2119" id="step-concept.4.1.2.3">may</span> provide others as well. <span id="impl-2">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what additional step types, if any, are provided. </span> Each use, or instance, of an atomic step invokes the processing defined by that type of step. A pipeline may contain instances of many types of steps and many instances of the same type of step.</span><span style="display: none;" class="add_version">There are many <em>types</em> of atomic steps. The standard library of atomic steps is described in [<a><span class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span></a>], but implementations <span class="rfc2119" id="step-concept.4.1.2.3">may</span> provide others as well. <span id="impl-2">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what additional step types, if any, are provided. </span> Each use, or instance, of an atomic step invokes the processing defined by that type of step. A pipeline may contain instances of many types of steps and many instances of the same type of step.</span><span class="modify_version">There are many <em>types</em> of atomic steps. The standard library of atomic steps is described in [<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>], but implementations <span class="rfc2119" id="step-concept.4.1.2.3">may</span> provide others as well. <span id="impl-2">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what additional step types, if any, are provided. </span> Each use, or instance, of an atomic step invokes the processing defined by that type of step. A pipeline may contain instances of many types of steps and many instances of the same type of step.</span></p></li><li><p>Compound steps, on the other hand, control and organize the flow of documents through a pipeline, providing familiar programming language functionality such as conditionals, iterators and exception handling. They contain other steps, whose evaluation they control.</p></li></ul></div><p><span id="dt-compound-step" class="termdef">[Definition: A <em class="glossterm">compound step</em> is a step that contains one or more <em class="glossterm"><a href="#dt-subpipeline">subpipelines</a></em>.]</span> That is, a compound step differs from an atomic step in that its semantics are at least partially determined by the steps that it contains.</p><p>Compound steps either directly contain a single subpipeline or contain several subpipelines and select one or more to evaluate dynamically. In the latter case, alternate subpipelines are identified by non-step wrapper elements that each contain a single subpipeline. </p><p><span id="dt-container" class="termdef">[Definition: A <em class="glossterm">container</em> is either a compound step or one of the non-step wrapper elements in a compound step that contains several subpipelines.]</span><span id="dt-contained-steps" class="termdef">[Definition: The steps that occur directly within a container are called that step’s <em class="glossterm">contained steps</em>. In other words, “container” and “contained steps” are inverse relationships.]</span><span id="dt-ancestors" class="termdef">[Definition: The <em class="glossterm">ancestors</em> of a step, if it has any, are its <em class="glossterm"><a href="#dt-container">container</a></em> and the ancestors of its container.]</span></p><p><span id="dt-subpipeline" class="termdef">[Definition: Sibling steps and variables (and the connections between them) form a <em class="glossterm">subpipeline</em>.]</span><span id="dt-last-step" class="termdef">[Definition: The <em class="glossterm">last step</em> in a subpipeline is its last step in document order.]</span></p><p class="element-syntax element-syntax-language-construct hanging-indent"><code class="code">subpipeline</code> = (<a href="#p.variable"><code class="tag-element">p:variable</code></a>|<a href="#p.for-each"><code class="tag-element">p:for-each</code></a>|<a href="#p.viewport"><code class="tag-element">p:viewport</code></a>|<a href="#p.choose"><code class="tag-element">p:choose</code></a>|<a href="#p.if"><code class="tag-element">p:if</code></a>|<a href="#p.group"><code class="tag-element">p:group</code></a>|<a href="#p.try"><code class="tag-element">p:try</code></a>|<code class="code"><a href="#p.atomic">p:<em class="replaceable"><code>standard-step</code></em></a></code>|<code class="code"><a href="#p.atomic"><em class="replaceable"><code>pfx:user-pipeline</code></em></a></code>)+ </p><div id="note-udp" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>When a user-defined pipeline is invoked, (identified with <code class="code"><em class="replaceable"><code>pfx:user-pipeline</code></em></code> in the preceding syntax summary) it appears as an atomic step. A pipeline <em>declaration</em> may contain a subpipeline, but the <em>invocation</em> of that pipeline is atomic and does not contain a subpipeline.</p></div></div><p>Steps have “ports” into which inputs and outputs are connected. Each step has a number of input ports and a number of output ports; a step can have zero input ports and/or zero output ports. The names of all ports on each step must be unique on that step (you can't have two input ports named “source”, nor can you have an input port named “schema” and an output port named “schema”). </p><p>A step may have zero or more <a href="#options">options</a>, all with unique names.</p><section id="step-names" class="section"><div class="section-titlepage"><h4><bdi class="secno">2.1.1. </bdi>Step names<a aria-label="§" class="self-link" href="#step-names"></a></h4></div><div class="content"><p>All of the different instances of steps (atomic or compound) in a pipeline can be distinguished from one another by <em>name</em>. Names can be specified using the (optional) <code class="tag-attribute">name</code> attribute. <span class="assert" id="unique-names">A specified step name <span class="rfc2119" id="unique-names.1">must</span> be unique within its scope, see <a href="#scoping" title="Scoping of Names">Section 14.2, “Scoping of Names”</a>.</span></p><p>The main purpose of step names in a pipeline is to <em>explicitly</em> connect to port(s) of another step. This applies to <a href="#p.input"><code class="tag-element">p:input</code></a>, <a href="#p.output"><code class="tag-element">p:output</code></a>, <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>, <a href="#p.with-option"><code class="tag-element">p:with-option</code></a> and <a href="#p.variable"><code class="tag-element">p:variable</code></a>, using either a <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> child element or a <code class="tag-attribute">pipe</code> attribute.</p><p>The following example uses the step names provided by the <code class="tag-attribute">name</code> attributes to explicitly connect ports, using <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> child elements. The document on the <code class="port">extra</code> port of the step gets an additional attribute and is subsequently inserted into the document on the <code class="port">source</code> port.</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0" name="main-step"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="extra"/&gt; &lt;p:output port="result" primary="true"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}" name="add-timestamp"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main-step" port="extra"/&gt; &lt;/p:with-input&gt; &lt;/p:add-attribute&gt; &lt;p:insert match="/*" position="first-child"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main-step" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="insertion"&gt; &lt;p:pipe step="add-timestamp" port="result"/&gt; &lt;/p:with-input&gt; &lt;/p:insert&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1" name="main-step"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="extra"/&gt; &lt;p:output port="result" primary="true"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}" name="add-timestamp"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main-step" port="extra"/&gt; &lt;/p:with-input&gt; &lt;/p:add-attribute&gt; &lt;p:insert match="/*" position="first-child"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main-step" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="insertion"&gt; &lt;p:pipe step="add-timestamp" port="result"/&gt; &lt;/p:with-input&gt; &lt;/p:insert&gt; &lt;/p:declare-step&gt;</span></code></pre><p>Alternatively, using <code class="tag-attribute">pipe</code> attributes to connect the ports, you could write this as:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0" name="main-step"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="extra"/&gt; &lt;p:output port="result" primary="true"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}" name="add-timestamp"&gt; &lt;p:with-input port="source" pipe="extra@main-step"/&gt; &lt;/p:add-attribute&gt; &lt;p:insert match="/*" position="first-child"&gt; &lt;p:with-input port="source" pipe="source@main-step"/&gt; &lt;p:with-input port="insertion" pipe="result@add-timestamp"/&gt; &lt;/p:insert&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1" name="main-step"&gt; &lt;p:input port="source" primary="true"/&gt; &lt;p:input port="extra"/&gt; &lt;p:output port="result" primary="true"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}" name="add-timestamp"&gt; &lt;p:with-input port="source" pipe="extra@main-step"/&gt; &lt;/p:add-attribute&gt; &lt;p:insert match="/*" position="first-child"&gt; &lt;p:with-input port="source" pipe="source@main-step"/&gt; &lt;p:with-input port="insertion" pipe="result@add-timestamp"/&gt; &lt;/p:insert&gt; &lt;/p:declare-step&gt;</span></code></pre><p>If the pipeline author does not provide an explicit name using the <code class="tag-attribute">name</code> attribute, the processor manufactures a default name. All default names are of the form “<code class="literal">!1</code><em class="replaceable"><code>.m</code></em><em class="replaceable"><code>.n</code></em>…” where “<em class="replaceable"><code>m</code></em>” is the position (in the sense of counting sibling elements) of the step’s highest ancestor element within the pipeline document or library which contains it, “<em class="replaceable"><code>n</code></em>” is the position of the next-highest ancestor, and so on, including all of the elements in the pipeline document (that were not <em class="glossterm"><a href="#dt-effectively-excluded">effectively excluded</a></em>). For example, consider the pipeline in <a href="#ex2" title="A validate and transform pipeline">Example 3, “A validate and transform pipeline”</a>. The <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> step has no name, so it gets the default name “<code class="literal">!1</code>”; the <a href="#p.choose"><code class="tag-element">p:choose</code></a> gets the name “<code class="literal">!1.1</code>”; the first <a href="#p.when"><code class="tag-element">p:when</code></a> gets the name “<code class="literal">!1.1.1</code>”; the <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> gets the name “<code class="literal">!1.1.2</code>”, etc. If the <a href="#p.choose"><code class="tag-element">p:choose</code></a> had a name, it would not have received a default name, but it would still have been counted and its first <a href="#p.when"><code class="tag-element">p:when</code></a> would still have been “<code class="literal">!1.1.1</code>”.</p><p>Providing every step in the pipeline with an interoperable name has several benefits:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>It allows implementers to refer to all steps in an interoperable fashion, for example, in error messages.</p></li><li><p>Pragmatically, we say that <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> are identified by a step name/port name pair. By manufacturing names for otherwise anonymous steps, we include implicit connections without changing our model.</p></li></ol></div><p>In a valid pipeline that runs successfully to completion, the manufactured names aren't visible (except perhaps in debugging or logging output).</p><div id="def-name-ncname" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>The format for defaulted names does not conform to the requirements of an <a href="http://www.w3.org/TR/xml-names/#NT-NCName">NCName</a>. This is an explicit design decision; it prevents pipelines from using the defaulted names on <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> elements. If an explicit connection requires a step name, the pipeline author must name the step. </p></div></div></div></section><section id="step-types" class="section"><div class="section-titlepage"><h4><bdi class="secno">2.1.2. </bdi>Step types<a aria-label="§" class="self-link" href="#step-types"></a></h4></div><div class="content"><p>A step can have a <em>type</em>. Step types are specified using the <code class="tag-attribute">type</code> attribute of the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> element. Step types are used as the name of the element by which the step is invoked. <span class="assert" id="unique-types">A specified step type <span class="rfc2119" id="unique-types.1">must</span> be unique within its scope, see <a href="#scoping" title="Scoping of Names">Section 14.2, “Scoping of Names”</a>.</span></p><p>Step types are QNames and <span class="rfc2119" id="step-types.3.1">must</span> be in namespace with a non-null namespace URI. Steps in the XProc standard and additional step libraries all have types in the XProc namespace: <code class="code">http://www.w3.org/ns/xproc</code>. When providing your own steps with a type, which is necessary to use/invoke them in another step, a different (non-null) namespace must be used.</p><p>Step types play an important role in the modularization of pipelines. They allow steps to be re-used. The following example defines a local step with type <code class="code">mysteps:add-timestamp-attribute</code> and subsequently uses this twice somewhere inside its main step’s pipeline: </p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:declare-step type="mysteps:add-timestamp-attribute"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:declare-step type="mysteps:add-timestamp-attribute"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;/p:declare-step&gt;</span></code></pre><p>Another way of doing this would be to isolate the <code class="code">mysteps:add-timestamp-attribute</code> step as a separate, stand-alone, pipeline:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step type="mysteps:add-timestamp-attribute" version="3.0" xmlns:p="http://www.w3.org/ns/xproc" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step type="mysteps:add-timestamp-attribute" version="3.1" xmlns:p="http://www.w3.org/ns/xproc" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt;</span></code></pre><p>Assuming this is stored in a file called <code class="code">add-timestamp-attribute.xpl</code>, you can now use the <a href="#p.import"><code class="tag-element">p:import</code></a> element to get it on board:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:import href="add-timestamp-attribute.xpl"/&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:import href="add-timestamp-attribute.xpl"/&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; ... &lt;mysteps:add-timestamp-attribute/&gt; ... &lt;/p:declare-step&gt;</span></code></pre><p>Yet another way of achieving the same result would be to add the <code class="code">mysteps:add-timestamp-attribute</code> step to an XProc <em>library</em>, using the <a href="#p.library"><code class="tag-element">p:library</code></a> root element:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:library version="3.0" xmlns:p="http://www.w3.org/ns/xproc" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:declare-step type="mysteps:add-timestamp-attribute"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt; ... more library steps &lt;/p:library&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:library version="3.1" xmlns:p="http://www.w3.org/ns/xproc" xmlns:mysteps="http://.../ns/mysteps"&gt; &lt;p:declare-step type="mysteps:add-timestamp-attribute"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:add-attribute attribute-name="timestamp" attribute-value="{current-dateTime()}"/&gt; &lt;/p:declare-step&gt; ... more library steps &lt;/p:library&gt;</span></code></pre><p>Importing a library is also done with the <a href="#p.import"><code class="tag-element">p:import</code></a> element. </p></div></section></div></section></div></section><section id="documents" class="section"><div class="section-titlepage"><h2><bdi class="secno">3. </bdi>Documents<a aria-label="§" class="self-link" href="#documents"></a></h2></div><div class="content"><p>An XProc pipeline processes documents. <span id="dt-document" class="termdef">[Definition: A <em class="glossterm">document</em> is a <em class="glossterm"><a href="#dt-representation">representation</a></em> and its <em class="glossterm"><a href="#dt-document-properties">document properties</a></em>.]</span>. <span id="dt-representation" class="termdef">[Definition: A <em class="glossterm">representation</em> is a data structure used by an XProc processor to refer to the actual document content.]</span></p><p>An output port may have several connections. In this case the document(s) that appear on that port are sent to each of the connections. In principle, a distinct copy of each document is sent to each connection. Critically, any changes made to one copy <span class="rfc2119" id="documents.3.1">must not</span> be visible in any other copy. In the interest of efficiency, if an implementation can isolate such changes, it is not required to make actual copies. </p><section id="document-properties" class="section"><div class="section-titlepage"><h3><bdi class="secno">3.1. </bdi>Document Properties<a aria-label="§" class="self-link" href="#document-properties"></a></h3></div><div class="content"><p>Documents have associated with them a set of properties. <span id="dt-document-properties" class="termdef">[Definition: The <em class="glossterm">document properties</em> are key/value pairs; they are exposed to the XProc pipeline as a map (<code class="type">map(xs:QName, item()*)</code>).]</span></p><p>Several properties are defined by this specification:</p><div class="variablelist"><dl><dt><span class="term"><code class="code">content-type</code></span></dt><dd><p>The value of the “<code class="code">content-type</code>” property identifies the media type ([<a href="#rfc2046"><span class="abbrev">RFC 2046</span></a>]) of the representation. The “<code class="code">content-type</code>” <span class="rfc2119" id="document-properties.4.1.2.1.4">must</span> always be present. The processor is responsible for assuring that the <code class="code">content-type</code> property matches the content type of each document produced on every output port.</p></dd><dt><span class="term"><code class="code">base-uri</code></span></dt><dd><p>The value of the “<code class="code">base-uri</code>” property identifies the base URI of the document; it will only be present if the document has a base URI. For XML documents, HTML documents, and text documents, the value of “<code class="code">base-uri</code>” is the base URI property of the document node. For other document types it is a property the processor keeps track of. If no such key is present, the document has no base URI.</p></dd><dt><span class="term"><code class="code">serialization</code></span></dt><dd><p>The value of the (optional) “<code class="code">serialization</code>” property holds serialization properties for the document. If present, it’s value <span class="rfc2119" id="document-properties.4.3.2.1.2">must</span> be of type <code class="type">map(xs:QName, item()*)</code>. <a id="err.inline.D0070"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0070"><code class="errqname">err:XD0070</code></a>) if a value is assigned to the <code class="code">serialization</code> document property that cannot be converted into <code class="type">map(xs:QName, item()*)</code> according to the rules in <a href="#implicit-casting">Implicit Casting</a>. Serialization properties control XML serialization as defined by [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>]. See also <a href="#serialization" title="Serialization parameters">Section 16.3.1, “Serialization parameters”</a>. </p><p>Some steps, like <code class="code">p:xslt</code> and <code class="code">p:xquery</code>, can specify serialization properties (for instance using an XSLT <code class="tag-element">xsl:output</code> element). If this is the case, the specified serialization properties <span class="rfc2119" id="document-properties.4.3.2.2.4">should</span> be returned in the result document(s) <code class="code">serialization</code> property, as an appropriate serialization properties map.</p><p><span style="display: none;" class="delete_version">If a step serializes a document whose document properties contain a <code class="code">serialization</code> property, it <span class="rfc2119" id="document-properties.4.3.2.3.2">must</span> use these serialization properties. If the step itself allows specification of serialization properties (usually by a <code class="option">serialization</code> option), both sets of serialization properties are merged. Serialization properties specified on the step itself have precedence over serialization properties specified with the <code class="code">serialization</code> document property.</span><span style="display: none;" class="add_version">If a step serializes a document whose document properties contain a <code class="code">serialization</code> property, it <span class="rfc2119" id="document-properties.4.3.2.3.2">must</span> use these serialization properties. If the step itself allows specification of serialization properties (usually by a <code class="option">serialization</code> option), the serialization properties are merged. Serialization properties specified on the document have precedence over serialization properties specified on the step. See <a href="#managing-properties" title="Managing properties">Section 3.1.1, “Managing properties”</a>.</span><span class="modify_version">If a step serializes a document whose document properties contain a <code class="code">serialization</code> property, it <span class="rfc2119" id="document-properties.4.3.2.3.2">must</span> use these serialization properties. If the step itself allows specification of serialization properties (usually by a <code class="option">serialization</code> option), <span class="deltaxml-old" style="background:#FF5555">both sets of</span><span class="deltaxml-new" style="background:#90EE90">the</span> serialization properties are merged. Serialization properties specified on the <span class="deltaxml-old" style="background:#FF5555">step itself</span><span class="deltaxml-new" style="background:#90EE90">document</span> have precedence over serialization properties specified <span class="deltaxml-old" style="background:#FF5555">with</span><span class="deltaxml-new" style="background:#90EE90">on</span> the <span class="deltaxml-old" style="background:#FF5555">serialization</span><span class="deltaxml-new" style="background:#90EE90">step</span><span class="deltaxml-old" style="background:#FF5555"> document property</span><span class="deltaxml-new" style="background:#90EE90">. See </span><a href="#managing-properties" title="Managing properties"><span class="deltaxml-new" style="background:#90EE90">Section 3.1.1, “Managing properties”</span></a>.</span></p></dd></dl></div><p>Other property keys may also be present, including user defined properties.</p><p>Steps are responsible for describing how document properties are transformed as documents flow through them. Many steps claim that the specified properties are preserved. Generally, it is the responsibility of the pipeline author to determine when this is inappropriate and take corrective action. However, it is the responsibility of the pipeline processor to assure that the <code class="code">content-type</code> property is correct. If a step transforms a document in a manner that is inconsistent with the <code class="code">content-type</code> property (accepting an XML document on the source port but producing a text document on the result, for example), the processor must assure that the <code class="code">content-type</code> property is appropriate. If a step changes the <code class="code">content-type</code> in this way, it <span class="rfc2119" id="document-properties.6.5">must</span> also remove the <code class="code">serialization</code> property.</p><section id="managing-properties" class="section"><div class="section-titlepage"><h4><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">3.1.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Managing properties</span><a aria-label="§" class="self-link" href="#managing-properties"></a></h4></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">In XProc 3.0, the rules for merging serialization properties stated that the properties on the step took precedence. In practice, all of the steps with a </span><code class="option"><span class="deltaxml-new" style="background:#90EE90">serialization</span></code><span class="deltaxml-new" style="background:#90EE90"> option explicitly stated the opposite. This inconsistency was confusing. Changing the behavior of the steps would likely break many existing pipelines, so the merging behavior has been changed in this specification instead.</span></p><p><span class="deltaxml-new" style="background:#90EE90">A pipeline author who wants to explicitly override all the serialization properites for a document can easily do so with </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:set-properties</span></code><span class="deltaxml-new" style="background:#90EE90"> before the step where they want the override to apply.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Explicitly overriding only </span><em><span class="deltaxml-new" style="background:#90EE90">some</span></em><span class="deltaxml-new" style="background:#90EE90"> properties is also possible, but somewhat more complicated. The following </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:set-attributes</span></code><span class="deltaxml-new" style="background:#90EE90"> example removes only the </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">indent</span></code><span class="deltaxml-new" style="background:#90EE90"> property from a document’s serialization properties, leaving all other properties intact:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:set-properties xmlns:map="http://www.w3.org/2005/xpath-functions/map" xmlns:xs="http://www.w3.org/2001/XMLSchema" properties=" map{'serialization': map:remove(map:get(p:document-properties(.), xs:QName('serialization')), xs:QName('indent'))}"/&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">Any property or set of properties can be removed or updated in this way.</span></p></div></section></div></section><section id="document-types" class="section"><div class="section-titlepage"><h3><bdi class="secno">3.2. </bdi>Document Types<a aria-label="§" class="self-link" href="#document-types"></a></h3></div><div class="content"><p>XProc <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> has been designed to make it possible to process any kind of document. Each document has a representation in the [<a href="#xpath-datamodel"><span class="abbrev">XQuery and XPath Data Model 3.1</span></a>]. This is necessary so that any kind of document can be passed as an argument to XPath functions, such as <a href="#f.document-properties"><code class="function">p:document-properties</code></a>. Practically speaking, there are five kinds of documents:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p><a href="#xml-documents">XML documents</a></p></li><li><p><a href="#html-documents">HTML documents</a></p></li><li><p><a href="#text-documents">Text documents</a></p></li><li><p><a href="#json-documents">JSON documents</a></p></li><li><p><a href="#other-documents">Other documents</a></p></li></ol></div><section id="xml-documents" class="section"><div class="section-titlepage"><h4><bdi class="secno">3.2.1. </bdi>XML Documents<a aria-label="§" class="self-link" href="#xml-documents"></a></h4></div><div class="content"><p>Representations of XML documents are general instances of the XDM. They are documents that contain a mixture of other node types (elements, text, comments, and processing instructions). This definition is intentionally broader than the definition of a well-formed XML document because it is often convenient for intermediate stages in a pipeline to produce more-or-less arbitrary fragments of XML that can be combined together by later stages. XML documents are identified by an XML media type. <span id="dt-XML-media-type" class="termdef">[Definition: The “<code class="literal">application/xml</code>” and “<code class="literal">text/xml</code>” media types and all media types of the form “<code class="literal"><em class="replaceable"><code>something</code></em>/<em class="replaceable"><code>something</code></em>+xml</code>” (except for “<code class="literal">application/xhtml+xml</code>” which is explicitly an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>) are <em class="glossterm">XML media types</em>. ]</span></p><p>In order to be consistent with the XPath data model, all general and external parsed entities <span class="rfc2119" id="xml-documents.3.1">must</span> be fully expanded in XML documents; they <span class="rfc2119" id="xml-documents.3.2">must not</span> contain any representation of [<a href="#xml-infoset-rec"><span class="abbrev">Infoset</span></a>] <code class="literal infoset-property">[unexpanded entity reference information items]</code>.</p><p><span id="impl-3">The level of support for typed values in XDM instances in an XProc pipeline is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></p><p>When an XML document is serialized, it <span class="rfc2119" id="xml-documents.5.1">should</span> be serialized using the XML serializer (see [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>]) by default. </p></div></section><section id="html-documents" class="section"><div class="section-titlepage"><h4><bdi class="secno">3.2.2. </bdi>HTML Documents<a aria-label="§" class="self-link" href="#html-documents"></a></h4></div><div class="content"><p>Representations of HTML documents are general instances of the XDM. Within XProc, they are <a href="#xml-documents">XML documents</a>. HTML documents are identified by an HTML media type. <span id="dt-HTML-media-type" class="termdef">[Definition: The “<code class="literal">text/html</code>” and “<code class="literal">application/xhtml+xml</code>” media types are <em class="glossterm">HTML media types</em>. ]</span></p><p>The distinction between XML documents and HTML documents is apparent in two places:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>When an HTML document is <em>parsed</em>, for example when it is the result of querying a web service or is loaded from a file on disk, an HTML parser <span class="rfc2119" id="html-documents.4.1.1.2">must</span> be used. An HTML parser will construct a balanced tree even if the HTML document would not be seen as well-formed XML if it was parsed by an XML parser. An HTML parser may also add elements not found in the original (for example table body elements inside tables). </p><div id="inline-html" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>The HTML parsing rules only apply when the content is parsed. HTML content in an unencoded <a href="#p.inline"><code class="tag-element">p:inline</code></a> must be well-formed XML (because it is literally in the pipeline) and will not be transformed in any way.</p></div></div></li><li><p>When an HTML document is serialized, it <span class="rfc2119" id="html-documents.4.2.1.1">should</span> be serialized using the HTML serializer for documents with media type “<code class="literal">text/html</code>” and the XHTML serializer for those with media type “<code class="literal">application/xhtml+xml</code>” (see [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>]) by default. </p></li></ol></div></div></section><section id="text-documents" class="section"><div class="section-titlepage"><h4><bdi class="secno">3.2.3. </bdi>Text Documents<a aria-label="§" class="self-link" href="#text-documents"></a></h4></div><div class="content"><p>Text documents are identified by a text media type. <span id="dt-text-media-type" class="termdef">[Definition: Media types of the form “<code class="literal">text/<em class="replaceable"><code>something</code></em></code>” are <em class="glossterm">text media types</em> with the exception of “<code class="literal">text/xml</code>” which is an XML media type, and “<code class="literal">text/html</code>” which is an HTML media type. Additionally the media types “<code class="literal">application/javascript</code>”, “<code class="literal">application/relax-ng-compact-syntax</code>”, and “<code class="literal">application/xquery</code>” are also text media types. ]</span><span id="impl-4">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether other media types not mentioned in this document are treated as text media types as well.</span> A text document is represented by a document node containing a single text node or by an empty document node (for empty text documents). </p><p>When a text document is serialized, it <span class="rfc2119" id="text-documents.3.1">should</span> be serialized using the Text serializer (see [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>]) by default.</p></div></section><section id="json-documents" class="section"><div class="section-titlepage"><h4><bdi class="secno">3.2.4. </bdi>JSON Documents<a aria-label="§" class="self-link" href="#json-documents"></a></h4></div><div class="content"><p>Representations of JSON documents are instances of the XDM. They are maps, arrays, or atomic values. JSON documents are identified by a JSON media type. <span id="dt-JSON-media-type" class="termdef">[Definition: The “<code class="literal">application/json</code>” media type and all media types of the form “<code class="literal">application/<em class="replaceable"><code>something</code></em>+json</code>” are <em class="glossterm">JSON media types</em>. ]</span></p><p>When a JSON document is serialized, it <span class="rfc2119" id="json-documents.3.1">should</span> be serialized using the JSON serializer (see [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>]) by default.</p></div></section><section id="other-documents" class="section"><div class="section-titlepage"><h4><bdi class="secno">3.2.5. </bdi>Other documents<a aria-label="§" class="self-link" href="#other-documents"></a></h4></div><div class="content"><p>Representations of other kinds of documents are empty XDM documents. <span id="impl-5">The <em>underlying</em> representations of other kinds of documents are <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span> Other kinds of documents are identified by media types that are not <em class="glossterm"><a href="#dt-XML-media-type">XML media types</a></em>, <em class="glossterm"><a href="#dt-HTML-media-type">HTML media types</a></em>, <em class="glossterm"><a href="#dt-text-media-type">text media types</a></em>, or <em class="glossterm"><a href="#dt-JSON-media-type">JSON media types</a></em>. </p><p><span id="impl-6">Serialization of other kinds of documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> The stored sequence of octets <span class="rfc2119" id="other-documents.3.2">should</span> be consistent with the media type: an <code class="code">image/png</code> image should be a PNG image, etc. </p></div></section></div></section><section id="creating-documents-from-xdm-step-results" class="section"><div class="section-titlepage"><h3><bdi class="secno">3.3. </bdi>Creating documents from XDM step results<a aria-label="§" class="self-link" href="#creating-documents-from-xdm-step-results"></a></h3></div><div class="content"><p>Some steps like <code class="tag-element">p:xslt</code>, <code class="tag-element">p:xquery</code> etc. create a sequence of new XDM instances. The same is true for the result of a <code class="code">select</code> expression on <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. Values in such a sequence can be of any XDM type (except attribute or function). Every item in such a sequence is converted into a <em>separate</em> document that will appear on the output port of that particular step or as the result of the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. The following rules apply to each of the items in the output sequence:</p><div class="itemizedlist"><ul><li><p>If the item is a text node, it is wrapped in a document node and the document’s content-type is <code class="literal">text/plain</code>.</p></li><li><p>If the item is an element, comment or processing-instruction node, a document node is wrapped around the node and the document’s content-type is set to <code class="literal">application/xml</code>.</p></li><li><p>If the item is a document node, content-type "application/xml" is used.</p></li><li><p>If the item is a <code class="code">map</code>, <code class="code">array</code> or any atomic value, content-type <code class="literal">application/json</code> is used.</p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>Setting the content-type to <code class="literal">application/json</code> for <em>any</em> map, array or atomic value means that a document with content-type <code class="literal">application/json</code> is <em>not</em> guaranteed serializable using the <code class="code">json</code> serialization method. For instance, a map with values that contain sequences cannot be serialized.</p></div></div></li></ul></div></div></section><section id="specified-content-types" class="section"><div class="section-titlepage"><h3><bdi class="secno">3.4. </bdi>Specifying content types<a aria-label="§" class="self-link" href="#specified-content-types"></a></h3></div><div class="content"><p>In some contexts (step inputs, and step outputs, for example), XProc allows the pipeline author to specify a list of content types to identify what kinds of documents are allowed. Each content type in this list must have one of the following forms:</p><div class="itemizedlist"><ul><li><p>A fully qualified type of the form “<code class="literal"><em class="replaceable"><code>type</code></em>/<em class="replaceable"><code>subtype</code></em>+<em class="replaceable"><code>ext</code></em></code>” where “<code class="literal">+<em class="replaceable"><code>ext</code></em></code>” is optional and any of <em class="replaceable"><code>type</code></em>, <em class="replaceable"><code>subtype</code></em>, and <em class="replaceable"><code>ext</code></em> can be specified as “<code class="literal">*</code>” meaning “any”. For example: <code class="literal">text/plain</code> (only plain text documents), <code class="literal">text/*</code> (any “text” content type), <code class="literal">*/*+xml</code> (any “+xml” content type), and <code class="literal">*/*</code> (any content type). </p></li><li><p>A fully qualified type preceded by a minus sign (“-”) indicates that the specified type is forbidden. For example: <code class="literal">-image/svg</code> forbids SVG images, <code class="literal">-text/*</code> forbids “text” content types, and <code class="literal">-text/html</code> forbids HTML documents. </p></li><li><p>A single token (without a “/”), is considered a shortcut form. The following shortcuts <span class="rfc2119" id="specified-content-types.3.3.1.1">must</span> be supported by the processor:</p><div class="variablelist"><dl><dt><span class="term"><code class="literal">xml</code></span></dt><dd><p>Expands to “<code class="literal">application/xml text/xml */*+xml -application/xhtml+xml</code>”. </p></dd><dt><span class="term"><code class="literal">html</code></span></dt><dd><p>Expands to “<code class="literal">text/html application/xhtml+xml</code>”. </p></dd><dt><span class="term"><code class="literal">text</code></span></dt><dd><p>Expands to: “<code class="literal">text/* -text/html -text/xml</code>”. </p></dd><dt><span class="term"><code class="literal">json</code></span></dt><dd><p>Expands to “<code class="literal">application/json</code>”. </p></dd><dt><span class="term"><code class="literal">any</code></span></dt><dd><p>Expands to “<code class="literal">*/*</code>”. </p></dd></dl></div></li><li class="add_version" style="display: none;"><p>A shortcut form preceded by a minus sign (“-”) indicates that the specified types are forbidden. When expanding a negated shortcut, any forbidden types in the expansion are ignored. In other words, <code class="literal">-xml</code> expands to “<code class="literal">-application/xml -text/xml -*/*+xml</code>”, the exclusion on HTML documents is ignored.</p></li><li class="modify_version"><p><span class="deltaxml-new" style="background:#90EE90">A shortcut form preceded by a minus sign (“-”) indicates that the specified types are forbidden. When expanding a negated shortcut, any forbidden types in the expansion are ignored. In other words, </span><code class="literal"><span class="deltaxml-new" style="background:#90EE90">-xml</span></code><span class="deltaxml-new" style="background:#90EE90"> expands to “</span><code class="literal"><span class="deltaxml-new" style="background:#90EE90">-application/xml -text/xml -*/*+xml</span></code><span class="deltaxml-new" style="background:#90EE90">”, the exclusion on HTML documents is ignored.</span></p></li></ul></div><p><a id="err.inline.D0079"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0079"><code class="errqname">err:XD0079</code></a>) if a supplied content-type is not a valid media type of the form “<code class="literal"><em class="replaceable"><code>type</code></em>/<em class="replaceable"><code>subtype</code></em>+<em class="replaceable"><code>ext</code></em></code>” or “<code class="literal"><em class="replaceable"><code>type</code></em>/<em class="replaceable"><code>subtype</code></em></code>”. <span id="impl-7">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if a processor accepts any other content type shortcuts.</span><a id="err.inline.S0111"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0111"><code class="errqname">err:XS0111</code></a>) if an unrecognized content type shortcut is specified. </p><p>To determine if a document is acceptable, the (expanded) list of content types is considered from left to right. If the actual content type matches an acceptable content type, the document is acceptable. If it matches a forbidden content type, then it is not. A content type that isn’t matched is ignored. The document is considered acceptable if and only if it matches at least one acceptable content type and the last content type that matched was not forbidden.</p><p>For example: a document with the content type “<code class="literal">image/svg</code>” is acceptable if the content type list expands to “<code class="literal">image/* application/xml</code>” but it is not acceptable if the content type list expands to “<code class="literal">image/* -image/svg</code>”. (Note that order matters; the document would be considered acceptable if the content type list expands to “<code class="literal">-image/svg image/*</code>”.) </p><p>In the particular case of shortcut values, note that “<code class="literal">application/xhtml+xml</code>” is acceptable if the content type list is “<code class="literal">xml html</code>” but not if it is “<code class="literal">html xml</code>”.</p><p><a id="err.inline.D0038"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0038"><code class="errqname">err:XD0038</code></a>) if an input document arrives on a port and it does not match the allowed content types.</p></div></section></div></section><section id="input-output" class="section"><div class="section-titlepage"><h2><bdi class="secno">4. </bdi>Inputs and Outputs<a aria-label="§" class="self-link" href="#input-output"></a></h2></div><div class="content"><p>Most steps have one or more inputs and one or more outputs. <a href="#fig-atomic-step" title="An atomic step">Figure 3, “An atomic step”</a> illustrates symbolically an <em class="glossterm"><a href="#dt-atomic-step">atomic step</a></em> with two inputs and one output.</p><figure id="fig-atomic-step" class="figure-wrapper"><div class="figure"><div id="fig-atomic-step.2" title="An atomic step with two inputs and one output" class="mediaobject"><img src="graphics/atomic-step.png" alt="An atomic step with two inputs and one output" /></div></div><div class="title">Figure 3. An atomic step</div></figure><p>All atomic steps are defined by a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>. The declaration of an atomic step type defines the input ports, output ports, and options of all steps of that type. For example, every <code class="tag-element">p:validate-with-xml-schema</code> step has two inputs, named “<code class="literal">source</code>” and “<code class="literal">schema</code>”, one output named “<code class="literal">result</code>”, and the same set of options. </p><p>Like atomic steps, top level, user-defined pipelines also have declarations.</p><p>The situation is slightly more complicated for the other compound steps because they don't have separate declarations; each instance of the compound step serves as its own declaration. On these compound steps, the number and names of the outputs can be different on each instance of the step.</p><p><a href="#fig-compound-step" title="A compound step">Figure 4, “A compound step”</a> illustrates symbolically a compound step with a subpipeline with one output. As you can see from the diagram, the output from the compound step comes from one of the outputs of the subpipeline within the step.</p><figure id="fig-compound-step" class="figure-wrapper"><div class="figure"><div id="fig-compound-step.2" title="A compound step with two inputs and one output" class="mediaobject"><img src="graphics/compound-step.png" alt="A compound step with two inputs and one output" /></div></div><div class="title">Figure 4. A compound step</div></figure><p><span id="dt-declared-inputs" class="termdef">[Definition: The input ports declared on a step are its <em class="glossterm">declared inputs</em>.]</span><span id="dt-declared-outputs" class="termdef">[Definition: The output ports declared on a step are its <em class="glossterm">declared outputs</em>.]</span> When a step is used in a pipeline, it is connected to other steps through its inputs and outputs. </p><p><span id="dt-anonymous-input" class="termdef">[Definition: The <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em><a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> each declare a single primary input without a port name. Such an input is called an <em class="glossterm">anonymous input</em>.]</span></p><p>When a step is used, all of the <em class="glossterm"><a href="#dt-declared-inputs">declared inputs</a></em> of the step <span class="rfc2119" id="input-output.11.2">must</span> be connected. Each connection binds the input to a data source (see <a href="#connections" title="Connections">Section 6, “Connections”</a>). <a id="err.inline.S0003"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0003"><code class="errqname">err:XS0003</code></a>) if any declared input is not connected.</p><p>The <em class="glossterm"><a href="#dt-declared-outputs">declared outputs</a></em> of a step are only connected when they are used by another step or expression. Any documents produced on an unconnected output port are discarded.</p><p>Primary input and primary output ports may be implicitly connected if no explicit connection is given, see <a href="#primary-input-output" title="Primary Inputs and Outputs">Section 5, “Primary Inputs and Outputs”</a>.</p><p>Output ports on compound steps have a dual nature: from the perspective of the compound step’s siblings, its outputs are just ordinary outputs and can be connected the same as other <em class="glossterm"><a href="#dt-declared-outputs">declared outputs</a></em>. From the perspective of the subpipeline inside the compound step, they behave like inputs and can be connected just like other inputs.</p><p>Within a compound step, the <em class="glossterm"><a href="#dt-declared-outputs">declared outputs</a></em> of the step can be connected to any of the various available outputs of <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> as well as other data sources (see <a href="#connections" title="Connections">Section 6, “Connections”</a>). If a (non-primary) output port of a compound step is left unconnected, it produces an empty sequence of documents from the perspective of its siblings.</p><p>Each input and output on a step is declared to accept or produce either a single document or a sequence of documents. It <em>is not</em> an error to connect a port that is declared to produce a sequence of documents to a port that is declared to accept only a single document. It is, however, an error if the former step does not produce exactly one document at run time.</p><p>It is also not an error to connect a port that is declared to produce a single document to a port that is declared to accept a sequence. A single document is the same as a sequence of one document.</p><p>An output port may have more than one connection: it may be connected to more than one input port, more than one of its container’s output ports, or both. At runtime this will result in the outputs being sent to each of those places.</p><p><span id="dt-signature" class="termdef">[Definition: The <em class="glossterm">signature</em> of a step is the set of inputs, outputs, and options that it is declared to accept.]</span> The declaration for a step provides a fixed signature which all its instances share.</p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>Within the context of what can be defined by XProc pipelines, step signatures are fixed and shared by all instances. There is no mechanism for a pipeline author to declare that an atomic step has a signature that varies. However, implementors may provide such mechanisms and other specifications may depend upon them. Such steps are “magic” and XProc <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> makes no effort to provide a mechanism to define them.</p></div></div><p><span id="dt-matches" class="termdef">[Definition: A step <em class="glossterm">matches</em> its signature if and only if it specifies an input for each declared input, it specifies no inputs that are not declared, it specifies an option for each option that is declared to be required, and it specifies no options that are not declared.]</span> In other words, every input and required option <span class="rfc2119" id="input-output.21.2">must</span> be specified and only inputs and options that are declared <span class="rfc2119" id="input-output.21.3">may</span> be specified. Options that aren't required do not have to be specified.</p><p>Steps <span class="rfc2119" id="input-output.22.1">may</span> also produce error, warning, and informative messages. These messages are captured and provided on the <code class="port">error</code> port inside of a <a href="#p.catch"><code class="tag-element">p:catch</code></a>. <span id="impl-8">Outside of a <a href="#p.try">try/catch</a>, the disposition of error messages is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em></span>. </p><p><span id="impl-9">How inputs are connected to documents outside the pipeline is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></p><p><span id="impl-10">How pipeline outputs are connected to documents outside the pipeline is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></p><p>Input ports <span class="rfc2119" id="input-output.25.1">may</span> specify a content type, or list of content types, that they accept, see <a href="#specified-content-types" title="Specifying content types">Section 3.4, “Specifying content types”</a>.</p><section id="external-docs" class="section"><div class="section-titlepage"><h3><bdi class="secno">4.1. </bdi>External Documents<a aria-label="§" class="self-link" href="#external-docs"></a></h3></div><div class="content"><p>It’s common for some of the documents used in processing a pipeline to be read from URIs. Sometimes this occurs directly, for example with a <a href="#p.document"><code class="tag-element">p:document</code></a> element. Sometimes it occurs indirectly, for example if an implementation allows the URI of a pipeline input to be specified on the command line or if an <code class="tag-element">p:xslt</code> step encounters an <code class="tag-element">xsl:import</code> in the stylesheet that it is processing. It’s also common for some of the documents produced in processing a pipeline to be written to locations which have, or at least could have, a URI. </p><p>The process of dereferencing a URI to retrieve a document is often more interesting than it seems at first. On the web, it may involve caches, proxies, and various forms of indirection. <span id="impl-11">Resolving a URI locally may involve resolvers of various sorts and possibly appeal to <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> mechanisms such as catalog files.</span></p><p>In XProc, the situation is made even more interesting by the fact that many intermediate results produced by steps in the pipeline have base URIs. <span id="impl-12">Whether (and when and how) or not the intermediate results that pass between steps are ever written to a filesystem is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></p><p><span style="display: none;" class="delete_version"><span id="impl-13">In Version 3.0 of XProc, how (or if) implementers provide local resolution mechanisms and how (or if) they provide access to intermediate results by URI is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-13">In Version 3.1 of XProc, how (or if) implementers provide local resolution mechanisms and how (or if) they provide access to intermediate results by URI is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-13">In Version <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> of XProc, how (or if) implementers provide local resolution mechanisms and how (or if) they provide access to intermediate results by URI is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>Version <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> of XProc does not require implementations to guarantee that multiple attempts to dereference the same URI always produce the same results.</p><div id="note-unsatisfying" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>On the one hand, this is a somewhat unsatisfying state of affairs because it leaves room for interoperability problems. On the other, it is not expected to cause such problems very often in practice. </p><p>If these problems arise in practice, implementers are encouraged to use the existing extension mechanisms to give users the control needed to circumvent them. Should such mechanisms become widespread, a standard mechanism could be added in some future version of the language.</p></div></div></div></section></div></section><section id="primary-input-output" class="section"><div class="section-titlepage"><h2><bdi class="secno">5. </bdi>Primary Inputs and Outputs<a aria-label="§" class="self-link" href="#primary-input-output"></a></h2></div><div class="content"><p>Each step may have one input port designated as the primary input port and one output port designated as the primary output port.</p><p><span id="dt-primary-input-port" class="termdef">[Definition: If a step has an input port which is explicitly marked “<code class="code">primary='true'</code>”, or if it has exactly one document input port and that port is <em>not</em> explicitly marked “<code class="code">primary='false'</code>”, then that input port is the <em class="glossterm">primary input port</em> of the step.]</span> If a step has a single input port and that port is explicitly marked “<code class="code">primary='false'</code>”, or if a step has more than one input port and none is explicitly marked as the primary, then the primary input port of that step is undefined. A step can have at most one primary input port.</p><p><span id="dt-primary-output-port" class="termdef">[Definition: If a step has an output port which is explicitly marked “<code class="code">primary='true'</code>”, or if it has exactly one document output port and that port is <em>not</em> explicitly marked “<code class="code">primary='false'</code>”, then that output port is the <em class="glossterm">primary output port</em> of the step.]</span> If a step has a single output port and that port is explicitly marked “<code class="code">primary='false'</code>”, or if a step has more than one output port and none is explicitly marked as the primary, then the primary output port of that step is undefined. A step can have at most one primary output port.</p><p>The special significance of primary input and output ports is that they are connected automatically by the processor if no explicit connection is given. Generally speaking, if two steps appear sequentially in a subpipeline, then the primary output of the first step will automatically be connected to the primary input of the second.</p><p>Additionally, if a container, that can have declared outputs, has no declared outputs and the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in its subpipeline has an unconnected primary output, then an implicit primary output port will be added to the compound step (and consequently the last step’s primary output will be connected to it). This implicit output port has no name. It inherits the <code class="tag-attribute">sequence</code> and the <code class="tag-attribute">content-types</code> properties of the port connected to it. This rule does not apply to <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>; step declarations must provide explicit names for all of their outputs.</p></div></section><section id="connections" class="section"><div class="section-titlepage"><h2><bdi class="secno">6. </bdi>Connections<a aria-label="§" class="self-link" href="#connections"></a></h2></div><div class="content"><p>Steps are connected together by their input ports, output ports, and bindings to variables and options. Variables and options also behave something like steps, connected together by the input on which they receive their context and by references to them by name elsewhere. <a id="err.inline.S0001"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0001"><code class="errqname">err:XS0001</code></a>) if there are any loops in the connections between steps, variables, and options: no step, variable, or option can be connected to itself nor can there be any sequence of connections through other steps that leads back to itself.</p><p>Consider <a href="#fig-depends" title="Dependencies between steps, variables, and options">Figure 5, “Dependencies between steps, variables, and options”</a>.</p><figure id="fig-depends" class="figure-wrapper"><div class="figure"><div id="fig-depends.2" title="Dependencies between steps, variables, and options" class="mediaobject"><img src="graphics/depends.png" alt="Dependencies between steps, variables, and options" /></div></div><div class="title">Figure 5. Dependencies between steps, variables, and options</div></figure><div class="itemizedlist"><ul><li><p>Step1 has no connections. </p></li><li><p>Step2 is connected to Step1 by an explicit dependency, see <a href="#depends" title="Additional dependent connections">Section 14.9.3, “Additional dependent connections”</a>. </p></li><li><p>Step3 is connected to Step2 because it reads from the output of Step2. It is also transitively connected to Step1 because Step2 is connected to it. </p></li><li><p>Step4 has no connections. In principle, Step1 and Step4 can be evaluated in parallel or in either order. </p></li><li><p>Step5 is connected to Step3 because it reads from the output of Step3. It is also transitively connected to Step2 and the connections that Step2 has. Step5 is also connected to Step4 because it’s option “<code class="literal">option1</code>” is connected to “<code class="literal">someVar</code>” which is connected to “<code class="literal">ecount</code>” which reads its context from Step4. </p></li><li><p>Step6 is connected to Step5 because it reads from the output of Step5. It is also transitively connected to all of the other steps. </p></li></ul></div><p><span id="dt-connection" class="termdef">[Definition: A <em class="glossterm">connection</em> associates an input or output port with some data source.]</span> Such a connection represents a binding between the port’s name and the data source as described by various locations, inline expressions, or readable ports.</p><p>An input port can be connected to:</p><div class="itemizedlist"><ul><li><p>The output port of some other step.</p></li><li><p>A fixed, inline document.</p></li><li><p>A document read from a URI.</p></li><li><p>One of the inputs declared on one of its <em class="glossterm"><a href="#dt-ancestors">ancestors</a></em> or a special port provided by an ancestor compound step, for example, “<code class="port">current</code>” in a <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> or <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>. </p></li></ul></div><p>When an input accepts a sequence of documents, the documents can come from any combination of these locations.</p><p>In contrast, output ports are connected when they are referenced by another input port, <em class="glossterm"><a href="#dt-declared-outputs">declared output</a></em> or other expression and may be connected to:</p><div class="itemizedlist"><ul><li><p>The input port or input context of some other step.</p></li><li><p>An option assigned with <a href="#p.with-option"><code class="tag-element">p:with-option</code></a> or a <a href="#p.variable"><code class="tag-element">p:variable</code></a> in a compound step.</p></li><li><p>A <em class="glossterm"><a href="#dt-value-template">value template</a></em> in an immediately following step. This can be an AVT in an <a href="#option-shortcut">option shortcut</a>, an AVT on a <a href="#p.document"><code class="tag-element">p:document</code></a> element, or a value template in a <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></li><li><p>One of the outputs declared on its container. </p></li></ul></div><p>As with an input, the output can be a sequence of documents constructed from any combination of the above.</p><p>Within the context of a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>, the <em class="glossterm"><a href="#dt-declared-outputs">declared outputs</a></em> of the compound step must describe their connections. The set of possibilities for this connection is exactly the same set as for any other input port within the current <em class="glossterm"><a href="#dt-environment">environment</a></em>.</p><section id="connecting-the-drp" class="section"><div class="section-titlepage"><h3><bdi class="secno">6.1. </bdi>Connections and the Default Readable Port<a aria-label="§" class="self-link" href="#connecting-the-drp"></a></h3></div><div class="content"><p>The <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is a convenience for pipeline authors. In the document which describes a pipeline, steps are sequential elements and it is very common for the output of one step to form the natural input to the step described by its immediately following sibling. Consider the following fragment:</p><pre class="programlisting language-markup xml"><code>&lt;p:add-xml-base/&gt; &lt;p:add-attribute attribute-name="element-count" attribute-value="{count(/*/*)}"/&gt;</code></pre><p>The output from the add XML base step is the natural input to the add-attribute step. The add XML base step is the source for both the document that will be processed by the add-attribute step and the document that will be used as the context item for the expression in the <code class="tag-attribute">attribute-value</code> attribute.</p><p>The fact that the output of the default readable port is used by the following step establishes a connection between the add XML base step and the add-attribute step.</p><p>However, unlike an explicit binding which <em>always</em> forms a connection, the default readable port <em>only</em> forms a connection if it is used. If the processor determines that the default readable port is not used, then it must forgo the connection and the steps can run in parallel.</p><p>Consider the following fragment:</p><pre class="programlisting language-markup xml"><code>&lt;p:add-xml-base/&gt; &lt;p:add-attribute attribute-name="class" attribute-value="homepage"&gt; &lt;p:with-input port="source"&gt; &lt;p:document href="http://example.com/"/&gt; &lt;/p:with-input&gt;</code></pre><p>The output of the add XML base step is still the default readable port, but it isn’t the source for the add-attribute step nor is the context item used in evaluating the <code class="tag-attribute">attribute-value</code> option (or any other option, including the default values of unspecified options), so the processor must omit the connection. This leads to increased parallelism and possibly improved performance.</p><p>However, it can cause unexpected results when steps have side-effects. Consider this slightly contrived pipeline fragment:</p><pre class="programlisting language-markup xml"><code>&lt;p:file-touch href="tempdoc.stamp"/&gt; &lt;p:file-copy href="tempdoc.stamp" target="time.stamp"/&gt; &lt;p:file-delete href="tempdoc.stamp"/&gt;</code></pre><p>Each of the file steps has a primary output port and consequently provides a <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> to the following step. Even though the file steps don’t have input ports, the document on the default readable port is the context item for evaluating the options on each step.</p><p>However, an implementation will observe that none of the options use the context item (and there are no inputs). Consequently, there are no connections between these steps and they can be run in an arbitrary order, or even in parallel. Running delete, followed by copy, followed by touch would be perfectly correct but would not have the side-effects expected by the pipeline author.</p><p>There’s a trade-off here between giving implementations the freedom to execute pipelines more efficiently and not violating user expectations. In practice, this problem only arises when scheduling steps that have side effects, steps with side effects are (relatively) uncommon, and by their nature are impossible for the processor to schedule with complete confidence.</p><p>The pipeline author can make the dependencies explicit in the pipeline, which will ensure that the processor schedules the steps in an order that has the desired the side-effects: </p><pre class="programlisting language-markup xml"><code>&lt;p:file-touch name="touchstamp" href="tempdoc.stamp"/&gt; &lt;p:file-copy name="copystamp" depends="touchstamp" href="tempdoc.stamp" target="time.stamp"/&gt; &lt;p:file-delete depends="copystamp" href="tempdoc.stamp"/&gt;</code></pre><p>Explicitly marking the dependencies between steps that have side effects is good practice.</p></div></section><section id="namespace-fixup" class="section"><div class="section-titlepage"><h3><bdi class="secno">6.2. </bdi>Namespace Fixup on XML Outputs<a aria-label="§" class="self-link" href="#namespace-fixup"></a></h3></div><div class="content"><p>XProc processors are expected, and sometimes required, to perform <em class="glossterm"><a href="#dt-namespace-fixup">namespace fixup</a></em> on XML outputs. Unless the semantics of a step explicitly says otherwise:</p><div class="itemizedlist"><ul><li><p>The in-scope namespaces associated with a node (even those that are inherited from namespace bindings that appear among its ancestors in the document in which it appears initially) are assumed to travel with that node.</p></li><li><p>Changes to one part of a tree (wrapping or unwrapping a node or renaming an element, for example) do not change the in-scope namespaces associated with the descendants of the node so changed.</p></li></ul></div><p>As a result, some steps can produce XML documents which have no direct serialization (because they include nodes with conflicting or missing namespace declarations, for example). <span id="dt-namespace-fixup" class="termdef">[Definition: To produce a serializable <em class="glossterm"><a href="#dt-XML">XML</a></em> document, the XProc processor must sometimes add additional namespace nodes, perhaps even renaming prefixes, to satisfy the constraints of <em class="glossterm"><a href="#dt-Namespaces-in-XML">Namespaces in XML</a></em>. This process is referred to as <em class="glossterm">namespace fixup</em>.]</span></p><p>Implementors are encouraged to perform <em class="glossterm"><a href="#dt-namespace-fixup">namespace fixup</a></em> before passing documents between steps, but they are not required to do so. Conversely, an implementation which <em>does</em> serialize between steps and therefore must perform such fixups, or reject documents that cannot be serialized, is also conformant.</p><p>Except where the semantics of a step explicitly require changes, processors are required to preserve the information in the documents and fragments they manipulate. In particular, the information corresponding to the [<a href="#xml-infoset-rec"><span class="abbrev">Infoset</span></a>] properties <code class="literal infoset-property">[attributes]</code>, <code class="literal infoset-property">[base URI]</code>, <code class="literal infoset-property">[children]</code>, <code class="literal infoset-property">[local name]</code>, <code class="literal infoset-property">[namespace name]</code>, <code class="literal infoset-property">[normalized value]</code>, <code class="literal infoset-property">[owner]</code>, and <code class="literal infoset-property">[parent]</code><span class="rfc2119" id="namespace-fixup.6.10">must</span> be preserved.</p><p>The information corresponding to <code class="literal infoset-property">[prefix]</code>, <code class="literal infoset-property">[in-scope namespaces]</code>, <code class="literal infoset-property">[namespace attributes]</code>, and <code class="literal infoset-property">[attribute type]</code><span class="rfc2119" id="namespace-fixup.7.5">should</span> be preserved, with changes to the first three only as required for <em class="glossterm"><a href="#dt-namespace-fixup">namespace fixup</a></em>. In particular, processors are encouraged to take account of prefix information in creating new namespace bindings, to minimize negative impact on prefixed names in content.</p><p><span style="display: none;" class="delete_version"><span id="impl-14">Except for cases which are specifically called out in [<a><span class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span class="modify_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span></a>], the extent to which namespace fixup, and other checks for outputs which cannot be serialized, are performed on intermediate outputs is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-14">Except for cases which are specifically called out in [<a><span class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span></a>], the extent to which namespace fixup, and other checks for outputs which cannot be serialized, are performed on intermediate outputs is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-14">Except for cases which are specifically called out in [<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>], the extent to which namespace fixup, and other checks for outputs which cannot be serialized, are performed on intermediate outputs is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>Whenever an implementation serializes XML, for example for pipeline outputs, logging, or as part of steps such as <code class="tag-element">p:store</code> or <code class="tag-element">p:http-request</code>, it is a dynamic error if that serialization can not be done so as to produce a document which is both well-formed and namespace-well-formed, as specified in <em class="glossterm"><a href="#dt-XML">XML</a></em> and <em class="glossterm"><a href="#dt-Namespaces-in-XML">Namespaces in XML</a></em>.</p></div></section></div></section><section id="initiating" class="section"><div class="section-titlepage"><h2><bdi class="secno">7. </bdi>Initiating a pipeline<a aria-label="§" class="self-link" href="#initiating"></a></h2></div><div class="content"><p>Initiating a pipeline necessarily involves two activities: static analysis and dynamic evaluation. <span id="dt-static-analysis" class="termdef">[Definition: <em class="glossterm">Static analysis</em> consists of those tasks that can be performed by inspection of the pipeline alone, including the binding of <a href="#statics">static options</a>, computation of serialization properties and document-properties, <a href="#use-when">evaluation of <code class="code">use-when</code> expressions</a>, performing a static analysis of all XPath expressions, and detecting static errors.]</span><span id="dt-dynamic-evaluation" class="termdef">[Definition: <em class="glossterm">Dynamic evaluation</em> consists of tasks which, in general, cannot be performed out until a source document is available.]</span></p><p><a id="err.inline.S0107"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0107"><code class="errqname">err:XS0107</code></a>) in XProc if any XPath expression or the XSLT <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em> in option <code class="option">match</code> on <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> contains a static error (error in expression syntax, references to unknown variables or functions, etc.). Type errors, even if they are determined during static analysis, <span class="rfc2119" id="initiating.3.2">must not</span> be raised statically by the XProc processor. </p><p><span id="impl-15">There may be an <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> mechanism for providing default values for static <a href="#p.option"><code class="tag-element">p:option</code></a>s. If such a mechanism exists, the values provided must match the sequence type declared for the option, if such a declaration exists.</span></p><section id="static-expressions" class="section"><div class="section-titlepage"><h3><bdi class="secno">7.1. </bdi>Evaluating expressions during static analysis<a aria-label="§" class="self-link" href="#static-expressions"></a></h3></div><div class="content"><p>Several kinds of expressions are evaluated during static analysis:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>The <code class="tag-attribute">select</code> expressions on static options.</p></li><li><p><a href="#value-templates">Value templates</a> in the attributes or descendants of <a href="#p.input"><code class="tag-element">p:input</code></a> and <a href="#p.output"><code class="tag-element">p:output</code></a> and map attributes on those descendants. </p></li><li><p>Expressions in <code class="tag-attribute">use-when</code> attributes used for <a href="#use-when">conditional element exclusion</a>.</p></li></ol></div><p>For the purposes of evaluating a these expressions, the initial context node, position, and size are all undefined. The <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> are limited to the lexically preceding, statically declared options. There are no available collections.</p><p>Options declared as the direct children of <a href="#p.library"><code class="tag-element">p:library</code></a> in imported libraries are considered in-scope for the declarations that follow.</p><p>The entire expression must be evaluated without reference to the non-static inputs to the pipeline. Expressions can access documents as long as they are available statically.</p><p>Consider:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step version="3.0" xmlns:p="http://www.w3.org/ns/xproc"&gt; &lt;p:input port="source"/&gt; &lt;p:option name="A" static="true" select="5"/&gt; &lt;p:option name="B" static="true" select="$A + count(doc('doc.xml')//*)" /&gt; &lt;p:variable name="D" select="count(//*)"/&gt; … &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step version="3.1" xmlns:p="http://www.w3.org/ns/xproc"&gt; &lt;p:input port="source"/&gt; &lt;p:option name="A" static="true" select="5"/&gt; &lt;p:option name="B" static="true" select="$A + count(doc('doc.xml')//*)" /&gt; &lt;p:variable name="D" select="count(//*)"/&gt; … &lt;/p:declare-step&gt;</span></code></pre><p>The value of <code class="code">$A</code> will be 5, unless a different value is provided before static analysis. The value of <code class="code">$B</code> will be the value of <code class="code">$A</code> plus the number of elements in <code class="uri">doc.xml</code><em>which must be successfully resolved during static analysis</em>. Although <code class="code">$D</code> can reference the document provided dynamically on the <code class="port">source</code> port, neither <code class="code">$A</code> nor <code class="code">$B</code> may.</p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>There is no guarantee that the document read from <code class="uri">doc.xml</code> during static analysis will be the same as the document read later during dynamic evaluation. See <a href="#external-docs" title="External Documents">Section 4.1, “External Documents”</a> for further discussion.</p></div></div><p>The results of XProc extension functions may differ during static analysis, as described in the description of each function.</p><p>Any errors that occur while evaluating expressions during static analysis will be raised statically.</p></div></section><section id="dynamic-evaluation" class="section"><div class="section-titlepage"><h3><bdi class="secno">7.2. </bdi>Dynamic evaluation of the pipeline<a aria-label="§" class="self-link" href="#dynamic-evaluation"></a></h3></div><div class="content"><p>Dynamic evaluation of the pipeline occurs when it begins to process documents. The processor evaluates any expressions necessary to provide all of the input documents and options required. The step processes the input documents and produces outputs which flow through the pipeline.</p><p>Unless otherwise specified, expressions that appear in attribute values (<em class="glossterm"><a href="#dt-attribute-value-template">attribute value templates</a></em>, map and array initializers that are always <a href="#syntax-summaries">treated as expressions</a>, etc.) get their context item from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. If there is no default readable port, the context item is undefined.</p><section id="environment" class="section"><div class="section-titlepage"><h4><bdi class="secno">7.2.1. </bdi>Environment<a aria-label="§" class="self-link" href="#environment"></a></h4></div><div class="content"><p><span id="dt-environment" class="termdef">[Definition: The <em class="glossterm">environment</em> is a context-dependent collection of information available within subpipelines.]</span></p><p>The environment consists of:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>A set of readable ports. <span id="dt-readable-ports" class="termdef">[Definition: The <em class="glossterm">readable ports</em> are a set of step name/port name pairs.]</span> Inputs and outputs can only be connected to readable ports.</p></li><li><p>A default readable port. <span id="dt-default-readable-port" class="termdef">[Definition: The <em class="glossterm">default readable port</em>, which may be undefined, is a specific step name/port name pair from the set of readable ports.]</span></p></li><li><p>A set of in-scope bindings. <span id="dt-in-scope-bindings" class="termdef">[Definition: The <em class="glossterm">in-scope bindings</em> are a set of name-value pairs, based on <em class="glossterm"><a href="#dt-option">option</a></em> and <em class="glossterm"><a href="#dt-variable">variable</a></em> bindings.]</span></p></li></ol></div><p><span id="dt-empty-environment" class="termdef">[Definition: The <em class="glossterm">empty environment</em> contains no readable ports, an undefined default readable port, and no in-scope bindings.]</span></p><p>Unless otherwise specified, the environment of a <em class="glossterm"><a href="#dt-contained-steps">contained step</a></em> is its <em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em>. <span id="dt-inherited-environment" class="termdef">[Definition: The <em class="glossterm">inherited environment</em> of a <em class="glossterm"><a href="#dt-contained-steps">contained step</a></em> is an environment that is the same as the environment of its <em class="glossterm"><a href="#dt-container">container</a></em> with the <a href="#dt-standard-modifications">standard modifications</a>. ]</span></p><p>The <span id="dt-standard-modifications">standard modifications</span> made to an inherited environment are:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>The declared inputs of the container are added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em>.</p><p>In other words, contained steps can see the inputs to their container.</p></li><li><p>The union of all the declared outputs of all of the step’s sibling steps are added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em>.</p><p>In other words, sibling steps can see each other’s outputs in addition to the outputs visible to their container.</p></li><li><p>If there is a preceding sibling step element:</p><div class="itemizedlist"><ul><li><p>If that preceding sibling has a <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em>, then that output port becomes the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>.</p></li><li><p>Otherwise, the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is undefined.</p></li></ul></div></li><li><p>If there <em>is not</em> a preceding sibling step element: </p><div class="itemizedlist"><ul><li><p>If the container has a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>, the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is that <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>.</p></li><li><p>Otherwise, the default readable port is unchanged.</p></li></ul></div></li></ol></div><p>A step with no parent inherits the <em class="glossterm"><a href="#dt-empty-environment">empty environment</a></em>. </p><p>Variables and options are lexically scoped. The environment of a step also includes the <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> for all of the variables and options “visible” from its lexical position. Variables and options can shadow each other; only the lexically most recent bindings are visible.</p><section id="initial-environment" class="section"><div class="section-titlepage"><h5><bdi class="secno">7.2.1.1. </bdi>Initial Environment<a aria-label="§" class="self-link" href="#initial-environment"></a></h5></div><div class="content"><p>When a pipeline is invoked by a processor, an initial environment is constructed. <span id="dt-initial-environment" class="termdef">[Definition: An <em class="glossterm">initial environment</em> is a <em class="glossterm"><a href="#dt-connection">connection</a></em> for each of the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> and a set of option bindings used to construct the initial <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em>.]</span> This environment is used in place of the <em class="glossterm"><a href="#dt-empty-environment">empty environment</a></em> that might have otherwise been provided.</p><p>An invoked pipeline’s <em class="glossterm"><a href="#dt-initial-environment">initial environment</a></em> is different from the environment constructed for the sub-pipeline of a declared step. The initial environment is constructed for the initial invocation of the pipeline by the processor outside the application. Steps that are subsequently invoked construct an environment as specified in <a href="#declare-pipelines" title="Declaring pipelines">Section 16.5.1, “Declaring pipelines”</a>.</p><p>When constructing an <em class="glossterm"><a href="#dt-initial-environment">initial environment</a></em>, an implementation is free to provide any set of mechanisms to construct connections for the input ports of the invoked step. These mechanisms are not limited to the variety of mechanisms described within this specification. Any extensions are implementation defined.</p><p>The set of <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> are constructed from a set of option name/value pairs. Each option value can be a simple string value, a specific data type instance (e.g. xs:dateTime), or a more complex value like a map item. How these values are specified is implementation defined.</p></div></section></div></section><section id="xpath-context" class="section"><div class="section-titlepage"><h4><bdi class="secno">7.2.2. </bdi>XPath in XProc<a aria-label="§" class="self-link" href="#xpath-context"></a></h4></div><div class="content"><p>XProc uses XPath 3.1 as an expression language. XPath expressions are evaluated by the XProc processor in several places: on compound steps, to compute the default values of options and the values of variables; on atomic steps, to compute the actual values of options. </p><p>XPath expressions are also passed to some steps. These expressions are evaluated by the implementations of the individual steps.</p><p>This distinction can be seen in the following example:</p><pre class="programlisting language-markup xml"><code>&lt;p:variable name="home" select="'http://example.com/docs'"/&gt; &lt;p:load name="read-from-home"&gt; &lt;p:with-option name="href" select="concat($home,'/document.xml')"/&gt; &lt;/p:load&gt; &lt;p:split-sequence name="select-chapters" test="@role='chapter'"&gt; &lt;p:with-input port="source" select="//section"/&gt; &lt;/p:split-sequence&gt;</code></pre><p>The select expression on the variable “<code class="varname">home</code>” is evaluated by the XProc processor. The value of the variable is “<code class="uri">http://example.com/docs</code>”.</p><p>The <code class="option">href</code> option of the <code class="tag-element">p:load</code> step is evaluated by the XProc processor. The actual <code class="literal">href</code> option received by the step is simply the string literal “<code class="uri">http://example.com/docs/document.xml</code>”. (The select expression on the <code class="literal">source</code> input of the <code class="tag-element">p:split-sequence</code> step is also evaluated by the XProc processor.) </p><p>The XPath expression “<code class="literal">@role='chapter'</code>” is passed literally to the <code class="literal">test</code> option on the <code class="tag-element">p:split-sequence</code> step. That’s because the nature of the <code class="tag-element">p:split-sequence</code> is that <em>it evaluates</em> the expression. Only some options on some steps expect XPath expressions. </p><p>The XProc processor evaluates all of the XPath expressions in <code class="tag-attribute">select</code> attributes on variables, options, and inputs, in <code class="tag-attribute">match</code> attributes on <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>, and in <code class="tag-attribute">test</code> attributes on <a href="#p.when"><code class="tag-element">p:when</code></a> and <a href="#p.if"><code class="tag-element">p:if</code></a> steps.</p><p>See <a href="#xproc-and-step-xpath-context" title="XPath contexts in XProc">Appendix B, <i>XPath contexts in XProc</i></a> for a detailed description of the context.</p></div></section></div></section></div></section><section id="xpath-extension-functions" class="section"><div class="section-titlepage"><h2><bdi class="secno">8. </bdi>XPath Extension Functions<a aria-label="§" class="self-link" href="#xpath-extension-functions"></a></h2></div><div class="content"><p>The XProc processor <span class="rfc2119" id="xpath-extension-functions.2.1">must</span> support the additional functions described in this section in XPath expressions evaluated by the processor.</p><p>These functions <span class="rfc2119" id="xpath-extension-functions.3.1">must not</span> be supported in XPath expressions evaluated by a step. In the interest of interoperability and to avoid imposing unnecessary constraints on implementors, XPath expressions inside, for example, a template in an XSLT step, cannot be aware of the XProc-defined functions. </p><section id="f.system-property" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.1. </bdi>System Properties<a aria-label="§" class="self-link" href="#f.system-property"></a></h3></div><div class="content"><p>XPath expressions within a pipeline document can interrogate the processor for information about the current state of the pipeline. Various aspects of the processor are exposed through the <a href="#f.system-property"><code class="function">p:system-property</code></a> function:</p><div class="funcsynopsis"><span class="funcname">p:system-property</span><span class="funcparen">(</span><span class="paramname">$property</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:string</span></div><p>The <code class="varname">$property</code> string <span class="rfc2119" id="f.system-property.4.2">must</span> have the form of an <a href="https://www.w3.org/TR/xquery-30/#doc-xquery30-EQName">EQName</a>. If it is a QName, it is expanded using the namespace declarations in scope for the expression. <a id="err.inline.D0015"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0015"><code class="errqname">err:XD0015</code></a>) if a QName is specified and it cannot be resolved with the in-scope namespace declarations. The <a href="#f.system-property"><code class="function">p:system-property</code></a> function returns the string representing the value of the system property identified by the EQName. If there is no such property, the empty string <span class="rfc2119" id="f.system-property.4.6">must</span> be returned.</p><p>Implementations <span class="rfc2119" id="f.system-property.5.1">must</span> provide the following system properties, which are all in the XProc namespace:</p><div class="variablelist"><dl><dt><span class="term"><code class="varname">p:episode</code></span></dt><dd><p>Returns a string which <span class="rfc2119" id="f.system-property.6.1.2.1.1">should</span> be unique for each invocation of the pipeline processor. In other words, if a processor is run several times in succession, or if several processors are running simultaneously, each invocation of each processor should get a distinct value from <code class="varname">p:episode</code>.</p><p>The unique identifier must be a valid <a href="http://www.w3.org/TR/xml/#NT-Name">XML name</a>. </p></dd><dt><span class="term"><code class="varname">p:locale</code></span></dt><dd><p>Returns a string which identifies the current environment (usually the OS) language. This is useful for, for example, message localization purposes. <span id="impl-16">The exact format of the language string is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> but <span class="rfc2119" id="f.system-property.6.2.2.1.1.2">should</span> be consistent with the <code class="tag-attribute">xml:lang</code> attribute.</span></p></dd><dt><span class="term"><code class="varname">p:product-name</code></span></dt><dd><p>Returns a string containing the name of the implementation, as defined by the implementer. This should normally remain constant from one release of the product to the next. It should also be constant across platforms in cases where the same source code is used to produce compatible products for multiple execution platforms.</p></dd><dt><span class="term"><code class="varname">p:product-version</code></span></dt><dd><p>Returns a string identifying the version of the implementation, as defined by the implementer. This should normally vary from one release of the product to the next, and at the discretion of the implementer it may also vary across different execution platforms. </p></dd><dt><span class="term"><code class="varname">p:vendor</code></span></dt><dd><p>Returns a string which identifies the vendor of the processor.</p></dd><dt><span class="term"><code class="varname">p:vendor-uri</code></span></dt><dd><p>Returns a URI which identifies the vendor of the processor. Often, this is the URI of the vendor’s web site.</p></dd><dt><span class="term"><code class="varname">p:version</code></span></dt><dd><p>Returns the version(s) of XProc implemented by the processor as a space-separated list. For example, a processor that supports XProc 1.0 would return “1.0”; a processor that supports XProc 1.0 and 3.0 would return “1.0 3.0”; a processor that supports only XProc 3.0 would return “3.0”.</p></dd><dt><span class="term"><code class="varname">p:xpath-version</code></span></dt><dd><p>Returns the version(s) of XPath implemented by the processor for evaluating XPath expressions on XProc elements. The result is a space-separated list of versions supported. For example, a processor that only supports XPath 3.1 would return “3.1”; a processor that supports XPath 3.1 and XPath 3.2 could return “3.1 3.2”.</p></dd><dt><span class="term"><code class="varname">p:psvi-supported</code></span></dt><dd><p>Returns true if the implementation supports passing PSVI annotations between steps, false otherwise.</p></dd></dl></div><p>Implementations may support additional system properties but such properties <span class="rfc2119" id="f.system-property.7.1">must</span> be in a namespace and <span class="rfc2119" id="f.system-property.7.2">must not</span> be in the XProc namespace.</p><p>The <a href="#f.system-property"><code class="function">p:system-property</code></a> function behaves normally during static analysis. <span id="impl-17">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> which additional system properties are available during static analysis.</span> If an additional system property is not available during static analysis, an empty string <span class="rfc2119" id="f.system-property.8.3">must</span> be returned.</p></div></section><section id="f.step-available" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.2. </bdi>Step Available<a aria-label="§" class="self-link" href="#f.step-available"></a></h3></div><div class="content"><p>The <a href="#f.step-available"><code class="function">p:step-available</code></a> function reports whether or not a particular type of step is understood by the processor and in scope where the function is called.</p><div class="funcsynopsis"><span class="funcname">p:step-available</span><span class="funcparen">(</span><span class="paramname">$step-type</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:boolean</span></div><p>The <code class="varname">$step-type</code> string <span class="rfc2119" id="f.step-available.4.2">must</span> have the form of an <a href="https://www.w3.org/TR/xquery-30/#doc-xquery30-EQName">EQName</a>. If it is a QName, it is expanded using the namespace declarations in scope for the expression. <a id="err.inline.D0015.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0015"><code class="errqname">err:XD0015</code></a>) if a QName is specified and it cannot be resolved with the in-scope namespace declarations. The <a href="#f.step-available"><code class="function">p:step-available</code></a> function returns <code class="code">true</code> if and only if the processor knows how to evaluate a step of the specified type where the function is called.</p><p>In case the argument of <a href="#f.step-available"><code class="function">p:step-available</code></a> refers to a step that is currently being defined, the function returns <code class="code">false</code>. In practice this occurs only if:</p><div class="itemizedlist"><ul><li><p><a href="#f.step-available"><code class="function">p:step-available</code></a> is used in a <code class="code">use-when</code> expression on or within the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> that defines the step to which it refers.</p></li><li><p><a href="#f.step-available"><code class="function">p:step-available</code></a> is used in a <code class="code">use-when</code> expression on a <a href="#p.library"><code class="tag-element">p:library</code></a> that contains the declaration of the step to which it refers.</p></li></ul></div><p>The <a href="#f.step-available"><code class="function">p:step-available</code></a> behaves normally during static analysis.</p></div></section><section id="f.iteration-position" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.3. </bdi>Iteration Position<a aria-label="§" class="self-link" href="#f.iteration-position"></a></h3></div><div class="content"><p>Some compound steps, such as <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>, process a sequence of documents. The iteration position is the position of the current document in that sequence: the first document has position 1, the second 2, etc. The <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a> function returns the iteration position of the nearest compound step that processes a sequence of documents.</p><div class="funcsynopsis"><span class="funcname">p:iteration-position</span><span class="funcparen">(</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:integer</span></div><p>If there is no compound step that processes a sequence of documents among the ancestors of the element on which the expression involving <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a> occurs, it returns 1.</p><p>The value of the <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a> function during static analysis is 1.</p></div></section><section id="f.iteration-size" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.4. </bdi>Iteration Size<a aria-label="§" class="self-link" href="#f.iteration-size"></a></h3></div><div class="content"><p>Both <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> process a sequence of documents. The iteration size is the total number of documents in that sequence. The <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a> function returns the iteration size of the nearest ancestor compound step that processes a sequence of documents.</p><div class="funcsynopsis"><span class="funcname">p:iteration-size</span><span class="funcparen">(</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:integer</span></div><p>If there is no <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> or <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> among the ancestors of the element on which the expression involving <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a> occurs, it returns 1.</p><p>The value of the <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a> function during static analysis is 1.</p></div></section><section id="f.version-available" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.5. </bdi>Version Available<a aria-label="§" class="self-link" href="#f.version-available"></a></h3></div><div class="content"><p>Returns true if and only if the processor supports the XProc version specified.</p><div class="funcsynopsis"><span class="funcname">p:version-available</span><span class="funcparen">(</span><span class="paramname">$version</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:boolean</span></div><p><span style="display: none;" class="delete_version">A version 3.0 processor will return <code class="literal">true()</code> when <code class="code">p:version-available('3.0')</code> is evaluated.</span><span style="display: none;" class="add_version">A version 3.1 processor will return <code class="literal">true()</code> when <code class="code">p:version-available('3.1')</code> is evaluated.</span><span class="modify_version">A version <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> processor will return <code class="literal">true()</code> when <code class="code">p:version-available('<span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span>')</code> is evaluated.</span></p><p>The <a href="#f.version-available"><code class="function">p:version-available</code></a> function behaves normally during static analysis.</p></div></section><section id="f.xpath-version-available" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.6. </bdi>XPath Version Available<a aria-label="§" class="self-link" href="#f.xpath-version-available"></a></h3></div><div class="content"><p>Returns true if and only if the processor supports the XPath version specified.</p><div class="funcsynopsis"><span class="funcname">p:xpath-version-available</span><span class="funcparen">(</span><span class="paramname">$version</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:boolean</span></div><p>A processor that supports XPath 3.1 will return <code class="literal">true()</code> when <code class="code">p:xpath-version-available('3.1')</code> is evaluated.</p><p>The <a href="#f.xpath-version-available"><code class="function">p:xpath-version-available</code></a> function behaves normally during static analysis.</p></div></section><section id="f.document-properties" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.7. </bdi>Document properties<a aria-label="§" class="self-link" href="#f.document-properties"></a></h3></div><div class="content"><p>This function retrieves the <em class="glossterm"><a href="#dt-document-properties">document properties</a></em> of a document as a map.</p><div class="funcsynopsis"><span class="funcname">p:document-properties</span><span class="funcparen">(</span><span class="paramname">$doc</span><span class="typeas"> as </span><span class="type">item()</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">map(xs:QName,item()*)</span></div><p>The map returned contains (exclusively) the document properties associated with the <em class="parameter"><code>$doc</code></em> specified. If the item is not associated with a document, the resulting map will be empty.</p><p>Document properties are associated with documents that flow out of steps. Documents loaded with XPath functions or through other out-of-band means may not have properties associated with them. In order to provide a consistent interface for pipeline authors, the base URI of a node is always returned in the <code class="code">base-uri</code> property and the <code class="code">content-type</code> property always contains at least the most general appropriate content type: If the document node has a single text node child, <code class="code">text/plain</code> is used, <code class="code">application/xml</code> otherwise.</p><p>The <a href="#f.document-properties"><code class="function">p:document-properties</code></a> function behaves normally during static analysis.</p></div></section><section id="f.document-property" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.8. </bdi>Document property<a aria-label="§" class="self-link" href="#f.document-property"></a></h3></div><div class="content"><p>This function retrieves a single value from the <em class="glossterm"><a href="#dt-document-properties">document properties</a></em> of a document.</p><div class="funcsynopsis"><span class="funcname">p:document-property</span><span class="funcparen">(</span><span class="paramname">$doc</span><span class="typeas"> as </span><span class="type">item()</span><span class="funccomma">, </span><span class="paramname">$key</span><span class="typeas"> as </span><span class="type">item()</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">item()*</span></div><p>The item returned is the value of the property named <code class="code">$key</code> in the document properties. An empty sequence is returned if <code class="code">$doc</code> is not associated with a document or no such key exists. <code class="code">$key</code> is interpreted as follows:</p><div class="itemizedlist"><ul><li><p>If <code class="code">$key</code> is of type <code class="type">xs:QName</code>, its value is used unchanged.</p></li><li><p>If <code class="code">$key</code> is an instance of type <code class="type">xs:string</code> (or a type derived from <code class="type">xs:string</code>) its value is transformed into a <code class="type">xs:QName</code> using the <a href="https://www.w3.org/TR/xpath-31/#doc-xpath31-EQName">XPath EQName production rules</a>. That is, it can be written as a local-name only, as a prefix plus local-name or as a URI plus local-name (using the <code class="code">Q{}</code> syntax).</p><p><a id="err.inline.D0061"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0061"><code class="errqname">err:XD0061</code></a>) if <code class="code">$key</code> is of type <code class="type">xs:string</code> and cannot be converted into a <code class="type">xs:QName</code>. </p></li><li><p>If <code class="code">$key</code> is of any other type, the function returns the empty sequence.</p></li></ul></div><p>The <a href="#f.document-property"><code class="function">p:document-property</code></a> function behaves normally during static analysis.</p></div></section><section id="f.urify" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.9. </bdi>Transform file system paths into URIs and normalize URIs<a aria-label="§" class="self-link" href="#f.urify"></a></h3></div><div class="content"><p>Most web technologies identify resources with URIs, but XProc must also operate with resources that are identified with strings encoded in other ways, for example, file system paths and the names of resources in archive files.</p><p>The <a href="#f.urify"><code class="function">p:urify</code></a> function attempts to transform file system paths into file URIs ([<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>]). If a presumptive yet not fully compliant URI is given as an argument, <a href="#f.urify"><code class="function">p:urify</code></a> attempts to resolve the string into a URI.</p><p>The <a href="#f.urify"><code class="function">p:urify</code></a> function resolves a string into a URI by employing a series of heuristics. These have been selected so that <code class="tag-element">p:urify</code> will not corrupt any actual, valid URIs and with the goal that it will return the least surprising result for any other string. If a pipeline author has more context to determine how a string should be transformed into a URI, writing the conversion process “by hand” in the pipeline may achieve better results.</p><div class="funcsynopsis"><span class="funcname">p:urify</span><span class="funcparen">(</span><span class="paramname">$filepath</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funccomma">, </span><span class="paramname">$basedir</span><span class="typeas"> as </span><span class="type">xs:string?</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:string</span></div><div class="funcsynopsis"><span class="funcname">p:urify</span><span class="funcparen">(</span><span class="paramname">$filepath</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:string</span></div><p>If the single-argument version of the function is used, the result is the same as calling the two-argument version with <em class="parameter"><code>$basedir</code></em> set to the empty sequence.</p><p>The <a href="#f.urify"><code class="function">p:urify</code></a> function behaves normally during static analysis.</p><p>The heuristics that <a href="#f.urify"><code class="function">p:urify</code></a> performs occur in two stages: first, the input string is analyzed to identify its features, then these features are used to construct a final URI string. An additional “fixup” process may be performed on <span class="deltaxml-old" style="background:#FF5555">the path portion</span><span class="deltaxml-new" style="background:#90EE90">portions</span> of the URI.</p><p>To make the operation of the <a href="#f.urify"><code class="function">p:urify</code></a> function easier to understand, the description that follows is presented as an algorithm with regular expressions. Implementors are not required to implement it this way, any implementation that achieves the correct results can be used.</p><p>The function may be implemented as an operation on strings; it need not try to determine the existence of a file or directory, and it <span class="rfc2119" id="f.urify.11.1">should not</span> follow symbolic links. However, two pieces of information need to be known from the environment: Whether the operating system identifies as “Windows” and the value of the file separator. More precisely, the operating system identifies as Windows if the <code class="literal">os-name</code> property as returned by the <code class="tag-element">p:os-info</code> steps starts with the string “<code class="literal">Windows</code>”. The file separator is what <code class="tag-element">p:os-info</code> returns as the <code class="literal">file-separator</code> property. If either of them are not known, it is assumed that the operating system is not Windows and the file separator is the forward slash, “<code class="literal">/</code>”.</p><p>The comparisons and regular expressions that follow are presented in lower case, but all of the operations performed are case blind: “file”, “FILE”, “File”, and “FiLe” are all identical. </p><section id="urify-normalize" class="section"><div class="section-titlepage"><h4><bdi class="secno">8.9.1. </bdi>Normalize file separators<a aria-label="§" class="self-link" href="#urify-normalize"></a></h4></div><div class="content"><p>Before beginning analysis, if the system file separator is not “/”, then all occurrences of the file separator in filenames must be replaced by “/”. (If the file separator <em>is</em> “/”, this section does not apply.)</p><p>Replacing file separators with “/” simplifies the analysis that follows and assures that the resulting URI will be syntactically correct. However, it must only be done when it is determined that the <em class="parameter"><code>$filepath</code></em> will become part of a file: URI.</p><p>To determine if the path will become part of a file: URI, consider the following cases in turn, stopping at the first which applies:</p><div class="itemizedlist"><ul><li><p>If the <em class="parameter"><code>$filepath</code></em> begins with “file:” or, on Windows, if it begins with a single letter followed by a colon, it will be part of a file: URI. </p></li><li><p>If the <em class="parameter"><code>$filepath</code></em> begins with an explicit scheme other than “file”, it will not be part of a file: URI.</p></li><li><p>If the <em class="parameter"><code>$basedir</code></em> is absent or the empty string, it will be part of a file: URI.</p></li><li><p>If the <em class="parameter"><code>$basedir</code></em> begins with an explicit scheme other than “file”, it will not be part of a file: URI. </p></li><li><p>If none of the preceding cases applies, it will be part of a file: URI. </p></li></ul></div><p>If it has been determined that the path will become part of a file: URI, replace each occurrence of the file separator character in <em class="parameter"><code>$filepath</code></em> with a “/”. </p></div></section><section id="urify-analysis" class="section"><div class="section-titlepage"><h4><bdi class="secno">8.9.2. </bdi>Analysis<a aria-label="§" class="self-link" href="#urify-analysis"></a></h4></div><div class="content"><p>The <em class="parameter"><code>$filepath</code></em> presented is analyzed to identify the following features:</p><div class="itemizedlist"><ul><li><p>The <em>scheme</em>, which may be absent or implicitly known or explicitly known.</p></li><li><p>Whether or not the string can be interpreted as <em>hierarchical</em>.</p></li><li><p>The <em>authority</em>, which may be absent.</p></li><li><p>The <em>drive letter</em>, which may be absent.</p></li><li><p><span style="display: none;" class="delete_version">And the <em>path</em>, which may be <em>absolute</em> or <em>relative</em>.</span><span style="display: none;" class="add_version">the <em>path</em>, which may be <em>absolute</em> or <em>relative</em>,</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">And </span>the <em>path</em>, which may be <em>absolute</em> or <em>relative</em><span class="deltaxml-old" style="background:#FF5555">.</span><span class="deltaxml-new" style="background:#90EE90">,</span></span></p></li><li class="add_version" style="display: none;"><p>And a <em>suffix</em> which is initially empty. </p></li><li class="modify_version"><p><span class="deltaxml-new" style="background:#90EE90">And a </span><em><span class="deltaxml-new" style="background:#90EE90">suffix</span></em><span class="deltaxml-new" style="background:#90EE90"> which is initially empty. </span></p></li></ul></div><p>The analysis proceeds along the following lines, stopping as soon as the features have been identified.</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If the <em class="parameter"><code>$filepath</code></em> is the empty string, it has no scheme, no authority, and no drive letter. Its path is the empty string and it is relative and hierarchical.</p></li><li><p>If the <em class="parameter"><code>$filepath</code></em> is the string “//”, it has no scheme, no authority, and no drive letter. Its path is the string “/” and it is absolute and hierarchical.</p></li><li><p>On a Windows system, if the <em class="parameter"><code>$filepath</code></em> matches the regular expression “<code class="code">^(file:/*)?([a-z]):(.*)</code>”, it is a “file” scheme URI. If the first match group begins with “file:”, it is an explicit file scheme URI, otherwise it is an implicit file scheme URI. The drive letter is the second match group. If the third match group begins with a “/”, the path is absolute and consists of the third match group with all but one leading “/” removed. Otherwise, the path is relative and consists of the entire third match group, or the empty string if the third match group is empty. </p><p>In all cases, the scheme is hierarchical and the authority is absent.</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">C:Users/Jane/Documents and Files/Thing</code>, an implicit file URI on drive C with the relative path “Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">C:/Users/Jane/Documents and Files/Thing</code> an implicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">C://Users/Jane/Documents and Files/Thing</code> an implicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">C:///Users/Jane/Documents and Files/Thing</code> an implicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">file:C:Users/Jane/Documents and Files/Thing</code> an explicit file URI on drive C with the relative path “Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">file:C:/Users/Jane/Documents and Files/Thing</code> an explicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">file:C://Users/Jane/Documents and Files/Thing</code> an explicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li><li><p><code class="code">file:C:///Users/Jane/Documents and Files/Thing</code> an explicit file URI on drive C with the absolute path “/Users/Jane/Documents and Files/Thing”. </p></li></ul></div></li><li><p>If the <em class="parameter"><code>$filepath</code></em> matches the regular expression “<code class="code">^file://([^/]+)(/.*)?$</code>”, it is an explicit “file” scheme URI. The first match group is the authority. If the second match group begins with a “/”, the path is absolute and consists of the second match group with all but one leading “/” removed. Otherwise, the path is the empty string and is relative. </p><p>In all cases, the scheme is hierarchical and the drive letter is absent.</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">file://authority.com</code> an explicit file URI with the authority “authority.com” and the relative path “”. </p></li><li><p><code class="code">file://authority.com/</code> an explicit file URI with the authority “authority.com” and the absolute path “/”. </p></li><li><p><code class="code">file://authority.com/path/to/thing</code> an explicit file URI with the authority “authority.com” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">file://authority.com//path/to/thing</code> an explicit file URI with the authority “authority.com” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">file://authority.com///path/to/thing</code> an explicit file URI with the authority “authority.com” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">file://authority.com:8080/path/to/thing</code> an explicit file URI with the authority “authority.com:8080” and the absolute path “/path/to/thing”. </p></li></ul></div></li><li><p>If the <em class="parameter"><code>$filepath</code></em> matches the regular expression “<code class="code">^file:(.*)$</code>”, it is an explicit “file” scheme URI. If the first match group begins with a “/”, the path is absolute and consists of the first match group with all but one leading “/” removed. Otherwise, the path is relative and consists of the entire first match group, or the empty string if the first match group is empty. </p><p>In all cases, the scheme is hierarchical and the drive letter and authority are absent.</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">file:</code> is an explicit file URI with the relative path “”. </p></li><li><p><code class="code">file:path/to/thing</code> is an explicit file URI with the relative path “path/to/thing”. </p></li><li><p><code class="code">file:/path/to/thing</code> is an explicit file URI with the absolute path “/path/to/thing”. </p></li><li><p><code class="code">file://path/to/thing</code> does not apply. It matches the preceding case; “path” is the authority. </p></li><li><p><code class="code">file:///path/to/thing</code> is an explicit file URI with the absolute path “/path/to/thing”. </p></li></ul></div></li><li><p>If the <em class="parameter"><code>$filepath</code></em> matches the regular expression “<code class="code">^([a-z]+):(.*)$</code>”, it is an explicit URI in the scheme identified by the first match group. The path is the second match group. (In the terms of [<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>], it may have an authority component, but that’s not relevant to <a href="#f.urify"><code class="function">p:urify</code></a>.) If the implementation does not know if the scheme is hierarchical, it is considered hierarchical if the path contains a “/”, otherwise it is considered non-hierarchical. (The “http”, “https”, and “ftp” schemes are hierarchical, for example; the “mailto”, “urn” and “doi” schemes are not.)</p><p>In all cases, the drive letter and authority are absent.</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">urn:publicid:ISO+8879%3A1986:ENTITIES+Added+Latin+1:EN</code> is a non-hierarchical “urn” URI. By the heuristic applied, the path is “publicid:ISO+8879%3A1986:ENTITIES+Added+Latin+1:EN”, but this will never be relevant as relative and absolute path resolution is never applied to non-hierarchical schemes. </p></li><li><p><code class="code">https:</code> is a hierarchical “https” URI with the relative path “”. </p></li><li><p><code class="code">https://example.com</code> is a hierarchical “https” URI with the absolute path “//example.com”. </p></li><li><p><code class="code">https://example.com/</code> is a hierarchical “https” URI with the absolute path “//example.com/”. </p></li><li><p><code class="code">https://example.com/path/to/thing</code> is a hierarchical “https” URI with the absolute path “//example.com/path/to/thing”. </p></li><li><p><code class="code">https://example.com//path/to/thing</code> is a hierarchical “https” URI with the absolute path “//example.com//path/to/thing”. </p></li><li><p><code class="code">https://example.com:9000/path/to/thing</code> is a hierarchical “https” URI with the absolute path “//example.com:9000/path/to/thing”. </p></li></ul></div></li><li><p>If the <em class="parameter"><code>$filepath</code></em> matches the regular expression “<code class="code">^//([^/]+)(/.*)?$</code>”, it has no scheme. The first match group is the authority. If the second match group begins with a “/”, the path is absolute and consists of the second match group with all but one leading “/” removed. Otherwise, the path is the empty string and is relative. It has no drive letter. </p><p>In all cases, the URI is hierarchical and the drive letter is absent.</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">//authority</code> has the authority “authority” and the relative path “”. </p></li><li><p><code class="code">//authority/</code> has the authority “authority” and the absolute path “/”. </p></li><li><p><code class="code">//authority/path/to/thing</code> has the authority “authority” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">//authority//path/to/thing</code> has the authority “authority” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">//authority///path/to/thing</code> has the authority “authority” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">//authority:8080/path/to/thing</code> has the authority “authority:8080” and the absolute path “/path/to/thing”. </p></li><li><p><code class="code">//authority/Documents and Files/thing</code> has the authority “authority” and the absolute path “/Documents and Files/thing”. </p></li></ul></div></li><li><p>If the <em class="parameter"><code>$filepath</code></em> begins with a “/”, the path is absolute and consists of <em class="parameter"><code>$filepath</code></em> with all but one leading “/” removed. Otherwise, the path is relative and consists of the entire <em class="parameter"><code>$filepath</code></em>. It is hierarchical and has no scheme, no authority and no drive letter. (This condition always applies if no preceding condition does.)</p><p>For example:</p><div class="itemizedlist"><ul><li><p><code class="code">path/to/thing</code> has the relative path “path/to/thing”. </p></li><li><p><code class="code">/path/to/thing</code> has the absolute path “/path/to/thing”. </p></li><li><p><code class="code">//path/to/thing</code> does not apply. It matches the preceding case; “path” is the authority. </p></li><li><p><code class="code">///path/to/thing</code> has the absolute path “/path/to/thing”. </p></li><li><p><code class="code">Documents and Files/thing</code> has the relative path “/Documents and Files/thing”. </p></li><li><p><code class="code">/Documents and Files/thing</code> has the absolute path “/Documents and Files/thing”. </p></li></ul></div></li></ol></div><p>If the analysis determines that the string represents a non-hierarchical URI, the <em class="parameter"><code>$filepath</code></em> is returned unchanged.</p><p><span class="deltaxml-new" style="background:#90EE90">If the </span><em class="parameter"><code><span class="deltaxml-new" style="background:#90EE90">$filepath</span></code></em><span class="deltaxml-new" style="background:#90EE90"> contains either a “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">?</span></code><span class="deltaxml-new" style="background:#90EE90">” or a “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">#</span></code><span class="deltaxml-new" style="background:#90EE90">”, that character and everything after it is removed from the </span><em class="parameter"><code><span class="deltaxml-new" style="background:#90EE90">$filepath</span></code></em><span class="deltaxml-new" style="background:#90EE90"> and saved as the </span><em><span class="deltaxml-new" style="background:#90EE90">suffix</span></em><span class="deltaxml-new" style="background:#90EE90">. If it contains both “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">?</span></code><span class="deltaxml-new" style="background:#90EE90">” and “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">#</span></code><span class="deltaxml-new" style="background:#90EE90">”, the suffix begins at whichever character occurs earliest in the path. (If “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">#</span></code><span class="deltaxml-new" style="background:#90EE90">” occurs first, it’s a fragment identifier that contains a question mark; if “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">?</span></code><span class="deltaxml-new" style="background:#90EE90">” occurs first, it’s a query followed by a fragment identifier, but that distinction isn't signficant to the </span><a href="#f.urify"><code class="function"><span class="deltaxml-new" style="background:#90EE90">p:urify</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function.) The </span><em><span class="deltaxml-new" style="background:#90EE90">suffix</span></em><span class="deltaxml-new" style="background:#90EE90"> is URI encoded as with </span><code class="function"><span class="deltaxml-new" style="background:#90EE90">fn:escape-html-uri</span></code><span class="deltaxml-new" style="background:#90EE90">. </span></p><p>If the analysis determines that the scheme is known and the path is absolute, a URI is constructed from the features, see below. Otherwise, the URI must be made absolute with respect to the <em class="parameter"><code>$basedir</code></em> provided.</p><p>If the <em class="parameter"><code>$basedir</code></em> is the empty sequence, construct a presumptive URI string from the string that represents the current working directory. If this presumptive URI does not end with the file separator, append the file separator. If the implementation is running in an environment where the concept of “current working directory” does not apply, the presumptive URI is the empty string. This presumptive URI becomes the <em class="parameter"><code>$basedir</code></em>.</p><p>Analyze the features of the <em class="parameter"><code>$basedir</code></em>.</p><p>If the <em class="parameter"><code>$basedir</code></em> has no scheme, it’s implicitly a “file” URI.</p><p>If the <em class="parameter"><code>$basedir</code></em> path is relative, the <em class="parameter"><code>$filepath</code></em> cannot be made absolute. <a id="err.inline.D0074"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0074"><code class="errqname">err:XD0074</code></a>) if no absolute base URI is supplied to <a href="#f.urify"><code class="function">p:urify</code></a> and none can be inferred from the current working directory.</p><p>The following additional constraints apply.</p><div class="itemizedlist"><ul><li><p><a id="err.inline.D0075"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0075"><code class="errqname">err:XD0075</code></a>) if the relative path has a drive letter and the base URI has a different drive letter or does not have a drive letter.</p></li><li><p><a id="err.inline.D0076"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0076"><code class="errqname">err:XD0076</code></a>) if the relative path has a drive letter and the base URI has an authority or if the relative path has an authority and the base URI has a drive letter. </p></li><li><p><a id="err.inline.D0077"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0077"><code class="errqname">err:XD0077</code></a>) if the relative path has a scheme that differs from the scheme of the base URI. </p></li><li><p><a id="err.inline.D0080"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0080"><code class="errqname">err:XD0080</code></a>) if the <em class="parameter"><code>$basedir</code></em> has a non-hierarchical scheme. </p></li></ul></div><p>Combine the features of the <em class="parameter"><code>$filepath</code></em> with the features of the <em class="parameter"><code>$basedir</code></em> to obtain a set of features to use to construct the result.</p><p>If the <em class="parameter"><code>$filepath</code></em> has no scheme or an implicit file scheme, perform fixup on the path, as described below. If the <em class="parameter"><code>$basedir</code></em> is an implicit file URI, perform fixup on its path.</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>The scheme is the scheme of the <em class="parameter"><code>$basedir</code></em>. </p></li><li><p>If the <em class="parameter"><code>$filepath</code></em> has an authority, use that authority, otherwise use the authority of the <em class="parameter"><code>$basedir</code></em>, if it has one.</p></li><li><p>The drive letter is the drive letter of the <em class="parameter"><code>$basedir</code></em>.</p></li><li><p>If the path of the <em class="parameter"><code>$filepath</code></em> absolute, that’s the path. Otherwise the path is the path of the <em class="parameter"><code>$filepath</code></em> resolved against the <em class="parameter"><code>$basedir</code></em>. </p><p><span style="display: none;" class="delete_version">If the <em class="parameter"><code>$basedir</code></em> ends in “/”, the resolved path is the concatention of the <em class="parameter"><code>$basedir</code></em> and <em class="parameter"><code>$filepath</code></em>’s path. Otherwise, the resolved path is the concatentation of all the characters in <em class="parameter"><code>$basedir</code></em> up to and including the last “/” it contains with the <em class="parameter"><code>$filepath</code></em>’s path. </span><span style="display: none;" class="add_version">If the <em class="parameter"><code>$basedir</code></em> ends in “/” or if the <em class="parameter"><code>$filepath</code></em> was the empty string after removing the <em>suffix</em>, the resolved path is the concatention of the <em class="parameter"><code>$basedir</code></em> and <em class="parameter"><code>$filepath</code></em>’s path. Otherwise, the resolved path is the concatentation of all the characters in <em class="parameter"><code>$basedir</code></em> up to and including the last “/” it contains with the <em class="parameter"><code>$filepath</code></em>’s path. </span><span class="modify_version">If the <em class="parameter"><code>$basedir</code></em> ends in “/”<span class="deltaxml-new" style="background:#90EE90"> or if the </span><em class="parameter"><code><span class="deltaxml-new" style="background:#90EE90">$filepath</span></code></em><span class="deltaxml-new" style="background:#90EE90"> was the empty string after removing the </span><em><span class="deltaxml-new" style="background:#90EE90">suffix</span></em>, the resolved path is the concatention of the <em class="parameter"><code>$basedir</code></em> and <em class="parameter"><code>$filepath</code></em>’s path. Otherwise, the resolved path is the concatentation of all the characters in <em class="parameter"><code>$basedir</code></em> up to and including the last “/” it contains with the <em class="parameter"><code>$filepath</code></em>’s path. </span></p><p>Path contraction for “.” and “..” is performed on the resolved path according to Section 3.3 of [<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>].</p></li></ol></div></div></section><section id="urify-fixup" class="section"><div class="section-titlepage"><h4><bdi class="secno">8.9.3. </bdi>Path fixup<a aria-label="§" class="self-link" href="#urify-fixup"></a></h4></div><div class="content"><p>If fixup is performed, the characters “?”, “#”, “\” and “ ” (space) are replaced by their percent-encoded forms, “%3F”, “%23”, “%5C”, and “%20”, respectively.</p><p>Unreserved characters that are percent encoded in the path are decoded per Section 2.4 of [<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>].</p></div></section><section id="urify-uri-construction" class="section"><div class="section-titlepage"><h4><bdi class="secno">8.9.4. </bdi>URI construction<a aria-label="§" class="self-link" href="#urify-uri-construction"></a></h4></div><div class="content"><p>The <a href="#f.urify"><code class="function">p:urify</code></a> result string is constructed from the features of the path (or the features of the path as resolved against the <em class="parameter"><code>$basedir</code></em>, if applicable) in the following way:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>Begin with an empty string.</p></li><li><p>If there is a scheme, append the scheme followed by a “:”.</p></li><li><p>If there is an authority, append “//” followed by the authority.</p><div class="itemizedlist"><ul><li><p>On a Windows system, if the scheme is known to be <code class="code">file</code> and the processor determines that the authority component is accessible via the universal naming convention (UNC), an additional “//” <span class="rfc2119" id="urify-uri-construction.3.3.2.1.1.2">may</span> be added before the authority. (In other words, <code class="code">file:////uncserver</code> is allowed.)</p></li></ul></div></li><li><p>If there is <em>not</em> an authority, but the scheme is “file” and the path is absolute,</p><div class="itemizedlist"><ul><li><p>Append “//”.</p></li><li><p>If there is a drive letter, append another “/”.</p></li></ul></div></li><li><p>If there is a drive letter, append the drive letter followed by a “:”.</p></li><li><p>Append the path.</p></li><li class="add_version" style="display: none;"><p>Append the suffix.</p></li><li class="modify_version"><p><span class="deltaxml-new" style="background:#90EE90">Append the suffix.</span></p></li></ol></div><p>The string constructed is the <a href="#f.urify"><code class="function">p:urify</code></a> result.</p></div></section></div></section><section id="f.function-library-importable" class="section"><div class="section-titlepage"><h3><bdi class="secno">8.10. </bdi>Function library importable<a aria-label="§" class="self-link" href="#f.function-library-importable"></a></h3></div><div class="content"><p>The <a href="#f.function-library-importable"><code class="function">p:function-library-importable</code></a> function reports whether or not function libraries of a particular type can be imported. </p><div class="funcsynopsis"><span class="funcname">p:function-library-importable</span><span class="funcparen">(</span><span class="paramname">$library-type</span><span class="typeas"> as </span><span class="type">xs:string</span><span class="funcparen">)</span><span class="typeas"> as </span><span class="type">xs:boolean</span></div><p>The <code class="varname">$library-type</code> string is interpreted as a content type. If the processor understands (<em class="foreignphrase">i.e.</em> if <a href="#p.import-functions"><code class="tag-element">p:import-functions</code></a> understands) how to load function libraries of that type, this function returns <code class="literal">true()</code>, otherwise it returns <code class="literal">false()</code>. </p><p>The <a href="#f.function-library-importable"><code class="function">p:function-library-importable</code></a> function behaves normally during static analysis.</p></div></section><section id="f.lookup-uri" class="section"><div class="section-titlepage"><h3><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">8.11. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Lookup URI</span><a aria-label="§" class="self-link" href="#f.lookup-uri"></a></h3></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">The </span><a href="#f.lookup-uri"><code class="function"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function attempts to determine what URI would be dereferenced if an attempt was made to retrieve a resource. </span></p><div class="funcsynopsis"><span class="funcname"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri</span></span><span class="funcparen"><span class="deltaxml-new" style="background:#90EE90">(</span></span><span class="paramname"><span class="deltaxml-new" style="background:#90EE90">$href</span></span><span class="typeas"><span class="deltaxml-new" style="background:#90EE90"> as </span></span><span class="type"><span class="deltaxml-new" style="background:#90EE90">xs:anyURI</span></span><span class="funcparen"><span class="deltaxml-new" style="background:#90EE90">)</span></span><span class="typeas"><span class="deltaxml-new" style="background:#90EE90"> as </span></span><span class="type"><span class="deltaxml-new" style="background:#90EE90">xs:anyURI</span></span></div><p><span class="deltaxml-new" style="background:#90EE90">Many systems employ some form of URI resolver. A URI resolver allows one resource to be substituted for another, perhaps loading </span><code class="uri"><span class="deltaxml-new" style="background:#90EE90">file:/system/xml/doc.rng</span></code><span class="deltaxml-new" style="background:#90EE90"> when </span><code class="uri"><span class="deltaxml-new" style="background:#90EE90">https://example.com/schemas/doc.rng</span></code><span class="deltaxml-new" style="background:#90EE90"> is requested. </span><span id="impl-18"><span class="deltaxml-new" style="background:#90EE90">It is </span><em class="glossterm"><a href="#dt-implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a></em><span class="deltaxml-new" style="background:#90EE90"> which kinds of URI resolvers a processor supports, if any, and how they are configured.</span></span></p><p><span class="deltaxml-new" style="background:#90EE90">If the processor has a URI resolver, the </span><a href="#f.lookup-uri"><code class="function"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function allows the pipeline to “peek” at what URI will be used in the request if an attempt is made to retrieve </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">$href</span></code><span class="deltaxml-new" style="background:#90EE90">. If the URI resolver maps </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">A.xml</span></code><span class="deltaxml-new" style="background:#90EE90"> to </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">B.xml</span></code><span class="deltaxml-new" style="background:#90EE90">, then </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri('A.xml')</span></code><span class="rfc2119" id="f.lookup-uri.5.6"><span class="deltaxml-new" style="background:#90EE90">should</span></span><span class="deltaxml-new" style="background:#90EE90"> return </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">B.xml</span></code><span class="deltaxml-new" style="background:#90EE90">.</span></p><p><span class="deltaxml-new" style="background:#90EE90">If the processor can’t determine what the mapping is (because the resolver being used doesn’t provide an API to do so, for example), or doesn’t support a resolver, the function </span><span class="rfc2119" id="f.lookup-uri.6.1"><span class="deltaxml-new" style="background:#90EE90">should</span></span><span class="deltaxml-new" style="background:#90EE90"> return the original URI.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The implementation </span><span class="rfc2119" id="f.lookup-uri.7.1"><span class="deltaxml-new" style="background:#90EE90">must not</span></span><span class="deltaxml-new" style="background:#90EE90"> attempt to dereference the resource in order to identify the mapping. Consequently, this function cannot determine if one or more server side redirects may occur and it has no insight into what caching proxies may be involved if the request accesses the network.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The </span><a href="#f.lookup-uri"><code class="function"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function behaves normally during static analysis but note that it is possible that a processor might use different resolvers at compile-time and run-time.</span></p></div></section><section id="other-xpath-extension-functions" class="section"><div class="section-titlepage"><h3><bdi class="secno"><span class="deltaxml-old" style="background:#FF5555">8.11. </span></bdi><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">8.12. </span></bdi>Other XPath Extension Functions<a aria-label="§" class="self-link" href="#other-xpath-extension-functions"></a></h3></div><div class="content"><p><span style="display: none;" class="delete_version"><span id="impl-18">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if the processor supports any other XPath extension functions.</span> Additional extension functions, if any, <span class="rfc2119" id="other-xpath-extension-functions.2.2">must not</span> use any of the XProc namespaces. </span><span style="display: none;" class="add_version"><span id="impl-19">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if the processor supports any other XPath extension functions.</span> Additional extension functions, if any, <span class="rfc2119" id="other-xpath-extension-functions.2.2">must not</span> use any of the XProc namespaces. </span><span class="modify_version"><span id="impl-19">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if the processor supports any other XPath extension functions.</span> Additional extension functions, if any, <span class="rfc2119" id="other-xpath-extension-functions.2.2">must not</span> use any of the XProc namespaces. </span></p><p><span style="display: none;" class="delete_version"><span id="impl-19">The value of the any other XPath extension functions during static analysis is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-20">The value of the any other XPath extension functions during static analysis is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-20">The value of the any other XPath extension functions during static analysis is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></div></section></div></section><section id="psvi-support" class="section"><div class="section-titlepage"><h2><bdi class="secno">9. </bdi>PSVIs in XProc<a aria-label="§" class="self-link" href="#psvi-support"></a></h2></div><div class="content"><p>XML documents flow between steps in an XProc pipeline. <a href="#infoset-conformance" title="Infoset Conformance">Section A.3, “Infoset Conformance”</a> identifies the properties of those documents that <span class="rfc2119" id="psvi-support.2.2">must</span> be available. Implementations <span class="rfc2119" id="psvi-support.2.3">may</span> also have the ability to pass PSVI annotations between steps.</p><p><span style="display: none;" class="delete_version"><span id="impl-20">Whether or not the pipeline processor supports passing PSVI annotations between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><span id="impl-21">The exact PSVI properties that are preserved when documents are passed between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-21">Whether or not the pipeline processor supports passing PSVI annotations between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><span id="impl-22">The exact PSVI properties that are preserved when documents are passed between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-21">Whether or not the pipeline processor supports passing PSVI annotations between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><span id="impl-22">The exact PSVI properties that are preserved when documents are passed between steps is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>A pipeline can use the <code class="varname">p:psvi-supported</code> system property to determine whether or not PSVI properties can be passed between steps.</p><p>A pipeline can assert that PSVI support is required with the <code class="tag-attribute">psvi-required</code> attribute:</p><div class="itemizedlist"><ul><li><p>On a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, <code class="tag-attribute">psvi-required</code> indicates whether or not the declared step requires PSVI support. <a id="err.inline.D0022"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0022"><code class="errqname">err:XD0022</code></a>) if a processor that does not support PSVI annotations attempts to invoke a step which asserts that they are required.</p></li><li><p>On a <a href="#p.library"><code class="tag-element">p:library</code></a>, the <code class="tag-attribute">psvi-required</code> attribute provides a default value for all of its <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a><em>children</em> that do not specify a value themselves.</p></li></ul></div><p>Many of the steps that an XProc pipeline can use are transformative in nature. The <code class="tag-element">p:delete</code> step, for example, can remove elements and attributes; the <code class="tag-element">p:label-elements</code> step can add attributes; etc. If PSVI annotations were always preserved, the use of such steps could result in documents that were inconsistent with their schema annotations.</p><p>In order to avoid these inconsistencies, most steps <span class="rfc2119" id="psvi-support.8.1">must not</span> produce PSVI annotated results even when PSVI passing is supported.</p><p>If PSVI passing is supported, the following constraints apply:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>Implementations <span class="rfc2119" id="psvi-support.10.1.1.1">must</span> faithfully transmit any PSVI properties produced on step outputs to the steps to which they are connected.</p></li><li><p>When only a subset of the input is processed by a step (because a <code class="tag-attribute">select</code> expression appears on an input port or a <code class="tag-attribute">match</code> expression is used to process only part of the input), any PSVI annotations that appear on the selected input <span class="rfc2119" id="psvi-support.10.2.1.3">must</span> be preserved in the resulting documents passed to the step.</p><p>Note that ID/IDREF constraints, and any other whole-document constraints, may not be satisfied within the selected portion, irrespective of what its PSVI properties claim.</p></li><li><p>If an output of a compound step is connected to an output which includes PSVI properties, those properties <span class="rfc2119" id="psvi-support.10.3.1.1">must</span> be preserved on the output of the compound step, <em>except</em> for the output of <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> which <span class="rfc2119" id="psvi-support.10.3.1.4">must not</span> contain any PSVI properties.</p></li><li><p>If an implementation supports XPath 2.0 or later, the data model constructed with which to evaluate XPath expressions and <em class="glossterm"><a href="#dt-selection-pattern">selection patterns</a></em><span class="rfc2119" id="psvi-support.10.4.1.2">should</span> take advantage of as much PSVI information as possible. </p><p><span id="dt-selection-pattern" class="termdef">[Definition: A <em class="glossterm">selection pattern</em> uses a subset of the syntax for path expressions, and is defined to match a node if the corresponding path expression would select the node. It is defined as in the <a href="https://www.w3.org/TR/xslt-30/#dt-selection-pattern">XSLT 3.0 specification</a>.]</span></p></li><li><p>All steps that explicitly behave like the <code class="tag-element">p:identity</code> step under some circumstances must preserve PSVI properties under those circumstances. In this specifications, those steps are <a href="#p.if"><code class="tag-element">p:if</code></a> when the condition is false and <a href="#p.choose"><code class="tag-element">p:choose</code></a> when no subpipline is selected.</p></li><li><p><span style="display: none;" class="delete_version">Except as specified above, or in the descriptions of individual steps, implementations <span class="rfc2119" id="psvi-support.10.6.1.1">must not</span> include PSVI properties in the outputs of steps. <span id="impl-22">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what PSVI properties, if any, are produced by extension steps.</span></span><span style="display: none;" class="add_version">Except as specified above, or in the descriptions of individual steps, implementations <span class="rfc2119" id="psvi-support.10.6.1.1">must not</span> include PSVI properties in the outputs of steps. <span id="impl-23">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what PSVI properties, if any, are produced by extension steps.</span></span><span class="modify_version">Except as specified above, or in the descriptions of individual steps, implementations <span class="rfc2119" id="psvi-support.10.6.1.1">must not</span> include PSVI properties in the outputs of steps. <span id="impl-23">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> what PSVI properties, if any, are produced by extension steps.</span></span></p></li></ol></div><div id="note-psvi" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>A processor that supports passing PSVI properties between steps is always free to do so. Even if <code class="code">psvi-required="false"</code> is explicitly specified, it is not an error for a step to produce a result that includes additional PSVI properties, provide it does not violate the constraints above.</p></div></div></div></section><section id="value-templates" class="section"><div class="section-titlepage"><h2><bdi class="secno">10. </bdi>Value Templates<a aria-label="§" class="self-link" href="#value-templates"></a></h2></div><div class="content"><p>An attribute or text node in a pipeline may, in particular circumstances, contain embedded expressions enclosed between curly brackets. Attributes and text nodes that use (or are permitted to use) this mechanism are referred to respectively as <em class="glossterm"><a href="#dt-attribute-value-template">attribute value templates</a></em> (AVTs) and <em class="glossterm"><a href="#dt-text-value-template">text value templates.</a></em> (TVTs).</p><p><span id="dt-value-template" class="termdef">[Definition: Collectively, attribute value templates and text value templates are referred to as <em class="glossterm">value templates</em>.]</span></p><p>A value template is a string that contains zero or more expressions delimited by curly brackets. Outside an expression, a doubled left or right curly bracket (“<code class="literal">{{</code>” or “<code class="literal">}}</code>”) represents a literal, single bracket and does not start or end an expression. Once an expression begins, it extends to the first unmatched right curly bracket that is not within a string literal or comment.</p><p>Value templates are not recursive. Curly brackets inside an expression are part of that expression and are not recognized as nested value templates.</p><p><a id="err.inline.S0066"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0066"><code class="errqname">err:XS0066</code></a>) if an expression does not have a closing right curly bracket or if an unescaped right curly bracket occurs outside of an expression. </p><p>It is a static error if the string contained between matching curly brackets in a value template, when interpreted as an XPath expression, contains errors. The error is signaled using the appropriate XPath error code.</p><p><a id="err.inline.D0050"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0050"><code class="errqname">err:XD0050</code></a>) if the XPath expression in a value template can not be evaluated. </p><p><a id="err.inline.D0051"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0051"><code class="errqname">err:XD0051</code></a>) if the XPath expression in an AVT or TVT evaluates to something to other than a sequence containing atomic values or nodes. Function, array and map items are explicitly excluded here because they do not have a string representation. </p><p>A value template that contains a reference to the context item reads that context item from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. This establishes a connection between the two steps. <a id="err.inline.D0065"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0065"><code class="errqname">err:XD0065</code></a>) to refer to the context item, size, or position in a value template if a sequence of documents appears on the default readable port. Value templates that do not contain a reference to the context item do not establish a connection to another step and do not require that a <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is available.</p><section id="attribute-value-templates" class="section"><div class="section-titlepage"><h3><bdi class="secno">10.1. </bdi>Attribute Value Templates<a aria-label="§" class="self-link" href="#attribute-value-templates"></a></h3></div><div class="content"><p><span id="dt-attribute-value-template" class="termdef">[Definition: In an attribute that is designated as an <em class="glossterm">attribute value template</em>, an expression can be used by surrounding the expression with curly brackets (<code class="code">{}</code>), following the general rules for <em class="glossterm"><a href="#dt-value-template">value templates</a></em>]</span>.</p><p><span style="display: none;" class="delete_version">Curly brackets are not treated specially in an attribute value in an XProc pipeline unless the attribute is specifically designated as one that permits an attribute value template. Option shortcuts permit attribute value templates. <span id="impl-23">Whether or not an extension attribute permits attribute value templates is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In element syntax summaries in this specification, the value of an attribute that allows attribute value templates is surrounded by curly brackets.</span><span style="display: none;" class="add_version">Curly brackets are not treated specially in an attribute value in an XProc pipeline unless the attribute is specifically designated as one that permits an attribute value template. Option shortcuts permit attribute value templates. <span id="impl-24">Whether or not an extension attribute permits attribute value templates is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In element syntax summaries in this specification, the value of an attribute that allows attribute value templates is surrounded by curly brackets.</span><span class="modify_version">Curly brackets are not treated specially in an attribute value in an XProc pipeline unless the attribute is specifically designated as one that permits an attribute value template. Option shortcuts permit attribute value templates. <span id="impl-24">Whether or not an extension attribute permits attribute value templates is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In element syntax summaries in this specification, the value of an attribute that allows attribute value templates is surrounded by curly brackets.</span></p><p>An attribute value template can be seen as an alternating sequence of zero or more “fixed” (non-expression) parts and expression parts.</p><p>The result of the attribute value template is the concatenation of the fixed parts and the string-value of the result of evaluating each expression part.</p><div id="note-dynerr" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>This process can generate dynamic errors, for example if the sequence contains an element with a complex content type (which cannot be atomized).</p></div></div><p>The value of an attribute that contains attribute value templates is a single string (the concatenation of the string values of the evaluated templates and non-template parts) as an <code class="type">xs:untypedAtomic</code>.</p></div></section><section id="text-value-templates" class="section"><div class="section-titlepage"><h3><bdi class="secno">10.2. </bdi>Text Value Templates<a aria-label="§" class="self-link" href="#text-value-templates"></a></h3></div><div class="content"><p><span id="dt-text-value-template" class="termdef">[Definition: In a text node that is designated as a <em class="glossterm">text value template</em>, expressions can be used by surrounding each expression with curly brackets (<code class="code">{}</code>), following the general rules for <em class="glossterm"><a href="#dt-value-template">value templates</a></em>.]</span></p><p>Text nodes that are descendants of a <a href="#p.inline"><code class="tag-element">p:inline</code></a> and text nodes that are descendants of an element node in an implicit inline may be text value templates. No other text node is a text value template.</p><p>Whether or not a text node that may be a text value template is designated one is determined by <code class="code">expand-text</code> and <code class="code">p:inline-expand-text</code> attributes, see <a href="#expand-text-attribute" title="Expand text attributes">Section 14.9.1, “Expand text attributes”</a>.</p><p>A text value template can be seen as an alternating sequence of zero or more “fixed” (non-expression) parts and expression parts.</p><p>This produces a sequence of strings (the fixed parts) and items (the results of evaluating each expression). Any items that are non-string atomic values are converted to strings by taking their string value. Strings are converted into text nodes.</p><p>The result of the text value template is this sequence of nodes.</p><div id="unlike-xslt-tvts" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>Unlike XSLT, in XProc, text value templates are not atomized and converted to single text nodes. It is possible to insert nodes with text value templates in XProc, for example, if the XPath expressions refer to variables that have node content.</p></div></div><p>If a node to be inserted with a text value template is a document node, all the children of the document node are inserted.</p><p>How the nodes are inserted depends on the content type of the <a href="#p.inline"><code class="tag-element">p:inline</code></a>.</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If the content type is an <em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em> or an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>, the nodes are added to the XML document where they occur. This is analogous to the way element constructors work in [<a href="#xquery10"><span class="abbrev">XQuery 1.0</span></a>]. </p><p>If the node is an attribute it is added to an element parent if and only if the attribute either has no preceding nodes in the sequence of nodes or has only attributes as preceding nodes. <a id="err.inline.D0052"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0052"><code class="errqname">err:XD0052</code></a>) if the XPath expression in a TVT evaluates to an attribute and either the parent is not an element or the attribute has a preceding node that it not an attribute. </p></li><li><p>If the content type is not an <em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em> or an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>, each text value template is replaced by the concatenation of the serialization of the nodes that result from evaluating the template.</p><p><span class="deltaxml-old" style="background:#FF5555">This serialization is performed with the following serialization parameters:</span></p><figure id="text-value-templates.11.2.3" class="informaltable-wrapper"><div class="informaltable"><table border="0" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">Parameter</span></th><th style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">Value</span></th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">byte-order-mark</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">cdata-section-elements</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">()</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">doctype-public</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">()</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">doctype-system</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">()</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">encoding</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">“utf-8”</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">escape-uri-attributes</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">include-content-type</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">indent</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">media-type</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">“application/xml”</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">method</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">“xml”</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">normalization-form</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">()</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">omit-xml-declaration</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">true</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">standalone</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">undeclare-prefixes</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">use-character-maps</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-old" style="background:#FF5555">()</span></td></tr><tr><td style="border-right: 1px solid ; "><code class="option"><span class="deltaxml-old" style="background:#FF5555">version</span></code></td><td><span class="deltaxml-old" style="background:#FF5555">1.0</span></td></tr></tbody></table></div></figure><div class="important admonition"><h3><span class="deltaxml-new" style="background:#90EE90">Important</span></h3><div class="admonition-body"><p><span class="deltaxml-new" style="background:#90EE90">This is a </span><em><span class="deltaxml-new" style="background:#90EE90">backwards incompatible</span></em><span class="deltaxml-new" style="background:#90EE90"> change from XProc 3.0 where the “</span><code class="literal"><span class="deltaxml-new" style="background:#90EE90">xml</span></code><span class="deltaxml-new" style="background:#90EE90">” serialization method was specified. Using the XML serialization, it was very difficult to get un-escaped markup into text content. Although, as the examples showed, it could be useful for JSON content, even that was unlikely to work in the general case because of problems with attribute value quotation.</span></p></div></div></li></ol></div><p><span class="deltaxml-new" style="background:#90EE90">This serialization is performed with the following serialization parameters:</span></p><figure id="text-value-templates.13" class="informaltable-wrapper"><div class="informaltable"><table border="0" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">Parameter</span></th><th style="border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">Value</span></th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-new" style="background:#90EE90">byte-order-mark</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">false</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-new" style="background:#90EE90">encoding</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">“utf-8”</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-new" style="background:#90EE90">media-type</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">“text/plain”</span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "><code class="option"><span class="deltaxml-new" style="background:#90EE90">method</span></code></td><td style="border-bottom: 1px solid ; "><span class="deltaxml-new" style="background:#90EE90">“text”</span></td></tr><tr><td style="border-right: 1px solid ; "><code class="option"><span class="deltaxml-new" style="background:#90EE90">item-separator</span></code></td><td><span class="deltaxml-new" style="background:#90EE90">“ ” (a single space)</span></td></tr></tbody></table></div></figure><p><span id="impl-25"><span class="deltaxml-new" style="background:#90EE90">Any other text output parameters used when serializing a text value template are </span><em class="glossterm"><a href="#dt-implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a></em><span class="deltaxml-new" style="background:#90EE90">.</span></span><a id="err.inline.D0052.1"></a><span class="deltaxml-new" style="background:#90EE90">It is a </span><em class="glossterm"><a href="#dt-dynamic-error"><span class="deltaxml-new" style="background:#90EE90">dynamic error</span></a></em><span class="deltaxml-new" style="background:#90EE90"> (</span><a href="#err.D0052"><code class="errqname"><span class="deltaxml-new" style="background:#90EE90">err:XD0052</span></code></a><span class="deltaxml-new" style="background:#90EE90">) if the XPath expression in a TVT evaluates to an attribute node when the content type is not an </span><em class="glossterm"><a href="#dt-XML-media-type"><span class="deltaxml-new" style="background:#90EE90">XML media type</span></a></em><span class="deltaxml-new" style="background:#90EE90"> or an </span><em class="glossterm"><a href="#dt-HTML-media-type"><span class="deltaxml-new" style="background:#90EE90">HTML media type</span></a></em><span class="deltaxml-new" style="background:#90EE90">. </span></p><p>Interpretation of the character content of the <a href="#p.inline"><code class="tag-element">p:inline</code></a> according to the media type occurs after text value templates have been replaced.</p><section id="text-value-templates.13" class="simplesect"><div class="section-titlepage"><h4><span class="deltaxml-old" style="background:#FF5555">Examples</span></h4></div><div class="content"><p><span class="deltaxml-old" style="background:#FF5555">Consider the following examples. In each case:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-old" style="background:#FF5555">The variable </span><code class="code"><span class="deltaxml-old" style="background:#FF5555">$name</span></code><span class="deltaxml-old" style="background:#FF5555"> is bound to the following XML element:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555"> &lt;name&gt;&lt;given&gt;Mary&lt;/given&gt; &lt;surname&gt;Smith&lt;/surname&gt;&lt;/name&gt;</span></code></pre></li><li><p><span class="deltaxml-old" style="background:#FF5555">The result of evaluating the text value template “</span><code class="code"><span class="deltaxml-old" style="background:#FF5555">{$name/node()}</span></code><span class="deltaxml-old" style="background:#FF5555">” is a sequence of three nodes, the given name element, a text node containing a single space, and the surname element.</span></p></li></ul></div><p><span class="deltaxml-old" style="background:#FF5555">If the media type is an XML media type:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555"> &lt;p:inline content-type="application/xml"&gt; &lt;attribution&gt;{$name/node()}&lt;/attribution&gt; &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-old" style="background:#FF5555">the result is that sequence of nodes:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555"> &lt;attribution&gt;&lt;given&gt;Mary&lt;/given&gt; &lt;surname&gt;Smith&lt;/surname&gt;&lt;/attribution&gt;</span></code></pre><p><span class="deltaxml-old" style="background:#FF5555">If the media type is not an XML media type:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555"> &lt;p:inline content-type="application/json"&gt; {{ "name": "{$name/node()}" }} &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-old" style="background:#FF5555">the result is the concatenation of the serialization of the nodes:</span></p><pre class="programlisting language-javascript javascript"><code><span class="deltaxml-old" style="background:#FF5555"> { "name": "&lt;given&gt;Mary&lt;/given&gt; &lt;surname&gt;Smith&lt;/surname&gt;" }</span></code></pre><p><span class="deltaxml-old" style="background:#FF5555">If the string value is desired, instead of escaped markup, write the expression such that it returns the string values:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555"> &lt;p:inline content-type="application/json"&gt; {{ "name": "{$name/node()/string()}" }} &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-old" style="background:#FF5555">To produce:</span></p><pre class="programlisting language-javascript javascript"><code><span class="deltaxml-old" style="background:#FF5555"> { "name": "Mary Smith" }</span></code></pre></div></section><section id="text-value-templates.16" class="simplesect"><div class="section-titlepage"><h4><span class="deltaxml-new" style="background:#90EE90">Examples</span></h4></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">Consider the following examples. In each case:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">The variable </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">$name</span></code><span class="deltaxml-new" style="background:#90EE90"> is bound to the following XML element:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;name&gt;&lt;given&gt;Mary&lt;/given&gt; &lt;surname&gt;Smith&lt;/surname&gt;&lt;/name&gt;</span></code></pre></li><li><p><span class="deltaxml-new" style="background:#90EE90">The result of evaluating the text value template “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">{$name/node()}</span></code><span class="deltaxml-new" style="background:#90EE90">” is a sequence of three nodes, the given name element, a text node containing a single space, and the surname element.</span></p></li></ul></div><p><span class="deltaxml-new" style="background:#90EE90">If the media type is an XML media type:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:inline content-type="application/xml"&gt; &lt;attribution&gt;{$name/node()}&lt;/attribution&gt; &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">the result is that sequence of nodes:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;attribution&gt;&lt;given&gt;Mary&lt;/given&gt; &lt;surname&gt;Smith&lt;/surname&gt;&lt;/attribution&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">If the media type is not an XML media type:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:inline content-type="application/json"&gt; {{ "name": "{$name/node()}" }} &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">the result is the concatenation of the text serialization of the nodes:</span></p><pre class="programlisting language-javascript javascript"><code><span class="deltaxml-new" style="background:#90EE90">{ "name": "Mary Smith" }</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">If the XML value with escaped markup is desired, use explicit serialization:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:inline content-type="application/json"&gt; {{ "name": "{ replace( serialize($name/node(), map{'method':'xml'}), '&amp;quot;', '\\&amp;quot;')}" }} &lt;/p:inline&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">To produce:</span></p><pre class="programlisting language-javascript javascript"><code><span class="deltaxml-new" style="background:#90EE90">{"name":"&lt;given&gt;Mary&lt;\/given&gt; &lt;surname&gt;Smith&lt;\/surname&gt;"}</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">Although it isn’t necessary in this example, note the special care being take to make sure that an unescaped literal “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">"</span></code><span class="deltaxml-new" style="background:#90EE90">” does not appear in the serialization. Interpretation of the content as JSON occurs after the value template has been expanded. If the serialization contains an unescaped double quote character, the result will be invalid JSON: </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">{"name": " … " … "}</span></code><span class="deltaxml-new" style="background:#90EE90">.</span></p></div></section></div></section></div></section><section id="variables-options-background" class="section"><div class="section-titlepage"><h2><bdi class="secno">11. </bdi>Variables and Options<a aria-label="§" class="self-link" href="#variables-options-background"></a></h2></div><div class="content"><section id="variables" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.1. </bdi>Variables<a aria-label="§" class="self-link" href="#variables"></a></h3></div><div class="content"><p>Pipeline authors can create variables to hold computed values.</p><p><span id="dt-variable" class="termdef">[Definition: A <em class="glossterm">variable</em> is a name/value pair. The name <span class="rfc2119" id="dt-variable.2">must</span> be an <a href="http://www.w3.org/TR/REC-xml-names/#dt-expname">expanded name</a>. The value may be any XPath data model value.]</span> Variable names are always expressed as literal values, pipelines cannot construct variable names dynamically. </p><p>The names of variables and options are not distinct and are lexically scoped. <span id="dt-shadow" class="termdef">[Definition: We say that a variable <em class="glossterm">shadows</em> another variable (or option) if it has the same name and appears later in the same lexical scope.]</span></p><p>Consider this pipeline:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:xs="http://www.w3.org/2001/XMLSchema" version="3.0"&gt; &lt;p:option name="bname" as="xs:integer" select="1"/&gt; &lt;p:identity message="NAME1={$bname}"&gt; &lt;p:with-input port="source"&gt; &lt;p:empty/&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;p:variable name="bname" select="$bname + 1"/&gt; &lt;p:identity message="NAME2={$bname}"/&gt; &lt;p:variable name="bname" select="7"/&gt; &lt;p:identity message="NAME3={$bname}"/&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:xs="http://www.w3.org/2001/XMLSchema" version="3.1"&gt; &lt;p:option name="bname" as="xs:integer" select="1"/&gt; &lt;p:identity message="NAME1={$bname}"&gt; &lt;p:with-input port="source"&gt; &lt;p:empty/&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;p:variable name="bname" select="$bname + 1"/&gt; &lt;p:identity message="NAME2={$bname}"/&gt; &lt;p:variable name="bname" select="7"/&gt; &lt;p:identity message="NAME3={$bname}"/&gt; &lt;/p:declare-step&gt;</span></code></pre><p>If no overriding value is provided for <code class="varname">$bname</code> at runtime, the pipeline will produce three messages: “NAME1=1”, “NAME2=2”, and “NAME3=7”. (If an overriding value is provided at runtime, “NAME1” will have that value, “NAME2” will have one more than that value, and “NAME3” will have the value 7. </p></div></section><section id="options" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.2. </bdi>Options<a aria-label="§" class="self-link" href="#options"></a></h3></div><div class="content"><p>Some steps accept options. The value of an option is the default value specified in its declaration, or a value provided by the caller of the step (overriding the default). If it has neither a default value nor a provided value, its value is the empty sequence.</p><p><span id="dt-option" class="termdef">[Definition: An <em class="glossterm">option</em> is a name/value pair. The name <span class="rfc2119" id="dt-option.2">must</span> be an <a href="http://www.w3.org/TR/REC-xml-names/#dt-expname">expanded name</a>. The value may be any XPath data model value.]</span> Option names are always expressed as literal values, pipelines cannot construct option names dynamically. </p><p><span style="display: none;" class="delete_version"><span id="impl-24">How outside values are specified for pipeline options on the pipeline initially invoked by the processor is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In other words, the command line options, APIs, or other mechanisms available to specify such options values are outside the scope of this specification.</span><span style="display: none;" class="add_version"><span id="impl-26">How outside values are specified for pipeline options on the pipeline initially invoked by the processor is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In other words, the command line options, APIs, or other mechanisms available to specify such options values are outside the scope of this specification.</span><span class="modify_version"><span id="impl-26">How outside values are specified for pipeline options on the pipeline initially invoked by the processor is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> In other words, the command line options, APIs, or other mechanisms available to specify such options values are outside the scope of this specification.</span></p><p>Some steps require a set of name/value pairs for the operations they perform. For example, an XSLT stylesheet might have required parameters or an XQuery query might have external variables. In the XProc Step Library, the standard way to pass such values to the step is to use an option named “<code class="literal">parameters</code>” whose value is a map.</p></div></section><section id="statics" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.3. </bdi>Static Options<a aria-label="§" class="self-link" href="#statics"></a></h3></div><div class="content"><p><span class="deltaxml-old" style="background:#FF5555">A </span><a href="#p.option"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:option</span></code></a><span class="deltaxml-old" style="background:#FF5555"> may be declared “static”; options declared within a </span><a href="#p.library"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:library</span></code></a><span class="rfc2119" id="statics.2.3"><span class="deltaxml-old" style="background:#FF5555">must</span></span><span class="deltaxml-old" style="background:#FF5555"> be static.</span></p><p><span style="display: none;" class="delete_version"><a id="err.inline.S0109"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0109"><code class="errqname">err:XS0109</code></a>) if options that are the direct children of <a href="#p.library"><code class="tag-element">p:library</code></a> are not declared “static”.</span><span style="display: none;" class="add_version">A <a href="#p.option"><code class="tag-element">p:option</code></a> may be declared “static”; options declared within a <a href="#p.library"><code class="tag-element">p:library</code></a><span class="rfc2119" id="statics.2.3">must</span> be static. <a id="err.inline.S0109"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0109"><code class="errqname">err:XS0109</code></a>) if options that are the direct children of <a href="#p.library"><code class="tag-element">p:library</code></a> are not declared “static”.</span><span class="modify_version"><span class="deltaxml-new" style="background:#90EE90">A </span><a href="#p.option"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:option</span></code></a><span class="deltaxml-new" style="background:#90EE90"> may be declared “static”; options declared within a </span><a href="#p.library"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:library</span></code></a><span class="rfc2119" id="statics.2.3"><span class="deltaxml-new" style="background:#90EE90">must</span></span><span class="deltaxml-new" style="background:#90EE90"> be static. </span><a id="err.inline.S0109"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0109"><code class="errqname">err:XS0109</code></a>) if options that are the direct children of <a href="#p.library"><code class="tag-element">p:library</code></a> are not declared “static”.</span></p><p>The values of static options are computed during <a href="#initiating">static analysis</a>.<span class="deltaxml-new" style="background:#90EE90"> Consequently, expressions which initialize static options may not refer to the context item, variables, or other options that are not static.</span></p><p><span class="deltaxml-old" style="background:#FF5555">XProc defines a single, global scope for static options. Every static option must have exactly one in-scope declaration.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Every static option must have exactly one in-scope declaration. </span><a id="err.inline.S0088"></a><span class="deltaxml-new" style="background:#90EE90">It is a </span><em class="glossterm"><a href="#dt-static-error"><span class="deltaxml-new" style="background:#90EE90">static error</span></a></em><span class="deltaxml-new" style="background:#90EE90"> (</span><a href="#err.S0088"><code class="errqname"><span class="deltaxml-new" style="background:#90EE90">err:XS0088</span></code></a><span class="deltaxml-new" style="background:#90EE90">) if the qualified name of a static option </span><em class="glossterm"><a href="#dt-shadow"><span class="deltaxml-new" style="background:#90EE90">shadows</span></a></em><span class="deltaxml-new" style="background:#90EE90"> the name of another static option or a variable.</span></p><p><span class="deltaxml-new" style="background:#90EE90">It is not an error if two static options with the same name appear in different scopes, but it is not good practice. Bear in mind, for example, that if the implementation provides a mechanism for specifying default values for static options at compile time, the value provided for any option must satisfy the type specified on every static option declaration with that name. Any mechanism for specifying default values for static options applies equally to options whether they are public or private.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Libraries that define static options, especially private ones, are encouraged to use namespaces so that collision with the names of options in the calling pipeline, or other imported libraries are unlikely.</span></p></div></section><section id="varopt-types" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.4. </bdi>Variable and option types<a aria-label="§" class="self-link" href="#varopt-types"></a></h3></div><div class="content"><p>Variables and options may declare that they have a type using the <code class="tag-attribute">as</code> attribute. The attribute value <span class="rfc2119" id="varopt-types.2.2">must</span> be an [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>] <a href="https://www.w3.org/TR/xpath-31/#dt-sequence-type">sequence type</a>. <a id="err.inline.S0096"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0096"><code class="errqname">err:XS0096</code></a>) if the sequence type is not syntactically valid. The sequence type <code class="literal">item()*</code> is assumed if no explicit type is provided. </p><p>If a variable or option declares a type, the supplied value of the variable or option is converted to the required type, using the function conversion rules specified by XPath 3.1. <a id="err.inline.D0036"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0036"><code class="errqname">err:XD0036</code></a>) if the supplied or defaulted value of a variable or option cannot be converted to the required type.</p></div></section><section id="implicit-casting" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.5. </bdi>Implicit casting<a aria-label="§" class="self-link" href="#implicit-casting"></a></h3></div><div class="content"><p>For the most part, the rules for casting between types in XPath work the way authors expect. You can type “3” for a decimal, you don’t have to type “3.0”, and an untyped atomic value, for example in an attribute such as <code class="code">limit="3"</code>, is implicitly cast to a number if that’s the required type. You don’t have to type <code class="code">limit="{xs:integer(3)}"</code>.</p><p>Unfortunately, there are two common cases in XProc that are not handled by the XPath conversion rules: conversions from strings to QNames or URIs. (Technically, conversions from <code class="type">xs:untypedAtomic</code> or <code class="type">xs:string</code>, or from types derived from <code class="type">xs:string</code>, values to <code class="type">xs:QName</code> or <code class="type">xs:anyURI</code> values.) XProc defines additional implicit casting rules for the case where an expression is evaluated to provide the value of a variable or option. (These are not extensions to the XPath rules in the general case and do not apply in arbitrary expressions.)</p><section id="qname-handling" class="section"><div class="section-titlepage"><h4><bdi class="secno">11.5.1. </bdi>Special rules for casting QNames<a aria-label="§" class="self-link" href="#qname-handling"></a></h4></div><div class="content"><p>Some steps have options whose values are QNames, for example “<code class="tag-attribute">attribute-name</code>” on <code class="tag-element">p:add-attribute</code>. If the type <code class="type">xs:QName</code> was strictly enforced, they would be tedious to specify. As a convenience for pipeline authors, the values of variables or options declared with the type <code class="type">xs:QName</code> are processed specially. The type <code class="type">xs:QName</code> is treated as <code class="type">xs:anyAtomicType</code> for the purpose of atomization. The value (or values) are converted to <code class="type">xs:QName</code>s:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If the value supplied for the option is an instance of <code class="type">xs:QName</code> then that value is used. </p></li><li><p>If the value supplied for the option is an instance of <code class="type">xs:untypedAtomic</code> or <code class="type">xs:string</code> (or a type derived from <code class="type">xs:string</code>), the QName is constructed by following the <a href="https://www.w3.org/TR/xpath-31/#doc-xpath31-EQName">EQName production rules</a> in [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>]. That is, it can be written as a local-name only, as a prefix plus local-name, or as a URI qualified name (using the <code class="code">Q{namespace}local-name</code> syntax). If it is written as local-name only, the constructed QName will not have a namespace URI, i.e. the default namespace is not applied here. <a id="err.inline.D0061.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0061"><code class="errqname">err:XD0061</code></a>) if the string value is not syntactically an EQName. <a id="err.inline.D0069"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0069"><code class="errqname">err:XD0069</code></a>) if the string value contains a colon and the designated prefix is not declared in the in-scope namespaces. </p></li><li><p><a id="err.inline.D0068"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0068"><code class="errqname">err:XD0068</code></a>) if the supplied value is not an instance of <code class="type">xs:QName</code>, <code class="type">xs:anyAtomicType</code>, <code class="type">xs:string</code> or a type derived from <code class="type">xs:string</code>. </p></li></ol></div><p>As an additional convenience, if the specified sequence type of an option or a variable is a map with <code class="type">xs:QName</code> keys (<code class="type">map(xs:QName, …)</code>), the supplied map value is processed specially. This makes it possible to pass in maps using (easier to write) <code class="type">xs:string</code> type keys that are converted automatically into the required <code class="type">xs:QName</code> keys.</p><p>Every key/value pair in a map supplied to a variable or an option with sequence type <code class="type">map(xs:QName, …)</code> is processed as follows:</p><div class="itemizedlist"><ul><li><p>If the entry’s key is of type <code class="type">xs:QName</code>, the entry is left unchanged.</p></li><li><p>If the entry’s key is an instance of type <code class="type">xs:untypedAtomic</code> or <code class="type">xs:string</code> (or a type derived from <code class="type">xs:string</code>) it is transformed into an <code class="type">xs:QName</code> using the <a href="https://www.w3.org/TR/xpath-31/#doc-xpath31-EQName">XPath EQName production rules</a> as described above.</p></li><li><p>If the entry’s key is of any other type, the entry is ignored and will be removed from the map.</p></li></ul></div></div></section><section id="handling-uris" class="section"><div class="section-titlepage"><h4><bdi class="secno">11.5.2. </bdi>Special rules for casting URIs<a aria-label="§" class="self-link" href="#handling-uris"></a></h4></div><div class="content"><p>Many steps have options whose values are <code class="type">xs:anyURI</code> values, for example “<code class="tag-attribute">href</code>” on <code class="tag-element">p:http-request</code>. If the type <code class="type">xs:anyURI</code> was strictly enforced, they would be tedious to specify. As a convenience for pipeline authors, the values of variables or options declared with the type <code class="type">xs:anyURI</code> are processed specially. The value (or values) are converted to <code class="type">xs:anyURI</code>s:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If the value supplied for the option is an instance of <code class="type">xs:anyURI</code> then that value is used. </p></li><li><p>If the value supplied for the option is an instance of <code class="type">xs:untypedAtomic</code> or <code class="type">xs:string</code> (or a type derived from <code class="type">xs:string</code>), the <code class="type">xs:anyURI</code> is constructed by casting the value to an <code class="type">xs:anyURI</code>. </p></li></ol></div><p><span style="display: none;" class="delete_version">The XPath rules for casting string values to URIs apply: <span id="impl-25">The extent to which an implementation validates the lexical form of the <code class="type">xs:anyURI</code> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">The XPath rules for casting string values to URIs apply: <span id="impl-27">The extent to which an implementation validates the lexical form of the <code class="type">xs:anyURI</code> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">The XPath rules for casting string values to URIs apply: <span id="impl-27">The extent to which an implementation validates the lexical form of the <code class="type">xs:anyURI</code> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></div></section></div></section><section id="opt-bindings" class="section"><div class="section-titlepage"><h3><bdi class="secno">11.6. </bdi>Namespaces on variables and options<a aria-label="§" class="self-link" href="#opt-bindings"></a></h3></div><div class="content"><p>Variable and option values carry with them not only their literal or computed value but also a set of namespaces. To see why this is necessary, consider the following step:</p><pre class="programlisting language-markup xml"><code>&lt;p:delete xmlns:p="http://www.w3.org/ns/xproc"&gt; &lt;p:with-option name="match" select="'html:div'" xmlns:html="http://www.w3.org/1999/xhtml"/&gt; &lt;/p:delete&gt;</code></pre><p>The <code class="tag-element">p:delete</code> step will delete elements that match the expression “<code class="literal">html:div</code>”, but that expression can only be correctly interpreted if there’s a namespace binding for the prefix “<code class="literal">html</code>” so that binding has to travel with the option.</p><p>The default namespace bindings associated with a variable or option value are computed as follows:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If the <code class="tag-attribute">select</code> attribute was used to specify the value and it consisted of a single <code class="literal">VariableReference</code> (per [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>]), then the namespace bindings from the referenced option or variable are used.</p></li><li><p>If the <code class="tag-attribute">select</code> attribute was used to specify the value and it evaluated to a node-set, then the in-scope namespaces from the first node in the selected node-set (or, if it’s not an element, its parent) are used.</p><p>The expression is evaluated in the appropriate context, See <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>.</p></li><li><p>Otherwise, the in-scope namespaces from the element providing the value are used. (For options specified using <a href="#option-shortcut">syntactic shortcuts</a>, the step element itself is providing the value.)</p></li></ol></div><p>The default namespace is never included in the namespace bindings for a variable or option value. Unqualified names are always in no-namespace.</p><p>Unfortunately, in more complex situations, there may be no single variable or option that can reliably be expected to have the correct set of namespace bindings. Consider this pipeline:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:ex="http://example.org/ns/ex" xmlns:h="http://www.w3.org/1999/xhtml" type="ex:delete-in-div" version="3.0"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:option name="divchild" required="true"/&gt; &lt;p:delete&gt; &lt;p:with-option name="match" select="concat('h:div/',$divchild)"/&gt; &lt;/p:delete&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:ex="http://example.org/ns/ex" xmlns:h="http://www.w3.org/1999/xhtml" type="ex:delete-in-div" version="3.1"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:option name="divchild" required="true"/&gt; &lt;p:delete&gt; &lt;p:with-option name="match" select="concat('h:div/',$divchild)"/&gt; &lt;/p:delete&gt; &lt;/p:declare-step&gt;</span></code></pre><p>It defines an atomic step (“<code class="literal">ex:delete-in-div</code>”) that deletes elements that occur inside of XHTML div elements. It might be used as follows:</p><pre class="programlisting language-markup xml"><code>&lt;ex:delete-in-div xmlns:p="http://www.w3.org/ns/xproc" xmlns:ex="http://example.org/ns/ex" xmlns:html="http://www.w3.org/1999/xhtml" divchild="html:p[@class='delete']"/&gt;</code></pre><p>In this case, the <code class="varname">match</code> option passed to the <code class="tag-element">p:delete</code> step needs <em>both</em> the namespace binding of “<code class="literal">h</code>” specified in the <code class="tag-element">ex:delete-in-div</code> pipeline definition <em>and</em> the namespace binding of “<code class="literal">html</code>” specified in the <code class="varname">divchild</code> option on the call of that pipeline. It’s not sufficient to provide just one of the sets of bindings.</p><p>If pipeline authors cannot arrange for all of the necessary namespace bindings to be in scope, then EQNames can be used to remove the dependency on namespace bindings:</p><pre class="programlisting language-markup xml"><code>&lt;ex:delete-in-div xmlns:p="http://www.w3.org/ns/xproc" xmlns:ex="http://example.org/ns/ex" divchild="q{http://www.w3.org/1999/xhtml}p[@class='delete']"/&gt;</code></pre><p>In this example, the expression will match “<code class="literal">p</code>” elements in the XHTML namespace irrespective of any bindings that may or may not be in scope.</p></div></section></div></section><section id="security-considerations" class="section"><div class="section-titlepage"><h2><bdi class="secno">12. </bdi>Security Considerations<a aria-label="§" class="self-link" href="#security-considerations"></a></h2></div><div class="content"><p>An XProc pipeline may attempt to access arbitrary network resources: steps such as <code class="tag-element">p:load</code> and <code class="tag-element">p:http-request</code> can attempt to read from an arbitrary URI; steps such as <code class="tag-element">p:store</code> can attempt to write to an arbitrary location; <code class="tag-element">p:exec</code> can attempt to execute an arbitrary program. Note, also, that some steps, such as <code class="tag-element">p:xslt</code> and <code class="tag-element">p:xquery</code>, include extension mechanisms which may attempt to execute arbitrary code. </p><p>In some environments, it may be inappropriate to provide the XProc pipeline with access to these resources. In a server environment, for example, it may be impractical to allow pipelines to store data. In environments where the pipeline cannot be trusted, allowing the pipeline to access arbitrary resources or execute arbitrary code may be a security risk.</p><p><span style="display: none;" class="delete_version"><a id="err.inline.D0021"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0021"><code class="errqname">err:XD0021</code></a>) for a pipeline to attempt to access a resource for which it has insufficient privileges or perform a step which is forbidden. <span id="impl-26">Which steps are forbidden, what privileges are needed to access resources, and under what circumstances these security constraints apply is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><a id="err.inline.D0021"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0021"><code class="errqname">err:XD0021</code></a>) for a pipeline to attempt to access a resource for which it has insufficient privileges or perform a step which is forbidden. <span id="impl-28">Which steps are forbidden, what privileges are needed to access resources, and under what circumstances these security constraints apply is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><a id="err.inline.D0021"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0021"><code class="errqname">err:XD0021</code></a>) for a pipeline to attempt to access a resource for which it has insufficient privileges or perform a step which is forbidden. <span id="impl-28">Which steps are forbidden, what privileges are needed to access resources, and under what circumstances these security constraints apply is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p><p>Steps in a pipeline may call themselves recursively which could result in pipelines which will never terminate.</p><p>A conformant XProc processor may limit the resources available to any or all steps in a pipeline. A conformant implementation may raise dynamic errors, or take any other corrective action, for any security problems that it detects.</p></div></section><section id="versioning-considerations" class="section"><div class="section-titlepage"><h2><bdi class="secno">13. </bdi>Versioning Considerations<a aria-label="§" class="self-link" href="#versioning-considerations"></a></h2></div><div class="content"><p><span style="display: none;" class="delete_version">A pipeline author <span class="rfc2119" id="versioning-considerations.2.1">may</span> identify the version of XProc for which a particular pipeline was authored by setting the <code class="tag-attribute">version</code> attribute. The <code class="tag-attribute">version</code> attribute can be specified on <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a>. If specified, the value of the <code class="tag-attribute">version</code> attribute <span class="rfc2119" id="versioning-considerations.2.7">must</span> be a <code class="type">xs:decimal</code>. <a id="err.inline.S0063"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0063"><code class="errqname">err:XS0063</code></a>) if the value of the <code class="tag-attribute">version</code> attribute is not a <code class="type">xs:decimal</code>.</span><span style="display: none;" class="add_version">Pipelines identify the version of XProc they are authored against with the <code class="tag-attribute">version</code> attribute. The <code class="tag-attribute">version</code> attribute can be specified on <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a>. If specified, the value of the <code class="tag-attribute">version</code> attribute <span class="rfc2119" id="versioning-considerations.2.6">must</span> be a <code class="type">xs:decimal</code>. <a id="err.inline.S0063"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0063"><code class="errqname">err:XS0063</code></a>) if the value of the <code class="tag-attribute">version</code> attribute is not a <code class="type">xs:decimal</code>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">A pipeline author</span><span class="deltaxml-new" style="background:#90EE90">Pipelines</span> <span class="deltaxml-old" style="background:#FF5555">may</span><span class="deltaxml-old" style="background:#FF5555"> </span>identify the version of XProc <span class="deltaxml-old" style="background:#FF5555">for which a particular pipeline was authored by setting</span><span class="deltaxml-new" style="background:#90EE90">they are authored against with</span> the <code class="tag-attribute">version</code> attribute. The <code class="tag-attribute">version</code> attribute can be specified on <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a>. If specified, the value of the <code class="tag-attribute">version</code> attribute <span class="rfc2119" id="versioning-considerations.2.6">must</span> be a <code class="type">xs:decimal</code>. <a id="err.inline.S0063"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0063"><code class="errqname">err:XS0063</code></a>) if the value of the <code class="tag-attribute">version</code> attribute is not a <code class="type">xs:decimal</code>.</span></p><p><span style="display: none;" class="delete_version">The version of XProc defined by this specification is “<code class="literal">3.0</code>”.</span><span style="display: none;" class="add_version">The version of XProc defined by this specification is “<code class="literal">3.1</code>”.</span><span class="modify_version">The version of XProc defined by this specification is “<code class="literal"><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></code>”.</span></p><p>A pipeline author <span class="rfc2119" id="versioning-considerations.4.1">must</span> identify the version of XProc on the document element of a pipeline document. <a id="err.inline.S0062"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0062"><code class="errqname">err:XS0062</code></a>) if a required <code class="tag-attribute">version</code> attribute is not present.</p><p>The version identified applies to the element on which the <code class="tag-attribute">version</code> attribute appears and all of its descendants, unless or until another version is explicitly identified.</p><p><span class="deltaxml-new" style="background:#90EE90">An XProc 3.1 processor </span><span class="rfc2119" id="versioning-considerations.6.1"><span class="deltaxml-new" style="background:#90EE90">must</span></span><span class="deltaxml-new" style="background:#90EE90"> accept pipelines labeled with version “3.1”. It </span><span class="rfc2119" id="versioning-considerations.6.2"><span class="deltaxml-new" style="background:#90EE90">should</span></span><span class="deltaxml-new" style="background:#90EE90"> also accept pipelines labeled with version “3.0”.</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">If a 3.1 processor accepts pipelines labeled with version “3.0”, it </span><span class="rfc2119" id="versioning-considerations.7.1.1.1"><span class="deltaxml-new" style="background:#90EE90">must</span></span><span class="deltaxml-new" style="background:#90EE90"> process them as if they were labeled “3.1”. In this case, the acceptable versions are “3.0” and “3.1”. </span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Alternatively, an XProc 3.1 processor </span><span class="rfc2119" id="versioning-considerations.7.2.1.1"><span class="deltaxml-new" style="background:#90EE90">may</span></span><span class="deltaxml-new" style="background:#90EE90"> reject pipelines labeled with version “3.0”. In this case, the only acceptable version is “3.1”.</span></p></li></ul></div><div class="note admonition"><h3><span class="deltaxml-new" style="background:#90EE90">A pragmatic approach to 3.0 and 3.1</span></h3><div class="admonition-body"><p><span class="deltaxml-new" style="background:#90EE90">In practice, implementations are expected to treat version “3.0” as a synonym for version “3.1”. Although there are technically a few backwards incompatiblities between 3.1 and 3.0, all known processors </span><em><span class="deltaxml-new" style="background:#90EE90">have always</span></em><span class="deltaxml-new" style="background:#90EE90"> implemented the behavior now defined in 3.1, so it is of no consequence.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Requiring processors to reject pipelines labeled “3.0” would be hostile to users with existing pipelines. Requiring implementors to strictly support the 3.0 behavior on pipelines labeled “3.0” would, from the user’s perspective, actually introduce errors in existing pipelines.</span></p></div></div><p><span style="display: none;" class="delete_version">XProc 3.0 takes a draconian approach to versioning. <a id="err.inline.S0060"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0060"><code class="errqname">err:XS0060</code></a>) if the processor encounters an explicit request for a version of the language other than “3.0”. </span><span style="display: none;" class="add_version"><a id="err.inline.S0060"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0060"><code class="errqname">err:XS0060</code></a>) if the processor encounters an explicit request for a version of the language not acceptable to the processor.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">XProc 3.0 takes a draconian approach to versioning. </span><a id="err.inline.S0060"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0060"><code class="errqname">err:XS0060</code></a>) if the processor encounters an explicit request for a version of the language <span class="deltaxml-old" style="background:#FF5555">other than “3.0”. </span><span class="deltaxml-new" style="background:#90EE90">not acceptable to the processor.</span></span></p></div></section><section id="syntax" class="section"><div class="section-titlepage"><h2><bdi class="secno">14. </bdi>Syntax Overview<a aria-label="§" class="self-link" href="#syntax"></a></h2></div><div class="content"><p><span style="display: none;" class="delete_version">This section describes the normative XML syntax of XProc. This syntax is sufficient to represent all the aspects of a pipeline, as set out in the preceding sections. <span id="dt-XML" class="termdef">[Definition: XProc is intended to work equally well with [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>] and [<a href="#xml11"><span class="abbrev">XML 1.1</span></a>]. Unless otherwise noted, the term “<em class="glossterm">XML</em>” refers equally to both versions.]</span><span id="dt-Namespaces-in-XML" class="termdef">[Definition: Unless otherwise noted, the term <em class="glossterm">Namespaces in XML</em> refers equally to [<a href="#xmlns10"><span class="abbrev">Namespaces 1.0</span></a>] and [<a href="#xmlns11"><span class="abbrev">Namespaces 1.1</span></a>].]</span><span id="impl-27">Support for pipeline documents written in XML 1.1 and pipeline inputs and outputs that use XML 1.1 is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">This section describes the normative XML syntax of XProc. This syntax is sufficient to represent all the aspects of a pipeline, as set out in the preceding sections. <span id="dt-XML" class="termdef">[Definition: XProc is intended to work equally well with [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>] and [<a href="#xml11"><span class="abbrev">XML 1.1</span></a>]. Unless otherwise noted, the term “<em class="glossterm">XML</em>” refers equally to both versions.]</span><span id="dt-Namespaces-in-XML" class="termdef">[Definition: Unless otherwise noted, the term <em class="glossterm">Namespaces in XML</em> refers equally to [<a href="#xmlns10"><span class="abbrev">Namespaces 1.0</span></a>] and [<a href="#xmlns11"><span class="abbrev">Namespaces 1.1</span></a>].]</span><span id="impl-29">Support for pipeline documents written in XML 1.1 and pipeline inputs and outputs that use XML 1.1 is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">This section describes the normative XML syntax of XProc. This syntax is sufficient to represent all the aspects of a pipeline, as set out in the preceding sections. <span id="dt-XML" class="termdef">[Definition: XProc is intended to work equally well with [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>] and [<a href="#xml11"><span class="abbrev">XML 1.1</span></a>]. Unless otherwise noted, the term “<em class="glossterm">XML</em>” refers equally to both versions.]</span><span id="dt-Namespaces-in-XML" class="termdef">[Definition: Unless otherwise noted, the term <em class="glossterm">Namespaces in XML</em> refers equally to [<a href="#xmlns10"><span class="abbrev">Namespaces 1.0</span></a>] and [<a href="#xmlns11"><span class="abbrev">Namespaces 1.1</span></a>].]</span><span id="impl-29">Support for pipeline documents written in XML 1.1 and pipeline inputs and outputs that use XML 1.1 is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p><span style="display: none;" class="delete_version">Elements in a pipeline document represent the pipeline, the steps it contains, the connections between those steps, the steps and connections contained within them, and so on. Each step is represented by an element; a combination of elements and attributes specify how the inputs and outputs of each step are connected and how options are passed. Outside of inline documents (<a href="#p.inline"><code class="tag-element">p:inline</code></a> elements explicitly or implicitly), text nodes that consist entirely of whitespace and XML comments are ignored. XML processing instructions are also generally ignored. <span id="impl-28">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if any processing instructions are significant to an implementation.</span> In an inline document, all markup is treated as if it was a quoted part of the inline document and no special semantics apply except as noted elsewhere in this specification.</span><span style="display: none;" class="add_version">Elements in a pipeline document represent the pipeline, the steps it contains, the connections between those steps, the steps and connections contained within them, and so on. Each step is represented by an element; a combination of elements and attributes specify how the inputs and outputs of each step are connected and how options are passed. Outside of inline documents (<a href="#p.inline"><code class="tag-element">p:inline</code></a> elements explicitly or implicitly), text nodes that consist entirely of whitespace and XML comments are ignored. XML processing instructions are also generally ignored. <span id="impl-30">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if any processing instructions are significant to an implementation.</span> In an inline document, all markup is treated as if it was a quoted part of the inline document and no special semantics apply except as noted elsewhere in this specification.</span><span class="modify_version">Elements in a pipeline document represent the pipeline, the steps it contains, the connections between those steps, the steps and connections contained within them, and so on. Each step is represented by an element; a combination of elements and attributes specify how the inputs and outputs of each step are connected and how options are passed. Outside of inline documents (<a href="#p.inline"><code class="tag-element">p:inline</code></a> elements explicitly or implicitly), text nodes that consist entirely of whitespace and XML comments are ignored. XML processing instructions are also generally ignored. <span id="impl-30">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> if any processing instructions are significant to an implementation.</span> In an inline document, all markup is treated as if it was a quoted part of the inline document and no special semantics apply except as noted elsewhere in this specification.</span></p><p>Conceptually, we can speak of steps as objects that have inputs and outputs, that are connected together and which may contain additional steps. Syntactically, we need a mechanism for specifying these relationships.</p><p><em class="glossterm"><a href="#dt-container">Containment</a></em> is represented naturally using nesting of XML elements. If a particular element identifies a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> then the step elements that are its immediate children form its <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>.</p><p>The connections between steps are expressed using names and references to those names.</p><section id="namespaces" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.1. </bdi>XProc Namespaces<a aria-label="§" class="self-link" href="#namespaces"></a></h3></div><div class="content"><p>There are three namespaces associated with XProc:</p><div class="variablelist"><dl><dt><span class="term"><code class="uri">http://www.w3.org/ns/xproc</code></span></dt><dd><p>The namespace of the XProc XML vocabulary described by this specification; by convention, the namespace prefix “<code class="literal">p:</code>” is used for this namespace.</p></dd><dt><span class="term"><code class="uri">http://www.w3.org/ns/xproc-step</code></span></dt><dd><p>The namespace used for documents that are inputs to and outputs from several standard and optional steps described in this specification. Some steps, such as <code class="tag-element">p:http-request</code> and <code class="tag-element">p:store</code>, have defined input or output vocabularies. We use this namespace for all of those documents. The conventional prefix “<code class="literal">c:</code>” is used for this namespace.</p></dd><dt><span class="term"><code class="uri">http://www.w3.org/ns/xproc-error</code></span></dt><dd><p>The namespace used for errors. The conventional prefix “<code class="literal">err:</code>” is used for this namespace. </p></dd></dl></div><p>This specification also makes use of the prefix “<code class="literal">xs:</code>” to refer to the [<a href="#xmlschema-1"><span class="abbrev">W3C XML Schema: Part 1</span></a>] namespace <code class="uri">http://www.w3.org/2001/XMLSchema</code> and the prefix “<code class="literal">xsi:</code>” to refer to the namespace <code class="uri">http://www.w3.org/2001/XMLSchema-instance</code></p></div></section><section id="scoping" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.2. </bdi>Scoping of Names<a aria-label="§" class="self-link" href="#scoping"></a></h3></div><div class="content"><p>Names are used to identify step types, steps, ports, options and variables. Step types, options, and variables are named with EQNames. Steps and ports are named with NCNames. The scope of a name is a measure of where it is available in a pipeline. <span id="dt-visible" class="termdef">[Definition: If two names are in the same scope, we say that they are <em class="glossterm">visible</em> to each other.]</span></p><p>Within a <a href="#p.library"><code class="tag-element">p:library</code></a>, declaring that the <code class="tag-attribute">visibility</code> of a step or static option is “<code class="code">private</code>” limits its visibility outside of the library. Note, however, that if other declarations of the same name are visible from the point where the private declaration occurs, that is still an error.</p><section id="scoping.4" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.2.1. </bdi>Scoping of step type names<a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p>The scope of the names of the step types is the pipeline in which they are declared, including any declarations imported from libraries via <a href="#p.import"><code class="tag-element">p:import</code></a>. Nested pipelines inherit the step types in scope for their parent.</p><p>In other words, the step types that are in scope in a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are:</p><div class="itemizedlist"><ul><li><p>The standard, built-in types (<a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, <a href="#p.choose"><code class="tag-element">p:choose</code></a>, etc.). </p></li><li><p>Any implementation-provided types. </p></li><li><p>Any step types declared in the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> children of the pipeline element. </p></li><li><p>The types of any <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>s that are imported. </p></li><li><p>Any public types that are in the scope of any <a href="#p.library"><code class="tag-element">p:library</code></a> that is imported. </p></li><li><p>Any step types that are in scope for the pipeline’s parent <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, if it has one. </p></li><li><p>The type of the pipeline itself, if it has one. </p></li></ul></div><p>The step types that are in scope in a <a href="#p.library"><code class="tag-element">p:library</code></a> are:</p><div class="itemizedlist"><ul><li><p>The standard, built-in types (<a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, <a href="#p.choose"><code class="tag-element">p:choose</code></a>, etc.). </p></li><li><p>Any implementation-provided types. </p></li><li><p>Any step types declared in the library (the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> children of the <a href="#p.library"><code class="tag-element">p:library</code></a> element). </p></li><li><p>The types of <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>s that are imported into the library.</p></li><li><p>Any public types that are in the scope of any <a href="#p.library"><code class="tag-element">p:library</code></a> that is imported. </p></li></ul></div><p><a id="err.inline.S0036"></a>All the step types in a pipeline or library <span class="rfc2119" id="scoping.4.7.1.1">must</span> have unique names: it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0036"><code class="errqname">err:XS0036</code></a>) if any step type name is built-in and/or declared or defined more than once in the same scope.</p></div></section><section id="scoping.5" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.2.2. </bdi>Scoping of step names<a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p><span style="display: none;" class="delete_version">The scope of the names of the steps (the values of the step’s <code class="code">name</code> attributes) is determined by the <em class="glossterm"><a href="#dt-environment">environment</a></em> of each step. In general, the name of a step, the names of its sibling steps, the names of any steps that it contains directly, the names of its ancestors, and the names of the siblings of its ancestors are all in a common scope. <a id="err.inline.S0002"></a>All steps in the same scope <span class="rfc2119" id="scoping.5.2.3.1">must</span> have unique names: it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0002"><code class="errqname">err:XS0002</code></a>) if two steps with the same name appear in the same scope.</span><span style="display: none;" class="add_version">The scope of the names of the steps (the values of the step’s <code class="code">name</code> attributes) is the step on which the name appears, the names of its sibling steps, the names of any steps that it contains directly, the names of its ancestors, and the names of the siblings of its ancestors. <a id="err.inline.S0002"></a>All steps in the same scope <span class="rfc2119" id="scoping.5.2.2.1">must</span> have unique names: it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0002"><code class="errqname">err:XS0002</code></a>) if two steps with the same name appear in the same scope.</span><span class="modify_version">The scope of the names of the steps (the values of the step’s <code class="code">name</code> attributes) is <span class="deltaxml-old" style="background:#FF5555">determined by </span>the <a href="#dt-environment"><span class="deltaxml-old" style="background:#FF5555">environment</span></a><span class="deltaxml-old" style="background:#FF5555"> of each step. In general, the name of a step</span><span class="deltaxml-new" style="background:#90EE90">step on which the name appears</span>, the names of its sibling steps, the names of any steps that it contains directly, the names of its ancestors, and the names of the siblings of its ancestors<span class="deltaxml-old" style="background:#FF5555"> are all in a common scope</span>. <a id="err.inline.S0002"></a>All steps in the same scope <span class="rfc2119" id="scoping.5.2.2.1">must</span> have unique names: it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0002"><code class="errqname">err:XS0002</code></a>) if two steps with the same name appear in the same scope.</span></p></div></section><section id="scoping.6" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.2.3. </bdi>Scoping of port names<a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p>The scope of an input or output port name is the step on which it is defined. The names of all the ports on any step <span class="rfc2119" id="scoping.6.2.1">must</span> be unique.</p><p>Taken together with the scoping of step names, these uniqueness constraints guarantee that the combination of a step name and a port name uniquely identifies exactly one port on exactly one in-scope step.</p></div></section><section id="scoping.7" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.2.4. </bdi>Scoping of non-static options and variables<a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p>The scope of non-static option and variable names is determined by where they are declared. Their scope consists of the sibling elements that follow its declaration and the descendants of those siblings. </p><p>Non-static options and variables declared in parent step declarations are not visible in child step declarations.</p></div></section><section id="scoping.8" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.2.5. </bdi>Scoping of static option names<a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p>The scope of the names of static options is the pipeline in which they are declared, including any declarations imported from libraries via <a href="#p.import"><code class="tag-element">p:import</code></a>. Nested pipelines inherit the static options in scope for their parent.</p><p>In other words, the step options that are in scope in a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are:</p><div class="itemizedlist"><ul><li><p>Any static options declared in the step.</p></li><li><p>Any public static options that are in the scope of any <a href="#p.library"><code class="tag-element">p:library</code></a> that is imported. </p></li><li><p>Any static options that are in scope for the pipeline’s parent <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, if it has one.</p></li></ul></div><p>The static options that are in scope in a <a href="#p.library"><code class="tag-element">p:library</code></a> are:</p><div class="itemizedlist"><ul><li><p>Any static options declared in the library (the <a href="#p.option"><code class="tag-element">p:option</code></a> children of the <a href="#p.library"><code class="tag-element">p:library</code></a> element).</p></li><li><p>Any public static options that are in the scope of any <a href="#p.library"><code class="tag-element">p:library</code></a> that is imported. </p></li></ul></div><p><a id="err.inline.S0071"></a>All the static options in a pipeline or library <span class="rfc2119" id="scoping.8.7.1.1">must</span> have unique names: it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0071"><code class="errqname">err:XS0071</code></a>) if any static option name is declared more than once in the same scope.</p></div></section><section id="scoping.9" class="section"><div class="section-titlepage"><h4><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">14.2.6. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Scoping of imported function names</span><a aria-label="§" class="self-link" href="#"></a></h4></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">The scope of function names imported with </span><a href="#p.import-functions"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import-functions</span></code></a><span class="deltaxml-new" style="background:#90EE90"> is limited to expressions that appear in elements and attributes that follow the </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import-function</span></code><span class="deltaxml-new" style="background:#90EE90"> element, in document order, in the pipeline document where the import occurs.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Function imports are not transitive. If a pipeline imports a library that imports functions, those functions are not available in the pipeline that imported the library, unless they’re also imported directly by the pipeline.</span></p></div></section></div></section><section id="xml-base-attribute" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.3. </bdi>Base URIs and xml:base<a aria-label="§" class="self-link" href="#xml-base-attribute"></a></h3></div><div class="content"><p>If a relative URI appears in an option of type <code class="type">xs:anyURI</code>, the base URI against which it <span class="rfc2119" id="xml-base-attribute.2.2">must</span> be made absolute is the base URI of the <a href="#p.option"><code class="tag-element">p:option</code></a> element. If the option value is specified using a <a href="#option-shortcut">syntactic shortcut</a>, the base URI of the step element on which the shortcut attribute appears <span class="rfc2119" id="xml-base-attribute.2.5">must</span> be used. In general, whenever a relative URI appears in an <code class="type">xs:anyURI</code>, its base URI is the base URI of the nearest ancestor element.</p><p>The pipeline author can control the base URIs of elements within the pipeline document with the <code class="tag-attribute">xml:base</code> attribute. The <code class="tag-attribute">xml:base</code> attribute <span class="rfc2119" id="xml-base-attribute.3.3">may</span> appear on any element in a pipeline and has the semantics outlined in [<a href="#xml-base"><span class="abbrev">XML Base</span></a>].</p><p><span class="deltaxml-new" style="background:#90EE90">As a consequence of the fact that XProc uses the semantics of [</span><a href="#xml-base"><span class="abbrev"><span class="deltaxml-new" style="background:#90EE90">XML Base</span></span></a><span class="deltaxml-new" style="background:#90EE90">] for all </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:base</span></code><span class="deltaxml-new" style="background:#90EE90"> attributes that appear in an XProc pipeline, a pipeline author </span><em><span class="deltaxml-new" style="background:#90EE90">cannot</span></em><span class="deltaxml-new" style="background:#90EE90"> set the literal </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:base</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute on an inline element with an attribute value template. This is an error:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:identity&gt; &lt;p:with-input&gt; &lt;p:inline&gt; &lt;doc&gt; &lt;page xml:base="{$someExpression}"&gt;somefile.xml&lt;/page&gt; &lt;/doc&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt;</span></code></pre><p><span class="deltaxml-new" style="background:#90EE90">The XML base value “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">{$someExpression}</span></code><span class="deltaxml-new" style="background:#90EE90">” is not a valid URI. Instead, you must use </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:add-attribute</span></code><span class="deltaxml-new" style="background:#90EE90"> or </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:set-attributes</span></code><span class="deltaxml-new" style="background:#90EE90">. For example:</span></p><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:identity&gt; &lt;p:with-input&gt; &lt;p:inline&gt; &lt;doc&gt; &lt;page&gt;somefile.xml&lt;/page&gt; &lt;/doc&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;p:add-attribute match="/doc/page" attribute-name="xml:base" attribute-value="{$someExpression}"/&gt;</span></code></pre><p>For XML documents, HTML documents, and text documents, the pipeline author can control the base URI of the document node by manipulating the document property “<code class="code">base-uri</code>”.</p></div></section><section id="xml-id-attribute" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.4. </bdi>Unique identifiers<a aria-label="§" class="self-link" href="#xml-id-attribute"></a></h3></div><div class="content"><p>A pipeline author can provide a globally unique identifier for any element in a pipeline with the <code class="tag-attribute">xml:id</code> attribute.</p><p>The <code class="tag-attribute">xml:id</code> attribute <span class="rfc2119" id="xml-id-attribute.3.2">may</span> appear on any element in a pipeline and has the semantics outlined in [<a href="#xml-id"><span class="abbrev">xml:id</span></a>].</p><p><span class="deltaxml-new" style="background:#90EE90">The semantics of an </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:id</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute are that </span><em><span class="deltaxml-new" style="background:#90EE90">it is</span></em><span class="deltaxml-new" style="background:#90EE90"> an ID. An XProc processor does not directly use the ID values, so it is not explicitly required to validate that the values of attributes named </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:id</span></code><span class="deltaxml-new" style="background:#90EE90"> conform to the constraints of XML ID values. It may be possible to set the literal </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:id</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute on an inline element with an attribute value template, but it is not best practice. </span><span id="impl-31"><span class="deltaxml-new" style="background:#90EE90">It is </span><em class="glossterm"><a href="#dt-implementation-dependent"><span class="deltaxml-new" style="background:#90EE90">implementation-dependent</span></a></em><span class="deltaxml-new" style="background:#90EE90"> if a processor validates </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:id</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute values.</span></span><span class="deltaxml-new" style="background:#90EE90"> (The same observations apply to </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:lang</span></code><span class="deltaxml-new" style="background:#90EE90"> and </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:space</span></code><span class="deltaxml-new" style="background:#90EE90"> attributes.) </span></p></div></section><section id="syntax-docs-ports" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.5. </bdi>Associating Documents with Ports<a aria-label="§" class="self-link" href="#syntax-docs-ports"></a></h3></div><div class="content"><p> A document or a sequence of documents can be connected to a port in four ways: <em class="glossterm"><a href="#dt-by-source">by source</a></em>, <em class="glossterm"><a href="#dt-by-URI">by URI</a></em>, by providing an <em class="glossterm"><a href="#dt-inline-document">inline document</a></em>, or by making it <em class="glossterm"><a href="#dt-empty-sequence">explicitly empty</a></em>. Each of these mechanisms is allowed where connections may be made, except that <a href="#p.input"><code class="tag-element">p:input</code></a> may not include a connection <em class="glossterm"><a href="#dt-by-source">by source</a></em>.</p><div class="variablelist"><dl><dt><span class="term">Specified by URI</span></dt><dd><p><span id="dt-by-URI" class="termdef">[Definition: A document is specified <em class="glossterm">by URI</em> if it is referenced with a URI.]</span> The <code class="tag-attribute">href</code> attribute on the <a href="#p.document"><code class="tag-element">p:document</code></a> element is used to refer to documents by URI.</p><p>In this example, the input to the <code class="tag-element">p:identity</code> step named “<code class="literal">otherstep</code>” comes from “<code class="uri">http://example.com/input.xml</code>”. </p><pre class="programlisting language-markup xml"><code>&lt;p:output port="result"/&gt; &lt;p:identity name="otherstep"&gt; &lt;p:with-input port="source"&gt; &lt;p:document href="http://example.com/input.xml"/&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt;</code></pre><p>See the description of <a href="#p.document"><code class="tag-element">p:document</code></a> for a complete description of how URIs may be specified.</p></dd><dt><span class="term">Specified by source</span></dt><dd><p><span id="dt-by-source" class="termdef">[Definition: A document is specified <em class="glossterm">by source</em> if it references a specific port on another step.]</span> The <code class="tag-attribute">step</code> and <code class="tag-attribute">port</code> attributes on the <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> element are used for this purpose. </p><p>In this example, the “<code class="literal">source</code>” input to the <code class="tag-element">p:xinclude</code> step named “<code class="literal">expand</code>” comes from the “<code class="literal">result</code>” port of the step named “<code class="literal">otherstep</code>”.</p><pre class="programlisting language-markup xml"><code>&lt;!-- there's no otherstep so this isn't expected to work... --&gt; &lt;p:xinclude name="expand"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="otherstep" port="result"/&gt; &lt;/p:with-input&gt; &lt;/p:xinclude&gt;</code></pre><p>See the description of <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> for a complete description of the ports that can be connected.</p></dd><dt><span class="term">Specified inline</span></dt><dd><p><span id="dt-inline-document" class="termdef">[Definition: An <em class="glossterm">inline document</em> is specified directly in the body of the element to which it connects.]</span> The content of the <a href="#p.inline"><code class="tag-element">p:inline</code></a> element is used for this purpose. </p><p>In this example, the “<code class="literal">stylesheet</code>” input to the XSLT step named “<code class="literal">xform</code>” comes from the content of the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> element itself.</p><pre class="programlisting language-markup xml"><code>&lt;p:xslt name="xform"&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:inline&gt; &lt;xsl:stylesheet version="1.0"&gt; ... &lt;/xsl:stylesheet&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:xslt&gt;</code></pre><p>Inline documents are considered “quoted”. The pipeline processor passes them literally to the port, even if they contain elements from the XProc namespace or other namespaces that would have other semantics outside of the <a href="#p.inline"><code class="tag-element">p:inline</code></a>.</p><p>See the description of <a href="#p.inline"><code class="tag-element">p:inline</code></a> for a complete description of how inline documents may be specified.</p></dd><dt><span class="term">Specified explicitly empty</span></dt><dd><p><span id="dt-empty-sequence" class="termdef">[Definition: An <em class="glossterm">empty sequence</em> of documents is specified with the <a href="#p.empty"><code class="tag-element">p:empty</code></a> element.]</span></p><p>In this example, the “<code class="literal">source</code>” input to the XSLT 2.0 step named “<code class="literal">generate</code>” is explicitly empty:</p><pre class="programlisting language-markup xml"><code>&lt;p:xslt name="generate" version="2.0"&gt; &lt;p:with-input port="source"&gt; &lt;p:empty/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:inline&gt; &lt;xsl:stylesheet version="2.0"&gt; ... &lt;/xsl:stylesheet&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;p:with-option name="template-name" select="'someName'"/&gt; &lt;/p:xslt&gt;</code></pre><p>If you omit the connection on a primary input port, a connection to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> will be assumed. Making the connection explicitly empty guarantees that the connection will be to an empty sequence of documents.</p><p>See the description of <a href="#p.empty"><code class="tag-element">p:empty</code></a> for a complete description of empty connections.</p></dd></dl></div><p>Note that a <a href="#p.input"><code class="tag-element">p:input</code></a>, <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>, or <a href="#p.output"><code class="tag-element">p:output</code></a> element may contain more than one <a href="#p.pipe"><code class="tag-element">p:pipe</code></a>, <a href="#p.document"><code class="tag-element">p:document</code></a>, or <a href="#p.inline"><code class="tag-element">p:inline</code></a> element. If more than one <em class="glossterm"><a href="#dt-connection">connection</a></em> is provided, then the specified sequence of documents is made available on that port in the same order as the connections.</p></div></section><section id="documentation" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.6. </bdi>Documentation<a aria-label="§" class="self-link" href="#documentation"></a></h3></div><div class="content"><p>Pipeline authors may add documentation to their pipeline documents with the <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> element. Except when it appears as a descendant of <a href="#p.inline"><code class="tag-element">p:inline</code></a>, the <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> element is completely ignored by pipeline processors, it exists simply for documentation purposes. If a <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> is provided as a descendant of <a href="#p.inline"><code class="tag-element">p:inline</code></a>, it has no special semantics, it is treated literally as part of the document to be provided on that port. The <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> element has no special semantics when it appears in documents that flow through the pipeline.</p><p>Pipeline processors that inspect the contents of <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> elements and behave differently on the basis of what they find are <em>not conformant</em>. Processor extensions <span class="rfc2119" id="documentation.3.3">must</span> be specified with <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a>.</p></div></section><section id="annotations" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.7. </bdi>Processor annotations<a aria-label="§" class="self-link" href="#annotations"></a></h3></div><div class="content"><p><span style="display: none;" class="delete_version">Pipeline authors may add annotations to their pipeline documents with the <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> element. <span id="impl-29">The semantics of <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> elements are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Processors <span class="rfc2119" id="annotations.2.3">should</span> specify a way for their annotations to be identified, perhaps with <a href="#extension-attributes">extension attributes</a>.</span><span style="display: none;" class="add_version">Pipeline authors may add annotations to their pipeline documents with the <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> element. <span id="impl-32">The semantics of <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> elements are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Processors <span class="rfc2119" id="annotations.2.3">should</span> specify a way for their annotations to be identified, perhaps with <a href="#extension-attributes">extension attributes</a>.</span><span class="modify_version">Pipeline authors may add annotations to their pipeline documents with the <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> element. <span id="impl-32">The semantics of <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> elements are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Processors <span class="rfc2119" id="annotations.2.3">should</span> specify a way for their annotations to be identified, perhaps with <a href="#extension-attributes">extension attributes</a>.</span></p><p>Where <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> is intended for human consumption, <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> elements are intended for processor consumption. A processor might, for example, use annotations to identify some particular aspect of an implementation, to request additional, perhaps non-standard features, to describe parallelism constraints, etc.</p><p>When a <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> appears as a descendant of <a href="#p.inline"><code class="tag-element">p:inline</code></a>, it has no special semantics; in that context it <span class="rfc2119" id="annotations.4.3">must</span> be treated literally as part of the document to be provided on that port. The <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> element has no special semantics when it appears in documents that flow through the pipeline. </p></div></section><section id="extension-attributes" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.8. </bdi>Extension attributes<a aria-label="§" class="self-link" href="#extension-attributes"></a></h3></div><div class="content"><p><span id="dt-extension-attribute" class="termdef">[Definition: An element from the XProc namespace <span class="rfc2119" id="dt-extension-attribute.1">may</span> have any attribute not from the XProc namespace, provided that the expanded-QName of the attribute has a non-null namespace URI. Such an attribute is called an <em class="glossterm">extension attribute</em>.]</span></p><p>The presence of an extension attribute must not cause the connections between steps to differ from the connections that would arise in the absence of the attribute. They must not cause the processor to fail to signal an error that would be signaled in the absence of the attribute.</p><p>A processor which encounters an extension attribute that it does not implement <span class="rfc2119" id="extension-attributes.4.1">must</span> behave as if the attribute was not present.</p></div></section><section id="common-attr" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.9. </bdi>Common Attributes<a aria-label="§" class="self-link" href="#common-attr"></a></h3></div><div class="content"><p>Several attributes can be used on any XProc step, or even any element in a pipeline. For convenience, they are all summarized here.</p><p>Attributes from the XML namespace are allowed anywhere. In particular:</p><div class="itemizedlist"><ul><li><p>An <code class="tag-attribute">xml:id</code> attribute is allowed on any element. It has the semantics of [<a href="#xml-id"><span class="abbrev">xml:id</span></a>].</p></li><li><p>An <code class="tag-attribute">xml:base</code> attribute is allowed on any element. It has the semantics of [<a href="#xml-base"><span class="abbrev">XML Base</span></a>].</p></li><li><p>An <code class="tag-attribute">xml:lang</code> attribute is allowed on any element. It has the semantics of [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>].</p></li><li><p>An <code class="tag-attribute">xml:space</code> attribute is allowed on any element. It has the semantics of [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>].</p></li></ul></div><p>The remaining attributes are sometimes in no namespace and sometimes explicitly in the XProc namespace. They are in no namespace when they appear on an XProc element; they are in the XProc namespace when they are on an element in any other namespace. In this way, they do not conflict with the names used in other vocabularies. <a id="err.inline.S0097"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0097"><code class="errqname">err:XS0097</code></a>) if an attribute in the XProc namespace appears on an element in the XProc namespace. </p><section id="expand-text-attribute" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.9.1. </bdi>Expand text attributes<a aria-label="§" class="self-link" href="#expand-text-attribute"></a></h4></div><div class="content"><p>The <code class="tag-attribute">[p:]expand-text</code> and <code class="tag-attribute">[p:]inline-expand-text</code> attributes control whether or not text and attribute nodes in descendant <a href="#p.inline"><code class="tag-element">p:inline</code></a> elements and implicit inlines are designated as value templates. Note that they control both text <em>and</em> attribute value templates.</p><p>The <code class="tag-attribute">[p:]expand-text</code> attribute can appear on all elements in the pipeline. It controls whether or not descendant inlines are designated as value templates. If the attribute <em>itself</em> appears among the descendants of a <a href="#p.inline"><code class="tag-element">p:inline</code></a> (or implicit inline), then it is a regular attribute and has no special semantics. In this case, the <code class="tag-attribute">[p:]inline-expand-text</code> attribute comes into play. </p><p>The <code class="tag-attribute">[p:]inline-expand-text</code> attribute appearing as descendant of a <a href="#p.inline"><code class="tag-element">p:inline</code></a> or in an implicit inline is treated as a special attribute, with the same semantics as the <code class="tag-attribute">[p:]expand-text</code> attribute. The attribute will not be part of the result of the <a href="#p.inline"><code class="tag-element">p:inline</code></a> or implicit inline.</p><p>If the <code class="tag-attribute">[p:]expand-text</code> or <code class="tag-attribute">[p:]inline-expand-text</code> attribute appears on more than one element among the ancestors of a text or attribute node in a <a href="#p.inline"><code class="tag-element">p:inline</code></a> element or implicit inline, only the value on the nearest ancestor is considered.</p><p>If the nearest <code class="tag-attribute">[p:]expand-text</code> or <code class="tag-attribute">[p:]inline-expand-text</code> attribute has the value “<code class="code">false</code>”, then the text and attribute nodes in a <a href="#p.inline"><code class="tag-element">p:inline</code></a> element or implicit inline are not value templates. If it has the value “<code class="code">true</code>”, or if no such attribute is present among ancestors, then the text and attribute nodes <em>are</em> value templates.</p><p>Neither <code class="tag-attribute">[p:]expand-text</code> nor <code class="tag-attribute">[p:]inline-expand-text</code> are attribute value templates themselves. <a id="err.inline.S0113"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0113"><code class="errqname">err:XS0113</code></a>) if either <code class="tag-attribute">[p:]expand-text</code> or <code class="tag-attribute">[p:]inline-expand-text</code> is to be interpreted by the processor and it does not have the value “<code class="code">true</code>” or “<code class="code">false</code>”. </p></div></section><section id="use-when" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.9.2. </bdi>Conditional Element Exclusion<a aria-label="§" class="self-link" href="#use-when"></a></h4></div><div class="content"><p>The <code class="tag-attribute">[p:]use-when</code> attribute controls whether or not an element (and its descendants) appear in the pipeline. The value of the attribute <span class="rfc2119" id="p.use-when.2">must</span> contain an XPath expression that can be evaluated statically (See <a href="#statics" title="Static Options">Section 11.3, “Static Options”</a>.) <span id="dt-effectively-excluded" class="termdef">[Definition: If the effective boolean value of the <code class="tag-attribute">[p:]use-when</code> expression is false, then the element and all of its descendants are <em class="glossterm">effectively excluded</em> from the pipeline document.]</span> If a node is effectively excluded, the processor <span class="rfc2119" id="p.use-when.5">must</span> behave as if the element was not present in the document. </p><p>Conditional element exclusion occurs during <a href="#initiating">static analysis</a> of the pipeline.</p><div id="note-excl-use-when" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>The effective exclusion of <code class="tag-attribute">[p:]use-when</code> processing occurs after XML parsing and has no effect on well-formedness or validation errors which will be reported in the usual way.</p></div></div><p>Deadlock situations can arise if two or more <code class="tag-attribute">[p:]use-when</code> expressions depend on each other. Consider, for example:</p><pre class="programlisting language-markup xml"><code>&lt;p:declare-step type="ex:A" use-when="p:step-available('ex:B')"&gt; … &lt;/p:declare-step&gt; &lt;p:declare-step type="ex:B" use-when="p:step-available('ex:A')"&gt; … &lt;/p:declare-step&gt;</code></pre><p>It is not possible for the processor to determine if <code class="code">ex:A</code> should be declared without first determining if <code class="code">ex:B</code> should be declared, and vice versa.</p><p><a id="err.inline.S0115"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0115"><code class="errqname">err:XS0115</code></a>) if two or more elements are contained within a deadlocked network of <code class="tag-attribute">[p:]use-when</code> expressions. In order to avoid deadlock, there must exist an order in which every expression can be resolved without reference to an expression that occurs after it in the ordering.</p><p>Processors may be required to evaluate expressions in an arbitrary order, but they are not required to solve a set of linear equations simultaneously. So, while “declare both <code class="code">ex:A</code> and <code class="code">ex:B</code>” is a valid solution to the example above, conformant processors are not required (or allowed) to find it because neither the order “A then B” nor the order “B then A” is sufficient to find the solution. </p></div></section><section id="depends" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.9.3. </bdi>Additional dependent connections<a aria-label="§" class="self-link" href="#depends"></a></h4></div><div class="content"><p>The <code class="tag-attribute">[p:]depends</code> attribute can appear on any step invocation <em>except</em><a href="#p.when"><code class="tag-element">p:when</code></a>, <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a>, <a href="#p.catch"><code class="tag-element">p:catch</code></a>, and <a href="#p.finally"><code class="tag-element">p:finally</code></a>. It adds an explicit dependency between steps. The value of the attribute is a space separated list of step names. <a id="err.inline.S0073"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0073"><code class="errqname">err:XS0073</code></a>) if any specified name is not the name of an in-scope step.</p><p>In most pipelines, the dependencies that arise naturally from the connections between steps are sufficient. If step “B” consumes the output of step “A”, then clearly “A” must run before “B”. However, it is sometimes the case that one step depends on another in ways that are not apparent in the connections. Consider, for example, a pipeline that interacts with two different web services. It may very well be the case that one web service has to run before the other, even though the latter does not consume any output from the former.</p><p>When <code class="tag-attribute">[p:]depends</code> is used, if step “Y” depends on step “X”, then “X” must run before “Y”. </p><p>The connections specified by the <code class="tag-attribute">[p:]depends</code> attribute apply <em>in addition to</em> the dependencies that arise naturally from connections between steps. Taken together with the input and output connections, the graph must not contain any loops. </p><p>The <code class="tag-attribute">[p:]depends</code> attribute is forbidden from several elements because they are only conditionally evaluated. The semantics of dependency are ambiguous at best in this case. Moving the dependency to the parent element resolves this ambiguity.</p></div></section><section id="timeout" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.9.4. </bdi>Controlling long running steps<a aria-label="§" class="self-link" href="#timeout"></a></h4></div><div class="content"><p>The <code class="tag-attribute">[p:]timeout</code> attribute allows a pipeline author to suggest a length of time beyond which the pipeline processor should consider that a step has taken an excessive amount of time.</p><p><span style="display: none;" class="delete_version">The value of the <code class="option">[p:]timeout</code> option must be a <code class="type">xs:nonNegativeInteger</code>. It is interpreted as a number of seconds. The value zero may be used to indicate that no limit is expressed (this is the same as omitting the attribute, but may sometimes be more convenient for pipeline authors). </span><a id="err.inline.S0077"></a>The <span class="deltaxml-old" style="background:#FF5555">value</span><span class="deltaxml-new" style="background:#90EE90">duration may be specified as an</span> <code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:double</span></code><span class="deltaxml-old" style="background:#FF5555">of</span><span class="deltaxml-new" style="background:#90EE90">, indicating a number of seconds, or as a duration using a string that satisfies</span> the <span class="deltaxml-old" style="background:#FF5555">[p:]timeout</span><span class="deltaxml-new" style="background:#90EE90">constraints of an </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:dayTimeDuration</span></code><span class="deltaxml-old" style="background:#FF5555"> option</span><span class="deltaxml-new" style="background:#90EE90">. The duration</span> <span class="rfc2119" id="timeout.3.3">must <span class="deltaxml-new" style="background:#90EE90">not</span></span><span class="deltaxml-new" style="background:#90EE90"> </span>be <span class="deltaxml-old" style="background:#FF5555">a </span><span class="deltaxml-new" style="background:#90EE90">negative</span><span class="deltaxml-old" style="background:#FF5555">xs:nonNegativeInteger</span>. It is <span class="deltaxml-old" style="background:#FF5555">interpreted as</span><span class="deltaxml-new" style="background:#90EE90">a </span><em class="glossterm"><a href="#dt-static-error"><span class="deltaxml-new" style="background:#90EE90">static error</span></a></em><span class="deltaxml-new" style="background:#90EE90"> (</span><span class="deltaxml-old" style="background:#FF5555"> a number of seconds</span><span class="deltaxml-new" style="background:#90EE90">) if the specified duration is not a positive number or a valid </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:dayTimeDuration</span></code>. <span class="deltaxml-old" style="background:#FF5555">The value</span><span class="deltaxml-new" style="background:#90EE90">A duration of</span> zero may be used to indicate that no limit is expressed (this is the same as omitting the attribute, but may sometimes be more convenient for pipeline authors). <a id="err.inline.S0077"></a>The <span class="deltaxml-old" style="background:#FF5555">value</span><span class="deltaxml-new" style="background:#90EE90">duration may be specified as an</span> <code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:double</span></code><span class="deltaxml-old" style="background:#FF5555">of</span><span class="deltaxml-new" style="background:#90EE90">, indicating a number of seconds, or as a duration using a string that satisfies</span> the <span class="deltaxml-old" style="background:#FF5555">[p:]timeout</span><span class="deltaxml-new" style="background:#90EE90">constraints of an </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:dayTimeDuration</span></code><span class="deltaxml-old" style="background:#FF5555"> option</span><span class="deltaxml-new" style="background:#90EE90">. The duration</span> <span class="rfc2119" id="timeout.3.3">must <span class="deltaxml-new" style="background:#90EE90">not</span></span><span class="deltaxml-new" style="background:#90EE90"> </span>be <span class="deltaxml-old" style="background:#FF5555">a </span><span class="deltaxml-new" style="background:#90EE90">negative</span><span class="deltaxml-old" style="background:#FF5555">xs:nonNegativeInteger</span>. It is <span class="deltaxml-old" style="background:#FF5555">interpreted as</span><span class="deltaxml-new" style="background:#90EE90">a </span><em class="glossterm"><a href="#dt-static-error"><span class="deltaxml-new" style="background:#90EE90">static error</span></a></em><span class="deltaxml-new" style="background:#90EE90"> (</span><span class="deltaxml-old" style="background:#FF5555"> a number of seconds</span><span class="deltaxml-new" style="background:#90EE90">) if the specified duration is not a positive number or a valid </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">xs:dayTimeDuration</span></code>. <span class="deltaxml-old" style="background:#FF5555">The value</span><span class="deltaxml-new" style="background:#90EE90">A duration of</span> zero may be used to indicate that no limit is expressed (this is the same as omitting the attribute, but may sometimes be more convenient for pipeline authors). </p><p><a id="err.inline.D0053"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0053"><code class="errqname">err:XD0053</code></a>) if a step runs longer than its timeout value.</p><p>The precise amount of time a step takes to perform its task depends on many factors (the hardware running the processor, the processor’s execution strategy, the system load etc.) This feature can not be used as an exact timing tool in XProc. Developers are advised to calculate the value for <code class="tag-attribute">[p:]timeout</code> generously, so the dynamic error is raised only in extreme cases.</p><p><span style="display: none;" class="delete_version"><span id="impl-30">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether a processor supports timeouts, and if it does, how precisely and precisely how the execution time of a step is measured.</span></span><span style="display: none;" class="add_version"><span id="impl-33">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether a processor supports timeouts, and if it does, how precisely and precisely how the execution time of a step is measured.</span></span><span class="modify_version"><span id="impl-33">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether a processor supports timeouts, and if it does, how precisely and precisely how the execution time of a step is measured.</span></span></p></div></section><section id="messages" class="section"><div class="section-titlepage"><h4><bdi class="secno">14.9.5. </bdi>Status and debugging output<a aria-label="§" class="self-link" href="#messages"></a></h4></div><div class="content"><p>The <code class="tag-attribute">[p:]message</code> attribute can appear on any step invocation. It’s value is treated as an attribute value template (irrespective of any enclosing <code class="tag-attribute">[p:]expand-text</code> setting) and the computed value is made available.</p><p><span style="display: none;" class="delete_version"><span id="impl-31">Precisely what “made available” means is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> It will often be as simple as printing the message on some output channel. But for embedded systems or other environments where “print it for the user” is meaningless or inconvenient, some other mechanism may be used. </span><span style="display: none;" class="add_version"><span id="impl-34">Precisely what “made available” means is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> It will often be as simple as printing the message on some output channel. But for embedded systems or other environments where “print it for the user” is meaningless or inconvenient, some other mechanism may be used. </span><span class="modify_version"><span id="impl-34">Precisely what “made available” means is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> It will often be as simple as printing the message on some output channel. But for embedded systems or other environments where “print it for the user” is meaningless or inconvenient, some other mechanism may be used. </span></p><p>If a processor can make the message available, it <span class="rfc2119" id="messages.4.1">should</span> do so before execution of the step begins.</p></div></section></div></section><section id="syntax-summaries" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.10. </bdi>Syntax Summaries<a aria-label="§" class="self-link" href="#syntax-summaries"></a></h3></div><div class="content"><p>The description of each element in the pipeline namespace is accompanied by a syntactic summary that provides a quick overview of the element’s syntax:</p><p class="element-syntax element-syntax-language-example"><code>&lt;p:some-element<br />  <strong>reqd-attribute</strong> = <var>some-type</var><br />  some-attribute? = <var>some-type</var><br />  avt-attribute? = { <var>some-type</var> }&gt;<br />    (<var>some</var> | <br />     <var>elements</var> | <br />     <var>allowed</var>)*,<br />    <var>other-elements?</var><br />&lt;/p:some-element&gt;</code></p><p>The content model fragments in these tableaux are presented in a simple, compact notation. In brief:</p><div class="variablelist"><dl><dt><span class="term">Attributes</span></dt><dd><div class="itemizedlist"><ul><li><p>Required attributes are bold. Optional attributes are followed by a question mark.</p></li><li><p>If an attribute value may contain an attribute value template, its type is shown in curly brackets: “<code class="code">{ some-type }</code>”. If <code class="literal">some-type</code> is <code class="type">xs:anyURI</code>, <code class="type">xs:QName</code>, or a map type with key type of <code class="type">xs:QName</code>, the conversions described in <a href="#implicit-casting" title="Implicit casting">Section 11.5, “Implicit casting”</a> apply.</p></li><li><p>An attribute value with a map type marks an <code class="type">XPathExpression</code> expected to deliver a map of the indicated type. If the map type has a key type of <code class="type">xs:QName</code>, the conversions described in <a href="#implicit-casting" title="Implicit casting">Section 11.5, “Implicit casting”</a> apply.</p></li></ul></div></dd><dt><span class="term">Elements</span></dt><dd><div class="itemizedlist"><ul><li><p>A name represent exactly one occurrence of an element with that name.</p></li><li><p>Parentheses are used for grouping. </p></li><li><p>Elements or groups separated by a comma (“,”) represent an ordered sequence: a followed by b followed by c: (a,b,c).</p></li><li><p>Elements or groups separated by a vertical bar (“|”) represent a choice: a or b or c: (a | b | c).</p></li><li><p>Elements or groups separated by an ampersand (“&amp;”) represent an unordered sequence: a and b and c, in any order: (a &amp; b &amp; c).</p></li><li><p>An element or group followed by a question mark (“?”) is optional; it may or may not occur but if it occurs it can occur only once.</p></li><li><p>An element or group followed by an asterisk (“*”) is optional and may be repeated; it may or may not occur and if it occurs it can occur any number of times. </p></li><li><p>An element or group followed by a plus (“+”) is required and may be repeated; it must occur at least once, and it can occur any number of times. </p></li></ul></div></dd></dl></div><p>For clarity of exposition, the common attributes (see <a href="#common-attr" title="Common Attributes">Section 14.9, “Common Attributes”</a>) are elided from the summaries as are the <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> and <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> elements, which are allowed anywhere, and attributes that are <a href="#option-shortcut">syntactic shortcuts for option values</a>. </p><p>The types given for attributes should be understood as follows:</p><div class="itemizedlist"><ul><li><p><code class="type">ID</code>, <code class="type">NCName</code>, <code class="type">NMTOKEN</code>, <code class="type">NMTOKENS</code>, <code class="type">anyURI</code>, <code class="type">boolean</code>, <code class="type">integer</code>, <code class="type">string</code>: As per [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>] including whitespace normalization as appropriate.</p></li><li><p><code class="type">EQName</code>: With whitespace normalization as per [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>] for QNames. Note, however, that QNames that have no prefix are always in no-namespace, irrespective of the default namespace. </p></li><li><p><code class="type">EQNameList</code>: As a whitespace separated list of EQNames, per the definition above. </p></li><li><p><code class="type">PrefixList</code>: As a list with <code class="literal infoset-property">[item type]</code><code class="type">NMTOKEN</code>, per [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>], including whitespace normalization. </p></li><li><p><code class="type">ExcludeInlinePrefixes</code>: As a <code class="type">PrefixList</code> per the definition above, with the following extensions: the tokens <code class="literal">#all</code> and <code class="literal">#default</code> may appear. </p></li><li><p><code class="type">XPathExpression</code>, <code class="type">XSLTSelectionPattern</code>: As a string per [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>], including whitespace normalization, and the further requirement to be a conformant Expression per [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>] or <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em> per [<a href="#xslt30"><span class="abbrev">XSLT 3.0</span></a>]. </p></li><li><p><code class="type">MediaTypes</code>: As a whitespace separated list of media types as defined in [<a href="#rfc2046"><span class="abbrev">RFC 2046</span></a>]. </p></li></ul></div></div></section><section id="common-errors" class="section"><div class="section-titlepage"><h3><bdi class="secno">14.11. </bdi>Common errors<a aria-label="§" class="self-link" href="#common-errors"></a></h3></div><div class="content"><p>A number of errors apply generally:</p><div class="itemizedlist"><ul><li><p><a id="err.inline.S0059"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0059"><code class="errqname">err:XS0059</code></a>) if the pipeline element is not <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a>. </p></li><li><p><a id="err.inline.S0008"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0008"><code class="errqname">err:XS0008</code></a>) if any element in the XProc namespace has attributes not defined by this specification unless they are <em class="glossterm"><a href="#dt-extension-attribute">extension attributes</a></em>. </p></li><li><p><a id="err.inline.S0038"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0038"><code class="errqname">err:XS0038</code></a>) if any required attribute is not provided. </p></li><li><p><a id="err.inline.S0077.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the value on an attribute of an XProc element does not satisfy the type required for that attribute. <a id="err.inline.S0077.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the value on an attribute of an XProc element does not satisfy the type required for that attribute. </p></li><li><p><a id="err.inline.D0028"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0028"><code class="errqname">err:XD0028</code></a>) if any attribute value does not satisfy the type required for that attribute.</p></li><li><p><a id="err.inline.S0044"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0044"><code class="errqname">err:XS0044</code></a>) if any step contains an atomic step for which there is no visible declaration.</p></li><li><p><a id="err.inline.S0037"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0037"><code class="errqname">err:XS0037</code></a>) if any user extension step or any element in the XProc namespace other than <a href="#p.inline"><code class="tag-element">p:inline</code></a> directly contains text nodes that do not consist entirely of whitespace. </p></li><li><p><a id="err.inline.S0015"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0015"><code class="errqname">err:XS0015</code></a>) if a compound step has no <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em>. </p></li><li><p><span style="display: none;" class="delete_version"><a id="err.inline.D0012"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0012"><code class="errqname">err:XD0012</code></a>) if any attempt is made to dereference a URI where the scheme of the URI reference is not supported. Implementations are encouraged to support as many schemes as is practical and, in particular, they <span class="rfc2119" id="common-errors.3.9.1.2">should</span> support both the <code class="literal">file:</code> and <code class="literal">http(s):</code> schemes. <span id="impl-32">The set of URI schemes actually supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><a id="err.inline.D0012"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0012"><code class="errqname">err:XD0012</code></a>) if any attempt is made to dereference a URI where the scheme of the URI reference is not supported. Implementations are encouraged to support as many schemes as is practical and, in particular, they <span class="rfc2119" id="common-errors.3.9.1.2">should</span> support both the <code class="literal">file:</code> and <code class="literal">http(s):</code> schemes. <span id="impl-35">The set of URI schemes actually supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><a id="err.inline.D0012"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0012"><code class="errqname">err:XD0012</code></a>) if any attempt is made to dereference a URI where the scheme of the URI reference is not supported. Implementations are encouraged to support as many schemes as is practical and, in particular, they <span class="rfc2119" id="common-errors.3.9.1.2">should</span> support both the <code class="literal">file:</code> and <code class="literal">http(s):</code> schemes. <span id="impl-35">The set of URI schemes actually supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></li><li><p><a id="err.inline.D0030"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0030"><code class="errqname">err:XD0030</code></a>) if a step is unable or incapable of performing its function. This is a general error code for “step failed” (e.g., if the input isn't of the expected type or if attempting to process the input causes the implementation to abort). Users and implementers who create extension steps are encouraged to use this code for general failures.</p></li><li><p>In most steps which use a select expression or <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em>, any kind of node can be identified by the expression or pattern. However, some expressions and patterns on some steps are only applicable to some kinds of nodes (e.g., it doesn't make sense to speak of adding attributes to a comment!). </p><p><a id="err.inline.C0023"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.C0023"><code class="errqname">err:XC0023</code></a>) if a select expression or <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em> returns a node type that is not allowed by the step. </p></li><li><p><a id="err.inline.S0100"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0100"><code class="errqname">err:XS0100</code></a>) if the pipeline document does not conform to the grammar for pipeline documents. This is a general error code indicating that the pipeline is syntactically incorrect in some way not identified more precisely in this specification. </p></li><li class="add_version" style="display: none;"><p><a id="err.inline.D0083"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0083"><code class="errqname">err:XD0083</code></a>) if an expression in the pipeline is cannot be evaluated (because of errors in expression syntax, references to unbound namespace prefixes, references to unknown variables or functions, etc.). This is a general error code indicating that dynamic expression evaluation failed for some reason not identified more precisely in this specification.</p></li><li class="modify_version"><p><a id="err.inline.D0083"></a><span class="deltaxml-new" style="background:#90EE90">It is a </span><em class="glossterm"><a href="#dt-dynamic-error"><span class="deltaxml-new" style="background:#90EE90">dynamic error</span></a></em><span class="deltaxml-new" style="background:#90EE90"> (</span><a href="#err.D0083"><code class="errqname"><span class="deltaxml-new" style="background:#90EE90">err:XD0083</span></code></a><span class="deltaxml-new" style="background:#90EE90">) if an expression in the pipeline is cannot be evaluated (because of errors in expression syntax, references to unbound namespace prefixes, references to unknown variables or functions, etc.). This is a general error code indicating that dynamic expression evaluation failed for some reason not identified more precisely in this specification.</span></p></li></ul></div><p>If an XProc processor can determine statically that a dynamic error will <em>always</em> occur, it <span class="rfc2119" id="common-errors.4.2">may</span> report that error statically provided that the error <em>does not</em> occur among the descendants of a <a href="#p.try"><code class="tag-element">p:try</code></a>. Dynamic errors inside a <a href="#p.try"><code class="tag-element">p:try</code></a><span class="rfc2119" id="common-errors.4.6">must not</span> be reported statically. They must be raised dynamically so that <a href="#p.catch"><code class="tag-element">p:catch</code></a> processing can be performed on them. </p></div></section></div></section><section id="steps" class="section"><div class="section-titlepage"><h2><bdi class="secno">15. </bdi>Steps<a aria-label="§" class="self-link" href="#steps"></a></h2></div><div class="content"><p>This section describes the core language steps of XProc; the full vocabulary of standard, atomic steps is described in [<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>].</p><section id="pipelines" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.1. </bdi>Pipelines<a aria-label="§" class="self-link" href="#pipelines"></a></h3></div><div class="content"><p>The document element of a pipeline document is <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> which declares a pipeline that can be evaluated by an XProc processor.</p><p>It encapsulates the behavior of a <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. Its children declare inputs, outputs, and options that the pipeline exposes and identify the steps in its subpipeline. </p><p>Viewed from the outside, a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> is a black box which performs some calculation on its inputs and produces its outputs. From the pipeline author’s perspective, the computation performed by the pipeline is described in terms of <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> which read the pipeline’s inputs and produce the pipeline’s outputs.</p><p>A <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> element can also be nested inside other <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a> elements in which case it simply declares a pipeline that will be run elsewhere.</p><p>For more details, see <a href="#p.declare-step" title="p:declare-step">Section 16.5, “p:declare-step”</a>.</p><section id="example-pipeline" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.1.1. </bdi>Example<a aria-label="§" class="self-link" href="#example-pipeline"></a></h4></div><div class="content"><p>A pipeline might accept a document as input; perform XInclude, validation, and transformation; and produce the transformed document as its output.</p><figure id="ex.p.pipeline" class="example-wrapper"><div class="title">Example 4. A Sample Pipeline Document</div><div class="example"><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xinclude/&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema"&gt; &lt;p:document href="http://example.com/path/to/schema.xsd"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;p:xslt&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:document href="http://example.com/path/to/stylesheet.xsl"/&gt; &lt;/p:with-input&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xinclude/&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema"&gt; &lt;p:document href="http://example.com/path/to/schema.xsd"/&gt; &lt;/p:with-input&gt; &lt;/p:validate-with-xml-schema&gt; &lt;p:xslt&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:document href="http://example.com/path/to/stylesheet.xsl"/&gt; &lt;/p:with-input&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre></div></figure></div></section></div></section><section id="p.for-each" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.2. </bdi>p:for-each<a aria-label="§" class="self-link" href="#p.for-each"></a></h3></div><div class="content"><p>A for-each is specified by the <code class="tag-element">p:for-each</code> element. It is a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> that processes a sequence of documents, applying its <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> to each document in turn.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:for-each<br />  name? = <var>NCName</var>&gt;<br />    ((<a href="#p.with-input">p:with-input</a>? &amp; <br />      <a href="#p.output">p:output</a>*),<br />     <var>subpipeline</var>)<br />&lt;/p:for-each&gt;</code></p><p>When a pipeline needs to process a sequence of documents using a subpipeline that only processes a single document, the <code class="tag-element">p:for-each</code> construct can be used as a wrapper around that subpipeline. The <code class="tag-element">p:for-each</code> will apply that subpipeline to each document in the sequence in turn.</p><p>The result of the <code class="tag-element">p:for-each</code> is a sequence of documents produced by processing each individual document in the input sequence. If the <code class="tag-element">p:for-each</code> has one or more output ports, what appears on each of those ports is the sequence of documents that is the concatenation of the sequence produced by each iteration of the loop on the port to which it is connected. If the iteration source for a <code class="tag-element">p:for-each</code> is an empty sequence, then the subpipeline is never run and an empty sequence is produced on all of the outputs. </p><p>The <code class="tag-element">p:for-each</code> has a single <em class="glossterm"><a href="#dt-anonymous-input">anonymous input</a></em>: its <em class="glossterm"><a href="#dt-connection">connection</a></em> is provided by the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. If no iteration sequence is explicitly provided, then the iteration source is read from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>.</p><p>The processor provides each document, one at a time, to the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> represented by the children of the <code class="tag-element">p:for-each</code> on a port named <code class="port">current</code>.</p><p>For each declared output, the processor collects all the documents that are produced for that output from all the iterations, in order, into a sequence. The result of the <code class="tag-element">p:for-each</code> on that output is that sequence of documents.</p><p>The environment inherited by the <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> of a <code class="tag-element">p:for-each</code> is the <em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em> with these modifications:</p><div class="itemizedlist"><ul><li><p>The port named “<code class="port">current</code>” on the <code class="tag-element">p:for-each</code> is added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em>.</p></li><li><p>The port named “<code class="port">current</code>” on the <code class="tag-element">p:for-each</code> is made the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>.</p></li></ul></div><p>If the <code class="tag-element">p:for-each</code> has a <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> (explicit or <a href="#primary-input-output">supplied by default</a>) and that port has no <em class="glossterm"><a href="#dt-connection">connection</a></em>, then it is connected to the <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> of the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. <a id="err.inline.S0006"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0006"><code class="errqname">err:XS0006</code></a>) if the primary output port has no explicit connection and the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the subpipeline does not have a primary output port.</p><p>Note that outputs declared for a <code class="tag-element">p:for-each</code> serve a dual role. Inside the <code class="tag-element">p:for-each</code>, they are used to read results from the subpipeline. Outside the <code class="tag-element">p:for-each</code>, they provide the aggregated results.</p><p>The <code class="tag-attribute">sequence</code> attribute on a <a href="#p.output"><code class="tag-element">p:output</code></a> inside a <code class="tag-element">p:for-each</code> only applies inside the step. From the outside, all of the outputs produce sequences.</p><section id="for-each-xpath-context" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.2.1. </bdi>XPath Context<a aria-label="§" class="self-link" href="#for-each-xpath-context"></a></h4></div><div class="content"><p>Within a <a href="#p.for-each"><code class="tag-element">p:for-each</code></a>, the <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a> and <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a> are taken from the sequence of documents that will be processed by the <a href="#p.for-each"><code class="tag-element">p:for-each</code></a>. The total number of documents is the <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a>; the ordinal value of the current document (the document appearing on the <code class="port">current</code> port) is the <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a>.</p><div id="impl1" class="note admonition"><h3>Note to implementers</h3><div class="admonition-body"><p>In the case where no XPath expression that must be evaluated by the processor makes any reference to <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a>, its value does not actually have to be calculated (and the entire input sequence does not, therefore, need to be buffered so that its size can be calculated before processing begins).</p></div></div></div></section><section id="example-for-each" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.2.2. </bdi>Example<a aria-label="§" class="self-link" href="#example-for-each"></a></h4></div><div class="content"><p>A <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> might accept a sequence of chapters as its input, process each chapter in turn with XSLT, a step that accepts only a single input document, and produce a sequence of formatted chapters as its output.</p><figure id="ex.p.for-each" class="example-wrapper"><div class="title">Example 5. A Sample For-Each</div><div class="example"><pre class="programlisting language-markup xml"><code>&lt;p:for-each name="chapters"&gt; &lt;p:with-input select="//chapter"/&gt; &lt;p:output port="html-results"&gt; &lt;p:pipe step="make-html" port="result"/&gt; &lt;/p:output&gt; &lt;p:output port="fo-results"&gt; &lt;p:pipe step="make-fo" port="result"/&gt; &lt;/p:output&gt; &lt;p:xslt name="make-html"&gt; &lt;p:with-input port="stylesheet" href="http://example.com/xsl/html.xsl"/&gt; &lt;/p:xslt&gt; &lt;p:xslt name="make-fo"&gt; &lt;p:with-input port="source" pipe="current@chapters"/&gt; &lt;p:with-input port="stylesheet" href="http://example.com/xsl/fo.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:for-each&gt;</code></pre></div></figure><p>The <code class="code">//chapter</code> elements of the document are selected. Each chapter is transformed into HTML and XSL Formatting Objects using an XSLT step. The resulting HTML and FO documents are aggregated together and appear on the <code class="literal">html-results</code> and <code class="literal">fo-results</code> ports, respectively, of the <code class="literal">chapters</code> step itself.</p></div></section></div></section><section id="p.viewport" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.3. </bdi>p:viewport<a aria-label="§" class="self-link" href="#p.viewport"></a></h3></div><div class="content"><p>A viewport is specified by the <code class="tag-element">p:viewport</code> element. It is a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> that processes single XML or HTML documents, applying its <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> to one or more subtrees of each document in turn.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:viewport<br />  name? = <var>NCName</var><br />  <strong>match</strong> = <var>XSLTSelectionPattern</var>&gt;<br />    ((<a href="#p.with-input">p:with-input</a>? &amp; <br />      <a href="#p.output">p:output</a>?),<br />     <var>subpipeline</var>)<br />&lt;/p:viewport&gt;</code></p><p>The result of the <code class="tag-element">p:viewport</code> is a copy of the original document where the selected subtrees have been replaced by the results of applying the subpipeline to them.</p><p>The <code class="tag-element">p:viewport</code> has a single <em class="glossterm"><a href="#dt-anonymous-input">anonymous input</a></em>: its <em class="glossterm"><a href="#dt-connection">connection</a></em> is provided by the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. If no document is explicitly provided, then the viewport source is read from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. If the <code class="tag-element">p:viewport</code> input is a sequence, each document in the sequence is processed in turn producing a sequence on the output. <a id="err.inline.D0072"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0072"><code class="errqname">err:XD0072</code></a>) if a document appearing on the input port of <code class="tag-element">p:viewport</code> is neither an XML document nor an HTML document.</p><p>The <code class="tag-attribute">match</code> attribute specifies an XSLT <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em>. Each matching node in the source document is wrapped in a document node, as necessary, and provided, one at a time, to the viewport’s <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> on a port named <code class="port">current</code>. The base URI of the resulting document that is passed to the subpipeline is the base URI of the matched node. <a id="err.inline.D0010"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0010"><code class="errqname">err:XD0010</code></a>) if the <code class="tag-attribute">match</code> expression on <code class="tag-element">p:viewport</code> matches an attribute or a namespace node.</p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>The <code class="tag-attribute">match</code> attribute on <code class="tag-element">p:viewport</code> is a selection pattern and may contain references to in-scope variables and options, but it is not an <em class="glossterm"><a href="#dt-attribute-value-template">attribute value template</a></em>. </p></div></div><p>After a match is found, the entire subtree rooted at that match is processed as a unit. No further attempts are made to match nodes among the descendants of any matched node.</p><p>The environment inherited by the <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> of a <code class="tag-element">p:viewport</code> is the <em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em> with these modifications:</p><div class="itemizedlist"><ul><li><p>The port named “<code class="port">current</code>” on the <code class="tag-element">p:viewport</code> is added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em>.</p></li><li><p>The port named “<code class="port">current</code>” on the <code class="tag-element">p:viewport</code> is made the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>.</p></li></ul></div><p>The <code class="tag-element">p:viewport</code> must contain a single, <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> declared explicitly or <a href="#primary-input-output">supplied by default</a>. If that port has no <em class="glossterm"><a href="#dt-connection">connection</a></em>, then it is connected to the <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> of the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. <a id="err.inline.S0006.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0006"><code class="errqname">err:XS0006</code></a>) if the primary output port is unconnected and the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the subpipeline does not have a primary output port.</p><p>What appears on the output from the <code class="tag-element">p:viewport</code> will be a copy of the input document where each matching node is replaced by the result of applying the subpipeline to the subtree rooted at that node. In other words, if the <em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em> matches a particular node then that node is wrapped in a document node and provided on the <code class="port">current</code> port, the subpipeline in the <code class="tag-element">p:viewport</code> is evaluated, and the result that appears on the <code class="port">output</code> port replaces the matched node.</p><p>If a document resulting from applying the subpipeline to the matched node is an XML document, an HTML document, or a text document, all child nodes of the document node will be used to replace the matched node. <a id="err.inline.D0073"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0073"><code class="errqname">err:XD0073</code></a>) if the document returned by applying the subpipeline to the matched node is not an XML document, an HTML document, or a text document. </p><p>If no documents appear on the <code class="port">output</code> port, the matched node will effectively be deleted. If exactly one document appears, the contents of that document will replace the matched node. If a sequence of documents appears, then the contents of each document in that sequence (in the order it appears in the sequence) will replace the matched node.</p><p>The output of the <code class="tag-element">p:viewport</code> itself is a sequence of documents that appear on a port named “<code class="literal">result</code>”. Note that the semantics of <code class="tag-element">p:viewport</code> are special. The <code class="port">output</code> port in the <code class="tag-element">p:viewport</code> is used only to access the results of the subpipeline. The output of the step itself appears on a port with the fixed name “<code class="literal">result</code>” that is never explicitly declared.</p><p>For the documents appearing on port <code class="port">result</code> all document properties will be preserved, except when option <code class="option">match</code> matches a document node and the result from applying the subpipeline to the document node is a (sequence of) text document(s). In this case the content-type property is changed to “<code class="literal">text/plain</code>” and the serialization property is removed, while all other document properties are preserved.</p><section id="viewport-xpath-context" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.3.1. </bdi>XPath Context<a aria-label="§" class="self-link" href="#viewport-xpath-context"></a></h4></div><div class="content"><p>Within a <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>, the <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a> and <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a> are taken from the sequence of documents that will be processed by the <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>. The total number of documents is the <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a>; the ordinal value of the current document (the document appearing on the <code class="port">current</code> port) is the <a href="#f.iteration-position"><code class="function">p:iteration-position</code></a>.</p><div id="impl2" class="note admonition"><h3>Note to implementers</h3><div class="admonition-body"><p>In the case where no XPath expression that must be evaluated by the processor makes any reference to <a href="#f.iteration-size"><code class="function">p:iteration-size</code></a>, its value does not actually have to be calculated (and the entire input sequence does not, therefore, need to be buffered so that its size can be calculated before processing begins).</p></div></div></div></section><section id="example-viewport" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.3.2. </bdi>Example<a aria-label="§" class="self-link" href="#example-viewport"></a></h4></div><div class="content"><p>A <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> might accept an XHTML document as its input, add an <code class="tag-element">hr</code> element at the beginning of all <code class="tag-element">div</code> elements that have the class value “chapter”, and return an XHTML document that is the same as the original except for that change.</p><figure id="ex.p.viewport" class="example-wrapper"><div class="title">Example 6. A Sample Viewport</div><div class="example"><pre class="programlisting language-markup xml"><code>&lt;p:viewport match="h:div[@class='chapter']" xmlns:h="http://www.w3.org/1999/xhtml"&gt; &lt;p:insert position="first-child"&gt; &lt;p:with-input port="insertion"&gt; &lt;hr xmlns="http://www.w3.org/1999/xhtml"/&gt; &lt;/p:with-input&gt; &lt;/p:insert&gt; &lt;/p:viewport&gt;</code></pre></div></figure><p>The nodes which match <code class="code">h:div[@class='chapter']</code> in the input document are selected. An <code class="code">hr</code> is inserted as the first child of each <code class="code">h:div</code> and the resulting version replaces the original <code class="code">h:div</code>. The result of the whole step is a copy of the input document with a horizontal rule as the first child of each selected <code class="code">h:div</code>.</p></div></section></div></section><section id="p.choose" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.4. </bdi>p:choose<a aria-label="§" class="self-link" href="#p.choose"></a></h3></div><div class="content"><p>A choose step is specified by the <code class="tag-element">p:choose</code> element. It is a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> that contains several, alternate subpipelines. One subpipeline is selected based on the evaluation of XPath expressions.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:choose<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     ((<a href="#p.when">p:when</a>+,<br />       <a href="#p.otherwise">p:otherwise</a>?) | <br />      (<a href="#p.when">p:when</a>*,<br />       <a href="#p.otherwise">p:otherwise</a>)))<br />&lt;/p:choose&gt;</code></p><p>A <code class="tag-element">p:choose</code> contains an arbitrary number of alternative <em class="glossterm"><a href="#dt-subpipeline">subpipelines</a></em>, at most one of which will be evaluated. <a id="err.inline.S0074"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0074"><code class="errqname">err:XS0074</code></a>) if a <code class="tag-element">p:choose</code> has neither a <a href="#p.when"><code class="tag-element">p:when</code></a> nor a <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a>.</p><p>The list of alternative subpipelines consists of zero or more subpipelines guarded by an XPath expression, followed optionally by a single default subpipeline.</p><p>The <code class="tag-element">p:choose</code> considers each subpipeline in turn and selects the first (and only the first) subpipeline for which the guard expression evaluates to true in its context. After a subpipeline is selected, no further guard expressions are evaluated. If there are no subpipelines for which the expression evaluates to true then, if a default subpipeline was specified, it is selected, otherwise, no subpipeline is selected.</p><p>After a <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> is selected, it is evaluated as if only it had been present.</p><p>The outputs of the <code class="tag-element">p:choose</code> are taken from the outputs of the selected <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. The outputs <em>available</em> from the <code class="tag-element">p:choose</code> are union of all of the outputs declared in any of its alternative subpipelines. In order to maintain consistency with respect to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>, if any subpipeline has a <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em>, even implicitly, then <em>every</em> subpipline must have a primary output port with the same name. In some cases, this may require making the implicit primary output explicit in order to assure that it has the same name. <a id="err.inline.S0102"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0102"><code class="errqname">err:XS0102</code></a>) if alternative subpipelines have different primary output ports. </p><p>Consider a <code class="tag-element">p:choose</code> that has two alternative subpipelines where one declares output ports “A” and “B” and the other declares output ports “B” and “C”. The outputs available from the <code class="tag-element">p:choose</code> are “A”, “B”, and “C”. No documents appear on any outputs not declared in the subpipline actually selected.</p><p>As a convenience to authors, it is not an error if some subpipelines declare outputs that can produce sequences and some do not. Each output of the <code class="tag-element">p:choose</code> is declared to produce a sequence. The content types that can appear on the port are the union of the content types that might be produced by any of the <a href="#p.when"><code class="tag-element">p:when</code></a> or the <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a>. If a primary output port is (explicitly or implicitly) defined and <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> is missing, documents with <em>any</em> content type can appear on that port. </p><p>The <code class="tag-element">p:choose</code> can specify the context item against which the XPath expressions that occur on each branch are evaluated. The context item is specified as a <em class="glossterm"><a href="#dt-connection">connection</a></em> in the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. If no explicit connection is provided, the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is used. If the context item is connected to <a href="#p.empty"><code class="tag-element">p:empty</code></a>, or is connected to more than one document, or is unconnected and the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is undefined, the context item is undefined. <a id="err.inline.D0001"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined. </p><p>Each conditional <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> is represented by a <a href="#p.when"><code class="tag-element">p:when</code></a> element. The default branch is represented by a <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> element. These elements are not sibling steps in the usual sense, the names of sibling <a href="#p.when"><code class="tag-element">p:when</code></a> elements and the <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> element are not in <a href="#scoping">the same scope</a>.</p><p>If the following conditions apply:</p><div class="itemizedlist"><ul><li><p>The <code class="tag-element">p:choose</code> does not contain a <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> child element</p></li><li><p>The <a href="#p.when"><code class="tag-element">p:when</code></a> branches all define a primary output port (either implicitly or explicitly)</p></li><li><p>None of the effective boolean values of the <a href="#p.when"><code class="tag-element">p:when</code></a> test expressions evaluates to <code class="code">true</code></p></li></ul></div><p>Then the <code class="tag-element">p:choose</code> copies any documents that appear on its default readable port to its primary output port. No documents will be written to the primary output port if there isn’t a default readable port, but that is not an error in this case. No documents will ever be written to any non-primary output ports in this case.</p><p>Informally: the default sub-pipeline for a missing <a href="#p.otherwise"><code class="tag-element">p:otherwise</code></a> is a <code class="tag-element">p:identity</code> step (with the additional feature that it isn’t an error if there’s no default readable port). If the <a href="#p.when"><code class="tag-element">p:when</code></a> branches do not have a primary output port, no output will be produced on any port.</p><section id="p.when" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.4.1. </bdi>p:when<a aria-label="§" class="self-link" href="#p.when"></a></h4></div><div class="content"><p>A when specifies one subpipeline guarded by a test expression. </p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:when<br />  name? = <var>NCName</var><br />  <strong>test</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     <a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:when&gt;</code></p><p>Each <code class="tag-element">p:when</code> branch of the <a href="#p.choose"><code class="tag-element">p:choose</code></a> has a <code class="tag-attribute">test</code> attribute which <span class="rfc2119" id="p.when.4.4">must</span> contain an XPath expression. That XPath expression’s effective boolean value is the guard for the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> contained within that <code class="tag-element">p:when</code>.</p><p>The <code class="tag-element">p:when</code> can specify a context item against which its <code class="tag-attribute">test</code> expression is to be evaluated. That context item is specified as a <em class="glossterm"><a href="#dt-connection">connection</a></em> for the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. If no context is specified on the <code class="tag-element">p:when</code>, the context of the <a href="#p.choose"><code class="tag-element">p:choose</code></a> is used. The context item is undefined if the connection or the context of the <a href="#p.choose"><code class="tag-element">p:choose</code></a> provides no or more than one document. <a id="err.inline.D0001.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined.</p><p>If the <code class="tag-attribute">collection</code> attribute has the value true, then the default collection will contain all of the documents that appeared on that input and the context item will be undefined. </p></div></section><section id="p.otherwise" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.4.2. </bdi>p:otherwise<a aria-label="§" class="self-link" href="#p.otherwise"></a></h4></div><div class="content"><p>An otherwise specifies the default branch; the subpipeline selected if no test expression on any preceding <a href="#p.when"><code class="tag-element">p:when</code></a> evaluates to true.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:otherwise<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:otherwise&gt;</code></p></div></section><section id="example-choose" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.4.3. </bdi>Example<a aria-label="§" class="self-link" href="#example-choose"></a></h4></div><div class="content"><p>A <a href="#p.choose"><code class="tag-element">p:choose</code></a> might test the version attribute of the document element and validate with an appropriate schema.</p><figure id="ex.p.choose" class="example-wrapper"><div class="title">Example 7. A Sample Choose</div><div class="example"><pre class="programlisting language-markup xml"><code>&lt;p:choose name="version"&gt; &lt;p:when test="/*[@version = 2]"&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v2schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:when&gt; &lt;p:when test="/*[@version = 1]"&gt; &lt;p:validate-with-xml-schema&gt; &lt;p:with-input port="schema" href="v1schema.xsd"/&gt; &lt;/p:validate-with-xml-schema&gt; &lt;/p:when&gt; &lt;p:when test="/*[@version]"&gt; &lt;p:identity/&gt; &lt;/p:when&gt; &lt;p:otherwise&gt; &lt;p:error code="NOVERSION"&gt; &lt;p:with-input port="source"&gt; &lt;p:inline&gt; &lt;message&gt;Required version attribute missing.&lt;/message&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:error&gt; &lt;/p:otherwise&gt; &lt;/p:choose&gt;</code></pre></div></figure></div></section></div></section><section id="p.if" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.5. </bdi>p:if<a aria-label="§" class="self-link" href="#p.if"></a></h3></div><div class="content"><p>A <code class="tag-element">p:if</code> specifies a single subpipeline guarded by a test expression.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:if<br />  name? = <var>NCName</var><br />  <strong>test</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     <a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:if&gt;</code></p><p>The <code class="tag-element">p:if</code> step has a <code class="tag-attribute">test</code> attribute which <span class="rfc2119" id="p.if.4.3">must</span> contain an XPath expression. That XPath expression’s effective boolean value is the guard for the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> contained within it. </p><p>The <code class="tag-element">p:if</code> step can specify a context item against which its <code class="tag-attribute">test</code> expression is to be evaluated. That context node is specified as a <em class="glossterm"><a href="#dt-connection">connection</a></em> for the <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>. If no context is specified on the <code class="tag-element">p:if</code>, the context comes from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. If no context is specified and there is no default readable port, the context item is undefined. The context item is also undefined, if no or more than one document is provided. <a id="err.inline.D0001.2"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined.</p><p>If the <code class="tag-attribute">collection</code> attribute has the value true, then the default collection will contain all of the documents that appeared on that input and the context item will be undefined. </p><p>The <code class="tag-element">p:if</code> must specify a primary output port (either implicitly or explicitly). <a id="err.inline.S0108"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0108"><code class="errqname">err:XS0108</code></a>) if the <code class="tag-element">p:if</code> step does not specify a primary output port. </p><p>The requirement for a primary output port stems from the semantics of <code class="tag-element">p:if</code>:</p><div class="itemizedlist"><ul><li><p>If the effective boolean value of the test expression is true, then the subpipline will be run. The output of the <code class="tag-element">p:if</code> in this case is determined by the output ports of the step and what the subpipeline sends to them.</p></li><li><p>If the effective boolean value of the test expression is false, then <code class="tag-element">p:if</code> copies any documents that appear on its default readable port to its primary output port. No documents will be written to the primary output port if there isn’t a default readable port, but that is not an error in this case. No documents will ever be written to any non-primary output ports if the test expression is false.</p></li></ul></div><p>Informally, if the test expression is false, then <code class="tag-element">p:if</code> acts like the identity step (with the additional feature that it isn’t an error if there’s no default readable port). A primary output port is required in order to make these semantics meaningful and consistent.</p><p>The <code class="tag-attribute">sequence</code> attribute and the <code class="tag-attribute">content-types</code> attribute of the primary output port only apply to the subpipeline of <code class="tag-element">p:if</code>. From the outside a primary output port of a <code class="tag-element">p:if</code> produces sequences and allows documents of any content type. For all other output ports the <code class="tag-attribute">sequence</code> attribute only applies to the subpipeline, while on the outside these ports may produce sequences.</p></div></section><section id="p.group" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.6. </bdi>p:group<a aria-label="§" class="self-link" href="#p.group"></a></h3></div><div class="content"><p>A group is specified by the <code class="tag-element">p:group</code> element. It is a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> that encapsulates the behavior of its <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:group<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:group&gt;</code></p><p>A <code class="tag-element">p:group</code> is a convenience wrapper for a collection of steps. </p><section id="example-group" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.6.1. </bdi>Example<a aria-label="§" class="self-link" href="#example-group"></a></h4></div><div class="content"><figure id="ex.p.group" class="example-wrapper"><div class="title">Example 8. An Example Group</div><div class="example"><pre class="programlisting language-markup xml"><code>&lt;p:group&gt; &lt;p:variable name="db-key" select="'some-long-string-of-nearly-random-characters'"/&gt; &lt;p:choose&gt; &lt;p:when test="/config/output = 'fo'"&gt; &lt;p:xslt&gt; &lt;p:with-option name="parameters" select="map {'key': $db-key }"/&gt; &lt;p:with-input port="stylesheet" href="fo.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:when&gt; &lt;p:when test="/config/output = 'svg'"&gt; &lt;p:xslt&gt; &lt;p:with-option name="parameters" select="map {'key': $db-key }"/&gt; &lt;p:with-input port="stylesheet" href="svg.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:when&gt; &lt;p:otherwise&gt; &lt;p:xslt&gt; &lt;p:with-option name="parameters" select="map {'key': $db-key }"/&gt; &lt;p:with-input port="stylesheet" href="html.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:otherwise&gt; &lt;/p:choose&gt; &lt;/p:group&gt;</code></pre></div></figure></div></section></div></section><section id="p.try" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.7. </bdi>p:try<a aria-label="§" class="self-link" href="#p.try"></a></h3></div><div class="content"><p>A try/catch step is specified by the <code class="tag-element">p:try</code> element. It is a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> that isolates its initial subpipeline, preventing dynamic errors that arise within it from being exposed to the rest of the pipeline. The <code class="tag-element">p:try</code> includes alternate recovery subpipelines, and may include a “finally” subpipeline to perform post-processing irrespective of the outcome of the <code class="tag-element">p:try</code>.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:try<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>,<br />     ((<a href="#p.catch">p:catch</a>+,<br />        <a href="#p.finally">p:finally</a>?) | <br />       (<a href="#p.catch">p:catch</a>*,<br />        <a href="#p.finally">p:finally</a>)))<br />&lt;/p:try&gt;</code></p><p>The step begins with the initial subpipeline; the recovery (or “catch”) pipelines are identified with <a href="#p.catch"><code class="tag-element">p:catch</code></a> elements; a “finally” pipeline is identified with a <a href="#p.finally"><code class="tag-element">p:finally</code></a> element.</p><p><a id="err.inline.S0075"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0075"><code class="errqname">err:XS0075</code></a>) if a <code class="tag-element">p:try</code> does not have at least one subpipeline step, at least one of <a href="#p.catch"><code class="tag-element">p:catch</code></a> or <a href="#p.finally"><code class="tag-element">p:finally</code></a>, and at most one <a href="#p.finally"><code class="tag-element">p:finally</code></a>.</p><p>The <code class="tag-element">p:try</code> step evaluates the initial subpipeline and, if no errors occur, the outputs of that pipeline are the outputs of the <code class="tag-element">p:try</code> step. However, if any errors occur, the <code class="tag-element">p:try</code> abandons the first subpipeline, discarding any output that it might have generated, and considers the recovery subpipelines. If there is no matching recovery subpipeline, the <code class="tag-element">p:try</code> fails. </p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>If the initial subpipeline fails, none of its outputs will be visible outside of the <code class="tag-element">p:try</code>, but it’s still possible for steps in the partially evaluated pipeline to have side effects that are visible outside the processor. For example, a web server might record that some interaction was performed, or a file on the local file system might have been modified.</p></div></div><p>If a recovery subpipeline is evaluated, the outputs of the recovery subpipeline are the outputs of the <code class="tag-element">p:try</code> step. If the recovery subpipeline is evaluated and a step within that subpipeline fails, the <code class="tag-element">p:try</code> fails.</p><p>Irrespective of whether the initial subpipeline succeeds or fails, if any recovery pipeline is selected, and whether it succeeds or fails, the <a href="#p.finally"><code class="tag-element">p:finally</code></a> block is <em>always</em> run after all other processing of the <code class="tag-element">p:try</code> has finished.</p><p>The outputs of the <code class="tag-element">p:try</code> are taken from the outputs of the initial <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> or the recovery subpipline if an error occurred in the initial subpipeline. The outputs <em>available</em> from the <code class="tag-element">p:try</code> are union of all of the outputs declared (explicitly or implicitly in the absence of any <a href="#p.output"><code class="tag-element">p:output</code></a> elements if the <em class="glossterm"><a href="#dt-last-step">last step</a></em> has a primary output port) in any of its alternative subpipelines. In order to maintain consistency with respect to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>, if any subpipeline has a <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em>, even implicitly, then <em>every</em> subpipline must have a primary output port with the same name. In some cases, this may require making the implicit primary output explicit in order to assure that it has the same name. <a id="err.inline.S0102.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0102"><code class="errqname">err:XS0102</code></a>) if alternative subpipelines have different primary output ports. </p><p>Consider a <code class="tag-element">p:try</code> that has an initial subpipeline that declares output ports “A” and “B” and a recovery subpipeline that declares output ports “B” and “C”. The outputs available from the <code class="tag-element">p:try</code> are “A”, “B”, and “C”. No documents appear on any outputs not declared in the subpipeline whose results are actually returned.</p><p>As a convenience to authors, it is not an error if an output port can produce a sequence in the initial subpipeline but not in the recovery subpipeline, or vice versa. Each output of the <code class="tag-element">p:try</code> is declared to produce a sequence. The content types that can appear on the port are the union of the content types that might be produced by the initial subpipeline and any of the recovery subpipelines. </p><p>A pipeline author can cause an error to occur with the <a href="#cv.error"><code class="tag-element">p:error</code></a> step.</p><p>If we assume that an absent <a href="#p.finally"><code class="tag-element">p:finally</code></a> always succeeds, evaluation of a <code class="tag-element">p:try</code> falls into one of these cases:</p><div class="itemizedlist"><ul><li><p>If the initial pipeline succeeds:</p><div class="itemizedlist"><ul><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> succeeds, the <code class="tag-element">p:try</code> succeeds and the outputs of the initial subpipeline are the outputs of the <code class="tag-element">p:try</code>. </p></li><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> fails, the <code class="tag-element">p:try</code> fails and the error raised by the <a href="#p.finally"><code class="tag-element">p:finally</code></a> is reported as the cause of the failure.</p></li></ul></div></li><li><p>If the initial pipeline fails and a recovery subpipeline is selected:</p><div class="itemizedlist"><ul><li><p>If the recovery pipeline succeeds:</p><div class="itemizedlist"><ul><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> succeeds, the <code class="tag-element">p:try</code> succeeds and the outputs of the recovery subpipeline are the outputs of the <code class="tag-element">p:try</code>. </p></li><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> fails, the <code class="tag-element">p:try</code> fails and the error raised by the <a href="#p.finally"><code class="tag-element">p:finally</code></a> is reported as the cause of the failure.</p></li></ul></div></li><li><p>If the recovery pipeline fails:</p><div class="itemizedlist"><ul><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> succeeds, the <code class="tag-element">p:try</code> fails and the error raised by the recovery subpipeline is reported as the cause of the failure.</p></li><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> fails, the <code class="tag-element">p:try</code> fails and the error raised by the <em>recovery subpipeline</em><span class="rfc2119" id="p.try.15.2.2.2.2.2.1.4">must</span> be reported as the cause of the failure. The error raised by the finally pipeline <span class="rfc2119" id="p.try.15.2.2.2.2.2.1.5">may</span> also be reported in addition to the error raised by the recovery pipeline.</p></li></ul></div></li></ul></div></li><li><p>If the initial pipeline fails and a recovery subpipeline is not selected:</p><div class="itemizedlist"><ul><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> succeeds, the <code class="tag-element">p:try</code> fails and the error raised by the initial subpipeline is reported as the cause of the failure.</p></li><li><p>If the <a href="#p.finally"><code class="tag-element">p:finally</code></a> fails, the <code class="tag-element">p:try</code> fails and the error raised by the <em>initial subpipeline</em><span class="rfc2119" id="p.try.15.3.2.2.1.4">must</span> be reported as the cause of the failure. The error raised by the finally pipeline <span class="rfc2119" id="p.try.15.3.2.2.1.5">may</span> also be reported in addition to the error raised by the initial subpipeline.</p></li></ul></div></li></ul></div><p>The <a href="#p.catch"><code class="tag-element">p:catch</code></a> and <a href="#p.finally"><code class="tag-element">p:finally</code></a> elements are not sibling steps, the names of sibling <a href="#p.catch"><code class="tag-element">p:catch</code></a> elements and the <a href="#p.finally"><code class="tag-element">p:finally</code></a> element are not in <a href="#scoping">the same scope</a>. The elements of the initial subpipeline are also not in the same scope as the <a href="#p.catch"><code class="tag-element">p:catch</code></a> and <a href="#p.finally"><code class="tag-element">p:finally</code></a> elements or their descendants.</p><section id="p.catch" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.7.1. </bdi>p:catch<a aria-label="§" class="self-link" href="#p.catch"></a></h4></div><div class="content"><p>A <code class="tag-element">p:catch</code> is a recovery subpipeline.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:catch<br />  name? = <var>NCName</var><br />  code? = <var>EQNameList</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:catch&gt;</code></p><p>The environment inherited by the <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> of the <code class="tag-element">p:catch</code> is the <em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em> with these modifications:</p><div class="itemizedlist"><ul><li><p>A primary input port named “<code class="port">error</code>” is added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> on the <code class="tag-element">p:catch</code>.</p></li><li><p>Output ports and variables from the <a href="#p.try"><code class="tag-element">p:try</code></a>’s subpipeline are not available.</p></li></ul></div><p>All except the last <code class="tag-element">p:catch</code> pipeline <span class="rfc2119" id="p.catch.6.2">must</span> have a <code class="tag-attribute">code</code> attribute. <a id="err.inline.S0064"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0064"><code class="errqname">err:XS0064</code></a>) if the <code class="tag-attribute">code</code> attribute is missing from any but the last <code class="tag-element">p:catch</code> or if any error code occurs in more than one <code class="tag-attribute">code</code> attribute among sibling <code class="tag-element">p:catch</code> elements. <a id="err.inline.S0083"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0083"><code class="errqname">err:XS0083</code></a>) if the value of the <code class="tag-attribute">code</code> attribute is not a whitespace separated list of EQNames.</p><p>When a <a href="#p.try"><code class="tag-element">p:try</code></a> considers the recovery subpipelines, if any of the specified error codes in a <code class="tag-element">p:catch</code> match the error that was raised in the initial subpipeline, then that <code class="tag-element">p:catch</code> is selected as the recovery pipeline. If the last <code class="tag-element">p:catch</code> does not have a <code class="tag-attribute">code</code> attribute, it is selected if no other <code class="tag-element">p:catch</code> has a matching error code. </p><p>What appears on the <code class="port">error</code> input port is an <a href="#err-vocab">error document</a>. The error document may contain messages generated by steps that were part of the initial subpipeline. Not all messages that appear are indicative of errors; for example, it is common for all <code class="tag-element">xsl:message</code> output from the XSLT component to appear on the <code class="port">error</code> input port. It is possible that the component which fails may not produce any messages at all. It is also possible that the failure of one component may cause others to fail so that there may be multiple failure messages in the document.</p></div></section><section id="p.finally" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.7.2. </bdi>p:finally<a aria-label="§" class="self-link" href="#p.finally"></a></h4></div><div class="content"><p>The last thing that the <a href="#p.try"><code class="tag-element">p:try</code></a> step does is evaluate the <code class="tag-element">p:finally</code> pipeline.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:finally<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:finally&gt;</code></p><p>The environment inherited by the <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em> of the <code class="tag-element">p:finally</code> is the <em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em> with these modifications:</p><div class="itemizedlist"><ul><li><p>A primary input port named “<code class="port">error</code>” is added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> on the <code class="tag-element">p:finally</code>.</p></li><li><p>Output ports and variables from the <a href="#p.try"><code class="tag-element">p:try</code></a>’s subpipeline are not available.</p></li></ul></div><p>If no error occurred, there will be no documents on the <code class="port">error</code> port. </p><p>The <code class="tag-element">p:finally</code> exists only to handle recovery and resource cleanup tasks. Because the <code class="tag-element">p:finally</code> will always be evaluated, it must not have output ports that might conflict with the output ports of either the initial subpipline or any <a href="#p.catch"><code class="tag-element">p:catch</code></a>. <a id="err.inline.S0072"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0072"><code class="errqname">err:XS0072</code></a>) if the name of any output port on the <code class="tag-element">p:finally</code> is the same as the name of any other output port in the <a href="#p.try"><code class="tag-element">p:try</code></a> or any of its sibling <a href="#p.catch"><code class="tag-element">p:catch</code></a> elements. <a id="err.inline.S0112"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0112"><code class="errqname">err:XS0112</code></a>) if <code class="tag-element">p:finally</code> declares a primary output port either explicitly or implicitly. </p></div></section><section id="err-vocab" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.7.3. </bdi>The Error Vocabulary<a aria-label="§" class="self-link" href="#err-vocab"></a></h4></div><div class="content"><p>In general, it is very difficult to predict error behavior. Step failure may be catastrophic (programmer error), or it may be the result of user error, resource failures, etc. Steps may detect more than one error, and the failure of one step may cause other steps to fail as well.</p><p>The <a href="#p.try"><code class="tag-element">p:try</code></a>/<a href="#p.catch"><code class="tag-element">p:catch</code></a> mechanism gives pipeline authors the opportunity to process the errors that caused the <a href="#p.try"><code class="tag-element">p:try</code></a> to fail. In order to facilitate some modicum of interoperability among processors, errors that are reported on the <code class="literal">error</code> input port of a <a href="#p.catch"><code class="tag-element">p:catch</code></a><span class="rfc2119" id="err-vocab.3.6">should</span> conform to the format described here. </p><section id="cv.errors" class="section"><div class="section-titlepage"><h5><bdi class="secno">15.7.3.1. </bdi>c:errors<a aria-label="§" class="self-link" href="#cv.errors"></a></h5></div><div class="content"><p>The error vocabulary consists of a root element, <code class="tag-element">c:errors</code> which contains zero or more <a href="#cv.error"><code class="tag-element">c:error</code></a> elements.</p><p class="element-syntax element-syntax-error-vocabulary"><code>&lt;c:errors&gt;<br />    <a href="#cv.error">c:error</a>*<br />&lt;/c:errors&gt;</code></p></div></section><section id="cv.error" class="section"><div class="section-titlepage"><h5><bdi class="secno">15.7.3.2. </bdi>c:error<a aria-label="§" class="self-link" href="#cv.error"></a></h5></div><div class="content"><p>Each specific error is represented by an <code class="tag-element">c:error</code> element:</p><p class="element-syntax element-syntax-error-vocabulary"><code>&lt;c:error<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  code? = <var>EQName</var><br />  cause? = <var>EQName</var><br />  href? = <var>anyURI</var><br />  line? = <var>integer</var><br />  column? = <var>integer</var><br />  offset? = <var>integer</var>&gt;<br />    <var>anyNode</var>*<br />&lt;/c:error&gt;</code></p><p>The <code class="tag-attribute">name</code> and <code class="tag-attribute">type</code> attributes identify the name and type, respectively, of the step which failed.</p><p>The <code class="tag-attribute">code</code> is an EQName which identifies the error. For steps which have defined error codes, this is an opportunity for the step to identify the error in a machine-processable fashion. Many steps omit this because they do not include the concept of errors identified by EQNames.</p><p><span style="display: none;" class="delete_version">The <code class="tag-attribute">cause</code> is an EQName which identifies an underlying error, if applicable. As an aide to interoperability, this specification mandates particular error codes for conditions that can arise in a variety of ways. For example, <code class="code">err:XD0050</code> is raised for all errors in XPath expressions in value templates. The implementation may use <code class="tag-attribute">cause</code> to record an underlying error (for example, the XPath error code). <span id="impl-33">The error codes that appear in <code class="tag-attribute">cause</code> are <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version">The <code class="tag-attribute">cause</code> is an EQName which identifies an underlying error, if applicable. As an aide to interoperability, this specification mandates particular error codes for conditions that can arise in a variety of ways. For example, <code class="code">err:XD0050</code> is raised for all errors in XPath expressions in value templates. The implementation may use <code class="tag-attribute">cause</code> to record an underlying error (for example, the XPath error code). <span id="impl-36">The error codes that appear in <code class="tag-attribute">cause</code> are <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version">The <code class="tag-attribute">cause</code> is an EQName which identifies an underlying error, if applicable. As an aide to interoperability, this specification mandates particular error codes for conditions that can arise in a variety of ways. For example, <code class="code">err:XD0050</code> is raised for all errors in XPath expressions in value templates. The implementation may use <code class="tag-attribute">cause</code> to record an underlying error (for example, the XPath error code). <span id="impl-36">The error codes that appear in <code class="tag-attribute">cause</code> are <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p><p>If the error was caused by a specific document, or by the location of some erroneous construction in a specific document, the <code class="tag-attribute">href</code>, <code class="tag-attribute">line</code>, <code class="tag-attribute">column</code>, and <code class="tag-attribute">offset</code> attributes identify this location. Generally, the error location is identified either with line and column numbers or with an offset from the beginning of the document, but not usually both.</p><p>The content of the <code class="tag-element">c:error</code> element is any well-formed XML. Specific steps, or specific implementations, may provide more detail about the format of the content of an error message.</p></div></section><section id="error-example" class="section"><div class="section-titlepage"><h5><bdi class="secno">15.7.3.3. </bdi>Error Example<a aria-label="§" class="self-link" href="#error-example"></a></h5></div><div class="content"><p>Consider the following XSLT stylesheet:</p><pre class="programlisting language-markup xml"><code>&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"&gt; &lt;xsl:template match="/"&gt; &lt;xsl:message terminate="yes"&gt; &lt;xsl:text&gt;This stylesheet is &lt;/xsl:text&gt; &lt;emph&gt;pointless&lt;/emph&gt; &lt;xsl:text&gt;.&lt;/xsl:text&gt; &lt;/xsl:message&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code></pre><p>If it was used in a step named “xform” in a <a href="#p.try"><code class="tag-element">p:try</code></a>, the following error document might be produced:</p><pre class="programlisting language-markup xml"><code>&lt;c:errors xmlns:c="http://www.w3.org/ns/xproc-step"&gt; &lt;c:error name="xform" type="p:xslt" href="style.xsl" line="6"&gt;This stylesheet is &lt;emph&gt;pointless&lt;/emph&gt;.&lt;/c:error&gt; &lt;/c:errors&gt;</code></pre><p>It is not an error for steps to generate non-standard error output as long as it is well-formed.</p></div></section></div></section><section id="example-try" class="section tocsuppress"><div class="section-titlepage"><h4><bdi class="secno">15.7.4. </bdi>Example<a aria-label="§" class="self-link" href="#example-try"></a></h4></div><div class="content"><p>A pipeline might attempt to process a document by dispatching it to some web service. If the web service succeeds, then those results are passed to the rest of the pipeline. However, if the web service cannot be contacted or reports an error, the <a href="#p.catch"><code class="tag-element">p:catch</code></a> step can provide some sort of default for the rest of the pipeline.</p><figure id="ex.p.trycatch" class="example-wrapper"><div class="title">Example 9. An Example Try/Catch</div><div class="example"><pre class="programlisting language-markup xml"><code>&lt;p:try&gt; &lt;p:http-request method="post" href="http://example.com/form-action"&gt; &lt;p:with-input&gt; &lt;p:inline content-type="application/x-www-form-urlencoded" &gt;name=W3C&amp;amp;spec=XProc&lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:http-request&gt; &lt;p:catch&gt; &lt;p:identity&gt; &lt;p:with-input port="source"&gt; &lt;p:inline&gt; &lt;c:error&gt;HTTP Request Failed&lt;/c:error&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;/p:catch&gt; &lt;/p:try&gt;</code></pre></div></figure></div></section></div></section><section id="p.atomic" class="section"><div class="section-titlepage"><h3><bdi class="secno">15.8. </bdi>Atomic Steps<a aria-label="§" class="self-link" href="#p.atomic"></a></h3></div><div class="content"><p><span style="display: none;" class="delete_version"><span id="dt-atomic-step" class="termdef">[Definition: An <em class="glossterm">atomic step</em> is a step that does not contain a subpipline when it is invoked.]</span> The built-in steps described in [<a><span class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span class="modify_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span></a>] are atomic. Steps like <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.try"><code class="tag-element">p:try</code></a> that always have a subpipline are <em>not</em> atomic. </span><span style="display: none;" class="add_version"><span id="dt-atomic-step" class="termdef">[Definition: An <em class="glossterm">atomic step</em> is a step that does not contain a subpipline when it is invoked.]</span> The built-in steps described in [<a><span class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span></a>] are atomic. Steps like <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.try"><code class="tag-element">p:try</code></a> that always have a subpipline are <em>not</em> atomic. </span><span class="modify_version"><span id="dt-atomic-step" class="termdef">[Definition: An <em class="glossterm">atomic step</em> is a step that does not contain a subpipline when it is invoked.]</span> The built-in steps described in [<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>] are atomic. Steps like <a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.try"><code class="tag-element">p:try</code></a> that always have a subpipline are <em>not</em> atomic. </span></p><p><span style="display: none;" class="delete_version">Steps declared with <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are atomic <em>when they are invoked</em>. <span id="impl-34">It is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> whether or not atomic steps can be defined through some other means.</span></span><span style="display: none;" class="add_version">Steps declared with <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are atomic <em>when they are invoked</em>. <span id="impl-37">It is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> whether or not atomic steps can be defined through some other means.</span></span><span class="modify_version">Steps declared with <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are atomic <em>when they are invoked</em>. <span id="impl-37">It is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> whether or not atomic steps can be defined through some other means.</span></span></p><p>The following table gives an overview over the types of atomic steps and the terms associated with these types:</p><figure id="p.atomic.5" class="informaltable-wrapper"><div class="informaltable"><table border="0" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; ">Provider</th><th style="border-right: 1px solid ; border-bottom: 1px solid ; ">Namespace (Prefix)</th><th style="border-right: 1px solid ; border-bottom: 1px solid ; ">Implemented in</th><th style="border-bottom: 1px solid ; ">Term</th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " rowspan="4">XProc processor</td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " rowspan="2"><code class="uri">http://www.w3.org/ns/xproc</code> (<code class="literal">p:</code>)</td><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">XProc</td><td style="border-bottom: 1px solid ; ">Processor-provided or standard (atomic) step implemented in XProc (there are currently no such steps defined)</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">Other technology</td><td style="border-bottom: 1px solid ; ">Processor-provided or standard (atomic) step</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " rowspan="2">Other namespace</td><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">XProc</td><td style="border-bottom: 1px solid ; ">Processor-provided extension (atomic) step implemented in XProc</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">Other technology</td><td style="border-bottom: 1px solid ; ">Processor-provided extension (atomic) step</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " rowspan="2">Other (pipeline author or third party)</td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " rowspan="2">Other namespace</td><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">XProc</td><td style="border-bottom: 1px solid ; ">User-defined (atomic) (extension) step</td></tr><tr><td style="border-right: 1px solid ; ">Other technology</td><td>(Third-party) (atomic) extension step</td></tr></tbody></table></div></figure><section id="p.standard" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.8.1. </bdi>Processor-provided standard atomic steps<a aria-label="§" class="self-link" href="#p.standard"></a></h4></div><div class="content"><p>In addition to the six step types described in the preceding sections, XProc provides a standard library of atomic step types. The full vocabulary of standards steps is described in [<a><span style="display: none;" class="delete_version" href="#steps30"><span class="abbrev">Steps 3.0</span></span><span style="display: none;" class="add_version" href="#steps31"><span class="abbrev">Steps 3.1</span></span><span class="modify_version" href="#steps31"><span class="abbrev">Steps <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></span></span></a>].</p><p>In addition to these standard atomic steps, other specifications by the same standardization body may define other optional steps in the XProc namespace, for example, validation or file system related steps.</p><p>Whether all steps in the XProc namespace are referred to as “standard (atomic) steps” or only the steps in the standard step library, depends on context and is intentionally kept fuzzy. Steps in the XProc namespace that are not included in the standard step library may also be referred to as “optional standard steps” if further distinction is required.</p><p>All of the standard (including optional), atomic steps are invoked in the same way:</p><p class="element-syntax element-syntax-language-construct"><code>&lt;<var>p:atomic-step</var><br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a> | <br />     <a href="#p.with-option">p:with-option</a>)*<br />&lt;/<var>p:atomic-step</var>&gt;</code></p><p>Where “<em class="replaceable"><code>p:atomic-step</code></em>” <span class="rfc2119" id="p.standard.7.2">must</span> be in the XProc namespace and <span class="rfc2119" id="p.standard.7.3">must</span> either be declared in the standard library or in an optional standard library for the XProc version supported by the processor (see <a href="#versioning-considerations" title="Versioning Considerations">Section 13, “Versioning Considerations”</a>). </p><p>Like the aforementioned processor-provided steps, hypothetical processor-provided atomic steps <em>implemented in XProc</em> are also in the XProc namespace and need not be explicitly imported by the surrounding pipeline.</p></div></section><section id="p.extension" class="section"><div class="section-titlepage"><h4><bdi class="secno">15.8.2. </bdi>Extension Steps<a aria-label="§" class="self-link" href="#p.extension"></a></h4></div><div class="content"><p>Pipeline authors may also have access to additional steps not defined or described by this specification. Such an <em class="glossterm"><a href="#dt-external-step">external step</a></em> is invoked just like the standard steps:</p><p class="element-syntax element-syntax-language-construct"><code>&lt;<var>ext:atomic-step</var><br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a> | <br />     <a href="#p.with-option">p:with-option</a>)*<br />&lt;/<var>ext:atomic-step</var>&gt;</code></p><p>Extension steps <span class="rfc2119" id="p.extension.4.1">must not</span> be in the XProc namespace and there <span class="rfc2119" id="p.extension.4.2">must</span> be a <em class="glossterm"><a href="#dt-visible">visible</a></em> step declaration at the point of use (see <a href="#scoping" title="Scoping of Names">Section 14.2, “Scoping of Names”</a>).</p><p>If the relevant step declaration has no <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>, then that step invokes the declared <em class="glossterm"><a href="#dt-external-step">external step</a></em>, which the processor must know how to perform. These steps are implementation-defined extensions. </p><p>If the relevant step declaration has a <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>, then that step runs the declared subpipeline. These steps are user- or implementation-defined extensions. Pipelines can refer to themselves (recursion is allowed), to pipelines defined in imported libraries, and to other pipelines in the same library if they are in a library.</p><p><a id="err.inline.S0010"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0010"><code class="errqname">err:XS0010</code></a>) if a pipeline contains a step whose specified inputs, outputs, and options do not <em class="glossterm"><a href="#dt-matches">match</a></em> the <em class="glossterm"><a href="#dt-signature">signature</a></em> for steps of that type.</p><p><a id="err.inline.D0017"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0017"><code class="errqname">err:XD0017</code></a>) if the running pipeline attempts to invoke an <em class="glossterm"><a href="#dt-external-step">external step</a></em> which the processor does not know how to perform.</p><p><span style="display: none;" class="delete_version"><span id="impl-35">The presence of other <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>; XProc provides no standard mechanism for defining them or describing what they can contain.</span><a id="err.inline.S0048"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0048"><code class="errqname">err:XS0048</code></a>) to use a declared step as a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>.</span><span style="display: none;" class="add_version"><span id="impl-38">The presence of other <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>; XProc provides no standard mechanism for defining them or describing what they can contain.</span><a id="err.inline.S0048"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0048"><code class="errqname">err:XS0048</code></a>) to use a declared step as a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>.</span><span class="modify_version"><span id="impl-38">The presence of other <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em> is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>; XProc provides no standard mechanism for defining them or describing what they can contain.</span><a id="err.inline.S0048"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0048"><code class="errqname">err:XS0048</code></a>) to use a declared step as a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>.</span></p></div></section></div></section></div></section><section id="other-elements" class="section"><div class="section-titlepage"><h2><bdi class="secno">16. </bdi>Other pipeline elements<a aria-label="§" class="self-link" href="#other-elements"></a></h2></div><div class="content"><section id="p.input" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.1. </bdi>p:input<a aria-label="§" class="self-link" href="#p.input"></a></h3></div><div class="content"><p>The declaration of an input identifies the name of the port, whether or not the port accepts a sequence, whether or not the port is a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>, what content types it accepts, and may provide a connection to default inputs for the port.</p><p>An input <em>declaration</em> has the following form:</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:input<br />  <strong>port</strong> = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  select? = <var>XPathExpression</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:input&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:input</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">port</code></span></dt><dd><p>The <code class="tag-attribute">port</code> attribute defines the name of the port. <a id="err.inline.S0011"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0011"><code class="errqname">err:XS0011</code></a>) to identify two ports with the same name on the same step.</p></dd><dt><span class="term"><code class="tag-attribute">sequence</code></span></dt><dd><p>The <code class="tag-attribute">sequence</code> attribute determines whether or not a sequence of documents is allowed on the port. <a id="err.inline.D0006"></a>If <code class="tag-attribute">sequence</code> is not specified, or has the value false, then it is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0006"><code class="errqname">err:XD0006</code></a>) unless exactly one document appears on the declared port.</p></dd><dt><span class="term"><code class="tag-attribute">primary</code></span></dt><dd><p>The <code class="tag-attribute">primary</code> attribute is used to identify the <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>. An input port is a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em> if <code class="tag-attribute">primary</code> is specified with the value <code class="literal">true</code> or if the step has only a single input port and <code class="tag-attribute">primary</code> is not specified. <a id="err.inline.S0030"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0030"><code class="errqname">err:XS0030</code></a>) to specify that more than one input port is the primary.</p></dd><dt><span class="term"><code class="tag-attribute">select</code></span></dt><dd><p>If a connection is provided in the declaration, then <code class="tag-attribute">select</code> may be used to select a portion of the input identified by the <a href="#p.empty"><code class="tag-element">p:empty</code></a>, <a href="#p.document"><code class="tag-element">p:document</code></a>, or <a href="#p.inline"><code class="tag-element">p:inline</code></a> elements in the <code class="tag-element">p:input</code>.</p><p>With the exception that <code class="tag-element">p:input</code> cannot establish a connection to another step, what is said about the <code class="tag-attribute">select</code> attribute in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> equally applies to <code class="tag-element">p:input</code>.</p><p>The <code class="tag-attribute">select</code> expression on <code class="tag-element">p:input</code> applies <em>only</em> if the default connection is used. If an explicit connection is provided by the caller, then the default select expression is ignored.</p></dd><dt><span class="term"><code class="tag-attribute">content-types</code></span></dt><dd><p>The <code class="tag-attribute">content-types</code> attribute lists one or more (space separated) content types that this input port will accept. If the attribute is not specified, <code class="literal">*/*</code> is assumed. See <a href="#specified-content-types" title="Specifying content types">Section 3.4, “Specifying content types”</a>. </p></dd><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p>The <code class="tag-attribute">exclude-inline-prefixes</code> allows the pipeline author to exclude some namespace declarations in inline content, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></dd></dl></div><p>On <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, any binding provided in <code class="tag-element">p:input</code> is a default connection for the port, if no other connection is provided, see <a href="#conn-prec" title="Connection precedence">Section 16.2.1, “Connection precedence”</a>. </p><p>The <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> element is explicitly excluded from a declaration because it would make the default value of an input dependent on the execution of some part of the pipeline. If a runtime binding is provided for an input port, implementations <span class="rfc2119" id="note-pipe-excl.2">must not</span> attempt to dereference the default bindings. In the case of <a href="#p.document"><code class="tag-element">p:document</code></a> connections, the URI is dereferenced only when the default connection is actually used, not during static analysis. </p></div></section><section id="p.with-input" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.2. </bdi>p:with-input<a aria-label="§" class="self-link" href="#p.with-input"></a></h3></div><div class="content"><p>An input <em>connection</em> has the following form:</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:with-input<br />  port? = <var>NCName</var><br />  select? = <var>XPathExpression</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:with-input&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:with-input</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">port</code></span></dt><dd><p>If the <code class="tag-attribute">port</code> is specified, then this is a binding for the specified port. If no port is specified, then:</p><div class="itemizedlist"><ul><li><p>In a <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> or <a href="#p.for-each"><code class="tag-element">p:for-each</code></a>, it is a binding for the step’s single, <em class="glossterm"><a href="#dt-anonymous-input">anonymous input</a></em> port.</p></li><li><p>In a <a href="#p.choose"><code class="tag-element">p:choose</code></a>, <a href="#p.when"><code class="tag-element">p:when</code></a> or <a href="#p.if"><code class="tag-element">p:if</code></a>, it is a binding for the context item for the test expression(s).</p></li><li><p>Elsewhere, it is a binding for the primary input port of the step in which it occurs. <a id="err.inline.S0065"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0065"><code class="errqname">err:XS0065</code></a>) if there is no primary input port. </p></li></ul></div><p><a id="err.inline.S0043"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0043"><code class="errqname">err:XS0043</code></a>) to specify a port name on <code class="tag-element">p:with-input</code> for <a href="#p.for-each"><code class="tag-element">p:for-each</code></a>, <a href="#p.viewport"><code class="tag-element">p:viewport</code></a>, <a href="#p.choose"><code class="tag-element">p:choose</code></a>, <a href="#p.when"><code class="tag-element">p:when</code></a>, or <a href="#p.if"><code class="tag-element">p:if</code></a>. </p><p><a id="err.inline.S0114"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0114"><code class="errqname">err:XS0114</code></a>) if a port name is specified and the step type being invoked does not have an input port declared with that name. </p><p><a id="err.inline.S0086"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0086"><code class="errqname">err:XS0086</code></a>) to provide more than one <code class="tag-element">p:with-input</code> for the same port. </p><p><span style="display: none;" class="delete_version">If no connection is provided for a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>, the input will be connected to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. <a id="err.inline.S0032"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0032"><code class="errqname">err:XS0032</code></a>) if no connection is provided and the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is undefined.</span><span style="display: none;" class="add_version">If no connection is provided for a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>, the input will be connected to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. <a id="err.inline.S0032"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0032"><code class="errqname">err:XS0032</code></a>) if no connection is provided, the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is undefined, and there is no default connection for the port.</span><span class="modify_version">If no connection is provided for a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em>, the input will be connected to the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. <a id="err.inline.S0032"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0032"><code class="errqname">err:XS0032</code></a>) if no connection is provided<span class="deltaxml-old" style="background:#FF5555"> and</span><span class="deltaxml-new" style="background:#90EE90">,</span> the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> is undefined<span class="deltaxml-new" style="background:#90EE90">, and there is no default connection for the port</span>.</span></p></dd><dt><span class="term"><code class="tag-attribute">select</code></span></dt><dd><p>If a <code class="tag-attribute">select</code> expression is specified, it is effectively a filter on the input. The expression will be evaluated once for each document that appears on the port, using that document as the context item. The result of evaluating the expression (on each document that appears, in the order they arrive) will be the sequence of items that the step receives on the port.</p><p>The rules as stated in <a href="#creating-documents-from-xdm-step-results" title="Creating documents from XDM step results">Section 3.3, “Creating documents from XDM step results”</a> will be applied to the members of this sequence and will turn these into separate documents. <a id="err.inline.D0016"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0016"><code class="errqname">err:XD0016</code></a>) if the select expression on a <a href="#p.input"><code class="tag-element">p:input</code></a> or <code class="tag-element">p:with-input</code> returns attribute nodes or function items.</p><p>If no documents are received, the expression is not evaluated and the step receives no input on the port.</p><p>For example:</p><pre class="programlisting language-markup xml"><code>&lt;p:with-input port="source"&gt; &lt;p:document href="http://example.org/input.html"/&gt; &lt;/p:with-input&gt;</code></pre><p>provides a single document, but</p><pre class="programlisting language-markup xml"><code>&lt;p:with-input xmlns:html="http://www.w3.org/1999/xhtml" port="source" select="//html:div"&gt; &lt;p:document href="http://example.org/input.html"/&gt; &lt;/p:with-input&gt;</code></pre><p>provides a sequence of zero or more documents, one for each <code class="code">html:div</code> in <code class="uri">http://example.org/input.html</code>. (Note that in the case of nested <code class="code">html:div</code> elements, this will result in the same content being returned in several documents.)</p><p>A select expression can equally be applied to input read from another step. This input:</p><pre class="programlisting language-markup xml"><code>&lt;p:with-input xmlns:html="http://www.w3.org/1999/xhtml" port="source" select="//html:div"&gt; &lt;p:pipe step="origin" port="result"/&gt; &lt;/p:with-input&gt;</code></pre><p>provides a sequence of zero or more documents, one for each <code class="code">html:div</code> in the document (or each of the documents) that is read from the <code class="literal">result</code> port of the step named <code class="literal">origin</code>.</p><p>The base URI of the document that results from a select expression is the base URI of the matched element or document. The document does not have a base URI if it results from selecting an atomic value.</p></dd><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>The <code class="tag-attribute">href</code> attribute is a shortcut for a <a href="#p.document"><code class="tag-element">p:document</code></a> child with an <code class="tag-attribute">href</code> attribute having the same value as this <code class="tag-attribute">href</code> attribute. </p><p><a id="err.inline.S0081"></a>If <code class="tag-attribute">href</code> is specified, it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0081"><code class="errqname">err:XS0081</code></a>) if any child elements other than <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> and <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> are present.</p><p><a id="err.inline.S0085"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0085"><code class="errqname">err:XS0085</code></a>) if both a <code class="tag-attribute">href</code> attribute and a <code class="tag-attribute">pipe</code> attribute are present.</p></dd><dt><span class="term"><code class="tag-attribute">pipe</code></span></dt><dd><p>The <code class="tag-attribute">pipe</code> attribute is a shortcut for one or more <a href="#p.pipe"><code class="tag-element">p:pipe</code></a> children. The attribute value <span class="rfc2119" id="p.with-input.5.4.2.1.3">must</span> be whitespace-separated list of tokens or empty. <a id="err.inline.S0090"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0090"><code class="errqname">err:XS0090</code></a>) if the value of the <code class="tag-attribute">pipe</code> attribute contains any tokens not of the form <em class="replaceable"><code>port-name</code></em>, <em class="replaceable"><code>port-name@step-name</code></em>, or <em class="replaceable"><code>@step-name</code></em>. If “<em class="replaceable"><code>port-name</code></em>” is omitted, the connection is to the primary output port of the step named “<em class="replaceable"><code>step-name</code></em>”. If “<code class="literal">@<em class="replaceable"><code>step-name</code></em></code>” is omitted, the connection is to the specified port on the same step as the step associated with the default readable port. If the value is empty, the connection is to the default readable port.</p><p><a id="err.inline.S0082"></a>If <code class="tag-attribute">pipe</code> is specified, it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0082"><code class="errqname">err:XS0082</code></a>) any child elements other than <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> and <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> are present.</p><p><a id="err.inline.S0085.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0085"><code class="errqname">err:XS0085</code></a>) if both an <code class="tag-attribute">href</code> attribute and a <code class="tag-attribute">pipe</code> attribute are present.</p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p>The <code class="tag-attribute">exclude-inline-prefixes</code> allows the pipeline author to exclude some namespace declarations in inline content, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></dd></dl></div><p>A <code class="tag-element">p:with-input</code> element with no children (<em class="foreignphrase">e.g.</em>, “<code class="code">&lt;p:with-input/&gt;</code>”) is treated implicitly as if it contained only “<code class="code">&lt;p:pipe/&gt;</code>”, which is in turn equivalent to a binding to the default readable port. </p><p>If the <code class="tag-element">p:with-input</code> contains elements not in the XProc namespace, they are <a href="#implicit-inlines">implicit inlines</a>.</p><section id="conn-prec" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.2.1. </bdi>Connection precedence<a aria-label="§" class="self-link" href="#conn-prec"></a></h4></div><div class="content"><p>XProc <span class="deltaxml-old" style="background:#FF5555">3.0 introduces</span><span class="deltaxml-new" style="background:#90EE90">has</span> a number of new connection defaulting mechanisms to make pipeline authoring easier. Defaults only apply if there’s no explicit connection, and they apply differently to primary and secondary inputs.</p><div class="variablelist"><dl><dt><span class="term">Primary input ports</span></dt><dd><p>For a given primary input port:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If there is a <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> for that port and it provides a binding, even an implicit one, that binding is used. </p></li><li><p>If there’s no <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> for that port and there is a default readable port, the input will be connected to the default readable port. </p></li><li><p>If there’s no <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> for that port and there’s no default readable port, then the default connection from the declaration’s <a href="#p.input"><code class="tag-element">p:input</code></a> will be used. <a id="err.inline.S0032.1"></a>It will be a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0032"><code class="errqname">err:XS0032</code></a>) if there is no default connection. </p></li></ol></div></dd><dt><span class="term">Secondary input ports</span></dt><dd><p>For a given secondary input port:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>If there is a <a href="#p.with-input"><code class="tag-element">p:with-input</code></a> for that port and it provides a binding, even an implicit one, that binding is used. </p></li><li><p><a id="err.inline.S0003.1"></a>If there’s no  for that port then the default connection from the declaration’s  will be used. It will be a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if there is no default connection. <a id="err.inline.S0003.1"></a>If there’s no  for that port then the default connection from the declaration’s  will be used. It will be a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if there is no default connection. </p></li></ol></div></dd></dl></div></div></section></div></section><section id="p.output" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.3. </bdi>p:output<a aria-label="§" class="self-link" href="#p.output"></a></h3></div><div class="content"><p>A <code class="tag-element">p:output</code> identifies an output port.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var> /&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:output</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">port</code></span></dt><dd><p>The <code class="tag-attribute">port</code> attribute defines the name of the port. <a id="err.inline.S0011.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0011"><code class="errqname">err:XS0011</code></a>) to identify two ports with the same name on the same step.</p></dd><dt><span class="term"><code class="tag-attribute">sequence</code></span></dt><dd><p>An output declaration can indicate if a sequence of documents is allowed to appear on the declared port. If <code class="tag-attribute">sequence</code> is specified with the value <code class="literal">true</code>, then a sequence is allowed. <a id="err.inline.D0007"></a>If <code class="tag-attribute">sequence</code> is not specified on <code class="tag-element">p:output</code>, or has the value false, then it is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0007"><code class="errqname">err:XD0007</code></a>) if the step does not produce exactly one document on the declared port.</p></dd><dt><span class="term"><code class="tag-attribute">primary</code></span></dt><dd><p>The <code class="tag-attribute">primary</code> attribute is used to identify the primary output port. An output port is a primary output port if <code class="tag-attribute">primary</code> is specified with the value <code class="literal">true</code> or if the step has only a single output port and primary is not specified. <a id="err.inline.S0014"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0014"><code class="errqname">err:XS0014</code></a>) to identify more than one output port as primary.</p></dd><dt><span class="term"><code class="tag-attribute">content-types</code></span></dt><dd><p>An output declaration can indicate the content types of the documents appearing on that port. If <code class="tag-attribute">content-types</code> is specified then only documents matching these content types are allowed to appear on that port. If the attribute is not specified, <code class="literal">*/*</code> is assumed. <a id="err.inline.D0042"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0042"><code class="errqname">err:XD0042</code></a>) if a document arrives on an output port whose content type is not accepted by the output port specification.</p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>Implementations are free to perform static checking of the connected ports and indicate that the content types of the connected ports will not match, however they <span class="rfc2119" id="p.output.5.4.2.2.2.1">must not</span> raise an error statically. </p></div></div></dd></dl></div><p>On <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em>, the declaration <span class="rfc2119" id="p.output.6.2">may</span> be accompanied by a <em class="glossterm"><a href="#dt-connection">connection</a></em> for the output.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:output&gt;</code></p><p>The additional attributes that can appear on an output declaration on a compound step are:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">pipe</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p>The <code class="tag-attribute">exclude-inline-prefixes</code> allows the pipeline author to exclude some namespace declarations in inline content, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></dd></dl></div><p>Finally, on a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> that declares a pipeline, the <code class="tag-element">p:output</code> can specify serialization options. </p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  serialization? = <var>map(xs:QName,item()*)</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:output&gt;</code></p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">serialization</code></span></dt><dd><p>The <code class="tag-attribute">serialization</code> attribute can be used to provide <a href="#serialization">serialization parameters</a>. </p></dd></dl></div><p><a id="err.inline.S0029"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0029"><code class="errqname">err:XS0029</code></a>) to specify a connection for a <code class="tag-element">p:output</code> inside a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> for an <em class="glossterm"><a href="#dt-external-step">external step</a></em>.</p><p>If a connection is provided for a <code class="tag-element">p:output</code>, documents are <em>read from</em> that connection and those documents form the output that <em>is written</em> to the output port. In other words, placing a <a href="#p.document"><code class="tag-element">p:document</code></a> inside a <code class="tag-element">p:output</code> causes the processor to <em>read that document</em> and provide it on the output port. It <em>does not</em> cause the processor to <em>write</em> the output to that document.</p><section id="serialization" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.3.1. </bdi>Serialization parameters<a aria-label="§" class="self-link" href="#serialization"></a></h4></div><div class="content"><p>The <code class="tag-attribute">serialization</code> attribute allows the user to request serialization parameters on an output port. These parameters control serialization as defined by [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>].</p><p><span style="display: none;" class="delete_version">If the pipeline processor serializes the output on a port, it <span class="rfc2119" id="serialization.3.1">must</span> use the serialization parameters specified. If a <code class="code">serialization</code> document property is present, the serialization properties specified by the <code class="code">serialization</code> document property must be merged with the properties specified with the <code class="tag-attribute">serialization</code> attribute first. For further details see the explanation of the <code class="code">serialization</code> document property in <a href="#document-properties" title="Document Properties">Section 3.1, “Document Properties”</a>.</span><span style="display: none;" class="add_version">If the pipeline processor serializes the output on a port, it <span class="rfc2119" id="serialization.3.1">must</span> use the serialization parameters specified. If a <code class="code">serialization</code> document property is present, the serialization is controlled by the merger of the two maps where the entries in the “serialization” property take precedence. For further details see the explanation of the <code class="code">serialization</code> document property in <a href="#document-properties" title="Document Properties">Section 3.1, “Document Properties”</a>.</span><span class="modify_version">If the pipeline processor serializes the output on a port, it <span class="rfc2119" id="serialization.3.1">must</span> use the serialization parameters specified. If a <code class="code">serialization</code> document property is present, the serialization <span class="deltaxml-old" style="background:#FF5555">properties specified</span><span class="deltaxml-new" style="background:#90EE90">is controlled</span> by the <span class="deltaxml-old" style="background:#FF5555">serialization</span><span class="deltaxml-new" style="background:#90EE90">merger</span> <span class="deltaxml-old" style="background:#FF5555">document property must be merged with the properties specified with</span><span class="deltaxml-new" style="background:#90EE90">of the two maps where</span> the <span class="deltaxml-new" style="background:#90EE90">entries in the “</span>serialization<span class="deltaxml-old" style="background:#FF5555"> attribute first</span><span class="deltaxml-new" style="background:#90EE90">” property take precedence</span>. For further details see the explanation of the <code class="code">serialization</code> document property in <a href="#document-properties" title="Document Properties">Section 3.1, “Document Properties”</a>.</span></p><p>If the processor is not serializing (if, for example, the pipeline has been called from another pipeline), then serialization does not apply. The serialization parameter map is computed (and must therefore be statically and syntactically valid), but the processor <span class="rfc2119" id="serialization.4.1">must not</span> raise an error if the output could not be serialized with those parameters. </p><p><a id="err.inline.D0020"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0020"><code class="errqname">err:XD0020</code></a>) if the combination of serialization options specified or defaulted is not allowed. Implementations <span class="rfc2119" id="serialization.5.2">must</span> check that all of the specified serialization options are allowed if they serialize the specified output. If the specified output is not being serialized implementations <span class="rfc2119" id="serialization.5.3">may</span> but are not required to check that the specified options are allowed.</p><p>In order to be consistent with the rest of this specification, values for boolean serialization parameters can also use one of the XML Schema lexical forms for boolean: <code class="literal">true</code>, <code class="literal">false</code>, <code class="literal">1</code>, or <code class="literal">0</code>. This is different from the [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>] specification, which uses <code class="literal">yes</code> and <code class="literal">no</code>. No change in semantics is implied by this different spelling.</p><p><span style="display: none;" class="delete_version"><span id="impl-36">The default value of any serialization parameters not specified on a particular output is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-39">The default value of any serialization parameters not specified on a particular output is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-39">The default value of any serialization parameters not specified on a particular output is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><section id="serialization-method" class="section"><div class="section-titlepage"><h5><bdi class="secno">16.3.1.1. </bdi>Serialization method<a aria-label="§" class="self-link" href="#serialization-method"></a></h5></div><div class="content"><p><span style="display: none;" class="delete_version">The <code class="option">method</code> option controls the serialization method used by this component with standard values of <code class="literal">html</code>, <code class="literal">xml</code>, <code class="literal">xhtml</code>, <code class="literal">text</code> and <code class="literal">json</code>. Only the <code class="literal">xml</code> value is required to be supported. <span id="impl-37">Implementations may support other method values but their results are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">The <code class="option">method</code> option controls the serialization method used by this component with standard values of <code class="literal">html</code>, <code class="literal">xml</code>, <code class="literal">xhtml</code>, <code class="literal">text</code> and <code class="literal">json</code>. Only the <code class="literal">xml</code> value is required to be supported. <span id="impl-40">Implementations may support other method values but their results are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">The <code class="option">method</code> option controls the serialization method used by this component with standard values of <code class="literal">html</code>, <code class="literal">xml</code>, <code class="literal">xhtml</code>, <code class="literal">text</code> and <code class="literal">json</code>. Only the <code class="literal">xml</code> value is required to be supported. <span id="impl-40">Implementations may support other method values but their results are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>If the serialization parameter <code class="literal">method</code> is not specified, the processor <span class="rfc2119" id="serialization-method.3.2">should</span> select a method based on the document’s <code class="literal">content-type</code> property:</p><div class="itemizedlist"><ul><li><p>For documents with content types <code class="literal">application/xml</code>, <code class="literal">text/xml</code>, and <code class="literal">application/*+xml</code> (except for <code class="literal">application/xhtml+xml</code>), serialization method <code class="literal">xml</code> should be used.</p></li><li><p>For documents with content type <code class="literal">application/xhtml+xml</code> serialization method <code class="literal">xhtml</code> should be used.</p></li><li><p>For documents with content type <code class="literal">text/html</code> serialization method <code class="literal">html</code> should be used.</p></li><li><p>For documents with <em class="glossterm"><a href="#dt-text-media-type">text media types</a></em> serialization method <code class="literal">text</code> should be used.</p></li><li><p>For documents with <em class="glossterm"><a href="#dt-JSON-media-type">JSON media types</a></em> serialization method <code class="literal">json</code> should be used.</p></li><li><p><span style="display: none;" class="delete_version"><span id="impl-38">The serialization method for documents with other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-41">The serialization method for documents with other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-41">The serialization method for documents with other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></li></ul></div><p>If serialization method <code class="literal">xml</code> or <code class="literal">html</code> (if supported) is chosen, either explicitly or implicitly, the following default values <span class="rfc2119" id="serialization-method.5.3">must</span> be used:</p><div class="itemizedlist"><ul><li><p>Parameter <code class="literal">version</code> is set to <code class="literal">1.0</code>.</p></li><li><p>Parameter <code class="literal">encoding</code> is set to <code class="literal">UTF-8</code>.</p></li><li><p>Parameter <code class="literal">omit-xml-declaration</code> is set to <code class="literal">false</code>.</p></li></ul></div></div></section><section id="serialization-minimal-conformance" class="section"><div class="section-titlepage"><h5><bdi class="secno">16.3.1.2. </bdi>Minimal conformance<a aria-label="§" class="self-link" href="#serialization-minimal-conformance"></a></h5></div><div class="content"><p>A minimally conforming implementation must support the <code class="code">xml</code> output method with the following option values:</p><div class="itemizedlist"><ul><li><p>The <code class="code">version</code> must support the value <code class="code">1.0</code>.</p></li><li><p>The <code class="code">encoding</code> must support the value <code class="code">UTF-8</code>.</p></li><li><p>The <code class="code">omit-xml-declaration</code> must be supported.</p></li></ul></div><p>All other option values may be ignored for the <code class="code">xml</code> output method.</p><p>If a processor chooses to implement an option for serialization, it <span class="rfc2119" id="serialization-minimal-conformance.5.1">must</span> conform to the semantics defined in the [<a href="#xml-serialization-31"><span class="abbrev">Serialization</span></a>] specification.</p></div></section></div></section></div></section><section id="variables-options" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.4. </bdi>Variables and Options<a aria-label="§" class="self-link" href="#variables-options"></a></h3></div><div class="content"><p>Variables and options provide a mechanism for pipeline authors to construct temporary results and hold onto them for reuse.</p><p>Variables are created in compound steps and, like XSLT variables, are single assignment, though they may be shadowed by subsequent declarations of other variables with the same name.</p><p>Options can be declared on atomic or compound steps. The value of an option can be specified by the caller invoking the step. Any value specified by the caller takes precedence over the default value of the option.</p><section id="p.variable" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.4.1. </bdi>p:variable<a aria-label="§" class="self-link" href="#p.variable"></a></h4></div><div class="content"><p>A <code class="tag-element">p:variable</code> declares a variable and associates a value with it. Variable declarations may optionally specify the type of the variable using an [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>] <a href="https://www.w3.org/TR/xpath-31/#dt-sequence-type">sequence Type</a>. </p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:variable<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  <strong>select</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:variable&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:variable</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">name</code></span></dt><dd><p>The name of the variable <span class="rfc2119" id="p.variable.5.1.2.1.1">must</span> be an EQName. If it does not contain a prefix then it is in no namespace. <a id="err.inline.S0028"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0028"><code class="errqname">err:XS0028</code></a>) to declare an option or variable in the XProc namespace. <a id="err.inline.S0087"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0087"><code class="errqname">err:XS0087</code></a>) if the name attribute on <a href="#p.option"><code class="tag-element">p:option</code></a> or <code class="tag-element">p:variable</code> has a prefix which is not bound to a namespace. </p><p><a id="err.inline.S0088.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the qualified name of a <code class="tag-element">p:variable</code><em class="glossterm"><a href="#dt-shadow">shadows</a></em> the name of a static option. <a id="err.inline.S0088.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the qualified name of a <code class="tag-element">p:variable</code><em class="glossterm"><a href="#dt-shadow">shadows</a></em> the name of a static option. </p></dd><dt><span class="term"><code class="tag-attribute">as</code></span></dt><dd><p>The type of the value may be specified in the <code class="tag-attribute">as</code> attribute using an XPath sequence type, see <a href="#varopt-types" title="Variable and option types">Section 11.4, “Variable and option types”</a>. </p></dd><dt><span class="term"><code class="tag-attribute">select</code></span></dt><dd><p>The variable’s value is specified with a <code class="tag-attribute">select</code> attribute. The <code class="tag-attribute">select</code> attribute <span class="rfc2119" id="p.variable.5.3.2.1.3">must</span> be specified. The content of the <code class="tag-attribute">select</code> attribute is an XPath expression which will be evaluated to provide the value of the variable. <a id="err.inline.S0094"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0094"><code class="errqname">err:XS0094</code></a>) if a <code class="tag-element">p:variable</code> does not have a select attribute. </p><p><span style="display: none;" class="delete_version">The <code class="tag-attribute">select</code> expression is evaluated as an XPath expression using the appropriate context as described in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>, for the enclosing <em class="glossterm"><a href="#dt-container">container</a></em>. <span id="impl-39">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">The <code class="tag-attribute">select</code> expression is evaluated as an XPath expression using the appropriate context as described in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>, for the enclosing <em class="glossterm"><a href="#dt-container">container</a></em>. <span id="impl-42">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">The <code class="tag-attribute">select</code> expression is evaluated as an XPath expression using the appropriate context as described in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>, for the enclosing <em class="glossterm"><a href="#dt-container">container</a></em>. <span id="impl-42">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term"><code class="tag-attribute">collection</code></span></dt><dd><p>If <code class="tag-attribute">collection</code> is unspecified or has the value <code class="literal">false</code>, then it has no effect. </p><p>If <code class="tag-attribute">collection</code> is <code class="literal">true</code>, the context item is undefined. All of the documents that appear on the connection for the <code class="tag-element">p:variable</code> will be available as the default collection within <code class="tag-attribute">select</code> expression.</p></dd><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">pipe</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p>The <code class="tag-attribute">exclude-inline-prefixes</code> allows the pipeline author to exclude some namespace declarations in inline content, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></dd></dl></div><p>Steps are connected together by their input and output ports. Variables are connected to steps by their input, which provides the context node for the expression, and by the expressions that contain references to them. Any step which contains a reference to a variable effectively consumes the “output” of the variable. <a id="err.inline.S0076"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0076"><code class="errqname">err:XS0076</code></a>) if there are any loops in the connections between steps and variables: no step can refer to a variable if there is any sequence of connections from that step that leads back to the input that provides the context node for the expression that defines the value of the variable. </p><p>If <code class="tag-attribute">collection</code> is true, the context item for the expression is undefined. Otherwise, the context item for the expression comes from the document connections, if they are specified. If they are not specified, the context item comes from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> (computed as if <code class="tag-element">p:variable</code> was an atomic step). If no <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> exists, the context item is undefined.</p><p><a id="err.inline.D0001.3"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined. <a id="err.inline.D0065.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0065"><code class="errqname">err:XD0065</code></a>) to refer to the context item, size, or position if a sequence of documents appears on the connection that provides the context. </p><p>Since all <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> are present in the Processor XPath Context as variable bindings, <code class="tag-attribute">select</code> expressions may refer to the value of <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> by variable reference.</p></div></section><section id="p.option" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.4.2. </bdi>p:option<a aria-label="§" class="self-link" href="#p.option"></a></h4></div><div class="content"><p>A <code class="tag-element">p:option</code> declares an option and associates a default value with it. Option declarations may optionally specify the type of the option using an [<a href="#xpath31"><span class="abbrev">XPath 3.1</span></a>] <a href="https://www.w3.org/TR/xpath-31/#dt-sequence-type">sequence Type</a>. </p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:option<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  values? = <var>string</var><br />  static? = <var>boolean</var><br />  required? = <var>boolean</var><br />  select? = <var>XPathExpression</var><br />  visibility? = <var>private|public</var> /&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:option</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">name</code></span></dt><dd><p>The name of the option <span class="rfc2119" id="p.option.5.1.2.1.1">must</span> be an EQName. If it does not contain a prefix then it is in no namespace. <a id="err.inline.S0028.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0028"><code class="errqname">err:XS0028</code></a>) to declare an option or variable in the XProc namespace. <a id="err.inline.S0087.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0087"><code class="errqname">err:XS0087</code></a>) if the name attribute on <code class="tag-element">p:option</code> or <a href="#p.variable"><code class="tag-element">p:variable</code></a> has a prefix which is not bound to a namespace. </p><p><a id="err.inline.S0088.2"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the qualified name of a <code class="tag-element">p:option</code><em class="glossterm"><a href="#dt-shadow">shadows</a></em> the name of a static option. <a id="err.inline.S0088.2"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> () if the qualified name of a <code class="tag-element">p:option</code><em class="glossterm"><a href="#dt-shadow">shadows</a></em> the name of a static option. </p></dd><dt><span class="term"><code class="tag-attribute">as</code></span></dt><dd><p>The type of the value may be specified in the <code class="tag-attribute">as</code> attribute using an XPath sequence type, see <a href="#varopt-types" title="Variable and option types">Section 11.4, “Variable and option types”</a>. </p></dd><dt><span class="term"><code class="tag-attribute">values</code></span></dt><dd><p>A list of acceptable values may be specified in the <code class="tag-attribute">values</code> attribute. If specified, the value of the <code class="tag-attribute">values</code> attribute <span class="rfc2119" id="p.option.5.3.2.1.3">must</span> be a list of atomic values expressed as an XPath sequence, for example: <code class="code">('one', 'two', 'three')</code>. <a id="err.inline.S0101"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0101"><code class="errqname">err:XS0101</code></a>) if the values list is not an XPath sequence of atomic values. </p><p>The values list is an additional constraint on the acceptable values for the option. <a id="err.inline.D0019"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0019"><code class="errqname">err:XD0019</code></a>) if an option declares a list of acceptable values and an attempt is made to specify a value that is not a member of that list. </p><p>The option value must satisfy the <code class="tag-attribute">as</code> type, if one is provided, and must be equal to (XPath “<code class="code">eq</code>”) one of the listed <code class="tag-attribute">values</code>. It is possible to combine <code class="tag-attribute">as</code> and <code class="tag-attribute">values</code> in ways that exclude all actual values (for example, <code class="code">as="xs:integer"</code> and <code class="code">values="(1.5,’pi’)"</code>). Doing so will make it impossible to specify a value for the option.</p></dd><dt><span class="term"><code class="tag-attribute">static</code></span></dt><dd><p>An indication of whether the option is to be evaluated statically or not. See <a href="#statics" title="Static Options">Section 11.3, “Static Options”</a>. If <code class="tag-attribute">static</code> is not specified, it defaults to “<code class="code">false</code>”.</p></dd><dt><span class="term"><code class="tag-attribute">required</code></span></dt><dd><p>An option may declare that it is required by specifying the value <code class="literal">true</code> for the <code class="tag-attribute">required</code> attribute. <a id="err.inline.S0018"></a>If an option is required, it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0018"><code class="errqname">err:XS0018</code></a>) to invoke the step without specifying a value for that option. If <code class="tag-attribute">required</code> is not specified, it defaults to “<code class="code">false</code>”.</p></dd><dt><span class="term"><code class="tag-attribute">select</code></span></dt><dd><p>If an option is not required, its default value may be specified with a <code class="tag-attribute">select</code> attribute. If no default value is specified, the default value is the empty sequence. </p><p>If specified, the content of the <code class="tag-attribute">select</code> attribute is an XPath expression which will be evaluated to provide the default value for the option. </p><p>The default value of an option is specified with an XPath expression. It must be a statically valid expression at that point. Consequently, if it contains option references, these can only be references to preceding non-static options on the step or to in-scope static options. <a id="err.inline.D0001.4"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined. This error will always arise if the <code class="tag-attribute">select</code> expression refers to the context item because there can never be a context item for <code class="tag-element">p:option</code> default values. </p><p><span style="display: none;" class="delete_version"><span id="impl-40">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-43">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-43">The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term"><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">visibility</span></code></span></dt><dt id="step-visibility"><span class="term"><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">visibility</span></code></span></dt><dd><p>If the <code class="tag-element">p:option</code> is a child of a <a href="#p.library"><code class="tag-element">p:library</code></a>, the <code class="tag-attribute">visibility</code> attribute controls whether the option is visible to an importing pipeline. If <code class="tag-attribute">visibility</code> is set to “<code class="literal">private</code>”, the option is visible inside the <a href="#p.library"><code class="tag-element">p:library</code></a> but not visible to any pipeline importing the <a href="#p.library"><code class="tag-element">p:library</code></a>. If the visibility attribute is missing, “<code class="literal">public</code>” is assumed. If the <code class="tag-element">p:option</code> is not a child of <code class="tag-element">a p:library</code> the attribute has no effect and is ignored. </p></dd></dl></div><p><a id="err.inline.S0004"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0004"><code class="errqname">err:XS0004</code></a>) to declare two or more options on the same step with the same name.</p><p>The following errors apply to options:</p><div class="itemizedlist"><ul><li><p><a id="err.inline.S0017"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0017"><code class="errqname">err:XS0017</code></a>) to specify that an option is both <code class="tag-attribute">required</code><em>and</em> has a default value.</p></li><li><p><a id="err.inline.S0095"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0095"><code class="errqname">err:XS0095</code></a>) to specify that an option is both <code class="tag-attribute">required</code><em>and</em> static.</p></li></ul></div><p>The pipeline author may use <a href="#p.with-option"><code class="tag-element">p:with-option</code></a> on a step when it is invoked. Values specified with <a href="#p.with-option"><code class="tag-element">p:with-option</code></a> override any default values specified.</p></div></section><section id="p.with-option" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.4.3. </bdi>p:with-option<a aria-label="§" class="self-link" href="#p.with-option"></a></h4></div><div class="content"><p>A <code class="tag-element">p:with-option</code> provides an actual value for an option when a step is invoked.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:with-option<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  <strong>select</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:with-option&gt;</code></p><p>The attributes that can appear on <code class="tag-element">p:with-option</code> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">name</code></span></dt><dd><p>The name of the option <span class="rfc2119" id="p.with-option.5.1.2.1.1">must</span> be a EQName. If it does not contain a prefix then it is in no namespace. <a id="err.inline.S0031"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0031"><code class="errqname">err:XS0031</code></a>) to use an option name in <code class="tag-element">p:with-option</code> if the step type being invoked has not declared an option with that name. </p><p><a id="err.inline.S0080"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0080"><code class="errqname">err:XS0080</code></a>) to include more than one <code class="tag-element">p:with-option</code> with the same option name as part of the same step invocation.</p></dd><dt><span class="term"><code class="tag-attribute">as</code></span></dt><dd><p>The type of the value may be specified in the <code class="tag-attribute">as</code> attribute using an XPath sequence type, see <a href="#varopt-types" title="Variable and option types">Section 11.4, “Variable and option types”</a>. </p></dd><dt><span class="term"><code class="tag-attribute">select</code></span></dt><dd><p>The actual value is specified with a <code class="tag-attribute">select</code> attribute. The <code class="tag-attribute">select</code> attribute <span class="rfc2119" id="p.with-option.5.3.2.1.3">must</span> be specified. The value of the <code class="tag-attribute">select</code> attribute is an XPath expression which will be evaluated to provide the value of the option.</p></dd><dt><span class="term"><code class="tag-attribute">collection</code></span></dt><dd><p>If <code class="tag-attribute">collection</code> is unspecified or has the value <code class="literal">false</code>, then it has no effect.</p><p>If <code class="tag-attribute">collection</code> is <code class="literal">true</code>, the context item is undefined. All of the documents that appear on the connection for the <code class="tag-element">p:with-option</code> will be available as the default collection within <code class="tag-attribute">select</code> expression.</p></dd><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">pipe</code></span></dt><dd><p>As described in <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>.</p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p>The <code class="tag-attribute">exclude-inline-prefixes</code> allows the pipeline author to exclude some namespace declarations in inline content, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </p></dd></dl></div><p>Any <code class="tag-element">p:with-option</code> which contains a reference to a variable effectively consumes the “output” of the <a href="#p.variable"><code class="tag-element">p:variable</code></a> or <a href="#p.option"><code class="tag-element">p:option</code></a> that defines that variable. <a id="err.inline.S0076.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0076"><code class="errqname">err:XS0076</code></a>) if there are any loops in the connections between steps and variables: no step can refer to a variable if there is any sequence of connections from that step that leads back to the input that provides the context node for the expression that defines the value of the variable. </p><p>If <code class="tag-attribute">collection</code> is true, the context item for the expression is undefined. Otherwise, the context item for the expression comes from the document connections, if they are specified. If they are not specified, the context item comes from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> of the step. If no <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em> exists, the context item is undefined.</p><p><a id="err.inline.D0001.5"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if an XPath expression makes reference to the context item, size, or position when the context item is undefined. <a id="err.inline.D0065.2"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0065"><code class="errqname">err:XD0065</code></a>) to refer to the context item, size, or position if a sequence of documents appears on the connection that provides the context. </p><p>Since all <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> are present in the Processor XPath Context as variable bindings, <code class="tag-attribute">select</code> expressions may refer to the value of <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> by variable reference. </p><p><a id="err.inline.S0092"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0092"><code class="errqname">err:XS0092</code></a>) if a <code class="tag-element">p:with-option</code> attempts to change the value of an option that is declared static. See <a href="#statics" title="Static Options">Section 11.3, “Static Options”</a>.</p><section id="option-shortcut" class="section"><div class="section-titlepage"><h5><bdi class="secno">16.4.3.1. </bdi>Syntactic Shortcut for Option Values<a aria-label="§" class="self-link" href="#option-shortcut"></a></h5></div><div class="content"><p>Namespace qualified attributes on a step are <em class="glossterm"><a href="#dt-extension-attribute">extension attributes</a></em>. Attributes, other than <code class="tag-attribute">name</code>, that are not namespace qualified are treated as a syntactic shortcut for specifying the value of an option. In other words, the following two steps are equivalent:</p><p>The first step uses the standard <a href="#p.with-option"><code class="tag-element">p:with-option</code></a> syntax:</p><pre class="programlisting language-markup xml"><code>&lt;ex:stepType&gt; &lt;p:with-option name="option-name" select="'some value'"/&gt; &lt;/ex:stepType&gt;</code></pre><p>The second step uses the syntactic shortcut:</p><pre class="programlisting language-markup xml"><code>&lt;ex:stepType option-name="some value"/&gt;</code></pre><p>There are some limitations to this shortcut syntax:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>It only applies to option names that are not in a namespace.</p></li><li><p>It only applies to option names that are not otherwise used on the step, such as “<code class="literal">name</code>”.</p></li></ol></div><p>For the value of an option’s syntactic shortcut attribute, the following applies:</p><div class="itemizedlist"><ul><li><p><span id="dt-map-attribute" class="termdef">[Definition: A <em class="glossterm">map attribute</em> is an option’s syntactic shortcut attribute for which the option’s sequence type is a map or array.]</span> The attribute’s value is interpreted directly as an XPath expression, which must result in a value of the applicable datatype.</p></li><li><p>For any other option’s sequence type it is considered an <em class="glossterm"><a href="#dt-attribute-value-template">attribute value template</a></em>. The context node for the attribute value template comes from the default readable port for the step on which they occur. If there is no such port, the context node is undefined.</p><p>As with other attribute value templates, the attribute’s string value, as an <code class="type">xs:untypedAtomic</code>, is used as the value of the option. Function conversion rules apply to convert this untyped atomic value to the option’s sequence type.</p></li></ul></div><p><a id="err.inline.S0027"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0027"><code class="errqname">err:XS0027</code></a>) if an option is specified with both the shortcut form and the long form. <a id="err.inline.S0031.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0031"><code class="errqname">err:XS0031</code></a>) to use an option on an <em class="glossterm"><a href="#dt-atomic-step">atomic step</a></em> that is not declared on steps of that type. <a id="err.inline.S0092.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0092"><code class="errqname">err:XS0092</code></a>) to specify a value for an option that is declared static. </p><p>The syntactic shortcuts apply equally to standard atomic steps and extension atomic steps.</p></div></section></div></section></div></section><section id="p.declare-step" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.5. </bdi>p:declare-step<a aria-label="§" class="self-link" href="#p.declare-step"></a></h3></div><div class="content"><p>A <code class="tag-element">p:declare-step</code> provides the type and <em class="glossterm"><a href="#dt-signature">signature</a></em> of a pipeline or an <em class="glossterm"><a href="#dt-external-step">external step</a></em>. Pipelines contain a subpipeline which defines what the declared step does. <span id="dt-external-step" class="termdef">[Definition: An <em class="glossterm">external step</em> is one supported by the implementation, but which has no exposed subpipeline.]</span></p><p><span style="display: none;" class="delete_version">The standard XProc atomic steps (<code class="tag-element">p:add-attribute</code>, <code class="tag-element">p:add-xml-base</code> …) are all external steps. <span id="impl-41">Whether or not an implementation allows users to provide their own external steps is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span> A <code class="tag-element">p:declare-step</code> must be provided for every pipeline and external step that is used in a pipeline.</span><span style="display: none;" class="add_version">The standard XProc atomic steps (<code class="tag-element">p:add-attribute</code>, <code class="tag-element">p:add-xml-base</code> …) are all external steps. <span id="impl-44">Whether or not an implementation allows users to provide their own external steps is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span> A <code class="tag-element">p:declare-step</code> must be provided for every pipeline and external step that is used in a pipeline.</span><span class="modify_version">The standard XProc atomic steps (<code class="tag-element">p:add-attribute</code>, <code class="tag-element">p:add-xml-base</code> …) are all external steps. <span id="impl-44">Whether or not an implementation allows users to provide their own external steps is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span> A <code class="tag-element">p:declare-step</code> must be provided for every pipeline and external step that is used in a pipeline.</span></p><p><span style="display: none;" class="delete_version"><span id="impl-42">When a declared step is evaluated directly by the XProc processor (as opposed to occurring as an atomic step in some <em class="glossterm"><a href="#dt-container">container</a></em>), how the input and output ports are connected to documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-45">When a declared step is evaluated directly by the XProc processor (as opposed to occurring as an atomic step in some <em class="glossterm"><a href="#dt-container">container</a></em>), how the input and output ports are connected to documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-45">When a declared step is evaluated directly by the XProc processor (as opposed to occurring as an atomic step in some <em class="glossterm"><a href="#dt-container">container</a></em>), how the input and output ports are connected to documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>A step declaration is not a <a href="#step-concept">step</a> in its own right. Sibling steps cannot refer to the inputs or outputs of a <code class="tag-element">p:declare-step</code> using <a href="#p.pipe"><code class="tag-element">p:pipe</code></a>; only instances of the type can be referenced.</p><section id="declare-pipelines" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.5.1. </bdi>Declaring pipelines<a aria-label="§" class="self-link" href="#declare-pipelines"></a></h4></div><div class="content"><p>When a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> declares a pipeline, that pipeline encapsulates the behavior of the specified <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. Its children declare inputs, outputs, and options that the pipeline exposes and identify the steps in its subpipeline.</p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span><span class="modify_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span></p><p>The attributes that can appear on <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are <a href="#common-attr">the common attributes</a> and:</p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">name</code></span></dt><dd><p>The <code class="tag-attribute">name</code> attribute provides a name for the step. This name can be used within the subpipeline to refer back to the declaration, for example, to read from its inputs. See also <a href="#step-names" title="Step names">Section 2.1.1, “Step names”</a>. </p></dd><dt><span class="term"><code class="tag-attribute">type</code></span></dt><dd><p>The <code class="tag-attribute">type</code> attribute provides a type for the step. Step types are used as the name of the element by which the step is invoked. See also <a href="#step-types" title="Step types">Section 2.1.2, “Step types”</a>.</p><p>The value of the <code class="tag-attribute">type</code> can be from any namespace provided that the expanded-QName of the value has a non-null namespace URI. <a id="err.inline.S0025"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0025"><code class="errqname">err:XS0025</code></a>) if the expanded-QName value of the <code class="tag-attribute">type</code> attribute is in no namespace or in the XProc namespace. Neither users nor implementers may define additional steps in the XProc namespace. </p></dd><dt><span class="term"><code class="tag-attribute">psvi-required</code></span></dt><dd><p>The <code class="tag-attribute">psvi-required</code> attribute allows the author to declare that a step relies on the processor’s ability to pass PSVI annotations between steps, see <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>. If the attribute is not specified, the value “<code class="literal">false</code>” is assumed. </p></dd><dt><span class="term"><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">xpath-version</span></code></span></dt><dt id="xpath-version-attribute"><span class="term"><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xpath-version</span></code></span></dt><dd><p><span style="display: none;" class="delete_version">The requested <code class="tag-attribute">xpath-version</code><span class="rfc2119" id="declare-pipelines.5.4.2.1.2">must</span> be used to evaluate XPath expressions subject to the constraints outlined in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>. If the attribute is not specified, the value “<code class="literal">3.1</code>” is assumed. <a id="err.inline.S0110"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0110"><code class="errqname">err:XS0110</code></a>) if the requested XPath version is less than “<code class="literal">3.1</code>”.</span><span style="display: none;" class="add_version">The requested <code class="tag-attribute">xpath-version</code><span class="rfc2119" id="xpath-version-attribute.2.1.2">must</span> be used to evaluate XPath expressions subject to the constraints outlined in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>. <a id="err.inline.S0110"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0110"><code class="errqname">err:XS0110</code></a>) if the requested XPath version is less than “<code class="literal">3.1</code>” or is not supported by the processor.</span><span class="modify_version">The requested <code class="tag-attribute">xpath-version</code><span class="rfc2119" id="xpath-version-attribute.2.1.2">must</span> be used to evaluate XPath expressions subject to the constraints outlined in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>. <span class="deltaxml-old" style="background:#FF5555">If the attribute is not specified, the value “</span><span class="deltaxml-old" style="background:#FF5555">3.1</span><span class="deltaxml-old" style="background:#FF5555">” is assumed. </span><a id="err.inline.S0110"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0110"><code class="errqname">err:XS0110</code></a>) if the requested XPath version is less than “<code class="literal">3.1</code>”<span class="deltaxml-new" style="background:#90EE90"> or is not supported by the processor</span>.</span></p><p><span id="impl-46"><span class="deltaxml-new" style="background:#90EE90">If a pipeline does not request a specific XPath version, the version used is </span><em class="glossterm"><a href="#dt-implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a></em><span class="deltaxml-new" style="background:#90EE90">.</span></span><span id="impl-47"><span class="deltaxml-new" style="background:#90EE90">If different pipelines or libraries declare different XPath versions, it is </span><em class="glossterm"><a href="#dt-implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a></em><span class="deltaxml-new" style="background:#90EE90"> how those conflicts are resolved.</span></span><span class="deltaxml-new" style="background:#90EE90"> An implementation might use different versions for different pipelines, or it might use the same version for all pipelines. </span><span id="impl-48"><span class="deltaxml-new" style="background:#90EE90">If an implementation elects to use the same version for all pipelines, the version selected is </span><em class="glossterm"><a href="#dt-implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a></em><span class="deltaxml-new" style="background:#90EE90">. </span></span></p></dd><dt><span class="term"><code class="tag-attribute">exclude-inline-prefixes</code></span></dt><dd><p><span style="display: none;" class="delete_version">The a description of <code class="tag-attribute">exclude-inline-prefixes</code>, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </span><span style="display: none;" class="add_version">For a description of <code class="tag-attribute">exclude-inline-prefixes</code>, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">The</span><span class="deltaxml-new" style="background:#90EE90">For</span> a description of <code class="tag-attribute">exclude-inline-prefixes</code>, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>. </span></p></dd><dt><span class="term"><code class="tag-attribute">version</code></span></dt><dd><p>The <code class="tag-attribute">version</code> attribute identifies the version of XProc for which this step declaration was authored. If the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> has no ancestors in the XProc namespace, then it <span class="rfc2119" id="declare-pipelines.5.6.2.1.3">must</span> have a <code class="tag-attribute">version</code> attribute. <a id="err.inline.S0062.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0062"><code class="errqname">err:XS0062</code></a>) if a required version attribute is not present. See <a href="#versioning-considerations" title="Versioning Considerations">Section 13, “Versioning Considerations”</a>.</p></dd><dt><span class="term"><code class="tag-attribute">visibility</code></span></dt><dd><p>If the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> is a child of a <a href="#p.library"><code class="tag-element">p:library</code></a> the <code class="tag-attribute">visibility</code> attribute controls whether the step is visible to an importing pipeline. If <code class="tag-attribute">visibility</code> is set to <code class="literal">private</code>, the step type is only visible inside the <a href="#p.library"><code class="tag-element">p:library</code></a> and is not visible to any pipeline importing the <a href="#p.library"><code class="tag-element">p:library</code></a>. If the <code class="tag-attribute">visibility</code> attribute is missing, <code class="literal">public</code> is assumed. If the <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> is not a child of a <a href="#p.library"><code class="tag-element">p:library</code></a> the attribute has no effect and is ignored. </p></dd></dl></div><p>In the general case, the children of a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> can be grouped into several sections. All of these sections, except the subpipeline, may be empty.</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>Imports must come first.</p></li><li><p>The prologue follows the imports. <span id="dt-prologue" class="termdef">[Definition: The <em class="glossterm">prologue</em> consists of the <a href="#p.input"><code class="tag-element">p:input</code></a>, <a href="#p.output"><code class="tag-element">p:output</code></a>, and <a href="#p.option"><code class="tag-element">p:option</code></a> elements. ]</span></p></li><li><p>The prologue may be followed by any number of inline <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> elements that declare additional steps.</p></li><li><p>Finally, there must be at least one step in the subpipeline.</p></li></ol></div><p>Options in the prologue may not shadow each other. <a id="err.inline.S0091"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0091"><code class="errqname">err:XS0091</code></a>) if an <a href="#p.option"><code class="tag-element">p:option</code></a> shadows another option declared within the same <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>. (Within the subpipeline, variables may shadow (non-static) options and lexically preceding variables.) </p><p>The prologue ends with additional <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> elements, if any, and is followed by the subpipeline. Any step imported or declared in the prologue of a pipeline may be invoked as a step within the subpipeline of that pipeline.</p><p>The environment inherited by the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em> is the <em class="glossterm"><a href="#dt-empty-environment">empty environment</a></em> with these modifications:</p><div class="itemizedlist"><ul><li><p>All of the declared inputs are added to the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> in the environment.</p></li><li><p>If a <em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em> is declared, that port is the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>, otherwise the default readable port is undefined.</p></li><li><p>The <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em> at the beginning of a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> are limited to the lexically preceding, statically declared options.</p></li></ul></div><p>If a <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> is declared and that port has no <em class="glossterm"><a href="#dt-connection">connection</a></em>, then it is connected to the <em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em> of the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the <em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em>. <a id="err.inline.S0006.2"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0006"><code class="errqname">err:XS0006</code></a>) if the primary output port is unconnected and the <em class="glossterm"><a href="#dt-last-step">last step</a></em> in the subpipeline does not have a primary output port.</p></div></section><section id="declare-atomic-steps" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.5.2. </bdi>Declaring external steps<a aria-label="§" class="self-link" href="#declare-atomic-steps"></a></h4></div><div class="content"><p>The distinction between a pipeline declaration and an external step declaration hinges on the presence or absence of a subpipeline. A step declaration that does not contain a subpipeline is, by definition, declaring an <em class="glossterm"><a href="#dt-external-step">external step</a></em>.</p><p>External step declarations may not import other pipelines or functions, may not declare static options, and may not declare additional steps. In other words, the content of an external step declaration consists exclusively of <a href="#p.input"><code class="tag-element">p:input</code></a>, <a href="#p.output"><code class="tag-element">p:output</code></a>, and <a href="#p.option"><code class="tag-element">p:option</code></a> elements.</p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span><span class="modify_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span></p><p><span style="display: none;" class="delete_version"><span id="impl-43">Implementations may use <em class="glossterm"><a href="#dt-extension-attribute">extension attributes</a></em> to provide <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> information about a declared step.</span> For example, such an attribute might identify the code which implements steps of this type.</span><span style="display: none;" class="add_version"><span id="impl-49">Implementations may use <em class="glossterm"><a href="#dt-extension-attribute">extension attributes</a></em> to provide <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> information about a declared step.</span> For example, such an attribute might identify the code which implements steps of this type.</span><span class="modify_version"><span id="impl-49">Implementations may use <em class="glossterm"><a href="#dt-extension-attribute">extension attributes</a></em> to provide <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> information about a declared step.</span> For example, such an attribute might identify the code which implements steps of this type.</span></p><p>It is not an error for a pipeline to include declarations for steps that a particular processor does not know how to implement. It is, of course, an error to attempt to evaluate such steps. The function <a href="#f.step-available"><code class="function">p:step-available</code></a> will return <code class="literal">false</code> when called with the type name of such a step.</p><p><a id="err.inline.D0017.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0017"><code class="errqname">err:XD0017</code></a>) if the running pipeline attempts to invoke an external step which the processor does not know how to perform.</p></div></section></div></section><section id="p.library" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.6. </bdi>p:library<a aria-label="§" class="self-link" href="#p.library"></a></h3></div><div class="content"><p>A <code class="tag-element">p:library</code> is a collection of static options, and step declarations.</p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span><span class="modify_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span></p><p>The <code class="tag-attribute">version</code> attribute identifies the version of XProc for which this library was authored. If the <code class="tag-element">p:library</code> has no ancestors in the XProc namespace, then it <span class="rfc2119" id="p.library.4.3">must</span> have a <code class="tag-attribute">version</code> attribute. See <a href="#versioning-considerations" title="Versioning Considerations">Section 13, “Versioning Considerations”</a>.</p><p>The requested <code class="tag-attribute">xpath-version</code><span class="rfc2119" id="p.library.5.2">must</span> be used to evaluate XPath expressions subject to the constraints outlined in <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>. If the attribute is not specified, the value “<code class="literal">3.1</code>” is assumed. <a id="err.inline.S0110.1"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0110"><code class="errqname">err:XS0110</code></a>) if the requested XPath version is less than “<code class="literal">3.1</code>”.</p><p>The <code class="tag-attribute">psvi-required</code> attribute allows the author to declare that a step relies on the processor’s ability to pass PSVI annotations between steps, see <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>. If the attribute is not specified, the value “<code class="literal">false</code>” is assumed. </p><p>For a description of <code class="tag-attribute">psvi-required</code>, see <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>; for <code class="tag-attribute">xpath-version</code>, see <a href="#xpath-context" title="XPath in XProc">Section 7.2.2, “XPath in XProc”</a>; for <code class="tag-attribute">exclude-inline-prefixes</code>, see <a href="#p.inline"><code class="tag-element">p:inline</code></a>.</p><div id="note-step-decl" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>The steps declared in a pipeline library are referred to by their type. It is not an error to put a <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> without a <code class="tag-attribute">type</code> in a <code class="tag-element">p:library</code>, but there is no standard mechanism for instantiating it or referring to it. It is effectively invisible.</p></div></div><p>Like <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>, within a library, imports must precede the prologue (any static options), which must precede any declared steps.</p><p>Libraries can import pipelines and/or other libraries. See also <a href="#handling-imports" title="Handling Circular and Re-entrant Library Imports (Non-Normative)">Appendix H, <i>Handling Circular and Re-entrant Library Imports (Non-Normative)</i></a>.</p></div></section><section id="p.import" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.7. </bdi>p:import<a aria-label="§" class="self-link" href="#p.import"></a></h3></div><div class="content"><p><span style="display: none;" class="delete_version">An <code class="tag-element">p:import</code> loads a pipeline or pipeline library, making it available in the pipeline or library which contains the <code class="tag-element">p:import</code>.</span><span style="display: none;" class="add_version">A <code class="tag-element">p:import</code> loads a pipeline or pipeline library, making it available in the pipeline or library which contains the <code class="tag-element">p:import</code>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">An</span><span class="deltaxml-new" style="background:#90EE90">A</span> <code class="tag-element">p:import</code> loads a pipeline or pipeline library, making it available in the pipeline or library which contains the <code class="tag-element">p:import</code>.</span></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:import<br />  <strong>href</strong> = <var>anyURI</var> /&gt;</code></p><p>An import statement loads the specified IRI and makes any <span class="deltaxml-new" style="background:#90EE90">public options or </span>pipelines declared within it available to the current pipeline. </p><p><span style="display: none;" class="add_version"><a id="err.inline.S0052"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0052"><code class="errqname">err:XS0052</code></a>) if the URI of a <code class="tag-element">p:import</code> cannot be retrieved or if, once retrieved, it does not point to a <a href="#p.library"><code class="tag-element">p:library</code></a> or <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>.</span><span class="modify_version"><a id="err.inline.S0052"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0052"><code class="errqname">err:XS0052</code></a>) if the URI of a <code class="tag-element">p:import</code> cannot be retrieved or if, once retrieved, it does not point to a <a href="#p.library"><code class="tag-element">p:library</code></a> or <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a>.<span class="deltaxml-old" style="background:#FF5555"> </span><a id="err.inline.S0053"></a><span class="deltaxml-old" style="background:#FF5555">It is a </span><a href="#dt-static-error"><span class="deltaxml-old" style="background:#FF5555">static error</span></a><span class="deltaxml-old" style="background:#FF5555"> (</span><a href="#err.S0053"><code class="errqname"><span class="deltaxml-old" style="background:#FF5555">err:XS0053</span></code></a><span class="deltaxml-old" style="background:#FF5555">) to import a single pipeline if that pipeline does not have a </span><span class="deltaxml-old" style="background:#FF5555">type</span><span class="deltaxml-old" style="background:#FF5555">. </span></span></p><p>Attempts to retrieve the library identified by the URI value may be redirected at the parser level (for example, in an entity resolver) or below (at the protocol level, for example, via an HTTP Location: header). In the absence of additional information outside the scope of this specification<span class="deltaxml-old" style="background:#FF5555"> within the resource</span>, the base URI of the library is always the URI of the actual resource returned. In other words, it is the URI of the resource retrieved after all redirection has occurred.</p><p><span class="deltaxml-new" style="background:#90EE90">Library imports can nest. An imported pipeline or library may contain additional </span><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import</span></code><span class="deltaxml-new" style="background:#90EE90">s which must be processed. Two imported pipelines or libraries are considered the same if the base URI of the resource retrieved is the same. If otherwise identical resources are retrieved with different base URIs (for instance when a web server returns the same document for different request URIs), they must </span><em><span class="deltaxml-new" style="background:#90EE90">not</span></em><span class="deltaxml-new" style="background:#90EE90"> be considered the same imported library.</span></p><p><span style="display: none;" class="delete_version">As imports are processed, a processor may encounter new <code class="tag-element">p:import</code> elements whose library URI is the same as one it has already processed in some other context. This may happen as a consequence of resolving the URI. If the actual base URI is the same as one that has already been processed, the implementation must recognize it as the same library and should not need to process the resource. Also, a duplicate, circular chain of imports, or a re-entrant import is not an error and implementations must take the necessary steps to avoid infinite loops and/or incorrect notification of duplicate step definitions. It is not an error for a library to import itself. An example of such steps is listed in <a href="#handling-imports" title="Handling Circular and Re-entrant Library Imports (Non-Normative)">Appendix H, <i>Handling Circular and Re-entrant Library Imports (Non-Normative)</i></a>.</span><span style="display: none;" class="add_version">When resolving <code class="tag-element">p:import</code>s, a processor may encounter multiple imports of the same pipeline or library. A duplicate import, circular chain of imports (even a library that imports itself), or a re-entrant import is not an error and implementations must take the necessary steps to avoid infinite loops and/or incorrect notification of duplicate step definitions. An example of such steps is listed in <a href="#handling-imports" title="Handling Circular and Re-entrant Library Imports (Non-Normative)">Appendix H, <i>Handling Circular and Re-entrant Library Imports (Non-Normative)</i></a>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">As imports</span><span class="deltaxml-new" style="background:#90EE90">When resolving</span> <code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">are</span><span class="deltaxml-new" style="background:#90EE90">p:import</span></code><span class="deltaxml-old" style="background:#FF5555"> processed, a processor may encounter new</span><span class="deltaxml-new" style="background:#90EE90">s, a processor may encounter multiple imports</span> <span class="deltaxml-old" style="background:#FF5555">p:import</span><span class="deltaxml-new" style="background:#90EE90">of</span> <span class="deltaxml-old" style="background:#FF5555">elements whose library URI is the same as one it has already processed in some other context. This may happen as a consequence of resolving the URI. If the actual base URI is the same as one that has already been processed, the implementation must recognize it as the same library and should not need to process the resource. Also, a duplicate</span><span class="deltaxml-new" style="background:#90EE90">the same pipeline or library. A duplicate import</span>, circular chain of imports<span class="deltaxml-new" style="background:#90EE90"> (even a library that imports itself)</span>, or a re-entrant import is not an error and implementations must take the necessary steps to avoid infinite loops and/or incorrect notification of duplicate step definitions. <span class="deltaxml-old" style="background:#FF5555">It is not an error for a library to import itself. </span>An example of such steps is listed in <a href="#handling-imports" title="Handling Circular and Re-entrant Library Imports (Non-Normative)">Appendix H, <i>Handling Circular and Re-entrant Library Imports (Non-Normative)</i></a>.</span></p><p><span class="deltaxml-old" style="background:#FF5555">A library is considered the same library if the base URI of the resource retrieved is the same. If different base URIs resolve to the same library (for instance when a web server returns the same document on different URLs), they must </span><em><span class="deltaxml-old" style="background:#FF5555">not</span></em><span class="deltaxml-old" style="background:#FF5555"> be considered the same imported library.</span></p><p><span class="deltaxml-new" style="background:#90EE90">In some URI schemes, it is possible for different URIs to identify “the same” resource. Consider, for example, </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">file:/path/file</span></code><span class="deltaxml-new" style="background:#90EE90"> and </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">file:/path/to/../file</span></code><span class="deltaxml-new" style="background:#90EE90">. To the extent practical, implementations </span><span class="rfc2119" id="canon-import-uris.3"><span class="deltaxml-new" style="background:#90EE90">should</span></span><span class="deltaxml-new" style="background:#90EE90"> attempt to resolve these differences before deciding if a particular library URI has already been imported. Note that this is distinct from the case where two genuinely different URIs happen to resolve to the same document. The processor isn’t expected to detect that case and errors are likely. </span></p><section id="import-visibility" class="section"><div class="section-titlepage"><h4><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">16.7.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Import visibility</span><a aria-label="§" class="self-link" href="#import-visibility"></a></h4></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">A </span><a href="#p.import"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import</span></code></a><span class="deltaxml-new" style="background:#90EE90"> statement makes new options and steps visible at the point where it occurs. There are two cases to consider:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">When a pipeline is imported (when the document element of the imported resource is </span><a href="#p.declare-step"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:declare-step</span></code></a><span class="deltaxml-new" style="background:#90EE90">), the step type of the declared step becomes visible.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">When a library is imported (when the document element of the imported resource is </span><a href="#p.library"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:library</span></code></a><span class="deltaxml-new" style="background:#90EE90">), all of the options and declared steps in that library become visible unless they have a </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">visibility</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute that is explicitly set to “</span><code class="code"><span class="deltaxml-new" style="background:#90EE90">private</span></code><span class="deltaxml-new" style="background:#90EE90">”.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Visibility through libraries is transitive. Any option or step that is visible when imported into a library is also visible where the containing library is imported.</span></p></li></ul></div><p><span class="deltaxml-new" style="background:#90EE90">Suppose that pipeline P imports library L1 that imports library L2. If library L1 contains two steps, A and B, where B is marked private, and library L2 contains a step C, then:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">Steps A and C become visible in P where L1 is imported.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Steps A, B, and C are visible in library L1.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Only step C is visible in library L2.</span></p></li></ul></div></div></section></div></section><section id="p.import-functions" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.8. </bdi>p:import-functions<a aria-label="§" class="self-link" href="#p.import-functions"></a></h3></div><div class="content"><p><span style="display: none;" class="delete_version">An <code class="tag-element">p:import-functions</code> element identifies a library of externally defined functions to be imported into the pipeline. After the functions have been imported, they are available in the processor XPath context.</span><span style="display: none;" class="add_version">An <code class="tag-element">p:import-functions</code> element identifies a library of externally defined functions to be imported into the pipeline. After the functions have been imported, they are available in the <a href="#xproc-xpath-context-31">processor XPath context</a> of the pipeline or library that they are imported into.</span><span class="modify_version">An <code class="tag-element">p:import-functions</code> element identifies a library of externally defined functions to be imported into the pipeline. After the functions have been imported, they are available in the <span class="deltaxml-old" style="background:#FF5555">processor</span><a href="#xproc-xpath-context-31"><span class="deltaxml-new" style="background:#90EE90">processor XPath context</span></a> <span class="deltaxml-old" style="background:#FF5555">XPath context</span><span class="deltaxml-new" style="background:#90EE90">of the pipeline or library that they are imported into</span>.</span></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:import-functions<br />  <strong>href</strong> = <var>anyURI</var><br />  content-type? = <var>ContentType</var><br />  namespace? = <var>string</var> /&gt;</code></p><div class="variablelist"><dl><dt><span class="term"><code class="tag-attribute">href</code></span></dt><dd><p>The <code class="tag-attribute">href</code> attribute identifies the URI of the function library. <a id="err.inline.S0103"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0103"><code class="errqname">err:XS0103</code></a>) if the URI of a <code class="tag-element">p:import-functions</code> element cannot be retrieved or if, once retrieved, it points to a library that the processor cannot import. </p></dd><dt><span class="term"><code class="tag-attribute">content-type</code></span></dt><dd><p><span style="display: none;" class="delete_version">The <code class="tag-attribute">content-type</code> specifies what kind of library is expected at the URI. <span id="impl-44">If no type is specified, the way that the processor determines the type of the library is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">The <code class="tag-attribute">content-type</code> specifies what kind of library is expected at the URI. <span id="impl-50">If no type is specified, the way that the processor determines the type of the library is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">The <code class="tag-attribute">content-type</code> specifies what kind of library is expected at the URI. <span id="impl-50">If no type is specified, the way that the processor determines the type of the library is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term"><code class="tag-attribute">namespace</code></span></dt><dd><p>If a <code class="tag-attribute">namespace</code> is specified, it must be a whitespace separated list of namespace URIs. Only functions in those namespaces will be loaded. </p></dd></dl></div><p><span class="deltaxml-new" style="background:#90EE90">Imported functions are loaded during static analysis. In particular, they can be used in </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">[p:]use-when</span></code><span class="deltaxml-new" style="background:#90EE90"> expressions and in expressions that initialize static options.</span></p><p><span style="display: none;" class="delete_version">The ability to import functions is optional. <span id="impl-45">Whether or not a processor can import functions, and if it can, what kinds of function libraries it can import from is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Pipeline authors can use <a href="#f.function-library-importable"><code class="function">p:function-library-importable</code></a> to test whether or not a particular kind of library can be loaded. </span><span style="display: none;" class="add_version">The ability to import functions is optional. <span id="impl-51">Whether or not a processor can import functions, and if it can, what kinds of function libraries it can import from is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Pipeline authors can use <a href="#f.function-library-importable"><code class="function">p:function-library-importable</code></a> to test whether or not a particular kind of library can be loaded. </span><span class="modify_version">The ability to import functions is optional. <span id="impl-51">Whether or not a processor can import functions, and if it can, what kinds of function libraries it can import from is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span> Pipeline authors can use <a href="#f.function-library-importable"><code class="function">p:function-library-importable</code></a> to test whether or not a particular kind of library can be loaded. </span></p><p>Importing functions from a library implies loading and processing that library according to its conventions (loading imports, resolving dependencies, etc.). <a id="err.inline.S0104"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0104"><code class="errqname">err:XS0104</code></a>) if the processor cannot load the function library. This may occur because the format is unknown, because it is a version of the library that the processor does not recognize, or if it’s uninterpretable for any other reason. <a id="err.inline.S0106"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0106"><code class="errqname">err:XS0106</code></a>) if the processor detects that a particular library is unloadable. This may occur if the processor is, in principle, able to load libraries of the specified format, but detects that the particuar library requested is somehow ill-formed (syntactically invalid, has unsatisfiable dependencies or circular imports, etc.). </p><p>Imported functions must be unique (they must not have the same name, namespace, and arity). <a id="err.inline.S0105"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0105"><code class="errqname">err:XS0105</code></a>) if a function imported from a library has the same name and arity as a function already imported. </p><p><span class="deltaxml-new" style="background:#90EE90">Function imports are not transitive. If a pipeline imports a library that imports functions, those functions are not available in the pipeline that imported the library, unless they’re also imported directly by the pipeline.</span></p></div></section><section id="p.pipe" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.9. </bdi>p:pipe<a aria-label="§" class="self-link" href="#p.pipe"></a></h3></div><div class="content"><p>A <code class="tag-element">p:pipe</code> connects an input to a port on another step.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:pipe<br />  step? = <var>NCName</var><br />  port? = <var>NCName</var> /&gt;</code></p><p>The <code class="tag-element">p:pipe</code> element connects to a readable port of another step. It identifies the readable port to which it connects with the name of the step in the <code class="tag-attribute">step</code> attribute and the name of the port on that step in the <code class="tag-attribute">port</code> attribute. <a id="err.inline.S0099"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0099"><code class="errqname">err:XS0099</code></a>) if <code class="tag-attribute">step</code> or <code class="tag-attribute">port</code> are not valid instances of <code class="literal">NCName</code>.</p><p>If the <code class="tag-attribute">step</code> attribute is not specified, it defaults to the step which provides the default readable port. If the <code class="tag-attribute">port</code> attribute is not specified, it defaults to the primary output port of the step identified (explicitly or implicitly).</p><p><a id="err.inline.S0067"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0067"><code class="errqname">err:XS0067</code></a>) if the <code class="tag-attribute">step</code> attribute is not specified, and there is no default readable port. <a id="err.inline.S0068"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0068"><code class="errqname">err:XS0068</code></a>) if the <code class="tag-attribute">port</code> attribute is not specified, and the step identified has no primary output port. </p><p><a id="err.inline.S0022"></a>In all cases except when the <code class="tag-element">p:pipe</code> is within an <a href="#p.output"><code class="tag-element">p:output</code></a> of a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>, it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0022"><code class="errqname">err:XS0022</code></a>) if the port identified by the <code class="tag-element">p:pipe</code> is not in the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> of the step that contains the <code class="tag-element">p:pipe</code>.</p><p>A <code class="tag-element">p:pipe</code> that is a <em class="glossterm"><a href="#dt-connection">connection</a></em> for an <a href="#p.output"><code class="tag-element">p:output</code></a> of a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em> may connect to one of the readable ports of the compound step or to an output port on one of the compound step’s <em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em>. In other words, the output of a compound step can simply be a copy of one of the available inputs or it can be the output of one of its children.</p><p><a id="err.inline.S0078"></a>When the <code class="tag-element">p:pipe</code> is within an <a href="#p.output"><code class="tag-element">p:output</code></a> of a <em class="glossterm"><a href="#dt-compound-step">compound step</a></em>, it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0078"><code class="errqname">err:XS0078</code></a>) if the port identified by the <code class="tag-element">p:pipe</code> is not in the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> of the compound step and is not a readable port of a contained step. </p></div></section><section id="p.inline" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.10. </bdi>p:inline<a aria-label="§" class="self-link" href="#p.inline"></a></h3></div><div class="content"><p>A <code class="tag-element">p:inline</code> provides a document inline.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:inline<br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  content-type? = <var>string</var><br />  document-properties? = <var>map(xs:QName,item()*)</var><br />  encoding? = <var>string</var>&gt;<br />    <var>anyNode</var>*<br />&lt;/p:inline&gt;</code></p><p>The <code class="tag-attribute">content-type</code> attribute can be used to set the content type of the provided document; the <code class="tag-attribute">document-properties</code> attribute can be used to set the <em class="glossterm"><a href="#dt-document-properties">document properties</a></em> of the provided document.</p><p>The document’s content type is determined statically. If a <code class="tag-attribute">content-type</code> is specified, that is the content type. Otherwise, the content type is “<code class="literal">application/xml</code>”. </p><p><a id="err.inline.D0062"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0062"><code class="errqname">err:XD0062</code></a>) if the <code class="tag-attribute">document-properties</code> map contains a <code class="literal">content-type</code> key and that key has a value that differs from the statically determined content type.</p><p>The base URI of the document is the base URI of the <code class="tag-element">p:inline</code> element or of the parent element in the case of an implicit inline. If <code class="tag-attribute">document-properties</code> provides a value for “<code class="literal">base-uri</code>”, this value is the base URI of the document. <a id="err.inline.D0064"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0064"><code class="errqname">err:XD0064</code></a>) if the base URI is not both absolute and valid according to [<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>].</p><p>How the content of a <code class="tag-element">p:inline</code> element is interpreted depends on the document’s content type and the <code class="tag-attribute">encoding</code> attribute. </p><p><a id="err.inline.D0054"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0054"><code class="errqname">err:XD0054</code></a>) if an encoding is specified and the content type is an <em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em> or an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>. </p><p><a id="err.inline.D0055"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0055"><code class="errqname">err:XD0055</code></a>) if the content type value specifies a character set and the <code class="tag-attribute">encoding</code> attribute is absent. </p><p><a id="err.inline.D0039"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0039"><code class="errqname">err:XD0039</code></a>) if the <code class="tag-attribute">encoding</code> attribute is present and content type value specifies a character set that is not supported by the implementation. </p><p><a id="err.inline.D0056"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0056"><code class="errqname">err:XD0056</code></a>) if an encoding is specified and the content of the <code class="tag-element">p:inline</code> contains any XML markup. <a id="err.inline.D0063"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0063"><code class="errqname">err:XD0063</code></a>) if the <code class="tag-element">p:inline</code> contains any XML markup and has a content type that is not an <em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em> or an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>. In other words, in these cases, the entire content must be a single text node. CDATA sections and character references do not count as markup for this purpose because they will already have been replaced by the XML parser that read the pipeline.</p><p><span style="display: none;" class="delete_version">If the <code class="tag-attribute">encoding</code> attribute is present, the content must be decoded. The encoding value “<code class="literal">base64</code>” <span class="rfc2119" id="p.inline.13.3">must</span> be supported and identifies the content as being base64-encoded. <span id="impl-46">An implementation may support encodings other than <code class="literal">base64</code>, but these encodings and their names are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><a id="err.inline.S0069"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0069"><code class="errqname">err:XS0069</code></a>) if the encoding specified is not supported by the implementation. <a id="err.inline.D0040"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0040"><code class="errqname">err:XD0040</code></a>) if the body is not correctly encoded per the value of the <code class="tag-attribute">encoding</code> attribute. </span><span style="display: none;" class="add_version">If the <code class="tag-attribute">encoding</code> attribute is present, the content must be decoded. The encoding value “<code class="literal">base64</code>” <span class="rfc2119" id="p.inline.13.3">must</span> be supported and identifies the content as being base64-encoded. <span id="impl-52">An implementation may support encodings other than <code class="literal">base64</code>, but these encodings and their names are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><a id="err.inline.S0069"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0069"><code class="errqname">err:XS0069</code></a>) if the encoding specified is not supported by the implementation. <a id="err.inline.D0040"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0040"><code class="errqname">err:XD0040</code></a>) if the body is not correctly encoded per the value of the <code class="tag-attribute">encoding</code> attribute. </span><span class="modify_version">If the <code class="tag-attribute">encoding</code> attribute is present, the content must be decoded. The encoding value “<code class="literal">base64</code>” <span class="rfc2119" id="p.inline.13.3">must</span> be supported and identifies the content as being base64-encoded. <span id="impl-52">An implementation may support encodings other than <code class="literal">base64</code>, but these encodings and their names are <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span><a id="err.inline.S0069"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0069"><code class="errqname">err:XS0069</code></a>) if the encoding specified is not supported by the implementation. <a id="err.inline.D0040"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0040"><code class="errqname">err:XD0040</code></a>) if the body is not correctly encoded per the value of the <code class="tag-attribute">encoding</code> attribute. </span></p><p>If an <code class="tag-attribute">encoding</code> attribute is present, value templates are never expanded. The value of <code class="tag-attribute">[p:]expand-text</code> is irrelevant and always ignored. Otherwise, the text content of <code class="tag-element">p:inline</code> is subject to text value template expansion irrespective of its content type. (Attribute value template expansion only applies to XML and HTML media types.) </p><p>The interpretation of the (possibly decoded) content depends on the document’s content type. </p><div class="note admonition"><h3>Note</h3><div class="admonition-body"><p>In the presence of <em class="glossterm"><a href="#dt-text-value-template">text value templates</a></em>, it is not possible to interpret the non-XML characters until the templates have been expanded.</p></div></div><section id="inline-xml-content" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.10.1. </bdi>Inline XML and HTML content<a aria-label="§" class="self-link" href="#inline-xml-content"></a></h4></div><div class="content"><p>If <code class="tag-attribute">content-type</code> is not specified or specifies an <em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em> or an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>, then the content is XML. A new XML document is created by wrapping a document node around the nodes which appear as children of <a href="#p.inline"><code class="tag-element">p:inline</code></a>.</p><p>The in-scope namespaces of the inline document differ from the in-scope namespace of the content of the <a href="#p.inline"><code class="tag-element">p:inline</code></a> element in that bindings for all its <em>excluded namespaces</em>, as defined below, are removed:</p><div class="itemizedlist"><ul><li><p>The XProc namespace itself (<code class="uri">http://www.w3.org/ns/xproc</code>) is excluded.</p></li><li><p>A namespace URI designated by using an <code class="tag-attribute">exclude-inline-prefixes</code> attribute on the enclosing <a href="#p.inline"><code class="tag-element">p:inline</code></a> is excluded.</p></li><li><p>A namespace URI designated by using an <code class="tag-attribute">exclude-inline-prefixes</code> attribute on any ancestor <a href="#p.declare-step"><code class="tag-element">p:declare-step</code></a> or <a href="#p.library"><code class="tag-element">p:library</code></a> is also excluded. (In other words, the effect of several <code class="tag-attribute">exclude-inline-prefixes</code> attributes among the ancestors of <a href="#p.inline"><code class="tag-element">p:inline</code></a> is cumulative.)</p></li></ul></div><p>The value of each prefix in the <code class="tag-attribute">exclude-inline-prefixes</code> attribute is interpreted as follows:</p><div class="itemizedlist"><ul><li><p>The value of the attribute is either <code class="literal">#all</code>, or a whitespace-separated list of tokens, each of which is either a namespace prefix or <code class="literal">#default</code>. The namespace bound to each of the prefixes is designated as an excluded namespace. <a id="err.inline.S0057"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0057"><code class="errqname">err:XS0057</code></a>) if the <code class="tag-attribute">exclude-inline-prefixes</code> attribute does not contain a list of tokens or if any of those tokens (except <code class="literal">#all</code> or <code class="literal">#default</code>) is not a prefix bound to a namespace in the in-scope namespaces of the element on which it occurs.</p></li><li><p>The default namespace of the element on which <code class="tag-attribute">exclude-inline-prefixes</code> occurs may be designated as an excluded namespace by including <code class="literal">#default</code> in the list of namespace prefixes. <a id="err.inline.S0058"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0058"><code class="errqname">err:XS0058</code></a>) if the value <code class="literal">#default</code> is used within the <code class="tag-attribute">exclude-inline-prefixes</code> attribute and there is no default namespace in scope. </p></li><li><p>The value <code class="literal">#all</code> indicates that all namespaces that are in scope for the element on which <code class="tag-attribute">exclude-inline-prefixes</code> occurs are designated as excluded namespaces.</p></li></ul></div><p>The XProc processor <span class="rfc2119" id="inline-xml-content.7.1">must</span> include all in-scope prefixes that are not explicitly excluded. If the namespace associated with an excluded prefix is used in the expanded-QName of a descendant element or attribute, the processor <span class="rfc2119" id="inline-xml-content.7.2">may</span> include that prefix anyway, or it may generate a new prefix.</p><p>Consider this example:</p><pre class="programlisting language-markup xml"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:c="http://www.w3.org/ns/xproc-step" version="3.0"&gt; &lt;p:output port="result" serialization="map { 'indent': true() }"/&gt; &lt;p:identity xmlns:a="http://example.com/a" xmlns:b="http://example.com/b" xmlns:c="http://example.com/c"&gt; &lt;p:with-input port="source"&gt; &lt;p:inline exclude-inline-prefixes="a b"&gt; &lt;doc&gt; &lt;b:part/&gt; &lt;/doc&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-markup xml"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" xmlns:c="http://www.w3.org/ns/xproc-step" version="3.1"&gt; &lt;p:output port="result" serialization="map { 'indent': true() }"/&gt; &lt;p:identity xmlns:a="http://example.com/a" xmlns:b="http://example.com/b" xmlns:c="http://example.com/c"&gt; &lt;p:with-input port="source"&gt; &lt;p:inline exclude-inline-prefixes="a b"&gt; &lt;doc&gt; &lt;b:part/&gt; &lt;/doc&gt; &lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt; &lt;/p:declare-step&gt;</span></code></pre><p>which might produce a result like this:</p><pre class="programlisting language-markup xml"><code>  &lt;doc xmlns:c="http://example.com/c"&gt; &lt;b:part xmlns:b="http://example.com/b"/&gt; &lt;/doc&gt;  </code></pre><p>The declaration for “<code class="literal">c</code>” must be present because it was not excluded. The “<code class="literal">part</code>” element uses the namespace bound to “<code class="literal">b</code>”, so <em>some</em> binding must be present. In this example, the original prefix has been preserved, but it would be equally correct if a different prefix had been used.</p><p>The text-node descendants of a <a href="#p.inline"><code class="tag-element">p:inline</code></a> may be <a href="#text-value-templates">text value templates</a>. Attribute descendants may be <a href="#attribute-value-templates">attribute value templates</a>. This is controlled by the <code class="tag-attribute">[p:]expand-text</code> and the <code class="tag-attribute">p:inline-expand-text</code> attribute. See <a href="#expand-text-attribute" title="Expand text attributes">Section 14.9.1, “Expand text attributes”</a>.</p></div></section><section id="inline-text" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.10.2. </bdi>Inline text content<a aria-label="§" class="self-link" href="#inline-text"></a></h4></div><div class="content"><p>If the document’s content type is a <em class="glossterm"><a href="#dt-text-media-type">text media type</a></em>, then the content is text. A new text document is created by joining the text nodes which appear as children of p:inline together to a single text node and wrapping a document node around it. Any preceding or following whitespace-only text nodes will be preserved.</p></div></section><section id="inline-json" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.10.3. </bdi>Inline JSON content<a aria-label="§" class="self-link" href="#inline-json"></a></h4></div><div class="content"><p>If the document’s content type is a <em class="glossterm"><a href="#dt-JSON-media-type">JSON media type</a></em>, then the context is JSON. A new JSON document is created by joining the text values of children of p:inline together and parse it as JSON.</p><p><a id="err.inline.D0057"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0057"><code class="errqname">err:XD0057</code></a>) if the text content does not conform to the JSON grammar.</p></div></section><section id="inline-others" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.10.4. </bdi>Other inline content<a aria-label="§" class="self-link" href="#inline-others"></a></h4></div><div class="content"><p><span style="display: none;" class="delete_version"><span id="impl-47">How a processor interprets other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>. </span></span><span style="display: none;" class="add_version"><span id="impl-53">How a processor interprets other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>. </span></span><span class="modify_version"><span id="impl-53">How a processor interprets other media types is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>. </span></span></p></div></section><section id="implicit-inlines" class="section"><div class="section-titlepage"><h4><bdi class="secno">16.10.5. </bdi>Implicit inlines<a aria-label="§" class="self-link" href="#implicit-inlines"></a></h4></div><div class="content"><p>As an authoring convenience, <a href="#p.inline"><code class="tag-element">p:inline</code></a> may be omitted if one or more element nodes, optionally preceded and/or followed by whitespace occurs where a <a href="#p.inline"><code class="tag-element">p:inline</code></a> is allowed. Whitespace around each element is ignored and the element is treated as if it was enclosed within a <a href="#p.inline"><code class="tag-element">p:inline</code></a> element (with no attributes). Elements in the XProc namespace are forbidden except for <a href="#p.documentation"><code class="tag-element">p:documentation</code></a> and <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> which are ignored. </p><p>The following example demonstrates this implicit behaviour:</p><pre class="programlisting language-markup xml"><code>&lt;p:identity name="identity" code="my:implicitinline1"&gt; &lt;p:with-input port="source"&gt; &lt;p xmlns="http://example.org/ns"&gt;Text&lt;/p&gt; &lt;p xmlns="http://example.org/ns"&gt;Other text&lt;/p&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt;</code></pre><p>Is interpreted as follows:</p><pre class="programlisting language-markup xml"><code>&lt;p:identity name="identity" code="my:implicitinline2"&gt; &lt;p:with-input port="source"&gt; &lt;p:inline&gt;&lt;p xmlns="http://example.org/ns"&gt;Text&lt;/p&gt;&lt;/p:inline&gt; &lt;p:inline&gt;&lt;p xmlns="http://example.org/ns"&gt;Other text&lt;/p&gt;&lt;/p:inline&gt; &lt;/p:with-input&gt; &lt;/p:identity&gt;</code></pre><p>An explicit <a href="#p.inline"><code class="tag-element">p:inline</code></a> is required if the author wants to include top level comments, processing instructions, or whitespace, or if the document element is in the XProc namespace.</p><p><a id="err.inline.S0079"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0079"><code class="errqname">err:XS0079</code></a>) if comments, non-whitespace text nodes, or processing instructions occur as siblings of an element node that would be treated as an implicit inline. </p></div></section></div></section><section id="p.document" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.11. </bdi>p:document<a aria-label="§" class="self-link" href="#p.document"></a></h3></div><div class="content"><p>A <code class="tag-element">p:document</code> reads a document from a URI.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:document<br />  <strong>href</strong> = { <var>anyURI</var> }<br />  content-type? = <var>string</var><br />  document-properties? = <var>map(xs:QName,item()*)</var><br />  parameters? = <var>map(xs:QName,item()*)</var> /&gt;</code></p><p>The value of the <code class="tag-attribute">href</code> attribute, after expanding any <em class="glossterm"><a href="#dt-attribute-value-template">attribute value templates</a></em>, is a URI. The URI is interpreted as an IRI reference. If it is relative, it is made absolute against the base URI of the <code class="tag-element">p:document</code> element. <a id="err.inline.D0064.1"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0064"><code class="errqname">err:XD0064</code></a>) if the base URI is not both absolute and valid according to [<a href="#rfc3986"><span class="abbrev">RFC 3986</span></a>]. </p><p>The semantics of <code class="tag-element">p:document</code> are the same as the semantics of <code class="tag-element">p:load</code> where the <code class="option">href</code> option is the URI, the <code class="option">content-type</code> option comes from <code class="tag-attribute">content-type</code> attribute, the <code class="option">document-properties</code> option comes from the <code class="tag-attribute">document-properties</code> attribute, and the <code class="option">parameters</code> option comes from the <code class="tag-attribute">parameters</code> attribute. </p><div id="note-document" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>A <code class="tag-element">p:document</code> always <em>reads</em> from the specified IRI. In the context of a <a href="#p.input"><code class="tag-element">p:input</code></a> or <a href="#p.with-input"><code class="tag-element">p:with-input</code></a>, this seems perfectly natural. In the context of a <a href="#p.output"><code class="tag-element">p:output</code></a>, this may seem a little asymmetrical. Putting a <code class="tag-element">p:document</code> in a <a href="#p.output"><code class="tag-element">p:output</code></a> causes the pipeline to <em>read</em> from the specified IRI and provide that document <em>as an output</em> on that port. </p><p>Use <code class="tag-element">p:store</code> to store the results that appear on a <a href="#p.output"><code class="tag-element">p:output</code></a>.</p></div></div></div></section><section id="p.empty" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.12. </bdi>p:empty<a aria-label="§" class="self-link" href="#p.empty"></a></h3></div><div class="content"><p>A <code class="tag-element">p:empty</code> connects to an <em class="glossterm"><a href="#dt-empty-sequence">empty sequence</a></em> of documents.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:empty /&gt;</code></p><p>If an empty binding is used, it must be the only binding for the port. <a id="err.inline.S0089"></a>It is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0089"><code class="errqname">err:XS0089</code></a>) if the <code class="tag-element">p:empty</code> binding appears as a sibling of any other binding, including itself.</p></div></section><section id="p.documentation" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.13. </bdi>p:documentation<a aria-label="§" class="self-link" href="#p.documentation"></a></h3></div><div class="content"><p>A <code class="tag-element">p:documentation</code> contains human-readable documentation.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:documentation&gt;<br />    <var>any-well-formed-content</var>*<br />&lt;/p:documentation&gt;</code></p><p>There are no constraints on the content of the <code class="tag-element">p:documentation</code> element. Documentation is ignored by pipeline processors. See <a href="#documentation" title="Documentation">Section 14.6, “Documentation”</a>. </p></div></section><section id="p.pipeinfo" class="section"><div class="section-titlepage"><h3><bdi class="secno">16.14. </bdi>p:pipeinfo<a aria-label="§" class="self-link" href="#p.pipeinfo"></a></h3></div><div class="content"><p>A <code class="tag-element">p:pipeinfo</code> contains ancillary information for steps in the pipeline.</p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:pipeinfo&gt;<br />    <var>any-well-formed-content</var>*<br />&lt;/p:pipeinfo&gt;</code></p><p>There are no constraints on the content of the <code class="tag-element">p:pipeinfo</code> element, see <a href="#annotations" title="Processor annotations">Section 14.7, “Processor annotations”</a>.</p></div></section></div></section><section id="errors" class="section"><div class="section-titlepage"><h2><bdi class="secno">17. </bdi>Errors<a aria-label="§" class="self-link" href="#errors"></a></h2></div><div class="content"><p>Errors in a pipeline can be divided into two classes: static errors and dynamic errors.</p><section id="static-errors" class="section"><div class="section-titlepage"><h3><bdi class="secno">17.1. </bdi>Static Errors<a aria-label="§" class="self-link" href="#static-errors"></a></h3></div><div class="content"><p><span id="dt-static-error" class="termdef">[Definition: A <em class="glossterm">static error</em> is one which can be detected before pipeline evaluation is even attempted.]</span> Examples of static errors include cycles in the pipeline graph and incorrect specification of inputs and outputs. </p><p>Static errors are fatal and must be detected before any steps are evaluated.</p><p>For a complete list of static errors, see <a href="#app.static-errors" title="Static Errors">Section F.1, “Static Errors”</a>.</p></div></section><section id="dynamic-errors" class="section"><div class="section-titlepage"><h3><bdi class="secno">17.2. </bdi>Dynamic Errors<a aria-label="§" class="self-link" href="#dynamic-errors"></a></h3></div><div class="content"><p><span id="dt-dynamic-error" class="termdef">[Definition: A <em class="glossterm">dynamic error</em> is one which occurs while a pipeline is being evaluated (and cannot be detected before evaluation begins).]</span> Examples of dynamic errors include references to URIs that cannot be resolved, steps which fail, and pipelines that exhaust the capacity of an implementation (such as memory or disk space).</p><p><span style="display: none;" class="delete_version">Implementations are required to evaluate the pipeline graph according to the rules of this specification, but they may choose to optimize pipeline execution in different ways. This may cause steps to be evaluated in different orders which consequently has an impact on error detection. <span id="impl-48">The detection of dynamic errors is somewhat <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> because the order of step execution may vary.</span> In cases where an implementation is able to run a pipeline without evaluating a particular expression, or running a particular step, the implementation is never required evaluate the expression or run the step solely in order to determine whether doing so causes a dynamic error. For example, if a variable is declared but never referenced, an implementation may choose whether or not to evaluate the expression which initializes the variable, which means that if evaluating the variable’s initializer causes a dynamic error, some implementations will signal this error and others will not.</span><span style="display: none;" class="add_version">Implementations are required to evaluate the pipeline graph according to the rules of this specification, but they may choose to optimize pipeline execution in different ways. This may cause steps to be evaluated in different orders which consequently has an impact on error detection. <span id="impl-54">The detection of dynamic errors is somewhat <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> because the order of step execution may vary.</span> In cases where an implementation is able to run a pipeline without evaluating a particular expression, or running a particular step, the implementation is never required evaluate the expression or run the step solely in order to determine whether doing so causes a dynamic error. For example, if a variable is declared but never referenced, an implementation may choose whether or not to evaluate the expression which initializes the variable, which means that if evaluating the variable’s initializer causes a dynamic error, some implementations will signal this error and others will not.</span><span class="modify_version">Implementations are required to evaluate the pipeline graph according to the rules of this specification, but they may choose to optimize pipeline execution in different ways. This may cause steps to be evaluated in different orders which consequently has an impact on error detection. <span id="impl-54">The detection of dynamic errors is somewhat <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> because the order of step execution may vary.</span> In cases where an implementation is able to run a pipeline without evaluating a particular expression, or running a particular step, the implementation is never required evaluate the expression or run the step solely in order to determine whether doing so causes a dynamic error. For example, if a variable is declared but never referenced, an implementation may choose whether or not to evaluate the expression which initializes the variable, which means that if evaluating the variable’s initializer causes a dynamic error, some implementations will signal this error and others will not.</span></p><p>There are some cases where this specification requires that steps must not be executed: for example, the content of a <a href="#p.when"><code class="tag-element">p:when</code></a><span class="rfc2119" id="dynamic-errors.4.2">must not</span> be executed if the <code class="tag-attribute">test</code> condition is false. This means that an implementation <span class="rfc2119" id="dynamic-errors.4.4">must not</span> signal any dynamic errors that would arise if the contents of the <a href="#p.when"><code class="tag-element">p:when</code></a> were executed.</p><p>An implementation may signal a dynamic error before any source document is available, but only if it can determine that the error would be signaled for every possible source document and every possible set of parameter values.</p><p>If a step fails due to a dynamic error, failure propagates upwards until either a <a href="#p.try"><code class="tag-element">p:try</code></a> is encountered or the entire pipeline fails. In other words, outside of a <a href="#p.try"><code class="tag-element">p:try</code></a>, step failure causes the entire pipeline to fail.</p><p>For a complete list of dynamic errors, see <a href="#app.dynamic-errors" title="Dynamic Errors">Section F.2, “Dynamic Errors”</a>.</p></div></section><section id="step-errors" class="section"><div class="section-titlepage"><h3><bdi class="secno">17.3. </bdi>Step Errors<a aria-label="§" class="self-link" href="#step-errors"></a></h3></div><div class="content"><p>Several of the steps in the standard and option step library can generate dynamic errors.</p><p>For a complete list of the dynamic errors raised by builtin pipeline steps, see <a href="#app.step-errors" title="Step Errors">Section F.3, “Step Errors”</a>.</p></div></section></div></section><article id="conformance" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">A. </bdi>Conformance<a aria-label="§" class="self-link" href="#conformance"></a></h2></header><div class="content"><p>Conformant processors <span class="rfc2119" id="conformance.2.1">must</span> implement all of the features described in this specification except those that are explicitly identified as optional.</p><p>Some aspects of processor behavior are not completely specified; those features are either <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> or <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</p><p><span id="dt-implementation-dependent" class="termdef">[Definition: An <em class="glossterm">implementation-dependent</em> feature is one where the implementation has discretion in how it is performed. Implementations are not required to document or explain how <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> features are performed.]</span></p><p><span id="dt-implementation-defined" class="termdef">[Definition: An <em class="glossterm">implementation-defined</em> feature is one where the implementation has discretion in how it is performed. Conformant implementations <span class="rfc2119" id="dt-implementation-defined.2">must</span> document how <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> features are performed.]</span></p><section id="implementation-defined" class="section"><div class="section-titlepage"><h2><bdi class="secno">A.1. </bdi>Implementation-defined features<a aria-label="§" class="self-link" href="#implementation-defined"></a></h2></div><div class="content"><p>The following features are implementation-defined:</p><ol class="features"><li>It is implementation-defined what additional step types, if any, are provided. See <a href="#step-concept" title="Steps">Section 2.1, “Steps”</a>.</li><li>The level of support for typed values in XDM instances in an XProc pipeline is implementation-defined. See <a href="#xml-documents" title="XML Documents">Section 3.2.1, “XML Documents”</a>.</li><li>It is implementation-defined whether other media types not mentioned in this document are treated as text media types as well. See <a href="#text-documents" title="Text Documents">Section 3.2.3, “Text Documents”</a>.</li><li>Serialization of other kinds of documents is implementation-defined. See <a href="#other-documents" title="Other documents">Section 3.2.5, “Other documents”</a>.</li><li>It is implementation-defined if a processor accepts any other content type shortcuts. See <a href="#specified-content-types" title="Specifying content types">Section 3.4, “Specifying content types”</a>.</li><li>How inputs are connected to documents outside the pipeline is implementation-defined. See <a href="#input-output" title="Inputs and Outputs">Section 4, “Inputs and Outputs”</a>.</li><li>How pipeline outputs are connected to documents outside the pipeline is implementation-defined. See <a href="#input-output" title="Inputs and Outputs">Section 4, “Inputs and Outputs”</a>.</li><li>In Version <span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span> of XProc, how (or if) implementers provide local resolution mechanisms and how (or if) they provide access to intermediate results by URI is implementation-defined. See <a href="#external-docs" title="External Documents">Section 4.1, “External Documents”</a>.</li><li>Except for cases which are specifically called out in , the extent to which namespace fixup, and other checks for outputs which cannot be serialized, are performed on intermediate outputs is implementation-defined. See <a href="#namespace-fixup" title="Namespace Fixup on XML Outputs">Section 6.2, “Namespace Fixup on XML Outputs”</a>.</li><li>There may be an implementation-defined mechanism for providing default values for static p:options. If such a mechanism exists, the values provided must match the sequence type declared for the option, if such a declaration exists. See <a href="#initiating" title="Initiating a pipeline">Section 7, “Initiating a pipeline”</a>.</li><li>The exact format of the language string is implementation-defined but should be consistent with the xml:lang attribute. See <a href="#f.system-property" title="System Properties">Section 8.1, “System Properties”</a>.</li><li>It is implementation-defined which additional system properties are available during static analysis. See <a href="#f.system-property" title="System Properties">Section 8.1, “System Properties”</a>.</li><li class="add_version" style="display: none;">It is implementation-defined which kinds of URI resolvers a processor supports, if any, and how they are configured. See <a href="#f.lookup-uri" title="Lookup URI">Section 8.11, “Lookup URI”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">It is implementation-defined which kinds of URI resolvers a processor supports, if any, and how they are configured. See </span><a href="#f.lookup-uri" title="Lookup URI"><span class="deltaxml-new" style="background:#90EE90">Section 8.11, “Lookup URI”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li>It is implementation-defined if the processor supports any other XPath extension functions. See <a href="#other-xpath-extension-functions" title="Other XPath Extension Functions">Section <span class="deltaxml-old" style="background:#FF5555">8.11</span><span class="deltaxml-new" style="background:#90EE90">8.12</span>, “Other XPath Extension Functions”</a>.</li><li>The value of the any other XPath extension functions during static analysis is implementation-defined. See <a href="#other-xpath-extension-functions" title="Other XPath Extension Functions">Section <span class="deltaxml-old" style="background:#FF5555">8.11</span><span class="deltaxml-new" style="background:#90EE90">8.12</span>, “Other XPath Extension Functions”</a>.</li><li>Whether or not the pipeline processor supports passing PSVI annotations between steps is implementation-defined. See <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>.</li><li>The exact PSVI properties that are preserved when documents are passed between steps is implementation-defined. See <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>.</li><li>It is implementation-defined what PSVI properties, if any, are produced by extension steps. See <a href="#psvi-support" title="PSVIs in XProc">Section 9, “PSVIs in XProc”</a>.</li><li>Whether or not an extension attribute permits attribute value templates is implementation-defined. See <a href="#attribute-value-templates" title="Attribute Value Templates">Section 10.1, “Attribute Value Templates”</a>.</li><li class="add_version" style="display: none;">Any other text output parameters used when serializing a text value template are implementation-defined. See <a href="#text-value-templates" title="Text Value Templates">Section 10.2, “Text Value Templates”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">Any other text output parameters used when serializing a text value template are implementation-defined. See </span><a href="#text-value-templates" title="Text Value Templates"><span class="deltaxml-new" style="background:#90EE90">Section 10.2, “Text Value Templates”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li>How outside values are specified for pipeline options on the pipeline initially invoked by the processor is implementation-defined. See <a href="#options" title="Options">Section 11.2, “Options”</a>.</li><li>The extent to which an implementation validates the lexical form of the xs:anyURI is implementation-defined. See <a href="#handling-uris" title="Special rules for casting URIs">Section 11.5.2, “Special rules for casting URIs”</a>.</li><li>Support for pipeline documents written in XML 1.1 and pipeline inputs and outputs that use XML 1.1 is implementation-defined. See <a href="#syntax" title="Syntax Overview">Section 14, “Syntax Overview”</a>.</li><li>It is implementation-defined if any processing instructions are significant to an implementation. See <a href="#syntax" title="Syntax Overview">Section 14, “Syntax Overview”</a>.</li><li>The semantics of p:pipeinfo elements are implementation-defined. See <a href="#annotations" title="Processor annotations">Section 14.7, “Processor annotations”</a>.</li><li>It is implementation-defined whether a processor supports timeouts, and if it does, how precisely and precisely how the execution time of a step is measured. See <a href="#timeout" title="Controlling long running steps">Section 14.9.4, “Controlling long running steps”</a>.</li><li>Precisely what “made available” means is implementation-defined. See <a href="#messages" title="Status and debugging output">Section 14.9.5, “Status and debugging output”</a>.</li><li>The set of URI schemes actually supported is implementation-defined. See <a href="#common-errors" title="Common errors">Section 14.11, “Common errors”</a>.</li><li>The presence of other compound steps is implementation-defined; XProc provides no standard mechanism for defining them or describing what they can contain. See <a href="#p.extension" title="Extension Steps">Section 15.8.2, “Extension Steps”</a>.</li><li>The default value of any serialization parameters not specified on a particular output is implementation-defined. See <a href="#serialization" title="Serialization parameters">Section 16.3.1, “Serialization parameters”</a>.</li><li>Implementations may support other method values but their results are implementation-defined. See <a href="#serialization-method" title="Serialization method">Section 16.3.1.1, “Serialization method”</a>.</li><li>The serialization method for documents with other media types is implementation-defined. See <a href="#serialization-method" title="Serialization method">Section 16.3.1.1, “Serialization method”</a>.</li><li>The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is implementation-defined. See <a href="#p.variable" title="p:variable">Section 16.4.1, “p:variable”</a>.</li><li>The precise details about what XPath expressions are allowed (for example, can the expression declare a function) is implementation-defined. See <a href="#p.option" title="p:option">Section 16.4.2, “p:option”</a>.</li><li>When a declared step is evaluated directly by the XProc processor (as opposed to occurring as an atomic step in some container), how the input and output ports are connected to documents is implementation-defined. See <a href="#p.declare-step" title="p:declare-step">Section 16.5, “p:declare-step”</a>.</li><li class="add_version" style="display: none;">If a pipeline does not request a specific XPath version, the version used is implementation-defined. See <a href="#declare-pipelines" title="Declaring pipelines">Section 16.5.1, “Declaring pipelines”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">If a pipeline does not request a specific XPath version, the version used is implementation-defined. See </span><a href="#declare-pipelines" title="Declaring pipelines"><span class="deltaxml-new" style="background:#90EE90">Section 16.5.1, “Declaring pipelines”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li class="add_version" style="display: none;">If different pipelines or libraries declare different XPath versions, it is implementation-defined how those conflicts are resolved. See <a href="#declare-pipelines" title="Declaring pipelines">Section 16.5.1, “Declaring pipelines”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">If different pipelines or libraries declare different XPath versions, it is implementation-defined how those conflicts are resolved. See </span><a href="#declare-pipelines" title="Declaring pipelines"><span class="deltaxml-new" style="background:#90EE90">Section 16.5.1, “Declaring pipelines”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li class="add_version" style="display: none;">If an implementation elects to use the same version for all pipelines, the version selected is implementation-defined. See <a href="#declare-pipelines" title="Declaring pipelines">Section 16.5.1, “Declaring pipelines”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">If an implementation elects to use the same version for all pipelines, the version selected is implementation-defined. See </span><a href="#declare-pipelines" title="Declaring pipelines"><span class="deltaxml-new" style="background:#90EE90">Section 16.5.1, “Declaring pipelines”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li>If no type is specified, the way that the processor determines the type of the library is implementation-defined. See <a href="#p.import-functions" title="p:import-functions">Section 16.8, “p:import-functions”</a>.</li><li>Whether or not a processor can import functions, and if it can, what kinds of function libraries it can import from is implementation-defined. See <a href="#p.import-functions" title="p:import-functions">Section 16.8, “p:import-functions”</a>.</li><li>An implementation may support encodings other than base64, but these encodings and their names are implementation-defined. See <a href="#p.inline" title="p:inline">Section 16.10, “p:inline”</a>.</li><li>How a processor interprets other media types is implementation-defined. See <a href="#inline-others" title="Other inline content">Section 16.10.4, “Other inline content”</a>.</li><li>It is implementation-defined whether additional information items and properties, particularly those made available in the PSVI, are preserved between steps. See <a href="#infoset-conformance" title="Infoset Conformance">Section A.3, “Infoset Conformance”</a>.</li><li>The version of Unicode supported is implementation-defined, but it is recommended that the most recent version of Unicode be used. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The context item used for binary documents is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The point in time returned as the current dateTime is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The implicit timezone is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The default language is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The default calendar is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The default place is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The list of available environment variables is implementation-defined. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The implicit timezone is implementation-defined. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The default language is implementation-defined. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The default calendar is implementation-defined. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The default place is implementation-defined. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The list of available environment variables is implementation-defined. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li></ol></div></section><section id="implementation-dependent" class="section"><div class="section-titlepage"><h2><bdi class="secno">A.2. </bdi>Implementation-dependent features<a aria-label="§" class="self-link" href="#implementation-dependent"></a></h2></div><div class="content"><p>The following features are implementation-dependent:</p><ol class="features"><li>The evaluation order of steps not connected to one another is implementation-dependent. See <a href="#pipeline-concepts" title="Pipeline Concepts">Section 2, “Pipeline Concepts”</a>.</li><li>The underlying representations of other kinds of documents are implementation-dependent. See <a href="#other-documents" title="Other documents">Section 3.2.5, “Other documents”</a>.</li><li>Outside of a try/catch, the disposition of error messages is implementation-dependent See <a href="#input-output" title="Inputs and Outputs">Section 4, “Inputs and Outputs”</a>.</li><li>Resolving a URI locally may involve resolvers of various sorts and possibly appeal to implementation-dependent mechanisms such as catalog files. See <a href="#external-docs" title="External Documents">Section 4.1, “External Documents”</a>.</li><li>Whether (and when and how) or not the intermediate results that pass between steps are ever written to a filesystem is implementation-dependent. See <a href="#external-docs" title="External Documents">Section 4.1, “External Documents”</a>.</li><li>Which steps are forbidden, what privileges are needed to access resources, and under what circumstances these security constraints apply is implementation-dependent. See <a href="#security-considerations" title="Security Considerations">Section 12, “Security Considerations”</a>.</li><li class="add_version" style="display: none;">It is implementation-dependent if a processor validates xml:id attribute values. See <a href="#xml-id-attribute" title="Unique identifiers">Section 14.4, “Unique identifiers”</a>.</li><li class="modify_version"><span class="deltaxml-new" style="background:#90EE90">It is implementation-dependent if a processor validates xml:id attribute values. See </span><a href="#xml-id-attribute" title="Unique identifiers"><span class="deltaxml-new" style="background:#90EE90">Section 14.4, “Unique identifiers”</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></li><li>The error codes that appear in cause are implementation-dependent. See <a href="#cv.error" title="c:error">Section 15.7.3.2, “c:error”</a>.</li><li>It is implementation-dependent whether or not atomic steps can be defined through some other means. See <a href="#p.atomic" title="Atomic Steps">Section 15.8, “Atomic Steps”</a>.</li><li>Whether or not an implementation allows users to provide their own external steps is implementation-dependent. See <a href="#p.declare-step" title="p:declare-step">Section 16.5, “p:declare-step”</a>.</li><li>Implementations may use extension attributes to provide implementation-dependent information about a declared step. See <a href="#declare-atomic-steps" title="Declaring external steps">Section 16.5.2, “Declaring external steps”</a>.</li><li>The detection of dynamic errors is somewhat implementation-dependent because the order of step execution may vary. See <a href="#dynamic-errors" title="Dynamic Errors">Section 17.2, “Dynamic Errors”</a>.</li><li>The set of available documents (those that may be retrieved with a URI) is implementation-dependent. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The set of available text resources (those that may be retrieved with a URI) is implementation-dependent. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The set of available collections is implementation-dependent. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The set of available URI collections is implementation-dependent. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The default URI collection is implementation-dependent. See <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>.</li><li>The set of available documents (those that may be retrieved with a URI) is implementation-dependent. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The set of available text resources (those that may be retrieved with a URI) is implementation-dependent. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The set of available URI collections is implementation-dependent. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li><li>The default URI collection is implementation-dependent. See <a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>.</li></ol></div></section><section id="infoset-conformance" class="section"><div class="section-titlepage"><h2><bdi class="secno">A.3. </bdi>Infoset Conformance<a aria-label="§" class="self-link" href="#infoset-conformance"></a></h2></div><div class="content"><p>This specification conforms to the XML Information Set [<a href="#xml-infoset-rec"><span class="abbrev">Infoset</span></a>]. The information corresponding to the following information items and properties must be available to the processor for the documents that flow through the pipeline.</p><div class="itemizedlist"><ul><li><p>The <code class="literal info-item">Document Information Item</code> with <code class="literal infoset-property">[base URI]</code> and <code class="literal infoset-property">[children]</code> properties.</p></li><li><p><code class="literal info-item">Element Information Items</code> with <code class="literal infoset-property">[base URI]</code>, <code class="literal infoset-property">[children]</code>, <code class="literal infoset-property">[attributes]</code>, <code class="literal infoset-property">[in-scope namespaces]</code>, <code class="literal infoset-property">[prefix]</code>, <code class="literal infoset-property">[local name]</code>, <code class="literal infoset-property">[namespace name]</code>, <code class="literal infoset-property">[parent]</code> properties.</p></li><li><p><code class="literal info-item">Attribute Information Items</code> with <code class="literal infoset-property">[namespace name]</code>, <code class="literal infoset-property">[prefix]</code>, <code class="literal infoset-property">[local name]</code>, <code class="literal infoset-property">[normalized value]</code>, <code class="literal infoset-property">[attribute type]</code>, and <code class="literal infoset-property">[owner element]</code> properties.</p></li><li><p><code class="literal info-item">Character Information Items</code> with <code class="literal infoset-property">[character code]</code>, <code class="literal infoset-property">[parent]</code>, and, optionally, <code class="literal infoset-property">[element content whitespace]</code> properties.</p></li><li><p><code class="literal info-item">Processing Instruction Information Items</code> with <code class="literal infoset-property">[base URI]</code>, <code class="literal infoset-property">[target]</code>, <code class="literal infoset-property">[content]</code> and <code class="literal infoset-property">[parent]</code> properties.</p></li><li><p><code class="literal info-item">Comment Information Items</code> with <code class="literal infoset-property">[content]</code> and <code class="literal infoset-property">[parent]</code> properties.</p></li><li><p><code class="literal info-item">Namespace Information Items</code> with <code class="literal infoset-property">[prefix]</code> and <code class="literal infoset-property">[namespace name]</code> properties.</p></li></ul></div><p><span style="display: none;" class="delete_version"><span id="impl-49">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether additional information items and properties, particularly those made available in the PSVI, are preserved between steps.</span></span><span style="display: none;" class="add_version"><span id="impl-55">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether additional information items and properties, particularly those made available in the PSVI, are preserved between steps.</span></span><span class="modify_version"><span id="impl-55">It is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> whether additional information items and properties, particularly those made available in the PSVI, are preserved between steps.</span></span></p></div></section></div></article><article id="xproc-and-step-xpath-context" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">B. </bdi>XPath contexts in XProc<a aria-label="§" class="self-link" href="#xproc-and-step-xpath-context"></a></h2></header><div class="content"><p>Two kinds of XPath context are relevant in XProc: the context of the pipeline itself (<a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>) and the context <em>within</em> steps (<a href="#step-xpath-context-31" title="Step XPath Context">Section B.2, “Step XPath Context”</a>). </p><section id="xproc-xpath-context-31" class="section"><div class="section-titlepage"><h2><bdi class="secno">B.1. </bdi>Processor XPath Context<a aria-label="§" class="self-link" href="#xproc-xpath-context-31"></a></h2></div><div class="content"><p>When the XProc processor evaluates an XPath expression using XPath, unless otherwise indicated by a particular step, it does so with the following static context:</p><div class="variablelist"><dl><dt><span class="term">XPath 1.0 compatibility mode</span></dt><dd><p>False</p></dd><dt><span class="term">Statically known namespaces</span></dt><dd><p>The namespace declarations in-scope for the containing element. </p></dd><dt><span class="term">Default element/type namespace</span></dt><dd><p>The null namespace.</p></dd><dt><span class="term">Default function namespace</span></dt><dd><p>The default function namespace is <code class="literal">http://www.w3.org/2005/xpath-functions</code>, as defined in [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>]. Function names that do not contain a colon always refer to the default function namespace, any in-scope binding for the default namespace <em>does not</em> apply. This specification does not provide a mechanism to override the default function namespace.</p></dd><dt><span class="term">In-scope schema definitions</span></dt><dd><p>A basic XPath 3.1 XProc processor includes the following named type definitions in its in-scope schema definitions:</p><div class="itemizedlist"><ul><li><p>All the primitive atomic types defined in [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>], with the exception of <code class="literal">xs:NOTATION</code>. That is: <code class="literal">xs:anyAtomicType</code>, <code class="literal">xs:anySimpleType</code>, <code class="literal">xs:anyURI</code>, <code class="literal">xs:base64Binary</code>, <code class="literal">xs:boolean</code>, <code class="literal">xs:date</code>, <code class="literal">xs:dateTime</code>, <code class="literal">xs:decimal</code>, <code class="literal">xs:double</code>, <code class="literal">xs:duration</code>, <code class="literal">xs:float</code>, <code class="literal">xs:gDay</code>, <code class="literal">xs:gMonth</code>, <code class="literal">xs:gMonthDay</code>, <code class="literal">xs:gYear</code>, <code class="literal">xs:gYearMonth</code>, <code class="literal">xs:hexBinary</code>, <code class="literal">xs:QName</code>, <code class="literal">xs:string</code>, and <code class="literal">xs:time</code>. </p></li><li><p>The derived atomic type <code class="literal">xs:integer</code> defined in [<a href="#xmlschema-2"><span class="abbrev">W3C XML Schema: Part 2</span></a>]. </p></li><li><p>The types <code class="literal">xs:anyType</code>, <code class="literal">xs:yearMonthDuration</code>, <code class="literal">xs:dayTimeDuration</code>, <code class="literal">xs:untyped</code>, and <code class="literal">xs:untypedAtomic</code> defined in [<a href="#xpath-datamodel"><span class="abbrev">XQuery and XPath Data Model 3.1</span></a>]. </p></li></ul></div></dd><dt><span class="term">In-scope variables</span></dt><dd><p>Variables and options are lexically scoped. The union of the options and the variables that are “visible” from the step’s lexical position are available as variable bindings to the XPath processor. Variables and options can shadow each other, only the lexically most recent bindings are visible.</p></dd><dt><span class="term">Context item static type</span></dt><dd><p>Document.</p></dd><dt><span class="term">Function signatures</span></dt><dd><p><span style="display: none;" class="delete_version">The signatures of the [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>] in namespaces <code class="literal">http://www.w3.org/2005/xpath-functions</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/math</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/map</code> and <code class="literal">http://www.w3.org/2005/xpath-functions/array</code>. Additionally the function signatures defined in <a href="#xpath-extension-functions" title="XPath Extension Functions">Section 8, “XPath Extension Functions”</a>. </span><span style="display: none;" class="add_version">The signatures of the [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>] in namespaces <code class="literal">http://www.w3.org/2005/xpath-functions</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/math</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/map</code> and <code class="literal">http://www.w3.org/2005/xpath-functions/array</code>. Additionally the function signatures defined in <a href="#xpath-extension-functions" title="XPath Extension Functions">Section 8, “XPath Extension Functions”</a>. If a pipeline loads external functions with <a href="#p.import-functions"><code class="tag-element">p:import-functions</code></a> those are available within their scope.</span><span class="modify_version">The signatures of the [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>] in namespaces <code class="literal">http://www.w3.org/2005/xpath-functions</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/math</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/map</code> and <code class="literal">http://www.w3.org/2005/xpath-functions/array</code>. Additionally the function signatures defined in <a href="#xpath-extension-functions" title="XPath Extension Functions">Section 8, “XPath Extension Functions”</a>. <span class="deltaxml-new" style="background:#90EE90">If a pipeline loads external functions with </span><a href="#p.import-functions"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import-functions</span></code></a><span class="deltaxml-new" style="background:#90EE90"> those are available within their scope.</span></span></p></dd><dt><span class="term">Statically known collations</span></dt><dd><p><span style="display: none;" class="delete_version">Implementation-defined but <span class="rfc2119" id="xproc-xpath-context-31.3.9.2.1.1">must</span> include the Unicode code point collation. <span id="impl-50">The version of Unicode supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>, but it is recommended that the most recent version of Unicode be used.</span></span><span style="display: none;" class="add_version">Implementation-defined but <span class="rfc2119" id="xproc-xpath-context-31.3.9.2.1.1">must</span> include the Unicode code point collation. <span id="impl-56">The version of Unicode supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>, but it is recommended that the most recent version of Unicode be used.</span></span><span class="modify_version">Implementation-defined but <span class="rfc2119" id="xproc-xpath-context-31.3.9.2.1.1">must</span> include the Unicode code point collation. <span id="impl-56">The version of Unicode supported is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>, but it is recommended that the most recent version of Unicode be used.</span></span></p></dd><dt><span class="term">Default collation</span></dt><dd><p>Unicode code point collation.</p></dd><dt><span class="term">Static base URI</span></dt><dd><p>The base URI of the element on which the expression occurs.</p></dd><dt><span class="term">Statically known documents</span></dt><dd><p>None.</p></dd><dt><span class="term">Statically known collections</span></dt><dd><p>None.</p></dd><dt><span class="term">Statically known default collection type</span></dt><dd><p><code class="literal">item()*</code></p></dd><dt><span class="term">Statically known decimal formats</span></dt><dd><p>None.</p></dd></dl></div><p>And the following dynamic context:</p><div class="variablelist"><dl><dt><span class="term">context item</span></dt><dd><p>The context item. The context item is either specified with a <em class="glossterm"><a href="#dt-connection">connection</a></em> or is taken from the <em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em>. If the explicit connection or the default readable port provides no or more than one document then the context item is undefined. <a id="err.inline.D0001.6"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) if the XPath expression makes use of the context item, but the context item is undefined. </p><p><span style="display: none;" class="delete_version">The context item used for an XML, text, or JSON document is the XDM representation of that item. <span id="impl-51">The context item used for binary documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version">The context item used for an XML, text, or JSON document is the XDM representation of that item. <span id="impl-57">The context item used for binary documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version">The context item used for an XML, text, or JSON document is the XDM representation of that item. <span id="impl-57">The context item used for binary documents is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p><p>If there is no explicit connection and there is no default readable port then the context item is undefined.</p></dd><dt><span class="term">context position and context size</span></dt><dd><p>If the context item is defined, the context position and context size are both “1”. <a id="err.inline.D0001.7"></a>It is a <em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em> (<a href="#err.D0001"><code class="errqname">err:XD0001</code></a>) to refer to the context position or size if the context item is undefined.</p></dd><dt><span class="term">Variable values</span></dt><dd><p>The union of the in-scope options and variables are available as variable bindings to the XPath processor. </p></dd><dt><span class="term">Named functions</span></dt><dd><p>The [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>] and the <a href="#xpath-extension-functions" title="XPath Extension Functions">Section 8, “XPath Extension Functions”</a>. </p></dd><dt><span class="term">Current dateTime</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-52">The point in time returned as the current dateTime is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-58">The point in time returned as the current dateTime is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-58">The point in time returned as the current dateTime is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Implicit timezone</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-53">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-59">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-59">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default language</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-54">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-60">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-60">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default calendar</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-55">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-61">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-61">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default place</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-56">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-62">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-62">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Available documents</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-57">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-63">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-63">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Available text resources</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-58">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-64">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-64">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Available collections</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-59">The set of available collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-65">The set of available collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-65">The set of available collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Default collection</span></dt><dd><p>None. </p></dd><dt><span class="term">Available URI collections</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-60">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-66">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-66">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Default URI collection</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-61">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-67">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-67">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Environment variables</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-62">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-68">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-68">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd></dl></div></div></section><section id="step-xpath-context-31" class="section"><div class="section-titlepage"><h2><bdi class="secno">B.2. </bdi>Step XPath Context<a aria-label="§" class="self-link" href="#step-xpath-context-31"></a></h2></div><div class="content"><p>When a step evaluates an XPath expression using XPath 3.1, unless otherwise indicated by a particular step, it does so with the following static context:</p><div class="variablelist"><dl><dt><span class="term">XPath 1.0 compatibility mode</span></dt><dd><p>False</p></dd><dt><span class="term">Statically known namespaces</span></dt><dd><p>The namespace declarations in-scope for the containing element.</p></dd><dt><span class="term">Default element/type namespace</span></dt><dd><p>The null namespace.</p></dd><dt><span class="term">Default function namespace</span></dt><dd><p>The default function namespace is <code class="literal">http://www.w3.org/2005/xpath-functions</code>, as defined in [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>]. Function names that do not contain a colon always refer to the default function namespace, any in-scope binding for the default namespace <em>does not</em> apply. This specification does not provide a mechanism to override the default function namespace.</p></dd><dt><span class="term">In-scope schema definitions</span></dt><dd><p>The same as the <a href="#xproc-xpath-context-31" title="Processor XPath Context">Section B.1, “Processor XPath Context”</a>. </p></dd><dt><span class="term">In-scope variables</span></dt><dd><p>None, unless otherwise specified by the step. </p></dd><dt><span class="term">Context item static type</span></dt><dd><p>Document.</p></dd><dt><span class="term">Function signatures</span></dt><dd><p>The signatures of the [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>] in namespaces <code class="literal">http://www.w3.org/2005/xpath-functions</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/math</code>, <code class="literal">http://www.w3.org/2005/xpath-functions/map</code> and <code class="literal">http://www.w3.org/2005/xpath-functions/array</code>. </p></dd><dt><span class="term">Statically known collations</span></dt><dd><p>Implementation-defined but <span class="rfc2119" id="step-xpath-context-31.3.9.2.1.1">must</span> include the Unicode code point collation.</p></dd><dt><span class="term">Default collation</span></dt><dd><p>Unicode code point collation.</p></dd><dt><span class="term">Static base URI</span></dt><dd><p>The base URI of the element on which the expression occurs.</p></dd><dt><span class="term">Statically known documents</span></dt><dd><p>None.</p></dd><dt><span class="term">Statically known collections</span></dt><dd><p>None.</p></dd><dt><span class="term">Statically known default collection type</span></dt><dd><p>item()*</p></dd><dt><span class="term">Statically known decimal formats</span></dt><dd><p>None.</p></dd></dl></div><p>And the following initial dynamic context:</p><div class="variablelist"><dl><dt><span class="term">context item</span></dt><dd><p>The document node of the document that appears on the primary input of the step, unless otherwise specified by the step.</p></dd><dt><span class="term">context position and context size</span></dt><dd><p>The context position and context size are both “1”, unless otherwise specified by the step. </p></dd><dt><span class="term">Variable values</span></dt><dd><p>None, unless otherwise specified by the step. </p></dd><dt><span class="term">Named functions</span></dt><dd><p>The [<a href="#xpath31-functions"><span class="abbrev">XPath and XQuery Functions and Operators 3.1</span></a>].</p></dd><dt><span class="term">Current dateTime</span></dt><dd><p>An implementation-defined point in time. </p></dd><dt><span class="term">Implicit timezone</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-63">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-69">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-69">The implicit timezone is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default language</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-64">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-70">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-70">The default language is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default calendar</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-65">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-71">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-71">The default calendar is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Default place</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-66">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-72">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-72">The default place is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd><dt><span class="term">Available documents</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-67">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-73">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-73">The set of available documents (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Available text resources</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-68">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-74">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-74">The set of available text resources (those that may be retrieved with a URI) is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Available collections</span></dt><dd><p>None. </p></dd><dt><span class="term">Default collection</span></dt><dd><p>None. </p></dd><dt><span class="term">Available URI collections</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-69">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-75">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-75">The set of available URI collections is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Default URI collection</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-70">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-76">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span><span class="modify_version"><span id="impl-76">The default URI collection is <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em>.</span></span></p></dd><dt><span class="term">Environment variables</span></dt><dd><p><span style="display: none;" class="delete_version"><span id="impl-71">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span style="display: none;" class="add_version"><span id="impl-77">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span><span class="modify_version"><span id="impl-77">The list of available environment variables is <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em>.</span></span></p></dd></dl></div><div id="note-amendments" class="note admonition"><h3>Note</h3><div class="admonition-body"><p>Some steps may also provide for implementation-defined or implementation-dependent amendments to the contexts. Those amendments are in addition to any specified by XProc.</p></div></div></div></section></div></article><article id="references" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">C. </bdi>References<a aria-label="§" class="self-link" href="#references"></a></h2></header><div class="content"><section id="normative-references" class="section"><div class="section-titlepage"><h2><bdi class="secno">C.1. </bdi>Normative References<a aria-label="§" class="self-link" href="#normative-references"></a></h2></div><div class="content"><div id="normative-references.2" class="bibliolist"><div id="steps30" class="bibliomixed"><p><span class="deltaxml-old" style="background:#FF5555">[</span><span class="abbrev"><span class="deltaxml-old" style="background:#FF5555">Steps 3.0</span></span><span class="deltaxml-old" style="background:#FF5555">] </span><a href="https://spec.xproc.org/3.0/steps/"><span class="citetitle"><cite><span class="deltaxml-old" style="background:#FF5555">XProc 3.0: Standard Step Library</span></cite></span></a><span class="deltaxml-old" style="background:#FF5555">. Norman Walsh, Achim Berndzen, Gerrit Imsieke and Erik Siegel, editors. </span></p></div><div id="steps31" class="bibliomixed"><p><span class="deltaxml-new" style="background:#90EE90">[</span><span class="abbrev"><span class="deltaxml-new" style="background:#90EE90">Steps 3.1</span></span><span class="deltaxml-new" style="background:#90EE90">] </span><a href="https://spec.xproc.org/3.1/steps/"><span class="citetitle"><cite><span class="deltaxml-new" style="background:#90EE90">XProc 3.1: Standard Step Library</span></cite></span></a><span class="deltaxml-new" style="background:#90EE90">. Norman Walsh, Achim Berndzen, Gerrit Imsieke and Erik Siegel, editors. </span></p></div><div id="xml-infoset-rec" class="bibliomixed"><p>[<span class="abbrev">Infoset</span>] <a href="https://www.w3.org/TR/xml-infoset/"><span class="citetitle"><cite>XML Information Set (Second Edition)</cite></span></a>. John Cowan, Richard Tobin, editors. W3C Working Group Note 04 February 2004. </p></div><div id="xml10" class="bibliomixed"><p>[<span class="abbrev">XML 1.0</span>] <a href="https://www.w3.org/TR/REC-xml/"><span class="citetitle"><cite>Extensible Markup Language (XML) 1.0 (Fifth Edition)</cite></span></a>. Tim Bray, Jean Paoli, C. M. Sperberg-McQueen, et. al. editors. W3C Recommendation 26 November 2008.</p></div><div id="xmlns10" class="bibliomixed"><p>[<span class="abbrev">Namespaces 1.0</span>] <a href="https://www.w3.org/TR/REC-xml-names/"><span class="citetitle"><cite>Namespaces in XML 1.0 (Third Edition)</cite></span></a>. Tim Bray, Dave Hollander, Andrew Layman, et. al., editors. W3C Recommendation 8 December 2009.</p></div><div id="xml11" class="bibliomixed"><p>[<span class="abbrev">XML 1.1</span>] <a href="https://www.w3.org/TR/xml11/"><span class="citetitle"><cite>Extensible Markup Language (XML) 1.1 (Second Edition)</cite></span></a>. Tim Bray, Jean Paoli, C. M. Sperberg-McQueen, et. al. editors. W3C Recommendation 16 August 2006.</p></div><div id="xmlns11" class="bibliomixed"><p>[<span class="abbrev">Namespaces 1.1</span>] <a href="https://www.w3.org/TR/xml-names11/"><span class="citetitle"><cite>Namespaces in XML 1.1 (Second Edition)</cite></span></a>. Tim Bray, Dave Hollander, Andrew Layman, et. al., editors. W3C Recommendation 16 August 2006.</p></div><div id="xpath31" class="bibliomixed"><p>[<span class="abbrev">XPath 3.1</span>] <a href="https://www.w3.org/TR/xpath31/"><span class="citetitle"><cite>XML Path Language (XPath) 3.1</cite></span></a>. Jonathan Robie, Michael Dyck, Josh Spiegel, editors. W3C Recommendation. 21 March 2017.</p></div><div id="xpath-datamodel" class="bibliomixed"><p>[<span class="abbrev">XQuery and XPath Data Model 3.1</span>] <a href="https://www.w3.org/TR/xpath-datamodel-31/"><span class="citetitle"><cite>XQuery and XPath Data Model 3.1</cite></span></a>. Norman Walsh, John Snelson, and Andrew Coleman, editors. W3C Recommendation. 21 March 2017.</p></div><div id="xml-serialization-31" class="bibliomixed"><p>[<span class="abbrev">Serialization</span>] <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/"><span class="citetitle"><cite>XSLT and XQuery Serialization 3.1</cite></span></a>. Andrew Coleman and C. M. Sperberg-McQueen, editors. W3C Recommendation. 21 March 2017.</p></div><div id="xpath31-functions" class="bibliomixed"><p>[<span class="abbrev">XPath and XQuery Functions and Operators 3.1</span>] <a href="https://www.w3.org/TR/xpath-functions-31/"><span class="citetitle"><cite>XPath and XQuery Functions and Operators 3.1</cite></span></a>. Michael Kay, editor. W3C Recommendation. 21 March 2017</p></div><div id="xslt30" class="bibliomixed"><p>[<span class="abbrev">XSLT 3.0</span>] <a href="https://www.w3.org/TR/xslt-30/"><span class="citetitle"><cite>XSL Transformations (XSLT) Version 3.0</cite></span></a>. Michael Kay, editor. W3C Recommendation. 8 June 2017.</p></div><div id="xquery10" class="bibliomixed"><p>[<span class="abbrev">XQuery 1.0</span>] <a href="https://www.w3.org/TR/xquery/"><span class="citetitle"><cite>XQuery 1.0: An XML Query Language</cite></span></a>. Scott Boag, Don Chamberlin, Mary Fernández, et. al., editors. W3C Recommendation. 23 January 2007.</p></div><div id="xmlschema-1" class="bibliomixed"><p>[<span class="abbrev">W3C XML Schema: Part 1</span>] <a href="https://www.w3.org/TR/xmlschema-1/"><span class="citetitle"><cite>XML Schema Part 1: Structures Second Edition</cite></span></a>. Henry S. Thompson, David Beech, Murray Maloney, et. al., editors. World Wide Web Consortium, 28 October 2004. </p></div><div id="xmlschema-2" class="bibliomixed"><p>[<span class="abbrev">W3C XML Schema: Part 2</span>] <a href="https://www.w3.org/TR/xmlschema-2/"><span class="citetitle"><cite>XML Schema Part 2: Datatypes Second Edition</cite></span></a>. Paul V. Biron and Ashok Malhotra, editors. World Wide Web Consortium, 28 October 2004. </p></div><div id="xml-id" class="bibliomixed"><p>[<span class="abbrev">xml:id</span>] <a href="https://www.w3.org/TR/xml-id/"><span class="citetitle"><cite>xml:id Version 1.0</cite></span></a>. Jonathan Marsh, Daniel Veillard, and Norman Walsh, editors. W3C Recommendation. 9 September 2005.</p></div><div id="xml-base" class="bibliomixed"><p>[<span class="abbrev">XML Base</span>] <a href="https://www.w3.org/TR/xmlbase/"><span class="citetitle"><cite>XML Base (Second Edition)</cite></span></a>. Jonathan Marsh and Richard Tobin, editors. W3C Recommendation. 28 January 2009.</p></div><div id="rfc2119" class="bibliomixed"><p>[<span class="abbrev">RFC 2119</span>] <a href="https://doi.org/10.17487/RFC2119"><span class="citetitle"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></span></a>. S. Bradner. Network Working Group, IETF, Mar 1997. </p></div><div id="rfc2396" class="bibliomixed"><p>[<span class="abbrev">RFC 2396</span>] <a href="https://doi.org/10.17487/RFC2396"><span class="citetitle"><cite>Uniform Resource Identifiers (URI): Generic Syntax</cite></span></a>. T. Berners-Lee, R. Fielding, and L. Masinter. Network Working Group, IETF, Aug 1998. </p></div><div id="rfc3023" class="bibliomixed"><p>[<span class="abbrev">RFC 3023</span>] <a href="https://doi.org/10.17487/RFC3023"><span class="citetitle"><cite>RFC 3023: XML Media Types</cite></span></a>. M. Murata, S. St. Laurent, and D. Kohn, editors. Internet Engineering Task Force. January, 2001.</p></div><div id="rfc2046" class="bibliomixed"><p>[<span class="abbrev">RFC 2046</span>] <a href="https://doi.org/10.17487/RFC2046"><span class="citetitle"><cite>RFC 2046: Multipurpose Internet Mail Extensions (MIME) Part Two: Media Types</cite></span></a>. N. Freed, N. Borenstein, editors. Internet Engineering Task Force. November, 1996.</p></div><div id="rfc3986" class="bibliomixed"><p>[<span class="abbrev">RFC 3986</span>] <a href="https://doi.org/10.17487/RFC3986"><span class="citetitle"><cite>RFC 3986: Uniform Resource Identifier (URI): General Syntax</cite></span></a>. T. Berners-Lee, R. Fielding, and L. Masinter, editors. Internet Engineering Task Force. January, 2005.</p></div></div></div></section></div></article><article id="glossary" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">D. </bdi>Glossary<a aria-label="§" class="self-link" href="#glossary"></a></h2></header><div class="content"><div class="glosslist"><dl><dt id="glossary.2.1" class="glossentry"><em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em></dt><dd class="glossdef"><p>The “<code class="literal">text/html</code>” and “<code class="literal">application/xhtml+xml</code>” media types are <em class="firstterm">HTML media types</em>. </p></dd><dt id="glossary.2.2" class="glossentry"><em class="glossterm"><a href="#dt-JSON-media-type">JSON media type</a></em></dt><dd class="glossdef"><p>The “<code class="literal">application/json</code>” media type and all media types of the form “<code class="literal">application/<em class="replaceable"><code>something</code></em>+json</code>” are <em class="firstterm">JSON media types</em>. </p></dd><dt id="glossary.2.3" class="glossentry"><em class="glossterm"><a href="#dt-Namespaces-in-XML">Namespaces in XML</a></em></dt><dd class="glossdef"><p>Unless otherwise noted, the term <em class="firstterm">Namespaces in XML</em> refers equally to [<a href="#xmlns10"><span class="abbrev">Namespaces 1.0</span></a>] and [<a href="#xmlns11"><span class="abbrev">Namespaces 1.1</span></a>].</p></dd><dt id="glossary.2.4" class="glossentry"><em class="glossterm"><a href="#dt-XML">XML</a></em></dt><dd class="glossdef"><p>XProc is intended to work equally well with [<a href="#xml10"><span class="abbrev">XML 1.0</span></a>] and [<a href="#xml11"><span class="abbrev">XML 1.1</span></a>]. Unless otherwise noted, the term “<em class="firstterm">XML</em>” refers equally to both versions.</p></dd><dt id="glossary.2.5" class="glossentry"><em class="glossterm"><a href="#dt-XML-media-type">XML media type</a></em></dt><dd class="glossdef"><p>The “<code class="literal">application/xml</code>” and “<code class="literal">text/xml</code>” media types and all media types of the form “<code class="literal"><em class="replaceable"><code>something</code></em>/<em class="replaceable"><code>something</code></em>+xml</code>” (except for “<code class="literal">application/xhtml+xml</code>” which is explicitly an <em class="glossterm"><a href="#dt-HTML-media-type">HTML media type</a></em>) are <em class="firstterm">XML media types</em>. </p></dd><dt id="glossary.2.6" class="glossentry"><em class="glossterm"><a href="#dt-ancestors">ancestors</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">ancestors</em> of a step, if it has any, are its <em class="glossterm"><a href="#dt-container">container</a></em> and the ancestors of its container.</p></dd><dt id="glossary.2.7" class="glossentry"><em class="glossterm"><a href="#dt-anonymous-input">anonymous input</a></em></dt><dd class="glossdef"><p>The <em class="glossterm"><a href="#dt-compound-step">compound steps</a></em><a href="#p.for-each"><code class="tag-element">p:for-each</code></a> and <a href="#p.viewport"><code class="tag-element">p:viewport</code></a> each declare a single primary input without a port name. Such an input is called an <em class="firstterm">anonymous input</em>.</p></dd><dt id="glossary.2.8" class="glossentry"><em class="glossterm"><a href="#dt-atomic-step">atomic step</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">atomic step</em> is a step that does not contain a subpipline when it is invoked.</p></dd><dt id="glossary.2.9" class="glossentry"><em class="glossterm"><a href="#dt-attribute-value-template">attribute value template</a></em></dt><dd class="glossdef"><p>In an attribute that is designated as an <em class="firstterm">attribute value template</em>, an expression can be used by surrounding the expression with curly brackets (<code class="code">{}</code>), following the general rules for <em class="glossterm"><a href="#dt-value-template">value templates</a></em></p></dd><dt id="glossary.2.10" class="glossentry"><em class="glossterm"><a href="#dt-bag-merger">bag-merger</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">bag-merger</em> of two or more bags (where a bag is an unordered list or, equivalently, something like a set except that it may contain duplicates) is a bag constructed by starting with an empty bag and adding each member of each of the input bags in turn to it. It follows that the cardinality of the result is the sum of the cardinality of all the input bags.</p></dd><dt id="glossary.2.11" class="glossentry"><em class="glossterm"><a href="#dt-by-source">by source</a></em></dt><dd class="glossdef"><p>A document is specified <em class="firstterm">by source</em> if it references a specific port on another step.</p></dd><dt id="glossary.2.12" class="glossentry"><em class="glossterm"><a href="#dt-by-URI">by URI</a></em></dt><dd class="glossdef"><p>A document is specified <em class="firstterm">by URI</em> if it is referenced with a URI.</p></dd><dt id="glossary.2.13" class="glossentry"><em class="glossterm"><a href="#dt-compound-step">compound step</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">compound step</em> is a step that contains one or more <em class="glossterm"><a href="#dt-subpipeline">subpipelines</a></em>.</p></dd><dt id="glossary.2.14" class="glossentry"><em class="glossterm"><a href="#dt-connection">connection</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">connection</em> associates an input or output port with some data source.</p></dd><dt id="glossary.2.15" class="glossentry"><em class="glossterm"><a href="#dt-contained-steps">contained steps</a></em></dt><dd class="glossdef"><p>The steps that occur directly within a container are called that step’s <em class="firstterm">contained steps</em>. In other words, “container” and “contained steps” are inverse relationships.</p></dd><dt id="glossary.2.16" class="glossentry"><em class="glossterm"><a href="#dt-container">container</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">container</em> is either a compound step or one of the non-step wrapper elements in a compound step that contains several subpipelines.</p></dd><dt id="glossary.2.17" class="glossentry"><em class="glossterm"><a href="#dt-declared-inputs">declared inputs</a></em></dt><dd class="glossdef"><p>The input ports declared on a step are its <em class="firstterm">declared inputs</em>.</p></dd><dt id="glossary.2.18" class="glossentry"><em class="glossterm"><a href="#dt-declared-outputs">declared outputs</a></em></dt><dd class="glossdef"><p>The output ports declared on a step are its <em class="firstterm">declared outputs</em>.</p></dd><dt id="glossary.2.19" class="glossentry"><em class="glossterm"><a href="#dt-default-readable-port">default readable port</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">default readable port</em>, which may be undefined, is a specific step name/port name pair from the set of readable ports.</p></dd><dt id="glossary.2.20" class="glossentry"><em class="glossterm"><a href="#dt-document">document</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">document</em> is a <em class="glossterm"><a href="#dt-representation">representation</a></em> and its <em class="glossterm"><a href="#dt-document-properties">document properties</a></em>.</p></dd><dt id="glossary.2.21" class="glossentry"><em class="glossterm"><a href="#dt-document-properties">document properties</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">document properties</em> are key/value pairs; they are exposed to the XProc pipeline as a map (<code class="type">map(xs:QName, item()*)</code>).</p></dd><dt id="glossary.2.22" class="glossentry"><em class="glossterm"><a href="#dt-dynamic-error">dynamic error</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">dynamic error</em> is one which occurs while a pipeline is being evaluated (and cannot be detected before evaluation begins).</p></dd><dt id="glossary.2.23" class="glossentry"><em class="glossterm"><a href="#dt-dynamic-evaluation">dynamic evaluation</a></em></dt><dd class="glossdef"><p><em class="firstterm">Dynamic evaluation</em> consists of tasks which, in general, cannot be performed out until a source document is available.</p></dd><dt id="glossary.2.24" class="glossentry"><em class="glossterm"><a href="#dt-effectively-excluded">effectively excluded</a></em></dt><dd class="glossdef"><p>If the effective boolean value of the <code class="tag-attribute">[p:]use-when</code> expression is false, then the element and all of its descendants are <em class="firstterm">effectively excluded</em> from the pipeline document.</p></dd><dt id="glossary.2.25" class="glossentry"><em class="glossterm"><a href="#dt-empty-environment">empty environment</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">empty environment</em> contains no readable ports, an undefined default readable port, and no in-scope bindings.</p></dd><dt id="glossary.2.26" class="glossentry"><em class="glossterm"><a href="#dt-empty-sequence">empty sequence</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">empty sequence</em> of documents is specified with the <a href="#p.empty"><code class="tag-element">p:empty</code></a> element.</p></dd><dt id="glossary.2.27" class="glossentry"><em class="glossterm"><a href="#dt-environment">environment</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">environment</em> is a context-dependent collection of information available within subpipelines.</p></dd><dt id="glossary.2.28" class="glossentry"><em class="glossterm"><a href="#dt-extension-attribute">extension attribute</a></em></dt><dd class="glossdef"><p>An element from the XProc namespace <span class="rfc2119" id="glossary.2.28.2.1.1">may</span> have any attribute not from the XProc namespace, provided that the expanded-QName of the attribute has a non-null namespace URI. Such an attribute is called an <em class="firstterm">extension attribute</em>.</p></dd><dt id="glossary.2.29" class="glossentry"><em class="glossterm"><a href="#dt-external-step">external step</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">external step</em> is one supported by the implementation, but which has no exposed subpipeline.</p></dd><dt id="glossary.2.30" class="glossentry"><em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">implementation-defined</em> feature is one where the implementation has discretion in how it is performed. Conformant implementations <span class="rfc2119" id="glossary.2.30.2.1.2">must</span> document how <em class="glossterm"><a href="#dt-implementation-defined">implementation-defined</a></em> features are performed.</p></dd><dt id="glossary.2.31" class="glossentry"><em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">implementation-dependent</em> feature is one where the implementation has discretion in how it is performed. Implementations are not required to document or explain how <em class="glossterm"><a href="#dt-implementation-dependent">implementation-dependent</a></em> features are performed.</p></dd><dt id="glossary.2.32" class="glossentry"><em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">in-scope bindings</em> are a set of name-value pairs, based on <em class="glossterm"><a href="#dt-option">option</a></em> and <em class="glossterm"><a href="#dt-variable">variable</a></em> bindings.</p></dd><dt id="glossary.2.33" class="glossentry"><em class="glossterm"><a href="#dt-inherited-environment">inherited environment</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">inherited environment</em> of a <em class="glossterm"><a href="#dt-contained-steps">contained step</a></em> is an environment that is the same as the environment of its <em class="glossterm"><a href="#dt-container">container</a></em> with the <a href="#dt-standard-modifications">standard modifications</a>. </p></dd><dt id="glossary.2.34" class="glossentry"><em class="glossterm"><a href="#dt-initial-environment">initial environment</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">initial environment</em> is a <em class="glossterm"><a href="#dt-connection">connection</a></em> for each of the <em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em> and a set of option bindings used to construct the initial <em class="glossterm"><a href="#dt-in-scope-bindings">in-scope bindings</a></em>.</p></dd><dt id="glossary.2.35" class="glossentry"><em class="glossterm"><a href="#dt-inline-document">inline document</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">inline document</em> is specified directly in the body of the element to which it connects.</p></dd><dt id="glossary.2.36" class="glossentry"><em class="glossterm"><a href="#dt-last-step">last step</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">last step</em> in a subpipeline is its last step in document order.</p></dd><dt id="glossary.2.37" class="glossentry"><em class="glossterm"><a href="#dt-map-attribute">map attribute</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">map attribute</em> is an option’s syntactic shortcut attribute for which the option’s sequence type is a map or array.</p></dd><dt id="glossary.2.38" class="glossentry"><em class="glossterm"><a href="#dt-matches">matches</a></em></dt><dd class="glossdef"><p>A step <em class="firstterm">matches</em> its signature if and only if it specifies an input for each declared input, it specifies no inputs that are not declared, it specifies an option for each option that is declared to be required, and it specifies no options that are not declared.</p></dd><dt id="glossary.2.39" class="glossentry"><em class="glossterm"><a href="#dt-namespace-fixup">namespace fixup</a></em></dt><dd class="glossdef"><p>To produce a serializable <em class="glossterm"><a href="#dt-XML">XML</a></em> document, the XProc processor must sometimes add additional namespace nodes, perhaps even renaming prefixes, to satisfy the constraints of <em class="glossterm"><a href="#dt-Namespaces-in-XML">Namespaces in XML</a></em>. This process is referred to as <em class="firstterm">namespace fixup</em>.</p></dd><dt id="glossary.2.40" class="glossentry"><em class="glossterm"><a href="#dt-option">option</a></em></dt><dd class="glossdef"><p>An <em class="firstterm">option</em> is a name/value pair. The name <span class="rfc2119" id="glossary.2.40.2.1.2">must</span> be an <a href="http://www.w3.org/TR/REC-xml-names/#dt-expname">expanded name</a>. The value may be any XPath data model value.</p></dd><dt id="glossary.2.41" class="glossentry"><em class="glossterm"><a href="#dt-pipeline">pipeline</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">pipeline</em> is a set of connected steps, with outputs of one step flowing into inputs of another.</p></dd><dt id="glossary.2.42" class="glossentry"><em class="glossterm"><a href="#dt-primary-input-port">primary input port</a></em></dt><dd class="glossdef"><p>If a step has an input port which is explicitly marked “<code class="code">primary='true'</code>”, or if it has exactly one document input port and that port is <em>not</em> explicitly marked “<code class="code">primary='false'</code>”, then that input port is the <em class="firstterm">primary input port</em> of the step.</p></dd><dt id="glossary.2.43" class="glossentry"><em class="glossterm"><a href="#dt-primary-output-port">primary output port</a></em></dt><dd class="glossdef"><p>If a step has an output port which is explicitly marked “<code class="code">primary='true'</code>”, or if it has exactly one document output port and that port is <em>not</em> explicitly marked “<code class="code">primary='false'</code>”, then that output port is the <em class="firstterm">primary output port</em> of the step.</p></dd><dt id="glossary.2.44" class="glossentry"><em class="glossterm"><a href="#dt-prologue">prologue</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">prologue</em> consists of the <a href="#p.input"><code class="tag-element">p:input</code></a>, <a href="#p.output"><code class="tag-element">p:output</code></a>, and <a href="#p.option"><code class="tag-element">p:option</code></a> elements. </p></dd><dt id="glossary.2.45" class="glossentry"><em class="glossterm"><a href="#dt-readable-ports">readable ports</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">readable ports</em> are a set of step name/port name pairs.</p></dd><dt id="glossary.2.46" class="glossentry"><em class="glossterm"><a href="#dt-representation">representation</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">representation</em> is a data structure used by an XProc processor to refer to the actual document content.</p></dd><dt id="glossary.2.47" class="glossentry"><em class="glossterm"><a href="#dt-selection-pattern">selection pattern</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">selection pattern</em> uses a subset of the syntax for path expressions, and is defined to match a node if the corresponding path expression would select the node. It is defined as in the <a href="https://www.w3.org/TR/xslt-30/#dt-selection-pattern">XSLT 3.0 specification</a>.</p></dd><dt id="glossary.2.48" class="glossentry"><em class="glossterm"><a href="#dt-shadow">shadow</a></em></dt><dd class="glossdef"><p>We say that a variable <em class="firstterm">shadows</em> another variable (or option) if it has the same name and appears later in the same lexical scope.</p></dd><dt id="glossary.2.49" class="glossentry"><em class="glossterm"><a href="#dt-signature">signature</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">signature</em> of a step is the set of inputs, outputs, and options that it is declared to accept.</p></dd><dt id="glossary.2.50" class="glossentry"><em class="glossterm"><a href="#dt-static-analysis">static analysis</a></em></dt><dd class="glossdef"><p><em class="firstterm">Static analysis</em> consists of those tasks that can be performed by inspection of the pipeline alone, including the binding of <a href="#statics">static options</a>, computation of serialization properties and document-properties, <a href="#use-when">evaluation of <code class="code">use-when</code> expressions</a>, performing a static analysis of all XPath expressions, and detecting static errors.</p></dd><dt id="glossary.2.51" class="glossentry"><em class="glossterm"><a href="#dt-static-error">static error</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">static error</em> is one which can be detected before pipeline evaluation is even attempted.</p></dd><dt id="glossary.2.52" class="glossentry"><em class="glossterm"><a href="#dt-step">step</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">step</em> is the basic computational unit of a pipeline.</p></dd><dt id="glossary.2.53" class="glossentry"><em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em></dt><dd class="glossdef"><p>The <em class="firstterm">step type exports</em> of an XProc element, against the background of a set of URIs of resources already visited (call this set <em>Visited</em>), are defined by cases.</p></dd><dt id="glossary.2.54" class="glossentry"><em class="glossterm"><a href="#dt-subpipeline">subpipeline</a></em></dt><dd class="glossdef"><p>Sibling steps and variables (and the connections between them) form a <em class="firstterm">subpipeline</em>.</p></dd><dt id="glossary.2.55" class="glossentry"><em class="glossterm"><a href="#dt-text-media-type">text media type</a></em></dt><dd class="glossdef"><p>Media types of the form “<code class="literal">text/<em class="replaceable"><code>something</code></em></code>” are <em class="firstterm">text media types</em> with the exception of “<code class="literal">text/xml</code>” which is an XML media type, and “<code class="literal">text/html</code>” which is an HTML media type. Additionally the media types “<code class="literal">application/javascript</code>”, “<code class="literal">application/relax-ng-compact-syntax</code>”, and “<code class="literal">application/xquery</code>” are also text media types. </p></dd><dt id="glossary.2.56" class="glossentry"><em class="glossterm"><a href="#dt-text-value-template">text value template</a></em></dt><dd class="glossdef"><p>In a text node that is designated as a <em class="firstterm">text value template</em>, expressions can be used by surrounding each expression with curly brackets (<code class="code">{}</code>), following the general rules for <em class="glossterm"><a href="#dt-value-template">value templates</a></em>.</p></dd><dt id="glossary.2.57" class="glossentry"><em class="glossterm"><a href="#dt-value-template">value template</a></em></dt><dd class="glossdef"><p>Collectively, attribute value templates and text value templates are referred to as <em class="firstterm">value templates</em>.</p></dd><dt id="glossary.2.58" class="glossentry"><em class="glossterm"><a href="#dt-variable">variable</a></em></dt><dd class="glossdef"><p>A <em class="firstterm">variable</em> is a name/value pair. The name <span class="rfc2119" id="glossary.2.58.2.1.2">must</span> be an <a href="http://www.w3.org/TR/REC-xml-names/#dt-expname">expanded name</a>. The value may be any XPath data model value.</p></dd><dt id="glossary.2.59" class="glossentry"><em class="glossterm"><a href="#dt-visible">visible</a></em></dt><dd class="glossdef"><p>If two names are in the same scope, we say that they are <em class="firstterm">visible</em> to each other.</p></dd></dl></div></div></article><article id="language-summary" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">E. </bdi>Pipeline Language Summary<a aria-label="§" class="self-link" href="#language-summary"></a></h2></header><div class="content"><p>This appendix summarizes the XProc pipeline language. Machine readable descriptions of this language are available in <a href="schemas/xproc.rng">RELAX NG</a> (and the RELAX NG <a href="schemas/xproc.rnc">compact syntax</a>). </p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:for-each<br />  name? = <var>NCName</var>&gt;<br />    ((<a href="#p.with-input">p:with-input</a>? &amp; <br />      <a href="#p.output">p:output</a>*),<br />     <var>subpipeline</var>)<br />&lt;/p:for-each&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:viewport<br />  name? = <var>NCName</var><br />  <strong>match</strong> = <var>XSLTSelectionPattern</var>&gt;<br />    ((<a href="#p.with-input">p:with-input</a>? &amp; <br />      <a href="#p.output">p:output</a>?),<br />     <var>subpipeline</var>)<br />&lt;/p:viewport&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:choose<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     ((<a href="#p.when">p:when</a>+,<br />       <a href="#p.otherwise">p:otherwise</a>?) | <br />      (<a href="#p.when">p:when</a>*,<br />       <a href="#p.otherwise">p:otherwise</a>)))<br />&lt;/p:choose&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:when<br />  name? = <var>NCName</var><br />  <strong>test</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     <a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:when&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:otherwise<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:otherwise&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:if<br />  name? = <var>NCName</var><br />  <strong>test</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a>?,<br />     <a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:if&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:group<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:group&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:try<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>,<br />     ((<a href="#p.catch">p:catch</a>+,<br />        <a href="#p.finally">p:finally</a>?) | <br />       (<a href="#p.catch">p:catch</a>*,<br />        <a href="#p.finally">p:finally</a>)))<br />&lt;/p:try&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:catch<br />  name? = <var>NCName</var><br />  code? = <var>EQNameList</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:catch&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:finally<br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.output">p:output</a>*,<br />     <var>subpipeline</var>)<br />&lt;/p:finally&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;<var>p:atomic-step</var><br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a> | <br />     <a href="#p.with-option">p:with-option</a>)*<br />&lt;/<var>p:atomic-step</var>&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;<var>ext:atomic-step</var><br />  name? = <var>NCName</var>&gt;<br />    (<a href="#p.with-input">p:with-input</a> | <br />     <a href="#p.with-option">p:with-option</a>)*<br />&lt;/<var>ext:atomic-step</var>&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:input<br />  <strong>port</strong> = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  select? = <var>XPathExpression</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:input&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:with-input<br />  port? = <var>NCName</var><br />  select? = <var>XPathExpression</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:with-input&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:output&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:output<br />  port? = <var>NCName</var><br />  sequence? = <var>boolean</var><br />  primary? = <var>boolean</var><br />  content-types? = <var>ContentTypes</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  serialization? = <var>map(xs:QName,item()*)</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:output&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:variable<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  <strong>select</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:variable&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:option<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  values? = <var>string</var><br />  static? = <var>boolean</var><br />  required? = <var>boolean</var><br />  select? = <var>XPathExpression</var><br />  visibility? = <var>private|public</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:with-option<br />  <strong>name</strong> = <var>EQName</var><br />  as? = <var>XPathSequenceType</var><br />  <strong>select</strong> = <var>XPathExpression</var><br />  collection? = <var>boolean</var><br />  href? = { <var>anyURI</var> }<br />  pipe? = <var>string</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var>&gt;<br />    ((<a href="#p.empty">p:empty</a> | <br />       (<a href="#p.document">p:document</a> | <br />        <a href="#p.pipe">p:pipe</a> | <br />        <a href="#p.inline">p:inline</a>)*) | <br />     <var>anyElement</var>*)<br />&lt;/p:with-option&gt;</code></p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span><span class="modify_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*,<br />    <a href="#p.declare-step">p:declare-step</a>*,<br />    <var>subpipeline</var>?<br />&lt;/p:declare-step&gt;</code></span></p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span><span class="modify_version"><code>&lt;p:declare-step<br />  name? = <var>NCName</var><br />  type? = <var>EQName</var><br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var><br />  visibility? = <var>private|public</var>&gt;<br />    (<a href="#p.input">p:input</a> | <br />     <a href="#p.output">p:output</a> | <br />     <a href="#p.option">p:option</a>)*<br />&lt;/p:declare-step&gt;</code></span></p><p class="element-syntax element-syntax-language-construct"><span style="display: none;" class="delete_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.0</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span><span style="display: none;" class="add_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var>3.1</var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span><span class="modify_version"><code>&lt;p:library<br />  psvi-required? = <var>boolean</var><br />  xpath-version? = <var>decimal</var><br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  version? = <var><span class="deltaxml-old" style="background:#FF5555">3.0</span><span class="deltaxml-new" style="background:#90EE90">3.1</span></var>&gt;<br />    (<a href="#p.import">p:import</a> | <br />     <a href="#p.import-functions">p:import-functions</a>)*,<br />    <a href="#p.option">p:option</a>*,<br />    <a href="#p.declare-step">p:declare-step</a>*<br />&lt;/p:library&gt;</code></span></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:import<br />  <strong>href</strong> = <var>anyURI</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:import-functions<br />  <strong>href</strong> = <var>anyURI</var><br />  content-type? = <var>ContentType</var><br />  namespace? = <var>string</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:pipe<br />  step? = <var>NCName</var><br />  port? = <var>NCName</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:inline<br />  exclude-inline-prefixes? = <var>ExcludeInlinePrefixes</var><br />  content-type? = <var>string</var><br />  document-properties? = <var>map(xs:QName,item()*)</var><br />  encoding? = <var>string</var>&gt;<br />    <var>anyNode</var>*<br />&lt;/p:inline&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:document<br />  <strong>href</strong> = { <var>anyURI</var> }<br />  content-type? = <var>string</var><br />  document-properties? = <var>map(xs:QName,item()*)</var><br />  parameters? = <var>map(xs:QName,item()*)</var> /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:empty /&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:documentation&gt;<br />    <var>any-well-formed-content</var>*<br />&lt;/p:documentation&gt;</code></p><p class="element-syntax element-syntax-language-construct"><code>&lt;p:pipeinfo&gt;<br />    <var>any-well-formed-content</var>*<br />&lt;/p:pipeinfo&gt;</code></p><p>The core steps are also summarized here.</p><p>As are the optional steps.</p><p>And the step vocabulary elements.</p></div></article><article id="errors-list" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">F. </bdi>List of Error Codes<a aria-label="§" class="self-link" href="#errors-list"></a></h2></header><div class="content"><p>The following error codes are defined by this specification.</p><section id="app.static-errors" class="section"><div class="section-titlepage"><h2><bdi class="secno">F.1. </bdi>Static Errors<a aria-label="§" class="self-link" href="#app.static-errors"></a></h2></div><div class="content"><p>The following <em class="glossterm"><a href="#dt-static-error">static errors</a></em> are defined:</p><div id="static-error-summary"><h5>Static Errors</h5><dl class="errs"><dt id="err.S0001"><code class="errqname">err:XS0001</code></dt><dd><p>It is a static error if there are any loops in the connections between steps, variables, and options: no step, variable, or option can be connected to itself nor can there be any sequence of connections through other steps that leads back to itself.</p><p>See: <a href="#err.inline.S0001">Connections</a></p></dd><dt id="err.S0002"><code class="errqname">err:XS0002</code></dt><dd><p>All steps in the same scope must have unique names: it is a static error if two steps with the same name appear in the same scope.</p><p>See: <a href="#err.inline.S0002">Scoping of step names</a></p></dd><dt id="err.S0003"><code class="errqname">err:XS0003</code></dt><dd><p>It is a static error if any declared input is not connected.</p><p>See: <a href="#err.inline.S0003">Inputs and Outputs</a><span class="deltaxml-new" style="background:#90EE90">, </span><a href="#err.inline.S0003.1"><span class="deltaxml-new" style="background:#90EE90">Connection precedence</span></a></p></dd><dt id="err.S0004"><code class="errqname">err:XS0004</code></dt><dd><p>It is a static error to declare two or more options on the same step with the same name.</p><p>See: <a href="#err.inline.S0004">p:option</a></p></dd><dt id="err.S0006"><code class="errqname">err:XS0006</code></dt><dd><p>It is a static error if the primary output port has no explicit connection and the last step in the subpipeline does not have a primary output port.</p><p>See: <a href="#err.inline.S0006">p:for-each</a>, <a href="#err.inline.S0006.1">p:viewport</a>, <a href="#err.inline.S0006.2">Declaring pipelines</a></p></dd><dt id="err.S0008"><code class="errqname">err:XS0008</code></dt><dd><p>It is a static error if any element in the XProc namespace has attributes not defined by this specification unless they are extension attributes.</p><p>See: <a href="#err.inline.S0008">Common errors</a></p></dd><dt id="err.S0010"><code class="errqname">err:XS0010</code></dt><dd><p>It is a static error if a pipeline contains a step whose specified inputs, outputs, and options do not match the signature for steps of that type.</p><p>See: <a href="#err.inline.S0010">Extension Steps</a></p></dd><dt id="err.S0011"><code class="errqname">err:XS0011</code></dt><dd><p>It is a static error to identify two ports with the same name on the same step.</p><p>See: <a href="#err.inline.S0011">p:input</a>, <a href="#err.inline.S0011.1">p:output</a></p></dd><dt id="err.S0014"><code class="errqname">err:XS0014</code></dt><dd><p>It is a static error to identify more than one output port as primary.</p><p>See: <a href="#err.inline.S0014">p:output</a></p></dd><dt id="err.S0015"><code class="errqname">err:XS0015</code></dt><dd><p>It is a static error if a compound step has no contained steps.</p><p>See: <a href="#err.inline.S0015">Common errors</a></p></dd><dt id="err.S0017"><code class="errqname">err:XS0017</code></dt><dd><p>It is a static error to specify that an option is both required and has a default value.</p><p>See: <a href="#err.inline.S0017">p:option</a></p></dd><dt id="err.S0018"><code class="errqname">err:XS0018</code></dt><dd><p>If an option is required, it is a static error to invoke the step without specifying a value for that option.</p><p>See: <a href="#err.inline.S0018">p:option</a></p></dd><dt id="err.S0022"><code class="errqname">err:XS0022</code></dt><dd><p>In all cases except when the p:pipe is within an p:output of a compound step, it is a static error if the port identified by the p:pipe is not in the readable ports of the step that contains the p:pipe.</p><p>See: <a href="#err.inline.S0022">p:pipe</a></p></dd><dt id="err.S0025"><code class="errqname">err:XS0025</code></dt><dd><p>It is a static error if the expanded-QName value of the type attribute is in no namespace or in the XProc namespace.</p><p>See: <a href="#err.inline.S0025">Declaring pipelines</a></p></dd><dt id="err.S0027"><code class="errqname">err:XS0027</code></dt><dd><p>It is a static error if an option is specified with both the shortcut form and the long form.</p><p>See: <a href="#err.inline.S0027">Syntactic Shortcut for Option Values</a></p></dd><dt id="err.S0028"><code class="errqname">err:XS0028</code></dt><dd><p>It is a static error to declare an option or variable in the XProc namespace.</p><p>See: <a href="#err.inline.S0028">p:variable</a>, <a href="#err.inline.S0028.1">p:option</a></p></dd><dt id="err.S0029"><code class="errqname">err:XS0029</code></dt><dd><p>It is a static error to specify a connection for a p:output inside a p:declare-step for an external step.</p><p>See: <a href="#err.inline.S0029">p:output</a></p></dd><dt id="err.S0030"><code class="errqname">err:XS0030</code></dt><dd><p>It is a static error to specify that more than one input port is the primary.</p><p>See: <a href="#err.inline.S0030">p:input</a></p></dd><dt id="err.S0031"><code class="errqname">err:XS0031</code></dt><dd><p>It is a static error to use an option name in p:with-option if the step type being invoked has not declared an option with that name.</p><p>See: <a href="#err.inline.S0031">p:with-option</a>, <a href="#err.inline.S0031.1">Syntactic Shortcut for Option Values</a></p></dd><dt id="err.S0032"><code class="errqname">err:XS0032</code></dt><dd><p>It is a static error if no connection is provided<span class="deltaxml-old" style="background:#FF5555"> and</span><span class="deltaxml-new" style="background:#90EE90">,</span> the default readable port is undefined<span class="deltaxml-new" style="background:#90EE90">, and there is no default connection for the port</span>.</p><p>See: <a href="#err.inline.S0032">p:with-input</a>, <a href="#err.inline.S0032.1">Connection precedence</a><span class="deltaxml-old" style="background:#FF5555">, </span><a href="#err.inline.S0032.2"><span class="deltaxml-old" style="background:#FF5555">Connection precedence</span></a></p></dd><dt id="err.S0036"><code class="errqname">err:XS0036</code></dt><dd><p>All the step types in a pipeline or library must have unique names: it is a static error if any step type name is built-in and/or declared or defined more than once in the same scope.</p><p>See: <a href="#err.inline.S0036">Scoping of step type names</a>, <a href="#err.inline.S0036.1">Handling Circular and Re-entrant Library Imports (Non-Normative)</a>, <a href="#err.inline.S0036.2">Handling Circular and Re-entrant Library Imports (Non-Normative)</a>, <a href="#err.inline.S0036.3">Handling Circular and Re-entrant Library Imports (Non-Normative)</a></p></dd><dt id="err.S0037"><code class="errqname">err:XS0037</code></dt><dd><p>It is a static error if any user extension step or any element in the XProc namespace other than p:inline directly contains text nodes that do not consist entirely of whitespace.</p><p>See: <a href="#err.inline.S0037">Common errors</a></p></dd><dt id="err.S0038"><code class="errqname">err:XS0038</code></dt><dd><p>It is a static error if any required attribute is not provided.</p><p>See: <a href="#err.inline.S0038">Common errors</a></p></dd><dt id="err.S0043"><code class="errqname">err:XS0043</code></dt><dd><p>It is a static error to specify a port name on p:with-input for p:for-each, p:viewport, p:choose, p:when, or p:if.</p><p>See: <a href="#err.inline.S0043">p:with-input</a></p></dd><dt id="err.S0044"><code class="errqname">err:XS0044</code></dt><dd><p>It is a static error if any step contains an atomic step for which there is no visible declaration.</p><p>See: <a href="#err.inline.S0044">Common errors</a></p></dd><dt id="err.S0048"><code class="errqname">err:XS0048</code></dt><dd><p>It is a static error to use a declared step as a compound step.</p><p>See: <a href="#err.inline.S0048">Extension Steps</a></p></dd><dt id="err.S0052"><code class="errqname">err:XS0052</code></dt><dd><p>It is a static error if the URI of a p:import cannot be retrieved or if, once retrieved, it does not point to a p:library or p:declare-step.</p><p>See: <a href="#err.inline.S0052">p:import</a></p></dd><dt id="err.S0053"><code class="errqname"><span class="deltaxml-old" style="background:#FF5555">err:XS0053</span></code></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">It is a static error to import a single pipeline if that pipeline does not have a type.</span></p><p><span class="deltaxml-old" style="background:#FF5555">See: </span><a href="#err.inline.S0053"><span class="deltaxml-old" style="background:#FF5555">p:import</span></a></p></dd><dt id="err.S0057"><code class="errqname">err:XS0057</code></dt><dd><p>It is a static error if the exclude-inline-prefixes attribute does not contain a list of tokens or if any of those tokens (except #all or #default) is not a prefix bound to a namespace in the in-scope namespaces of the element on which it occurs.</p><p>See: <a href="#err.inline.S0057">Inline XML and HTML content</a></p></dd><dt id="err.S0058"><code class="errqname">err:XS0058</code></dt><dd><p>It is a static error if the value #default is used within the exclude-inline-prefixes attribute and there is no default namespace in scope.</p><p>See: <a href="#err.inline.S0058">Inline XML and HTML content</a></p></dd><dt id="err.S0059"><code class="errqname">err:XS0059</code></dt><dd><p>It is a static error if the pipeline element is not p:declare-step or p:library.</p><p>See: <a href="#err.inline.S0059">Common errors</a></p></dd><dt id="err.S0060"><code class="errqname">err:XS0060</code></dt><dd><p>It is a static error if the processor encounters an explicit request for a version of the language <span class="deltaxml-old" style="background:#FF5555">other than “3.0”</span><span class="deltaxml-new" style="background:#90EE90">not acceptable to the processor</span>.</p><p>See: <a href="#err.inline.S0060">Versioning Considerations</a></p></dd><dt id="err.S0062"><code class="errqname">err:XS0062</code></dt><dd><p>It is a static error if a required version attribute is not present.</p><p>See: <a href="#err.inline.S0062">Versioning Considerations</a>, <a href="#err.inline.S0062.1">Declaring pipelines</a></p></dd><dt id="err.S0063"><code class="errqname">err:XS0063</code></dt><dd><p>It is a static error if the value of the version attribute is not a xs:decimal.</p><p>See: <a href="#err.inline.S0063">Versioning Considerations</a></p></dd><dt id="err.S0064"><code class="errqname">err:XS0064</code></dt><dd><p>It is a static error if the code attribute is missing from any but the last p:catch or if any error code occurs in more than one code attribute among sibling p:catch elements.</p><p>See: <a href="#err.inline.S0064">p:catch</a></p></dd><dt id="err.S0065"><code class="errqname">err:XS0065</code></dt><dd><p>It is a static error if there is no primary input port.</p><p>See: <a href="#err.inline.S0065">p:with-input</a></p></dd><dt id="err.S0066"><code class="errqname">err:XS0066</code></dt><dd><p>It is a static error if an expression does not have a closing right curly bracket or if an unescaped right curly bracket occurs outside of an expression. </p><p>See: <a href="#err.inline.S0066">Value Templates</a></p></dd><dt id="err.S0067"><code class="errqname">err:XS0067</code></dt><dd><p>It is a static error if the step attribute is not specified, and there is no default readable port. It is a static error if the port attribute is not specified, and the step identified has no primary output port. </p><p>See: <a href="#err.inline.S0067">p:pipe</a></p></dd><dt id="err.S0068"><code class="errqname">err:XS0068</code></dt><dd><p>It is a static error if the port attribute is not specified, and the step identified has no primary output port.</p><p>See: <a href="#err.inline.S0068">p:pipe</a></p></dd><dt id="err.S0069"><code class="errqname">err:XS0069</code></dt><dd><p>It is a static error if the encoding specified is not supported by the implementation.</p><p>See: <a href="#err.inline.S0069">p:inline</a></p></dd><dt id="err.S0071"><code class="errqname">err:XS0071</code></dt><dd><p>All the static options in a pipeline or library must have unique names: it is a static error if any static option name is declared more than once in the same scope.</p><p>See: <a href="#err.inline.S0071">Scoping of static option names</a></p></dd><dt id="err.S0072"><code class="errqname">err:XS0072</code></dt><dd><p>It is a static error if the name of any output port on the p:finally is the same as the name of any other output port in the p:try or any of its sibling p:catch elements.</p><p>See: <a href="#err.inline.S0072">p:finally</a></p></dd><dt id="err.S0073"><code class="errqname">err:XS0073</code></dt><dd><p>It is a static error if any specified name is not the name of an in-scope step.</p><p>See: <a href="#err.inline.S0073">Additional dependent connections</a></p></dd><dt id="err.S0074"><code class="errqname">err:XS0074</code></dt><dd><p>It is a static error if a p:choose has neither a p:when nor a p:otherwise.</p><p>See: <a href="#err.inline.S0074">p:choose</a></p></dd><dt id="err.S0075"><code class="errqname">err:XS0075</code></dt><dd><p>It is a static error if a p:try does not have at least one subpipeline step, at least one of p:catch or p:finally, and at most one p:finally.</p><p>See: <a href="#err.inline.S0075">p:try</a></p></dd><dt id="err.S0076"><code class="errqname">err:XS0076</code></dt><dd><p>It is a static error if there are any loops in the connections between steps and variables: no step can refer to a variable if there is any sequence of connections from that step that leads back to the input that provides the context node for the expression that defines the value of the variable.</p><p>See: <a href="#err.inline.S0076">p:variable</a>, <a href="#err.inline.S0076.1">p:with-option</a></p></dd><dt id="err.S0077"><code class="errqname">err:XS0077</code></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">It is a static error if the value on an attribute of an XProc element does not satisfy the type required for that attribute.</span></p><p><span class="deltaxml-new" style="background:#90EE90">It is a static error if the specified duration is not a positive number or a valid xs:dayTimeDuration.</span></p><p>See: <a href="#err.inline.S0077"><span class="deltaxml-new" style="background:#90EE90">Controlling long running steps</span></a><span class="deltaxml-new" style="background:#90EE90">, </span><a href="#err.inline.S0077.1">Common errors</a></p></dd><dt id="err.S0078"><code class="errqname">err:XS0078</code></dt><dd><p>When the p:pipe is within an p:output of a compound step, it is a static error if the port identified by the p:pipe is not in the readable ports of the compound step and is not a readable port of a contained step.</p><p>See: <a href="#err.inline.S0078">p:pipe</a></p></dd><dt id="err.S0079"><code class="errqname">err:XS0079</code></dt><dd><p>It is a static error if comments, non-whitespace text nodes, or processing instructions occur as siblings of an element node that would be treated as an implicit inline.</p><p>See: <a href="#err.inline.S0079">Implicit inlines</a></p></dd><dt id="err.S0080"><code class="errqname">err:XS0080</code></dt><dd><p>It is a static error to include more than one p:with-option with the same option name as part of the same step invocation.</p><p>See: <a href="#err.inline.S0080">p:with-option</a></p></dd><dt id="err.S0081"><code class="errqname">err:XS0081</code></dt><dd><p>If href is specified, it is a static error if any child elements other than p:documentation and p:pipeinfo are present.</p><p>See: <a href="#err.inline.S0081">p:with-input</a></p></dd><dt id="err.S0082"><code class="errqname">err:XS0082</code></dt><dd><p>If pipe is specified, it is a static error any child elements other than p:documentation and p:pipeinfo are present.</p><p>See: <a href="#err.inline.S0082">p:with-input</a></p></dd><dt id="err.S0083"><code class="errqname">err:XS0083</code></dt><dd><p>It is a static error if the value of the code attribute is not a whitespace separated list of EQNames.</p><p>See: <a href="#err.inline.S0083">p:catch</a></p></dd><dt id="err.S0085"><code class="errqname">err:XS0085</code></dt><dd><p>It is a static error if both a href attribute and a pipe attribute are present.</p><p>See: <a href="#err.inline.S0085">p:with-input</a>, <a href="#err.inline.S0085.1">p:with-input</a></p></dd><dt id="err.S0086"><code class="errqname">err:XS0086</code></dt><dd><p>It is a static error to provide more than one p:with-input for the same port.</p><p>See: <a href="#err.inline.S0086">p:with-input</a></p></dd><dt id="err.S0087"><code class="errqname">err:XS0087</code></dt><dd><p>It is a static error if the name attribute on p:option or p:variable has a prefix which is not bound to a namespace.</p><p>See: <a href="#err.inline.S0087">p:variable</a>, <a href="#err.inline.S0087.1">p:option</a></p></dd><dt id="err.S0088"><code class="errqname">err:XS0088</code></dt><dd><p>It is a static error if the qualified name of a <span class="deltaxml-old" style="background:#FF5555">p:variable</span><span class="deltaxml-new" style="background:#90EE90">static option</span> shadows the name of <span class="deltaxml-old" style="background:#FF5555">a</span><span class="deltaxml-new" style="background:#90EE90">another</span> static option<span class="deltaxml-new" style="background:#90EE90"> or a variable</span>.</p><p>See: <a href="#err.inline.S0088"><span class="deltaxml-new" style="background:#90EE90">Static Options</span></a><span class="deltaxml-new" style="background:#90EE90">, </span><a href="#err.inline.S0088.1">p:variable</a>, <a href="#err.inline.S0088.2">p:option</a></p></dd><dt id="err.S0089"><code class="errqname">err:XS0089</code></dt><dd><p>It is a static error if the p:empty binding appears as a sibling of any other binding, including itself.</p><p>See: <a href="#err.inline.S0089">p:empty</a></p></dd><dt id="err.S0090"><code class="errqname">err:XS0090</code></dt><dd><p>It is a static error if the value of the pipe attribute contains any tokens not of the form port-name, port-name@step-name, or @step-name. </p><p>See: <a href="#err.inline.S0090">p:with-input</a></p></dd><dt id="err.S0091"><code class="errqname">err:XS0091</code></dt><dd><p>It is a static error if an p:option shadows another option declared within the same p:declare-step.</p><p>See: <a href="#err.inline.S0091">Declaring pipelines</a></p></dd><dt id="err.S0092"><code class="errqname">err:XS0092</code></dt><dd><p>It is a static error if a p:with-option attempts to change the value of an option that is declared static.</p><p>See: <a href="#err.inline.S0092">p:with-option</a>, <a href="#err.inline.S0092.1">Syntactic Shortcut for Option Values</a></p></dd><dt id="err.S0094"><code class="errqname">err:XS0094</code></dt><dd><p>It is a static error if a p:variable does not have a select attribute.</p><p>See: <a href="#err.inline.S0094">p:variable</a></p></dd><dt id="err.S0095"><code class="errqname">err:XS0095</code></dt><dd><p>It is a static error to specify that an option is both required and static.</p><p>See: <a href="#err.inline.S0095">p:option</a></p></dd><dt id="err.S0096"><code class="errqname">err:XS0096</code></dt><dd><p>It is a static error if the sequence type is not syntactically valid.</p><p>See: <a href="#err.inline.S0096">Variable and option types</a></p></dd><dt id="err.S0097"><code class="errqname">err:XS0097</code></dt><dd><p>It is a static error if an attribute in the XProc namespace appears on an element in the XProc namespace.</p><p>See: <a href="#err.inline.S0097">Common Attributes</a></p></dd><dt id="err.S0099"><code class="errqname">err:XS0099</code></dt><dd><p>It is a static error if step or port are not valid instances of NCName.</p><p>See: <a href="#err.inline.S0099">p:pipe</a></p></dd><dt id="err.S0100"><code class="errqname">err:XS0100</code></dt><dd><p>It is a static error if the pipeline document does not conform to the grammar for pipeline documents.</p><p>See: <a href="#err.inline.S0100">Common errors</a></p></dd><dt id="err.S0101"><code class="errqname">err:XS0101</code></dt><dd><p>It is a static error if the values list is not an XPath sequence of atomic values.</p><p>See: <a href="#err.inline.S0101">p:option</a></p></dd><dt id="err.S0102"><code class="errqname">err:XS0102</code></dt><dd><p>It is a static error if alternative subpipelines have different primary output ports.</p><p>See: <a href="#err.inline.S0102">p:choose</a>, <a href="#err.inline.S0102.1">p:try</a></p></dd><dt id="err.S0103"><code class="errqname">err:XS0103</code></dt><dd><p>It is a static error if the URI of a p:import-functions element cannot be retrieved or if, once retrieved, it points to a library that the processor cannot import.</p><p>See: <a href="#err.inline.S0103">p:import-functions</a></p></dd><dt id="err.S0104"><code class="errqname">err:XS0104</code></dt><dd><p>It is a static error if the processor cannot load the function library.</p><p>See: <a href="#err.inline.S0104">p:import-functions</a></p></dd><dt id="err.S0105"><code class="errqname">err:XS0105</code></dt><dd><p>It is a static error if a function imported from a library has the same name and arity as a function already imported.</p><p>See: <a href="#err.inline.S0105">p:import-functions</a></p></dd><dt id="err.S0106"><code class="errqname">err:XS0106</code></dt><dd><p>It is a static error if the processor detects that a particular library is unloadable.</p><p>See: <a href="#err.inline.S0106">p:import-functions</a></p></dd><dt id="err.S0107"><code class="errqname">err:XS0107</code></dt><dd><p>It is a static error in XProc if any XPath expression or the XSLT selection pattern in option match on p:viewport contains a static error (error in expression syntax, references to unknown variables or functions, etc.).</p><p>See: <a href="#err.inline.S0107">Initiating a pipeline</a></p></dd><dt id="err.S0108"><code class="errqname">err:XS0108</code></dt><dd><p>It is a static error if the p:if step does not specify a primary output port.</p><p>See: <a href="#err.inline.S0108">p:if</a></p></dd><dt id="err.S0109"><code class="errqname">err:XS0109</code></dt><dd><p>It is a static error if options that are the direct children of p:library are not declared “static”</p><p>See: <a href="#err.inline.S0109">Static Options</a></p></dd><dt id="err.S0110"><code class="errqname">err:XS0110</code></dt><dd><p>It is a static error if the requested XPath version is less than “3.1”</p><p>See: <a href="#err.inline.S0110">Declaring pipelines</a>, <a href="#err.inline.S0110.1">p:library</a></p></dd><dt id="err.S0111"><code class="errqname">err:XS0111</code></dt><dd><p>It is a static error if an unrecognized content type shortcut is specified.</p><p>See: <a href="#err.inline.S0111">Specifying content types</a></p></dd><dt id="err.S0112"><code class="errqname">err:XS0112</code></dt><dd><p>It is a static error if p:finally declares a primary output port either explicitly or implicitly.</p><p>See: <a href="#err.inline.S0112">p:finally</a></p></dd><dt id="err.S0113"><code class="errqname">err:XS0113</code></dt><dd><p>It is a static error if either [p:]expand-text or [p:]inline-expand-text is to be interpreted by the processor and it does not have the value “true” or “false”.</p><p>See: <a href="#err.inline.S0113">Expand text attributes</a></p></dd><dt id="err.S0114"><code class="errqname">err:XS0114</code></dt><dd><p>It is a static error if a port name is specified and the step type being invoked does not have an input port declared with that name.</p><p>See: <a href="#err.inline.S0114">p:with-input</a></p></dd><dt id="err.S0115"><code class="errqname">err:XS0115</code></dt><dd><p>It is a static error if two or more elements are contained within a deadlocked network of [p:]use-when expressions.</p><p>See: <a href="#err.inline.S0115">Conditional Element Exclusion</a></p></dd></dl></div></div></section><section id="app.dynamic-errors" class="section"><div class="section-titlepage"><h2><bdi class="secno">F.2. </bdi>Dynamic Errors<a aria-label="§" class="self-link" href="#app.dynamic-errors"></a></h2></div><div class="content"><p>The following <em class="glossterm"><a href="#dt-dynamic-error">dynamic errors</a></em> are defined:</p><div id="dynamic-error-summary"><h5>Dynamic Errors</h5><dl class="errs"><dt id="err.D0001"><code class="errqname">err:XD0001</code></dt><dd><p>It is a dynamic error if an XPath expression makes reference to the context item, size, or position when the context item is undefined.</p><p>See: <a href="#err.inline.D0001">p:choose</a>, <a href="#err.inline.D0001.1">p:when</a>, <a href="#err.inline.D0001.2">p:if</a>, <a href="#err.inline.D0001.3">p:variable</a>, <a href="#err.inline.D0001.4">p:option</a>, <a href="#err.inline.D0001.5">p:with-option</a>, <a href="#err.inline.D0001.6">Processor XPath Context</a>, <a href="#err.inline.D0001.7">Processor XPath Context</a></p></dd><dt id="err.D0006"><code class="errqname">err:XD0006</code></dt><dd><p>If sequence is not specified, or has the value false, then it is a dynamic error unless exactly one document appears on the declared port.</p><p>See: <a href="#err.inline.D0006">p:input</a></p></dd><dt id="err.D0007"><code class="errqname">err:XD0007</code></dt><dd><p>If sequence is not specified on p:output, or has the value false, then it is a dynamic error if the step does not produce exactly one document on the declared port.</p><p>See: <a href="#err.inline.D0007">p:output</a></p></dd><dt id="err.D0010"><code class="errqname">err:XD0010</code></dt><dd><p>It is a dynamic error if the match expression on p:viewport matches an attribute or a namespace node.</p><p>See: <a href="#err.inline.D0010">p:viewport</a></p></dd><dt id="err.D0012"><code class="errqname">err:XD0012</code></dt><dd><p>It is a dynamic error if any attempt is made to dereference a URI where the scheme of the URI reference is not supported.</p><p>See: <a href="#err.inline.D0012">Common errors</a></p></dd><dt id="err.D0015"><code class="errqname">err:XD0015</code></dt><dd><p>It is a dynamic error if a QName is specified and it cannot be resolved with the in-scope namespace declarations.</p><p>See: <a href="#err.inline.D0015">System Properties</a>, <a href="#err.inline.D0015.1">Step Available</a></p></dd><dt id="err.D0016"><code class="errqname">err:XD0016</code></dt><dd><p>It is a dynamic error if the select expression on a p:input or p:with-input returns attribute nodes or function items.</p><p>See: <a href="#err.inline.D0016">p:with-input</a></p></dd><dt id="err.D0017"><code class="errqname">err:XD0017</code></dt><dd><p>It is a dynamic error if the running pipeline attempts to invoke an external step which the processor does not know how to perform.</p><p>See: <a href="#err.inline.D0017">Extension Steps</a>, <a href="#err.inline.D0017.1">Declaring external steps</a></p></dd><dt id="err.D0019"><code class="errqname">err:XD0019</code></dt><dd><p>It is a dynamic error if an option declares a list of acceptable values and an attempt is made to specify a value that is not a member of that list.</p><p>See: <a href="#err.inline.D0019">p:option</a></p></dd><dt id="err.D0020"><code class="errqname">err:XD0020</code></dt><dd><p>It is a dynamic error if the combination of serialization options specified or defaulted is not allowed.</p><p>See: <a href="#err.inline.D0020">Serialization parameters</a></p></dd><dt id="err.D0021"><code class="errqname">err:XD0021</code></dt><dd><p>It is a dynamic error for a pipeline to attempt to access a resource for which it has insufficient privileges or perform a step which is forbidden.</p><p>See: <a href="#err.inline.D0021">Security Considerations</a></p></dd><dt id="err.D0022"><code class="errqname">err:XD0022</code></dt><dd><p>It is a dynamic error if a processor that does not support PSVI annotations attempts to invoke a step which asserts that they are required.</p><p>See: <a href="#err.inline.D0022">PSVIs in XProc</a></p></dd><dt id="err.D0028"><code class="errqname">err:XD0028</code></dt><dd><p>It is a dynamic error if any attribute value does not satisfy the type required for that attribute.</p><p>See: <a href="#err.inline.D0028">Common errors</a></p></dd><dt id="err.D0030"><code class="errqname">err:XD0030</code></dt><dd><p>It is a dynamic error if a step is unable or incapable of performing its function.</p><p>See: <a href="#err.inline.D0030">Common errors</a></p></dd><dt id="err.D0036"><code class="errqname">err:XD0036</code></dt><dd><p>It is a dynamic error if the supplied or defaulted value of a variable or option cannot be converted to the required type.</p><p>See: <a href="#err.inline.D0036">Variable and option types</a></p></dd><dt id="err.D0038"><code class="errqname">err:XD0038</code></dt><dd><p>It is a dynamic error if an input document arrives on a port and it does not match the allowed content types.</p><p>See: <a href="#err.inline.D0038">Specifying content types</a></p></dd><dt id="err.D0039"><code class="errqname">err:XD0039</code></dt><dd><p>It is a dynamic error if the encoding attribute is present and content type value specifies a character set that is not supported by the implementation.</p><p>See: <a href="#err.inline.D0039">p:inline</a></p></dd><dt id="err.D0040"><code class="errqname">err:XD0040</code></dt><dd><p>It is a dynamic error if the body is not correctly encoded per the value of the encoding attribute.</p><p>See: <a href="#err.inline.D0040">p:inline</a></p></dd><dt id="err.D0042"><code class="errqname">err:XD0042</code></dt><dd><p>It is a dynamic error if a document arrives on an output port whose content type is not accepted by the output port specification.</p><p>See: <a href="#err.inline.D0042">p:output</a></p></dd><dt id="err.D0050"><code class="errqname">err:XD0050</code></dt><dd><p>It is a dynamic error if the XPath expression in a value template can not be evaluated.</p><p>See: <a href="#err.inline.D0050">Value Templates</a></p></dd><dt id="err.D0051"><code class="errqname">err:XD0051</code></dt><dd><p>It is a dynamic error if the XPath expression in an AVT or TVT evaluates to something to other than a sequence containing atomic values or nodes.</p><p>See: <a href="#err.inline.D0051">Value Templates</a></p></dd><dt id="err.D0052"><code class="errqname">err:XD0052</code></dt><dd><p>It is a dynamic error if the XPath expression in a TVT evaluates to an attribute and either the parent is not an element or the attribute has a preceding node that it not an attribute.</p><p>See: <a href="#err.inline.D0052">Text Value Templates</a><span class="deltaxml-new" style="background:#90EE90">, </span><a href="#err.inline.D0052.1"><span class="deltaxml-new" style="background:#90EE90">Text Value Templates</span></a></p></dd><dt id="err.D0053"><code class="errqname">err:XD0053</code></dt><dd><p>It is a dynamic error if a step runs longer than its timeout value.</p><p>See: <a href="#err.inline.D0053">Controlling long running steps</a></p></dd><dt id="err.D0054"><code class="errqname">err:XD0054</code></dt><dd><p>It is a dynamic error if an encoding is specified and the content type is an XML media type or an HTML media type.</p><p>See: <a href="#err.inline.D0054">p:inline</a></p></dd><dt id="err.D0055"><code class="errqname">err:XD0055</code></dt><dd><p>It is a dynamic error if the content type value specifies a character set and the encoding attribute is absent.</p><p>See: <a href="#err.inline.D0055">p:inline</a></p></dd><dt id="err.D0056"><code class="errqname">err:XD0056</code></dt><dd><p>It is a dynamic error if an encoding is specified and the content of the p:inline contains any XML markup.</p><p>See: <a href="#err.inline.D0056">p:inline</a></p></dd><dt id="err.D0057"><code class="errqname">err:XD0057</code></dt><dd><p>It is a dynamic error if the text content does not conform to the JSON grammar.</p><p>See: <a href="#err.inline.D0057">Inline JSON content</a></p></dd><dt id="err.D0061"><code class="errqname">err:XD0061</code></dt><dd><p>It is a dynamic error if $key is of type xs:string and cannot be converted into a xs:QName.</p><p>See: <a href="#err.inline.D0061">Document property</a>, <a href="#err.inline.D0061.1">Special rules for casting QNames</a></p></dd><dt id="err.D0062"><code class="errqname">err:XD0062</code></dt><dd><p>It is a dynamic error if the document-properties map contains a content-type key and that key has a value that differs from the statically determined content type.</p><p>See: <a href="#err.inline.D0062">p:inline</a></p></dd><dt id="err.D0063"><code class="errqname">err:XD0063</code></dt><dd><p>It is a dynamic error if the p:inline contains any XML markup and has a content type that is not an XML media type or an HTML media type.</p><p>See: <a href="#err.inline.D0063">p:inline</a></p></dd><dt id="err.D0064"><code class="errqname">err:XD0064</code></dt><dd><p>It is a dynamic error if the base URI is not both absolute and valid according to .</p><p>See: <a href="#err.inline.D0064">p:inline</a>, <a href="#err.inline.D0064.1">p:document</a></p></dd><dt id="err.D0065"><code class="errqname">err:XD0065</code></dt><dd><p>It is a dynamic error to refer to the context item, size, or position in a value template if a sequence of documents appears on the default readable port.</p><p>See: <a href="#err.inline.D0065">Value Templates</a>, <a href="#err.inline.D0065.1">p:variable</a>, <a href="#err.inline.D0065.2">p:with-option</a></p></dd><dt id="err.D0068"><code class="errqname">err:XD0068</code></dt><dd><p>It is a dynamic error if the supplied value is not an instance of xs:QName, xs:anyAtomicType, xs:string or a type derived from xs:string.</p><p>See: <a href="#err.inline.D0068">Special rules for casting QNames</a></p></dd><dt id="err.D0069"><code class="errqname">err:XD0069</code></dt><dd><p>It is a dynamic error if the string value contains a colon and the designated prefix is not declared in the in-scope namespaces.</p><p>See: <a href="#err.inline.D0069">Special rules for casting QNames</a></p></dd><dt id="err.D0070"><code class="errqname">err:XD0070</code></dt><dd><p>It is a dynamic error if a value is assigned to the serialization document property that cannot be converted into map(xs:QName, item()*) according to the rules in Implicit Casting.</p><p>See: <a href="#err.inline.D0070">Document Properties</a></p></dd><dt id="err.D0072"><code class="errqname">err:XD0072</code></dt><dd><p>It is a dynamic error if a document appearing on the input port of p:viewport is neither an XML document nor an HTML document.</p><p>See: <a href="#err.inline.D0072">p:viewport</a></p></dd><dt id="err.D0073"><code class="errqname">err:XD0073</code></dt><dd><p>It is a dynamic error if the document returned by applying the subpipeline to the matched node is not an XML document, an HTML document, or a text document.</p><p>See: <a href="#err.inline.D0073">p:viewport</a></p></dd><dt id="err.D0074"><code class="errqname">err:XD0074</code></dt><dd><p>It is a dynamic error if no absolute base URI is supplied to p:urify and none can be inferred from the current working directory.</p><p>See: <a href="#err.inline.D0074">Analysis</a></p></dd><dt id="err.D0075"><code class="errqname">err:XD0075</code></dt><dd><p>It is a dynamic error if the relative path has a drive letter and the base URI has a different drive letter or does not have a drive letter.</p><p>See: <a href="#err.inline.D0075">Analysis</a></p></dd><dt id="err.D0076"><code class="errqname">err:XD0076</code></dt><dd><p>It is a dynamic error if the relative path has a drive letter and the base URI has an authority or if the relative path has an authority and the base URI has a drive letter.</p><p>See: <a href="#err.inline.D0076">Analysis</a></p></dd><dt id="err.D0077"><code class="errqname">err:XD0077</code></dt><dd><p>It is a dynamic error if the relative path has a scheme that differs from the scheme of the base URI.</p><p>See: <a href="#err.inline.D0077">Analysis</a></p></dd><dt id="err.D0079"><code class="errqname">err:XD0079</code></dt><dd><p>It is a dynamic error if a supplied content-type is not a valid media type of the form “type/subtype+ext” or “type/subtype”.</p><p>See: <a href="#err.inline.D0079">Specifying content types</a></p></dd><dt id="err.D0080"><code class="errqname">err:XD0080</code></dt><dd><p>It is a dynamic error if the basedir has a non-hierarchical scheme.</p><p>See: <a href="#err.inline.D0080">Analysis</a></p></dd><dt id="err.D0083"><code class="errqname"><span class="deltaxml-new" style="background:#90EE90">err:XD0083</span></code></dt><dd><p><span class="deltaxml-new" style="background:#90EE90">It is a dynamic error if an expression in the pipeline is cannot be evaluated (because of errors in expression syntax, references to unbound namespace prefixes, references to unknown variables or functions, etc.).</span></p><p><span class="deltaxml-new" style="background:#90EE90">See: </span><a href="#err.inline.D0083"><span class="deltaxml-new" style="background:#90EE90">Common errors</span></a></p></dd></dl></div></div></section><section id="app.step-errors" class="section"><div class="section-titlepage"><h2><bdi class="secno">F.3. </bdi>Step Errors<a aria-label="§" class="self-link" href="#app.step-errors"></a></h2></div><div class="content"><p>The following <em class="glossterm"><a href="#dt-dynamic-error">dynamic errors</a></em> can be raised by steps in this specification:</p><div id="step-error-summary"><h5>Step Errors</h5><dl class="errs"><dt id="err.C0023"><code class="errqname">err:XC0023</code></dt><dd><p>It is a dynamic error if a select expression or selection pattern returns a node type that is not allowed by the step.</p><p>See: <a href="#err.inline.C0023">Common errors</a></p></dd></dl></div></div></section></div></article><article id="namespace-fixup-guidance" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">G. </bdi>Guidance on Namespace Fixup (Non-Normative)<a aria-label="§" class="self-link" href="#namespace-fixup-guidance"></a></h2></header><div class="content"><p>An XProc processor may find it necessary to add missing namespace declarations to ensure that a document can be serialized. While this process is implementation defined, the purpose of this appendix is to provide guidance as to what an implementation might do to either prevent such situations or fix them as before serialization.</p><p>When a namespace binding is generated, the prefix associated with the QName of the element or attribute in question should be used. From an Infoset perspective, this is accomplished by setting the <code class="code">[prefix]</code> on the element or attribute. Then when an implementation needs to add a namespace binding, it can reuse that prefix if possible. If reusing the prefix is not possible, the implementation must generate a new prefix that is unique to the in-scope namespace of the element or owner element of the attribute.</p><p>An implementation can avoid namespace fixup by making sure that the standard step library does not output documents that require fixup. The following list contains suggestions as to how to accomplish this within the steps:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>Any step that outputs an element in the step vocabulary namespace <code class="uri">http://www.w3.org/ns/xproc-step</code> must ensure that namespace is declared. An implementation should generate a namespace binding using the prefix “<code class="literal">c</code>”.</p></li><li><p>When attributes are added by <code class="tag-element">p:add-attribute</code> or <code class="tag-element">p:set-attributes</code>, the step must ensure the namespace of the attributes added are declared. If the prefix used by the QName is not in the in-scope namespaces of the element on which the attribute was added, the step must add a namespace declaration of the prefix to the in-scope namespaces. If the prefix is amongst the in-scope namespace and is not bound to the same namespace name, a new prefix and namespace binding must be added. When a new prefix is generated, the prefix associated with the attribute should be changed to reflect that generated prefix value. </p></li><li><p>When an element is renamed by <code class="tag-element">p:rename</code>, the step must ensure the namespace of the element is declared. If the prefix used by the QName is not in the in-scope namespaces of the element being renamed, the step must add a namespace declaration of the prefix to the in-scope namespaces. If the prefix is amongst the in-scope namespace and is not bound to the same namespace name, a new prefix and namespace binding must be added. When a new prefix is generated, the prefix associated with the element should be changed to reflect that generated prefix value. </p><p>If the element does not have a namespace name and there is a default namespace, the default namespace must be undeclared. For each of the child elements, the original default namespace declaration must be preserved by adding a default namespace declaration unless the child element has a different default namespace.</p></li><li><p>When an attribute is renamed by <code class="tag-element">p:rename</code>, the step must ensure the namespace of the renamed attribute is declared. If the prefix used by the QName is not in the in-scope namespaces of the element on which the attribute was added, the step must add a namespace declaration of the prefix to the in-scope namespaces. If the prefix is amongst the in-scope namespace and is not bound to the same namespace name, a new prefix and namespace binding must be added. When a new prefix is generated, the prefix associated with the attribute should be changed to reflect that generated prefix value. </p></li><li><p>When an element wraps content via <code class="tag-element">p:wrap</code>, there may be in-scope namespaces coming from ancestor elements of the new wrapper element. The step must ensure the namespace of the element is declared properly. By default, the wrapper element will inherit the in-scope namespaces of the parent element if one exists. As such, there may be a existing namespace declaration or default namespace.</p><p>If the prefix used by the QName is not in the in-scope namespaces of the wrapper element, the step must add a namespace declaration of the prefix to the in-scope namespaces. If the prefix is amongst the in-scope namespace and is not bound to the same namespace name, a new prefix and namespace binding must be added. When a new prefix is generated, the prefix associated with the wrapper element should be changed to reflect that generated prefix value. </p><p>If the element does not have a namespace name and there is a default namespace, the default namespace must be undeclared. For each of the child elements, the original default namespace declaration must be preserved by adding a default namespace declaration unless the child element has a different default namespace.</p></li><li><p>When the wrapper element is added for <code class="tag-element">p:wrap-sequence</code> or <code class="tag-element">p:pack</code>, the prefix used by the QName must be added to the in-scope namespaces.</p></li><li><p>When a element is removed via <code class="tag-element">p:unwrap</code>, an in-scope namespaces that are declared on the element must be copied to any child element except when the child element declares the same prefix or declares a new default namespace.</p></li><li><p>In the output from <code class="tag-element">p:xslt</code>, if an element was generated from the xsl:element or an attribute from xsl:attribute, the step must guarantee that an namespace declaration exists for the namespace name used. Depending on the XSLT implementation, the namespace declaration for the namespace name of the element or attribute may not be declared. It may also be the case that the original prefix is available. If the original prefix is available, the step should attempt to re-use that prefix. Otherwise, it must generate a prefix for a namespace binding and change the prefix associated the element or attribute.</p></li></ol></div></div></article><article id="handling-imports" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">H. </bdi>Handling Circular and Re-entrant Library Imports (Non-Normative)<a aria-label="§" class="self-link" href="#handling-imports"></a></h2></header><div class="content"><p>When handling imports, an implementation needs to be able to detect the following situations, and distinguish them from cases where multiple import chains produce genuinely conflicting step definitions:</p><div class="orderedlist"><ol style="list-style: decimal;"><li><p>Circular imports: A imports B, B imports A.</p></li><li><p>Re-entrant imports: A imports B and C, B imports D, C imports D.</p></li></ol></div><p>One way to achieve this is as follows:</p><p><span id="dt-step-type-exports" class="termdef">[Definition: The <em class="glossterm">step type exports</em> of an XProc element, against the background of a set of URIs of resources already visited (call this set <em>Visited</em>), are defined by cases.]</span></p><p>The <a href="#dt-step-type-exports">step type exports</a> of an XProc element are as follows:</p><div class="variablelist"><dl><dt><span class="term">p:declare-step</span></dt><dd><p>A singleton bag containing the <code class="code">type</code> of the element</p></dd><dt><span class="term">p:library</span></dt><dd><p>The <em class="glossterm"><a href="#dt-bag-merger">bag-merger</a></em> of the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of all the element’s children</p></dd><dt><span class="term">p:import</span></dt><dd><p>Let <em>RU</em> be the actual resolved URI of the resource identified by the <code class="code">href</code> of the element. If <em>RU</em> is a member of <em>Visited</em>, then an empty bag, otherwise update <em>Visited</em> by adding <em>RU</em> to it, and return the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of the document element of the retrieved representation</p></dd><dt><span class="term">all other elements</span></dt><dd><p>An empty bag</p></dd></dl></div><p>The changes to <em>Visited</em> mandated by the <code class="code">p:import</code> case above are persistent, not scoped. That is, not only the recursive processing of the imported resource but also subsequent processing of siblings and ancestors must be against the background of the updated value. In practice this means either using a side-effected global variable, or not only passing <em>Visited</em> as an argument to any recursive or iterative processing, but also <em>returning</em> its updated value for subsequent use, along with the bag of step types.</p><p>Given a pipeline library document with actual resolved URI <em>DU</em>, <a id="err.inline.S0036.1"></a>it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0036"><code class="errqname">err:XS0036</code></a>) if the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of the document element of the retrieved representation, against the background of a singleton set containing <em>DU</em> as the initial <em>Visited</em> set, contains any duplicates.</p><p>Given a top-level pipeline document with actual resolved URI <em>DU</em>, <a id="err.inline.S0036.2"></a>it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0036"><code class="errqname">err:XS0036</code></a>) if the <em class="glossterm"><a href="#dt-bag-merger">bag-merger</a></em> of the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of the document element of the retrieved representation with the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of its children, against the background of a singleton set containing <em>DU</em> as the initial <em>Visited</em> set, contains any duplicates.</p><p>Given a non-top-level <code class="code">p:declare-step</code> element, <a id="err.inline.S0036.3"></a>it is a <em class="glossterm"><a href="#dt-static-error">static error</a></em> (<a href="#err.S0036"><code class="errqname">err:XS0036</code></a>) if the <em class="glossterm"><a href="#dt-bag-merger">bag-merger</a></em> of the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of its parent with the <em class="glossterm"><a href="#dt-step-type-exports">step type exports</a></em> of its children, against the background of a copy of the <em>Visited</em> set of its parent as the initial <em>Visited</em> set, contains any duplicates.</p><p>The phrase "a copy of the <em>Visited</em> set" in the preceding paragraph is meant to indicate that checking of non-top-level <code class="code">p:declare-step</code> elements does <em>not</em> have a persistent impact on the checking of its parent. The contrast is that whereas changes to <em>Visited</em> pass both up <em>and</em> down through <code class="code">p:import</code>, they pass only <em>down</em> through <em>p:declare-step</em>.</p><p><span id="dt-bag-merger" class="termdef">[Definition: The <em class="glossterm">bag-merger</em> of two or more bags (where a bag is an unordered list or, equivalently, something like a set except that it may contain duplicates) is a bag constructed by starting with an empty bag and adding each member of each of the input bags in turn to it. It follows that the cardinality of the result is the sum of the cardinality of all the input bags.]</span></p></div></article><article id="parallelism" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">I. </bdi>Sequential steps, parallelism, and side-effects<a aria-label="§" class="self-link" href="#parallelism"></a></h2></header><div class="content"><p>XProc imposes as few constraints on the order in which steps must be evaluated as possible and almost no constraints on parallel execution.</p><p>In the simple, and we believe overwhelmingly common case, inputs flow into the pipeline, through the pipeline from one step to the next, and results are produced at the end. The order of the steps is constrained by the input/output connections between them. Implementations are free to execute them in a purely sequential fashion or in parallel, as they see fit. The results are the same in either case.</p><p>This is not true for pipelines which rely on side effects, such as the state of the filesystem or the state of the web. Consider the following pipeline:</p><pre class="programlisting language-none"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xslt name="generate-stylesheet"&gt; &lt;p:with-input port="source" href="someURI"/&gt; &lt;p:with-input port="stylesheet" href="someOtherURI"/&gt; &lt;/p:xslt&gt; &lt;p:store name="save-xslt" href="gen-style.xsl"/&gt; &lt;p:xslt name="style"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="stylesheet" href="gen-style.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-none"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.1"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xslt name="generate-stylesheet"&gt; &lt;p:with-input port="source" href="someURI"/&gt; &lt;p:with-input port="stylesheet" href="someOtherURI"/&gt; &lt;/p:xslt&gt; &lt;p:store name="save-xslt" href="gen-style.xsl"/&gt; &lt;p:xslt name="style"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="stylesheet" href="gen-style.xsl"/&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><p>There’s no guarantee that “style” step will execute after the “save-xslt” step. In this case, the solution is straightforward. Even if you need the saved stylesheet, you don't need to rely on it in your pipeline:</p><pre class="programlisting language-none"><code><span class="deltaxml-old" style="background:#FF5555">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="main" version="3.0"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xslt name="generate-stylesheet"&gt; &lt;p:with-input port="source" href="someURI"/&gt; &lt;p:with-input port="stylesheet" href="someOtherURI"/&gt; &lt;/p:xslt&gt; &lt;p:store name="save-xslt" href="gen-style.xsl"/&gt; &lt;p:xslt name="style"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:pipe step="generate-stylesheet" port="result"/&gt; &lt;/p:with-input&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><pre class="programlisting language-none"><code><span class="deltaxml-new" style="background:#90EE90">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" name="main" version="3.1"&gt; &lt;p:input port="source"/&gt; &lt;p:output port="result"/&gt; &lt;p:xslt name="generate-stylesheet"&gt; &lt;p:with-input port="source" href="someURI"/&gt; &lt;p:with-input port="stylesheet" href="someOtherURI"/&gt; &lt;/p:xslt&gt; &lt;p:store name="save-xslt" href="gen-style.xsl"/&gt; &lt;p:xslt name="style"&gt; &lt;p:with-input port="source"&gt; &lt;p:pipe step="main" port="source"/&gt; &lt;/p:with-input&gt; &lt;p:with-input port="stylesheet"&gt; &lt;p:pipe step="generate-stylesheet" port="result"/&gt; &lt;/p:with-input&gt; &lt;/p:xslt&gt; &lt;/p:declare-step&gt;</span></code></pre><p>Now the result is independent of the implementation strategy.</p><p>Implementations are free to invent additional control structures using <a href="#p.pipeinfo"><code class="tag-element">p:pipeinfo</code></a> and <a href="#extension-attributes">extension attributes</a> to provide greater control over parallelism in their implementations.</p></div></article><article id="xproc-media-type" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">J. </bdi>The <code class="code">application/xproc+xml</code> media type<a aria-label="§" class="self-link" href="#xproc-media-type"></a></h2></header><div class="content"><p>This appendix registers a new MIME media type, “<span class="quote"><code class="code">application/xproc+xml</code></span>”.</p><section id="media-type-registration" class="section"><div class="section-titlepage"><h2><bdi class="secno">J.1. </bdi>Registration of MIME media type application/xproc+xml<a aria-label="§" class="self-link" href="#media-type-registration"></a></h2></div><div class="content"><div class="variablelist"><dl><dt><span class="term">MIME media type name:</span></dt><dd><p><code class="code">application</code></p></dd><dt><span class="term">MIME subtype name:</span></dt><dd><p><code class="code">xproc+xml</code></p></dd><dt><span class="term">Required parameters:</span></dt><dd><p>None. </p></dd><dt><span class="term">Optional parameters:</span></dt><dd><div class="variablelist"><dl><dt><span class="term"><code class="code">charset</code></span></dt><dd><p>This parameter has identical semantics to the <code class="code">charset</code> parameter of the <code class="code">application/xml</code> media type as specified in [<a href="#rfc3023"><span class="abbrev">RFC 3023</span></a>] or its successors. </p></dd></dl></div></dd><dt><span class="term">Encoding considerations:</span></dt><dd><p>By virtue of XProc content being XML, it has the same considerations when sent as “<span class="quote"><code class="code">application/xproc+xml</code></span>” as does XML. See [<a href="#rfc3023"><span class="abbrev">RFC 3023</span></a>], Section 3.2. </p></dd><dt><span class="term">Security considerations:</span></dt><dd><p>Several XProc elements may refer to arbitrary URIs. In this case, the security issues of [<a href="#rfc2396"><span class="abbrev">RFC 2396</span></a>], section 7, should be considered.</p><p>In addition, because of the extensibility features of XProc, it is possible that “application/xproc+xml” may describe content that has security implications beyond those described here. However, only in the case where the processor recognizes and processes the additional content, or where further processing of that content is dispatched to other processors, would security issues potentially arise. And in that case, they would fall outside the domain of this registration document.</p></dd><dt><span class="term">Interoperability considerations:</span></dt><dd><p>This specification describes processing semantics that dictate behavior that must be followed when dealing with, among other things, unrecognized elements.</p><p>Because XProc is extensible, conformant "application/xproc+xml" processors can expect that content received is well-formed XML, but it cannot be guaranteed that the content is valid XProc or that the processor will recognize all of the elements and attributes in the document.</p></dd><dt><span class="term">Published specification:</span></dt><dd><p>This media type registration is for XProc documents as described by this specification which is located at <a href="http://www.w3.org/TR/xproc/">http://www.w3.org/TR/xproc/</a>.</p></dd><dt><span class="term">Applications which use this media type:</span></dt><dd><p>There is no experimental, vendor specific, or personal tree predecessor to “<span class="quote"><code class="code">application/xproc+xml</code></span>”, reflecting the fact that no applications currently recognize it. This new type is being registered in order to allow for the deployment of XProc on the World Wide Web, as a first class XML application. </p></dd><dt><span class="term">Additional information:</span></dt><dd><div class="variablelist"><dl><dt><span class="term">Magic number(s):</span></dt><dd><p>There is no single initial octet sequence that is always present in XProc documents. </p></dd><dt><span class="term">File extension(s):</span></dt><dd><p>XProc documents are most often identified with the extension “<span class="quote"><code class="filename">.xpl</code></span>”. </p></dd><dt><span class="term">Macintosh File Type Code(s):</span></dt><dd><p>TEXT</p></dd></dl></div></dd><dt><span class="term">Person &amp; email address to contact for further information:</span></dt><dd><p>Norman Walsh, <code class="email">&lt;<a href="mailto:Norman.Walsh@MarkLogic.com">Norman.Walsh@MarkLogic.com</a>&gt;</code>.</p></dd><dt><span class="term">Intended usage:</span></dt><dd><p>COMMON</p></dd><dt><span class="term">Author/Change controller:</span></dt><dd><p>The XProc specification is a work product of the World Wide Web Consortium’s XML Processing Model Working Group. The W3C has change control over these specifications.</p></dd></dl></div></div></section><section id="fragid" class="section"><div class="section-titlepage"><h2><bdi class="secno">J.2. </bdi>Fragment Identifiers<a aria-label="§" class="self-link" href="#fragid"></a></h2></div><div class="content"><p>For documents labeled as “<span class="quote"><code class="code">application/xproc+xml</code></span>”, the fragment identifier notation is exactly that for “<span class="quote"><code class="code">application/xml</code></span>”, as specified in [<a href="#rfc3023"><span class="abbrev">RFC 3023</span></a>] or its successors.</p></div></section></div></article><article id="ancillary-files" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">K. </bdi>Ancillary files<a aria-label="§" class="self-link" href="#ancillary-files"></a></h2></header><div class="content"><p>This specification includes by reference a number of ancillary files.</p><div class="variablelist"><dl><dt><span class="term"><a href="xproc31.rnc"><span class="deltaxml-new" style="background:#90EE90">xproc31.rnc</span></a><span class="deltaxml-new" style="background:#90EE90">, </span><a href="xproc31.rng"><span class="deltaxml-new" style="background:#90EE90">xproc31.rng</span></a></span></dt><dd><p><span class="deltaxml-new" style="background:#90EE90">A RELAX NG Schema for XProc 3.1 pipelines, in compact or XML form. </span></p></dd><dt><span class="term"><a href="xproc30.rnc">xproc30.rnc</a>, <a href="xproc30.rng">xproc30.rng</a></span></dt><dd><p>A RELAX NG Schema for XProc 3.0 pipelines, in compact or XML form. </p></dd><dt><span class="term"><a href="xproc10.rnc">xproc10.rnc</a>, <a href="xproc10.rng">xproc10.rng</a></span></dt><dd><p>A RELAX NG Schema for XProc 1.0 pipelines, in compact or XML form. </p></dd><dt><span class="term"><a href="xproc.rnc">xproc.rnc</a>, <a href="xproc.rng">xproc.rng</a></span></dt><dd><p>A RELAX NG Schema for XProc pipelines, in compact or XML form. It will validate <span class="deltaxml-old" style="background:#FF5555">either </span>XProc 1.0<span class="deltaxml-old" style="background:#FF5555"> pipelines or XProc 3.0</span><span class="deltaxml-new" style="background:#90EE90">, 3.0, or 3.1</span> pipelines, depending on the value of the version attribute. </p><p>In order to use this schema, you must also download the 1.0<span class="deltaxml-old" style="background:#FF5555"> and 3.0</span><span class="deltaxml-new" style="background:#90EE90">, 3.0, and 3.1</span> schemas; they are included <span class="deltaxml-new" style="background:#90EE90">by reference </span>into this one.</p></dd><dt><span class="term"><a href="library.xpl">library.xpl</a></span></dt><dd><p>An XProc pipeline library that declares all of the standard built-in steps. </p></dd></dl></div></div></article><article id="credits" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">L. </bdi>Credits<a aria-label="§" class="self-link" href="#credits"></a></h2></header><div class="content"><p>This document is derived from <a href="https://www.w3.org/TR/2010/REC-xproc-20100511/">XProc: An XML Pipeline Language</a> published by the W3C. It was developed by the <em class="citetitle">XML Processing Model Working Group</em> and edited by Norman Walsh, Alex Miłowski, and Henry Thompson.</p><p>The editors of this specification extend their gratitude to everyone who contributed to this document and all of the versions that came before it.</p></div></article><article id="changelog" class="appendix"><header class="appendix-titlepage"><h2><bdi class="secno">M. </bdi>Change Log<a aria-label="§" class="self-link" href="#changelog"></a></h2></header><div class="content"><p><span class="deltaxml-old" style="background:#FF5555">This list contains the non-editorial changes made after the August 2020 “</span><a href="https://spec.xproc.org/lastcall-2020-08/head/xproc/"><span class="deltaxml-old" style="background:#FF5555">last call</span></a><span class="deltaxml-old" style="background:#FF5555">” draft:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-old" style="background:#FF5555">The </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">depends</span></code><span class="deltaxml-old" style="background:#FF5555"> attribute is forbidden on </span><a href="#p.when"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:when</span></code></a><span class="deltaxml-old" style="background:#FF5555">, </span><a href="#p.otherwise"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:otherwise</span></code></a><span class="deltaxml-old" style="background:#FF5555">, </span><a href="#p.catch"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:catch</span></code></a><span class="deltaxml-old" style="background:#FF5555">, and </span><a href="#p.finally"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:finally</span></code></a><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Processors may remove any implicit connections that they can determine statically will never be used (issue </span><a href="https://github.com/xproc/3.0-specification/issues/995"><span class="deltaxml-old" style="background:#FF5555">995</span></a><span class="deltaxml-old" style="background:#FF5555">). </span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Expanded and clarified the rules for implicit casting (issues </span><a href="https://github.com/xproc/3.0-specification/issues/1001"><span class="deltaxml-old" style="background:#FF5555">1001</span></a><span class="deltaxml-old" style="background:#FF5555"> and </span><a href="https://github.com/xproc/3.0-specification/issues/1012"><span class="deltaxml-old" style="background:#FF5555">1012</span></a><span class="deltaxml-old" style="background:#FF5555">). </span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The semantics of the </span><a href="#f.urify"><code class="function"><span class="deltaxml-old" style="background:#FF5555">p:urify</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function were extensively redrafted and clarified.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Text value templates are never expanded in the descendants of </span><a href="#p.inline"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:inline</span></code></a><span class="deltaxml-old" style="background:#FF5555"> elements that specify an </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">encoding</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified the semantics of </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">[p:]use-when</span></code><span class="deltaxml-old" style="background:#FF5555"> to address potential deadlock situations that can arise if two or more expressions depend on each other.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified that </span><a href="#f.step-available"><code class="function"><span class="deltaxml-old" style="background:#FF5555">p:step-available</span></code></a><span class="deltaxml-old" style="background:#FF5555"> cannot refer to the step currently being declared (issue </span><a href="https://github.com/xproc/3.0-specification/issues/1057"><span class="deltaxml-old" style="background:#FF5555">1057</span></a><span class="deltaxml-old" style="background:#FF5555">). </span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">A number of error codes have been clarified and new error codes have been added.</span></p></li></ul></div><p><span class="deltaxml-old" style="background:#FF5555">This list contains the non-editorial changes made after the December 2019 “</span><a href="https://spec.xproc.org/lastcall-2019-12/head/xproc/"><span class="deltaxml-old" style="background:#FF5555">last call</span></a><span class="deltaxml-old" style="background:#FF5555">” draft:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-old" style="background:#FF5555">The </span><code class="code"><span class="deltaxml-old" style="background:#FF5555">visibility</span></code><span class="deltaxml-old" style="background:#FF5555"> attribute of </span><a href="#p.variable"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:variable</span></code></a><span class="deltaxml-old" style="background:#FF5555"> was removed.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The description of the </span><code class="code"><span class="deltaxml-old" style="background:#FF5555">select</span></code><span class="deltaxml-old" style="background:#FF5555"> attribute of </span><a href="#p.option"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:option</span></code></a><span class="deltaxml-old" style="background:#FF5555"> no longer mentions static variables.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Error XD0079 added for defective content-types. (Was XS0070 or XS00130).</span></p></li></ul></div><p><span class="deltaxml-old" style="background:#FF5555">This list contains the non-editorial changes made after the February 2019 “</span><a href="http://spec.xproc.org/lastcall-2019-02/head/xproc/"><span class="deltaxml-old" style="background:#FF5555">last call</span></a><span class="deltaxml-old" style="background:#FF5555">” draft:</span></p><div class="itemizedlist"><ul><li><p><span class="deltaxml-old" style="background:#FF5555">The </span><code class="code"><span class="deltaxml-old" style="background:#FF5555">p:document-properties-document()</span></code><span class="deltaxml-old" style="background:#FF5555"> function was removed</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The semantics of </span><a href="#p.if"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:if</span></code></a><span class="deltaxml-old" style="background:#FF5555"> have been changed. If the test expression is false, </span><a href="#p.if"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:if</span></code></a><span class="deltaxml-old" style="background:#FF5555"> behaves roughly like an identity step. Previously it produced no outputs.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">It is no longer a static error (XS0093), if </span><a href="#p.option"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:option</span></code></a><span class="deltaxml-old" style="background:#FF5555"> or </span><a href="#p.variable"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:variable</span></code></a><span class="deltaxml-old" style="background:#FF5555"> have an attribute </span><code class="literal"><span class="deltaxml-old" style="background:#FF5555">visibility</span></code><span class="deltaxml-old" style="background:#FF5555"> and are not children of a </span><a href="#p.library"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:library</span></code></a><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The semantics of </span><a href="#p.choose"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:choose</span></code></a><span class="deltaxml-old" style="background:#FF5555"> have been changed. The default sub-pipeline for a missing </span><a href="#p.otherwise"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:otherwise</span></code></a><span class="deltaxml-old" style="background:#FF5555"> is a </span><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:identity</span></code><span class="deltaxml-old" style="background:#FF5555"> step (with the additional feature that it isn’t an error if there’s no default readable port). A primary output port on the </span><a href="#p.when"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:when</span></code></a><span class="deltaxml-old" style="background:#FF5555"> branches for this is required.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The way the context item for XPath expressions is provided has been changed. It is now provided if and only if the connection delivers exactly one document, otherwise the context item is undefined. A new error (XD0001) is introduced. It is raised if an XPath expression makes use of the context item, but the context item is undefined. Two dynamic errors (XD0005 and XD0008) were removed.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Content type shortcuts and the notion of forbidden content types have been added. See </span><a href="#specified-content-types" title="Specifying content types"><span class="deltaxml-old" style="background:#FF5555">Section 3.4, “Specifying content types”</span></a><span class="deltaxml-old" style="background:#FF5555">. </span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Introduction of the </span><code class="code"><span class="deltaxml-old" style="background:#FF5555">serialization</span></code><span class="deltaxml-old" style="background:#FF5555"> document property. See </span><a href="#document-properties" title="Document Properties"><span class="deltaxml-old" style="background:#FF5555">Section 3.1, “Document Properties”</span></a><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">The semantics pf </span><a href="#p.viewport"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:viewport</span></code></a><span class="deltaxml-old" style="background:#FF5555"> have been changed. HTML documents are now allowed as input and </span><code class="option"><span class="deltaxml-old" style="background:#FF5555">match</span></code><span class="deltaxml-old" style="background:#FF5555"> may now match every node type except attributes and namespace nodes.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Static </span><a href="#p.variable"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:variable</span></code></a><span class="deltaxml-old" style="background:#FF5555">s have been removed; the semantics of static </span><a href="#p.option"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:option</span></code></a><span class="deltaxml-old" style="background:#FF5555">s have been updated and clarified.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified that the </span><code class="literal"><span class="deltaxml-old" style="background:#FF5555">base-uri</span></code><span class="deltaxml-old" style="background:#FF5555"> property must always be a legal URI per [</span><a href="#rfc3986"><span class="abbrev"><span class="deltaxml-old" style="background:#FF5555">RFC 3986</span></span></a><span class="deltaxml-old" style="background:#FF5555">].</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Expanded the range of media types that may be considered “text” documents; opened the possibility for implementations to extend the list.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified that leading and trailing whitespace within a </span><a href="#p.inline"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:inline</span></code></a><span class="deltaxml-old" style="background:#FF5555"> is not discarded.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Identified the </span><code class="port"><span class="deltaxml-old" style="background:#FF5555">error</span></code><span class="deltaxml-old" style="background:#FF5555"> port as the primary input port in </span><a href="#p.catch"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:catch</span></code></a><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified that </span><a href="#p.finally"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:finally</span></code></a><span class="rfc2119" id="changelog.7.14.1.2"><span class="deltaxml-old" style="background:#FF5555">must not</span></span><span class="deltaxml-old" style="background:#FF5555"> declare a primary output port.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified which functions are available during static analysis.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified that atomic values are considered JSON documents.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Made </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">href</span></code><span class="deltaxml-old" style="background:#FF5555"> required on </span><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">c:entry</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified how sequences of XDM values (for example, from a </span><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:xslt</span></code><span class="deltaxml-old" style="background:#FF5555"> step) are converted into documents.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Updated the description of the </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">select</span></code><span class="deltaxml-old" style="background:#FF5555"> attribute for </span><a href="#p.input"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:input</span></code></a><span class="deltaxml-old" style="background:#FF5555"> so that it is in line with the more recent changes that have been applied to </span><a href="#p.with-input"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:with-input</span></code></a><span class="deltaxml-old" style="background:#FF5555">.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Changed description of </span><a href="#p.viewport"><code class="tag-element"><span class="deltaxml-old" style="background:#FF5555">p:viewport</span></code></a><span class="deltaxml-old" style="background:#FF5555"> stating that the base URI of every matched node is the document's base URI, not just for document and element nodes.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Changed the default value for serialization property </span><code class="literal"><span class="deltaxml-old" style="background:#FF5555">omit-xml-declaration</span></code><span class="deltaxml-old" style="background:#FF5555"> from </span><code class="literal"><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> to </span><code class="literal"><span class="deltaxml-old" style="background:#FF5555">false</span></code><span class="deltaxml-old" style="background:#FF5555"> in section “Serialization method” . Removed remark about default settings for this parameter from section “Minimal conformance”.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Clarified the conditions under which steps may produce PSVI annotations.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Added a </span><code class="tag-attribute"><span class="deltaxml-old" style="background:#FF5555">cause</span></code><span class="deltaxml-old" style="background:#FF5555"> attribute to the error vocabulary for recording the error codes of underlying errors.</span></p></li></ul></div><p><span class="deltaxml-new" style="background:#90EE90">This appendix summarizes the changes introduced in XProc 3.1.</span></p><section id="changelog.3" class="section"><div class="section-titlepage"><h2><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Backwards incompatible changes</span><a aria-label="§" class="self-link" href="#"></a></h2></div><div class="content"><p><span class="deltaxml-new" style="background:#90EE90">None.</span></p><section id="changelog.3.3" class="section"><div class="section-titlepage"><h3><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1.1. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Substantive changes</span><a aria-label="§" class="self-link" href="#"></a></h3></div><div class="content"><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1153"><span class="deltaxml-new" style="background:#90EE90">issue 1153</span></a><span class="deltaxml-new" style="background:#90EE90"> by changing the [p:]timeout error code from err:XD0036 to err:XS0077.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1133"><span class="deltaxml-new" style="background:#90EE90">issue 1133</span></a><span class="deltaxml-new" style="background:#90EE90"> by clarifying that imported function names are not transitive. </span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1129"><span class="deltaxml-new" style="background:#90EE90">issue 1129</span></a><span class="deltaxml-new" style="background:#90EE90"> by clarifying the way that </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:base</span></code><span class="deltaxml-new" style="background:#90EE90">, </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:id</span></code><span class="deltaxml-new" style="background:#90EE90">, </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:lang</span></code><span class="deltaxml-new" style="background:#90EE90">, and </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:space</span></code><span class="deltaxml-new" style="background:#90EE90"> are processed in XProc pipelines. The substantial clarification is that an </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xml:base</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute cannot be specified using an attribute value template. </span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1127"><span class="deltaxml-new" style="background:#90EE90">issue 1127</span></a><span class="deltaxml-new" style="background:#90EE90"> by allowing the value of the </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">[p:]timeout</span></code><span class="deltaxml-new" style="background:#90EE90"> attribute to be either a number of seconds or an </span><code class="type"><span class="deltaxml-new" style="background:#90EE90">xs:dayTimeDuration</span></code><span class="deltaxml-new" style="background:#90EE90">.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1124"><span class="deltaxml-new" style="background:#90EE90">issue 1124</span></a><span class="deltaxml-new" style="background:#90EE90"> by clarifying that when serialization properties are merged, the document properties supersede properties set on any step. Technically, this is a backwards incompatible change, but all of the steps with serialization properties specified this order, so no actual incompatibility exists.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1116"><span class="deltaxml-new" style="background:#90EE90">issue 1116</span></a><span class="deltaxml-new" style="background:#90EE90"> by clarifying that negated shortcut forms are allowed in </span><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">content-types</span></code><span class="deltaxml-new" style="background:#90EE90">.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1115"><span class="deltaxml-new" style="background:#90EE90">issue 1115</span></a><span class="deltaxml-new" style="background:#90EE90"> by clarifying how processors must behave when encountering pipelines labeled with version “3.0” and “3.1”. </span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Added a new error code, </span><code class="code"><span class="deltaxml-new" style="background:#90EE90">err:XD0083</span></code><span class="deltaxml-new" style="background:#90EE90"> as a catch-all error for the case when dynamic evaluation of an expression fails.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1096"><span class="deltaxml-new" style="background:#90EE90">issue 1096</span></a><span class="deltaxml-new" style="background:#90EE90"> by adding a </span><a href="#f.lookup-uri"><code class="function"><span class="deltaxml-new" style="background:#90EE90">p:lookup-uri</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/Vnext/issues/39"><span class="deltaxml-new" style="background:#90EE90">V.next issue 39</span></a><span class="deltaxml-new" style="background:#90EE90"> by allowing the </span><a href="#xpath-version-attribute"><code class="tag-attribute"><span class="deltaxml-new" style="background:#90EE90">xpath-version</span></code></a><span class="deltaxml-new" style="background:#90EE90"> to be implementation defined.</span></p></li></ul></div></div></section><section id="changelog.3.4" class="section"><div class="section-titlepage"><h3><bdi class="secno"><span class="deltaxml-new" style="background:#90EE90">M.1.2. </span></bdi><span class="deltaxml-new" style="background:#90EE90">Editorial changes</span><a aria-label="§" class="self-link" href="#"></a></h3></div><div class="content"><div class="itemizedlist"><ul><li><p><span class="deltaxml-new" style="background:#90EE90">Clarified the semantics of </span><a href="#p.import-functions"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import-functions</span></code></a><span class="deltaxml-new" style="background:#90EE90">.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">References to version “3.0” were changed to “3.1” throughout.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1085"><span class="deltaxml-new" style="background:#90EE90">issue 1085</span></a><span class="deltaxml-new" style="background:#90EE90"> by </span><a href="#statics"><span class="deltaxml-new" style="background:#90EE90">clarifying</span></a><span class="deltaxml-new" style="background:#90EE90"> how the scope of static options interacts with their initialized values.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1083"><span class="deltaxml-new" style="background:#90EE90">issue 1083</span></a><span class="deltaxml-new" style="background:#90EE90"> by </span><a href="#p.import"><span class="deltaxml-new" style="background:#90EE90">clarifying</span></a><span class="deltaxml-new" style="background:#90EE90"> the semantics of </span><a href="#p.import"><code class="tag-element"><span class="deltaxml-new" style="background:#90EE90">p:import</span></code></a><span class="deltaxml-new" style="background:#90EE90">.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90">Resolved </span><a href="https://github.com/xproc/3.0-specification/issues/1083"><span class="deltaxml-new" style="background:#90EE90">issue 1095</span></a><span class="deltaxml-new" style="background:#90EE90"> by </span><a href="#canon-import-uris"><span class="deltaxml-new" style="background:#90EE90">suggesting</span></a><span class="deltaxml-new" style="background:#90EE90"> that implementations should make library URIs canonical when comparing them.</span></p></li></ul></div></div></section></div></section></div></article></article><script src="js/prism.js"></script><script src="js/fixup.js"></script><script src="/js/scroll.js"></script></body></html>